/* Generated by Together */
package es.altia.agora.interfaces.user.web.sge;

import es.altia.agora.business.escritorio.UsuarioValueObject;
import es.altia.agora.interfaces.user.web.util.ActionSession;

import java.io.IOException;
import java.util.Vector;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import es.altia.agora.business.sge.ConsultaExpedientesValueObject;
import es.altia.agora.business.util.GeneralValueObject;
import es.altia.agora.business.sge.persistence.ConsultaExpedientesManager;
import es.altia.agora.business.sge.persistence.TramitacionExpedientesManager;
import es.altia.agora.business.sge.TramitacionValueObject;
import es.altia.agora.business.sge.persistence.OperacionesExpedienteManager;

import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;

public final class GestionIncidenciasAction extends ActionSession {
    
    
    public ActionForward performSession(ActionMapping mapping,
            ActionForm form,
            HttpServletRequest request,
            HttpServletResponse response) throws IOException, ServletException {
                
        // Validaremos los parametros del request especificados
        HttpSession session = request.getSession();
        
        String opcion;
        String numExp;
        
        if ((session.getAttribute("usuario") != null)) {
            UsuarioValueObject usuario = (UsuarioValueObject)session.getAttribute("usuario");
            String[] params = usuario.getParamsCon();
            
            // Si usuario en sesion es nulo --> error.
            opcion = request.getParameter("opcion");
            numExp = request.getParameter("numeroExpediente");
                                                      
            if ("reabrirExpediente".equals(opcion)){
                ConsultaExpedientesValueObject cExpVO = new ConsultaExpedientesValueObject();
                cExpVO.setNumeroExpediente(numExp);
                cExpVO.setReaperturaExpediente(true); //para que en consultar no haga paginacion
                Vector resultados =  ConsultaExpedientesManager.getInstance().consultar(usuario,cExpVO,params, false, false,"","",true);
                
                String msgAlerta;
                TramitacionValueObject tramitacionVO;
                if (resultados.isEmpty()){
                    //No existe el expediente con dicho código      
                    msgAlerta = "msjExpNoExiste";                    
                }else{                    
                    tramitacionVO = (TramitacionValueObject) resultados.get(0);
                     m_Log.debug("*** ESTADO DEL EXPEDIENTE : " + tramitacionVO.getEstado());
                    if (("9".equals(tramitacionVO.getEstado()))||("1".equals(tramitacionVO.getEstado()))){
                        //El expediente está cerrado    
                        GeneralValueObject gVO = 
                                new GeneralValueObject();
                        gVO.setAtributo("codMunicipio",tramitacionVO.getCodMunicipio());
                        gVO.setAtributo("ejercicio",tramitacionVO.getEjercicio());
                        gVO.setAtributo("numero",numExp);
                        gVO.setAtributo("codProcedimiento",tramitacionVO.getCodProcedimiento());
                        gVO.setAtributo("estadoExpediente",tramitacionVO.getEstado());
                        gVO.setAtributo("usuario",Integer.toString(usuario.getIdUsuario()));
                        gVO.setAtributo("nomUsuario",usuario.getNombreUsu());

                        //Reabrimos el expediente
                        if (TramitacionExpedientesManager.getInstance().reabrirExpediente(gVO,params)!=-1) {
                            msgAlerta = "msjExpReabierto";
                            OperacionesExpedienteManager.getInstance().registrarReabrirExpediente(gVO, params);
                        } else                            
                            msgAlerta = "msjExpErrorApertura";                        
                    }else{ 
                        msgAlerta = "msjExpNoFinalizError";
                    }                    
                }
                request.setAttribute("msgAlerta",msgAlerta);  
                request.setAttribute("numeroExpediente",numExp);
            }
            
        } else { // No hay usuario.
            opcion = "no_usuario";
        }
        
        /* Redirigimos al JSP de salida*/
        return (mapping.findForward(opcion));
    }
}