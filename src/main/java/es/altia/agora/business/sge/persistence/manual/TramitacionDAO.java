package es.altia.agora.business.sge.persistence.manual; 

import es.altia.agora.business.administracion.exception.GestionException;
import es.altia.agora.business.administracion.mantenimiento.CamposListadosParametrizablesVO;
import es.altia.agora.business.administracion.mantenimiento.ValoresCriterioBusquedaExpPendientesVO;
import es.altia.agora.business.administracion.mantenimiento.persistence.manual.UORDTO;
import es.altia.agora.business.administracion.mantenimiento.persistence.manual.UORsDAO;
import es.altia.agora.business.administracion.mantenimiento.persistence.manual.UsuariosGruposDAO;
import es.altia.agora.business.administracion.persistence.manual.CalendarioGeneralDAO;
import es.altia.agora.business.escritorio.UsuarioValueObject;
import es.altia.agora.business.registro.HistoricoMovimientoValueObject;
import es.altia.agora.business.registro.persistence.HistoricoMovimientoManager;
import es.altia.agora.business.sge.DefinicionProcedimientosValueObject;
import es.altia.agora.business.sge.TramitacionValueObject;
import es.altia.agora.business.registro.RegistroValueObject; 
import es.altia.agora.business.sge.CampoSuplementarioVO;
import es.altia.agora.business.sge.exception.TramitacionException;
import es.altia.agora.business.sge.persistence.CamposListadoPendientesProcedimientoManager;
import es.altia.agora.business.sge.persistence.DefinicionProcedimientosManager;
import es.altia.agora.business.util.GeneralValueObject;
import es.altia.agora.business.sge.persistence.TramitacionManager;
import es.altia.agora.business.terceros.CondicionesBusquedaTerceroVO;
import es.altia.agora.business.terceros.DomicilioSimpleValueObject;
import es.altia.agora.business.terceros.TercerosValueObject;
import es.altia.agora.business.terceros.persistence.TercerosManager;
import es.altia.agora.business.terceros.mantenimiento.persistence.manual.ProvinciasDAO;
import es.altia.agora.business.terceros.mantenimiento.persistence.manual.MunicipiosDAO;
import es.altia.agora.business.terceros.mantenimiento.MunicipioVO;
import es.altia.agora.interfaces.user.web.registro.MantAnotacionRegistroForm;
import es.altia.agora.business.util.ElementoListaValueObject;
import es.altia.agora.business.util.GlobalNames;    
import es.altia.agora.business.util.jdbc.SigpGeneralOperations;
import es.altia.agora.interfaces.user.web.util.FormateadorTercero;
import es.altia.agora.business.util.HistoricoAnotacionHelper;
import es.altia.agora.business.util.TransformacionAtributoSelect;
import es.altia.agora.technical.ConstantesDatos;
import es.altia.agora.technical.Fecha;
import es.altia.common.exception.TechnicalException; 
import es.altia.common.service.config.Config;
import es.altia.common.service.config.ConfigServiceHelper;
import es.altia.flexia.expedientes.relacionados.plugin.vo.ExpedienteRelacionadoVO;
import es.altia.util.StringUtils;
import es.altia.util.cache.CacheDatosFactoria;
import es.altia.util.conexion.AdaptadorSQL;
import es.altia.util.conexion.AdaptadorSQLBD;
import es.altia.util.conexion.BDException;
import es.altia.util.exceptions.InternalErrorException;
import es.altia.util.jdbc.GeneralOperations;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import java.sql.*;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.GregorianCalendar;
import java.util.Vector;
import es.altia.util.commons.DateOperations;
import es.altia.util.commons.NumericOperations;
import java.lang.Integer;
import java.util.Calendar;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.SortedMap;


public class TramitacionDAO { 
    
    private static final String TIPO_PLAZO_DIAS_HABILES = "H";
    private static final String TIPO_PLAZO_DIAS_NATURALES = "N";
    private static final String TIPO_PLAZO_MESES = "M";

    private static final int TIPO_PLAZO_EXPEDIENTES_DIAS_NATURALES = 2;
    private static final int TIPO_PLAZO_EXPEDIENTES_DIAS_HABILES = 1;
    private static final int TIPO_PLAZO_EXPEDIENTES_MESES = 3;

    private static final String  COLUMNA_ORDEN_INTERESADO="19";

    /* Declaracion de servicios */
    protected static Config m_ConfigTechnical; // Fichero de configuracion tecnico
    protected static Log m_Log =
            LogFactory.getLog(TramitacionDAO.class.getName());



    /* Instancia unica */
    private static TramitacionDAO instance = null;

    protected static String idiomaDefecto;
    protected static String sql_res_codDpto;
    protected static String sql_res_codUnid;
    protected static String sql_res_tipoReg;
    protected static String sql_res_ejer;
    protected static String sql_res_num;
    protected static String sql_res_obs;
    protected static String sql_res_fecAnot;
    protected static String sql_res_asunt;
    protected static String sql_res_estado;
    protected static String sql_res_codTerc;
    protected static String sql_res_domTerc;
    protected static String sql_res_modTerc;
    protected static String sql_res_tipoDestino;
    protected static String sql_res_ord_dpto; // Ordinaria
    protected static String sql_res_ord_unid;

    protected static String sql_hte_ter; // Identificador tercero
    protected static String sql_hte_nvr; // Version tercero
    protected static String sql_hte_nan;
    protected static String sql_hte_a1a;
    protected static String sql_hte_a2a;
    protected static String sql_hte_noc;
    protected static String sql_hte_p1a;
    protected static String sql_hte_p2a;

    protected static String ext_mun;
    protected static String ext_eje;
    protected static String ext_num;
    protected static String ext_pro;
    protected static String ext_ter;
    protected static String ext_nvr;
    protected static String ext_rol;
    protected static String ext_dot;

    protected static String sql_dnn_dom; // Domicilio tercero, no normalizado
    protected static String sql_dpo_dom; // Domicilio tercero, normalizado

    protected static String sql_dnn_pai;
    protected static String sql_dnn_prv;
    protected static String sql_dnn_mun;
    protected static String sql_mun_pai;
    protected static String sql_mun_prv;
    protected static String sql_mun_cod;

    protected static String sql_dpo_dirSuelo;
    protected static String sql_dsu_codDirSuelo;
    protected static String sql_dsu_pais;
    protected static String sql_dsu_prov;
    protected static String sql_dsu_mun;

    protected static String sql_uor_nombre;
    protected static String sql_uor_codigo;
    protected static String sql_uor_codigo_visible;

    protected static String sql_uou_org;
    protected static String sql_uou_ent;
    protected static String sql_uou_uor;
    protected static String sql_uou_usu;

    protected static String sql_exp_codMun;
    protected static String sql_exp_codProc;
    protected static String sql_exp_ejer;
    protected static String sql_exp_num;
    protected static String sql_exp_fechIni;
    protected static String sql_exp_uor;
    protected static String sql_exp_estado;
    protected static String sql_exp_asunto;
  protected static String sql_exp_loc;

    protected static String sql_pro_codMun;
    protected static String sql_pro_cod;
    protected static String sql_pro_utr;
    protected static String sql_pro_tipo;
    protected static String sql_pro_fechHast;
    protected static String sql_pro_fechDesd;
    protected static String sql_pro_tipInic;
    protected static String sql_pro_estado;
    protected static String sql_pro_tramInternet;

    protected static String sql_pml_codMun;
    protected static String sql_pml_codProc;
    protected static String sql_pml_campo;
    protected static String sql_pml_lengua;
    protected static String sql_pml_valorCampo;

    protected static String sql_pui_codMun;
    protected static String sql_pui_codProc;
    protected static String sql_pui_uor;

    protected static String sql_org_codigo;
    protected static String sql_org_num;
    protected static String sql_nex_codMun;
    protected static String sql_nex_codProc;
    protected static String sql_nex_uor;
    protected static String sql_nex_num;
    protected static String sql_nex_ejer;

    protected static String sql_exr_mun;
    protected static String sql_exr_pro;
    protected static String sql_exr_eje;
    protected static String sql_exr_num;
    protected static String sql_exr_dep;
    protected static String sql_exr_uor;
    protected static String sql_exr_ejr;
    protected static String sql_exr_nre;
    protected static String sql_exr_tip;
    protected static String sql_exr_ori;
    protected static String sql_exr_top;

    protected static String sql_cro_mun;
    protected static String sql_cro_pro;
    protected static String sql_cro_eje;
    protected static String sql_cro_num;
    protected static String sql_cro_tra;
    protected static String sql_cro_ocu;
    protected static String sql_cro_fef;
    protected static String sql_cro_fli;
    protected static String sql_cro_uor;
    protected static String sql_cro_ffp;
     protected static String sql_cro_fip;

    protected static String sql_tra_mun;
    protected static String sql_tra_pro;
    protected static String sql_tra_cod;
    protected static String sql_tra_utr;

    protected static String rol_mun;
    protected static String rol_pro;
    protected static String rol_cod;
    protected static String rol_des; 
    protected static String rol_pde;

    protected static String sql_rel_codMun;
    protected static String sql_rel_codProc;
    protected static String sql_rel_ejer;
    protected static String sql_rel_num;
    protected static String sql_rel_estado;
    protected static String sql_rel_exp_codMun;
    protected static String sql_rel_exp_codProc;
    protected static String sql_rel_exp_ejer;
    protected static String sql_rel_exp_num;
    protected static String sql_rel_exp_codMunR;
    protected static String sql_rel_exp_codProcR;
    protected static String sql_rel_exp_ejerR;
    protected static String sql_rel_exp_numR;
    
    protected static String r_ext_coduor;
    protected static String r_ext_tipo;
    protected static String r_ext_numero;
    protected static String r_ext_ano;
    protected static String r_ext_dep;
    protected static String r_ext_ter;
    protected static String r_ext_nvr;
    protected static String r_ext_dot;
    protected static String r_ext_rol;



    /**
     * Construye un nuevo TramitacionDAO.
     * Es protected, por lo que la unica manera de instanciar esta clase
     * es usando el factory method <code>getInstance</code>
     */
    protected TramitacionDAO() {
        super();
        // Fichero de configuracion techserver
        m_ConfigTechnical = ConfigServiceHelper.getConfig("techserver");
        // Servicio de log

        idiomaDefecto = m_ConfigTechnical.getString("idiomaDefecto");
        // Tabla R_RES
        sql_res_codDpto= m_ConfigTechnical.getString("SQL.R_RES.codDpto");
        sql_res_codUnid= m_ConfigTechnical.getString("SQL.R_RES.codUnidad");
        sql_res_tipoReg= m_ConfigTechnical.getString("SQL.R_RES.tipoReg");
        sql_res_ejer= m_ConfigTechnical.getString("SQL.R_RES.ejercicio");
        sql_res_num= m_ConfigTechnical.getString("SQL.R_RES.numeroAnotacion");
        sql_res_fecAnot= m_ConfigTechnical.getString("SQL.R_RES.fechaAnotacion");
        sql_res_asunt = m_ConfigTechnical.getString("SQL.R_RES.asunto");
        sql_res_obs = m_ConfigTechnical.getString("SQL.R_RES.observaciones");
        sql_res_estado = m_ConfigTechnical.getString("SQL.R_RES.estAnot");
        sql_res_codTerc= m_ConfigTechnical.getString("SQL.R_RES.codTercero");
        sql_res_domTerc= m_ConfigTechnical.getString("SQL.R_RES.domicTercero");
        sql_res_modTerc= m_ConfigTechnical.getString("SQL.R_RES.modifInteresado");
        sql_res_tipoDestino = m_ConfigTechnical.getString("SQL.R_RES.tipoAnotacionDestino");
        sql_res_ord_dpto = m_ConfigTechnical.getString("SQL.R_RES.orgOrigAnot");
        sql_res_ord_unid= m_ConfigTechnical.getString("SQL.R_RES.unidOrigDest");

        sql_hte_ter = m_ConfigTechnical.getString("SQL.T_HTE.identificador");
        sql_hte_nvr = m_ConfigTechnical.getString("SQL.T_HTE.version");
        sql_hte_nan = m_ConfigTechnical.getString("SQL.T_HTE.nombre");
        sql_hte_a1a = m_ConfigTechnical.getString("SQL.T_HTE.apellido1");
        sql_hte_a2a = m_ConfigTechnical.getString("SQL.T_HTE.apellido2");
        sql_hte_p1a = m_ConfigTechnical.getString("SQL.T_HTE.partApellido1");
        sql_hte_p2a = m_ConfigTechnical.getString("SQL.T_HTE.partApellido2");

        ext_mun = m_ConfigTechnical.getString("SQL.E_EXT.codMunicipio");
        ext_eje = m_ConfigTechnical.getString("SQL.E_EXT.ano");
        ext_num = m_ConfigTechnical.getString("SQL.E_EXT.numero");
        ext_pro = m_ConfigTechnical.getString("SQL.E_EXT.codProcedimiento");
        ext_ter = m_ConfigTechnical.getString("SQL.E_EXT.codTercero");
        ext_nvr = m_ConfigTechnical.getString("SQL.E_EXT.verTercero");
        ext_rol = m_ConfigTechnical.getString("SQL.E_EXT.rolTercero");
        ext_dot = m_ConfigTechnical.getString("SQL.E_EXT.codDomicilio");

        sql_dnn_pai = m_ConfigTechnical.getString("SQL.T_DNN.idPaisD");
        sql_mun_pai = m_ConfigTechnical.getString("SQL.T_MUN.idPais");
        sql_dnn_prv = m_ConfigTechnical.getString("SQL.T_DNN.idProvinciaD");
        sql_mun_prv = m_ConfigTechnical.getString("SQL.T_MUN.idProvincia");
        sql_dnn_mun = m_ConfigTechnical.getString("SQL.T_DNN.idMunicipioD");
        sql_mun_cod = m_ConfigTechnical.getString("SQL.T_MUN.idMunicipio");

        sql_dnn_dom = m_ConfigTechnical.getString("SQL.T_DNN.idDomicilio");
        sql_dpo_dom = m_ConfigTechnical.getString("SQL.T_DPO.domicilio"); // Domicilio tercero, normalizado
        sql_dpo_dirSuelo = m_ConfigTechnical.getString("SQL.T_DPO.suelo");
        sql_dsu_codDirSuelo = m_ConfigTechnical.getString("SQL.T_DSU.identificador");
        sql_dsu_pais= m_ConfigTechnical.getString("SQL.T_DSU.pais");
        sql_dsu_prov= m_ConfigTechnical.getString("SQL.T_DSU.provincia");
        sql_dsu_mun = m_ConfigTechnical.getString("SQL.T_DSU.municipio");

        sql_uou_uor= m_ConfigTechnical.getString("SQL.A_UOU.unidadOrg");
        sql_uou_usu= m_ConfigTechnical.getString("SQL.A_UOU.usuario");
        sql_uou_org= m_ConfigTechnical.getString("SQL.A_UOU.organizacion");
        sql_uou_ent= m_ConfigTechnical.getString("SQL.A_UOU.entidad");

        sql_uor_nombre = m_ConfigTechnical.getString("SQL.A_UOR.nombre");
        sql_uor_codigo = m_ConfigTechnical.getString("SQL.A_UOR.codigo");
        sql_uor_codigo_visible = m_ConfigTechnical.getString("SQL.A_UOR.codigoVisible");

        sql_exp_codMun= m_ConfigTechnical.getString("SQL.E_EXP.codMunicipio");
        sql_exp_codProc= m_ConfigTechnical.getString("SQL.E_EXP.codProcedimiento");
        sql_exp_ejer= m_ConfigTechnical.getString("SQL.E_EXP.ano");
        sql_exp_num= m_ConfigTechnical.getString("SQL.E_EXP.numero");
        sql_exp_fechIni= m_ConfigTechnical.getString("SQL.E_EXP.fechaInicio");
        sql_exp_uor=  m_ConfigTechnical.getString("SQL.E_EXP.uor");
        sql_exp_estado= m_ConfigTechnical.getString("SQL.E_EXP.estado");
        sql_exp_asunto= m_ConfigTechnical.getString("SQL.E_EXP.asunto");
    sql_exp_loc= m_ConfigTechnical.getString("SQL.E_EXP.localizacion");

        sql_pro_codMun= m_ConfigTechnical.getString("SQL.E_PRO.municipio");
        sql_pro_cod= m_ConfigTechnical.getString("SQL.E_PRO.codigoProc");
        sql_pro_fechHast= m_ConfigTechnical.getString("SQL.E_PRO.fechaLimiteHasta");
        sql_pro_fechDesd= m_ConfigTechnical.getString("SQL.E_PRO.fechaLimiteDesde");
        sql_pro_utr=m_ConfigTechnical.getString("SQL.E_PRO.unidad");
        sql_pro_tipo= m_ConfigTechnical.getString("SQL.E_PRO.tipoProcedimiento");
        sql_pro_tipInic= m_ConfigTechnical.getString("SQL.E_PRO.tipoInicio");
        sql_pro_estado= m_ConfigTechnical.getString("SQL.E_PRO.estadoProcedimiento");
        sql_pro_tramInternet= m_ConfigTechnical.getString("SQL.E_PRO.tramitacionInternet");

        sql_pml_codMun= m_ConfigTechnical.getString("SQL.E_PML.codMunicipio");
        sql_pml_codProc= m_ConfigTechnical.getString("SQL.E_PML.codProcedimiento");
        sql_pml_campo= m_ConfigTechnical.getString("SQL.E_PML.codCampoML");
        sql_pml_lengua= m_ConfigTechnical.getString("SQL.E_PML.idioma");
        sql_pml_valorCampo= m_ConfigTechnical.getString("SQL.E_PML.valor");

        sql_pui_codMun = m_ConfigTechnical.getString("SQL.E_PUI.codMunicipio");
        sql_pui_codProc = m_ConfigTechnical.getString("SQL.E_PUI.codProcedimiento");
        sql_pui_uor = m_ConfigTechnical.getString("SQL.E_PUI.codUnidadInicio");

        sql_org_codigo= m_ConfigTechnical.getString("SQL.A_ORG.codigo");
        sql_org_num= m_ConfigTechnical.getString("SQL.A_ORG.numExp");

        sql_nex_codMun= m_ConfigTechnical.getString("SQL.E_NEX.codMunicipio");
        sql_nex_codProc= m_ConfigTechnical.getString("SQL.E_NEX.codProcedimiento");
        sql_nex_uor= m_ConfigTechnical.getString("SQL.E_NEX.uor");
        sql_nex_num= m_ConfigTechnical.getString("SQL.E_NEX.numero");
        sql_nex_ejer= m_ConfigTechnical.getString("SQL.E_NEX.ejercicio");

        sql_exr_mun= m_ConfigTechnical.getString("SQL.E_EXR.codMunicipio");
        sql_exr_pro= m_ConfigTechnical.getString("SQL.E_EXR.codProcedimiento");
        sql_exr_eje= m_ConfigTechnical.getString("SQL.E_EXR.ejercicio");
        sql_exr_num= m_ConfigTechnical.getString("SQL.E_EXR.numero");
        sql_exr_dep= m_ConfigTechnical.getString("SQL.E_EXR.departamentoAnotacion");
        sql_exr_uor= m_ConfigTechnical.getString("SQL.E_EXR.unidadAnotacion");
        sql_exr_ejr= m_ConfigTechnical.getString("SQL.E_EXR.ejercicioAnotacion");
        sql_exr_nre= m_ConfigTechnical.getString("SQL.E_EXR.numeroRegistro");
        sql_exr_tip= m_ConfigTechnical.getString("SQL.E_EXR.tipoRegistro");
        sql_exr_ori= m_ConfigTechnical.getString("SQL.E_EXR.origen");
        sql_exr_top= m_ConfigTechnical.getString("SQL.E_EXR.tipoOperacion");

        sql_cro_mun = m_ConfigTechnical.getString("SQL.E_CRO.codMunicipio");
        sql_cro_pro = m_ConfigTechnical.getString("SQL.E_CRO.codProcedimiento");
        sql_cro_eje = m_ConfigTechnical.getString("SQL.E_CRO.ano");
        sql_cro_num = m_ConfigTechnical.getString("SQL.E_CRO.numero");
        sql_cro_tra = m_ConfigTechnical.getString("SQL.E_CRO.codTramite");
        sql_cro_ocu = m_ConfigTechnical.getString("SQL.E_CRO.ocurrencia");
        sql_cro_fef = m_ConfigTechnical.getString("SQL.E_CRO.fechaFin");
        sql_cro_fli = m_ConfigTechnical.getString("SQL.E_CRO.fechaLimite");
        sql_cro_uor = m_ConfigTechnical.getString("SQL.E_CRO.codUnidadTramitadora");
        sql_cro_ffp = m_ConfigTechnical.getString("SQL.E_CRO.fechaFinPlazo");
        sql_cro_fip = m_ConfigTechnical.getString("SQL.E_CRO.fechaInicioPlazo");
        sql_tra_mun = m_ConfigTechnical.getString("SQL.E_TRA.codMunicipio");
        sql_tra_pro = m_ConfigTechnical.getString("SQL.E_TRA.codProcedimiento");
        sql_tra_cod = m_ConfigTechnical.getString("SQL.E_TRA.codTramite");
        sql_tra_utr = m_ConfigTechnical.getString("SQL.E_TRA.unidadTramite");

        rol_mun = m_ConfigTechnical.getString("SQL.E_ROL.codMunicipio");
        rol_pro = m_ConfigTechnical.getString("SQL.E_ROL.codProcedimiento");
        rol_cod = m_ConfigTechnical.getString("SQL.E_ROL.codRol");
        rol_des = m_ConfigTechnical.getString("SQL.E_ROL.descripcion");
        rol_pde = m_ConfigTechnical.getString("SQL.E_ROL.porDefecto");

        sql_rel_codMun= m_ConfigTechnical.getString("SQL.G_REL.codMunicipio");
        sql_rel_codProc= m_ConfigTechnical.getString("SQL.G_REL.codProcedimiento");
        sql_rel_ejer= m_ConfigTechnical.getString("SQL.G_REL.ano");
        sql_rel_num= m_ConfigTechnical.getString("SQL.G_REL.numero");
        sql_rel_estado= m_ConfigTechnical.getString("SQL.G_REL.estado");
        sql_rel_exp_codMun= m_ConfigTechnical.getString("SQL.G_EXP.codMunicipio");
        sql_rel_exp_codProc= m_ConfigTechnical.getString("SQL.G_EXP.codProcedimiento");
        sql_rel_exp_ejer= m_ConfigTechnical.getString("SQL.G_EXP.ejercicio");
        sql_rel_exp_num= m_ConfigTechnical.getString("SQL.G_EXP.numero");
        sql_rel_exp_codMunR= m_ConfigTechnical.getString("SQL.G_EXP.codMunicipioR");
        sql_rel_exp_codProcR= m_ConfigTechnical.getString("SQL.G_EXP.codProcedimientoR");
        sql_rel_exp_ejerR= m_ConfigTechnical.getString("SQL.G_EXP.ejercicioR");
        sql_rel_exp_numR= m_ConfigTechnical.getString("SQL.G_EXP.numeroR");


        // Interesados registro
    r_ext_coduor = m_ConfigTechnical.getString ("SQL.R_EXT.codUor");
    r_ext_tipo   = m_ConfigTechnical.getString ("SQL.R_EXT.tipo");
    r_ext_ano    = m_ConfigTechnical.getString ("SQL.R_EXT.ano");
    r_ext_numero = m_ConfigTechnical.getString ("SQL.R_EXT.numero");
    r_ext_dep    = m_ConfigTechnical.getString ("SQL.R_EXT.coddepartamento");
    r_ext_ter    = m_ConfigTechnical.getString ("SQL.R_EXT.codTercero");
    r_ext_nvr    = m_ConfigTechnical.getString ("SQL.R_EXT.verTercero");
    r_ext_dot    = m_ConfigTechnical.getString ("SQL.R_EXT.codDomicilio");
    r_ext_rol    = m_ConfigTechnical.getString ("SQL.R_EXT.rolTercero");

    }

    public static TramitacionDAO getInstance() { 
        synchronized(TramitacionDAO.class) {
                if (instance == null)
                    instance = new TramitacionDAO();
            }
        return instance;
    }


    /*
    public Vector getAsientosEntradaRegistro(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params,
                                             String fechaDesde, String fechaHasta, String nombreServicio)
    throws TramitacionException, TechnicalException {
        */
    public Vector getAsientosEntradaRegistro(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params,
                                             String fechaDesde, String fechaHasta, String nombreServicio,String documentoBusqueda,String nombreBusqueda,String apellido1Busqueda,String apellido2Busqueda,String codAsunto,String unidadRegistroAsunto,String tipoRegistroAsunto,String codUorDestino,String ejercicio,String numAnotacion, String codUorAnotacion
                                            )
    throws TramitacionException, TechnicalException {

        //Esta consulta es para los registros internos de flexia. el RTE también llama a este DAO, pero no hacemos la consulta para evitar duplicados
        if(!"SGE".equals(nombreServicio)) return new Vector(); 
        //String nombre,String apellido1,String apellido2,String codAsunto,String codUorDestino
        m_Log.debug("getAsientosEntradaRegistro");
        
         m_Log.debug("cod UOR interno anotacion: "+ codUorAnotacion);

        m_Log.debug("documentoBusqueda: " + documentoBusqueda + " ,nombreBusqueda: " + nombreBusqueda + ",apellido1Busqueda: " + apellido1Busqueda + ",apellido2Busqueda: " + apellido2Busqueda + ",codAsunto: " + codAsunto + ",codUorDestino: " + codUorDestino + ",ejercicio: " + ejercicio + ",numAnotacion: " + numAnotacion);
        Vector<TramitacionValueObject> lista = new Vector<TramitacionValueObject>();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String columna= tVO.getColumna();
        String tipoOrden=tVO.getTipoOrdenacion();

        // SE COMPRUEBA SI SÓLO SE DEBEN CONTAR EXPEDIENTES
        boolean soloContar = tVO.isSoloContarExpedientesBuzonEntrada();
        
        int posE = 0;
        int numPaginaE = 0;
        int pagActual = -1;
        if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado()!=null) {
            pagActual = Integer.parseInt(tVO.getPaginaListado());
        }
        
        int lineas = -1;
        if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado()!=null) {
            lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());    
        }
       
        
        try {
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

            String pWhere3 = "";
            String parte_select = 
                    
            /** ORIGINAL      
            "SELECT RES_DEP, RES_UOR,RES_UOD, RES_TIP, RES_EJE, RES_NUM, RES_OBS,R_RES.PROCEDIMIENTO," + GlobalNames.ESQUEMA_GENERICO + "A_USU.USU_NOM AS NOM, ";
            parte_select += oad.convertir("RES_FEC", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS FECANOT, ";
            parte_select += oad.convertir("RES_FED", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS FECDOC, ";
            parte_select += "RES_ASU, HTE_NOM,UOR.UOR_NOM, UOD.UOR_NOM AS UNIDADDESTINO, ";
            parte_select += oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA1", "' '", "HTE_AP1"}) + " AS APELLIDO1, "
                    + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA2", "' '", "HTE_AP2"}) +
                    " AS APELLIDO2,(SELECT COUNT (*) FROM  R_EXT WHERE res_uor=ext_uor AND res_dep=ext_dep AND res_tip=ext_tip AND res_eje=ext_eje AND res_num=ext_num )AS num_terceros,exr_num, "+
                    oad.convertir("RES_FEC", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYY/MM/DD") + " AS FECANOTORD, "+
                    oad.convertir("RES_FED", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYY/MM/DD") + " AS FECDOCORD";
            */

            "SELECT DISTINCT * FROM (SELECT RES_DEP, RES_UOR,RES_UOD, RES_TIP, RES_EJE, RES_NUM, RES_OBS," + GlobalNames.ESQUEMA_GENERICO + "A_USU.USU_NOM AS NOM, ";
            parte_select += oad.convertir("RES_FEC", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY HH24:MI:SS") + " AS FECANOT, ";
            parte_select += oad.convertir("RES_FED", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS FECDOC, ";
            parte_select += "RES_ASU, HTE_NOM,UOR.UOR_NOM, UOD.UOR_NOM AS UNIDADDESTINO, ";
            parte_select += oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA1", "' '", "HTE_AP1"}) + " AS APELLIDO1, "
                    + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA2", "' '", "HTE_AP2"}) +
                    " AS APELLIDO2, HTE_DOC, (SELECT COUNT (*) FROM  R_EXT WHERE res_uor=ext_uor AND res_dep=ext_dep AND res_tip=ext_tip AND res_eje=ext_eje AND res_num=ext_num )AS num_terceros, "+
                    " RES_FEC, " +
                    " RES_FED ";
             parte_select +=",TTR_DES as TRANSPORTE , rta.CODIGO as COD_ASUNTO_CODIFICADO, rta.DESCRIPCION as DES_ASUNTO_CODIFICADO";
            
            /** ORIGINAL
            String parteFrom1 = " FROM R_RES left join e_exr on ( res_tip=exr_tip and res_eje=exr_ejr and res_uor=exr_uor and res_num=exr_nre and res_dep=exr_dep) ";            
            ***/
            
            // Se comenta el left join con r_tipoasunto puesto que para filtrar por asunto no es necesario
            //String parteFrom1 = " FROM R_RES LEFT JOIN R_TIPOASUNTO ON (R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND (R_TIPOASUNTO.UNIDADREGISTRO=-1 OR R_RES.RES_UOR=R_TIPOASUNTO.UNIDADREGISTRO) AND (R_TIPOASUNTO.TIPOREGISTRO='E' OR R_TIPOASUNTO.TIPOREGISTRO='A')) ";
            String parteFrom1 = " FROM ";
            
            if (tVO.getRegPendCatalogacion() != null && !"".equals(tVO.getRegPendCatalogacion()) && "0".equals(tVO.getRegPendCatalogacion())) {
                parteFrom1 = parteFrom1 + "R_RED D, ";
            }
            
            parteFrom1 = parteFrom1 + "R_RES "     
                                + "LEFT JOIN R_TTR ON (TTR_IDE=RES_TTR) "
                                + "LEFT JOIN R_TIPOASUNTO rta ON (r_res.ASUNTO = rta.CODIGO AND (r_res.RES_TIP = rta.TIPOREGISTRO OR rta.TIPOREGISTRO = 'A') AND r_res.RES_UOR = rta.UNIDADREGISTRO), T_HTE, A_UOR UOR,A_UOR UOD, " + GlobalNames.ESQUEMA_GENERICO +  "A_USU"; 
            String pWhere = " WHERE UOR.UOR_COD=RES_UOR AND UOD.UOR_COD=RES_UOD AND RES_TIP = 'E' AND RES_MOD != 1 AND RES_TER = HTE_TER AND RES_TNV = HTE_NVR AND " + GlobalNames.ESQUEMA_GENERICO + "A_USU.USU_COD=RES_USU  ";
            String p2Where = " AND (RES_EST = " + ConstantesDatos.REG_ANOTACION_ESTADO_PENDIENTE 
                    + " OR RES_EST = " + ConstantesDatos.REG_ANOTACION_ESTADO_ACEPTADA_EN_DESTINO + ") AND RES_UOD IN  (SELECT UOU_UOR FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU "
                    + " WHERE UOU_USU = " + uVO.getIdUsuario() + " AND UOU_ORG = " + uVO.getOrgCod() + " AND UOU_ENT = " + uVO.getEntCod() + ") ";
             if((ejercicio == null || "".equals(ejercicio))){
                 // && (numAnotacion == null || "".equals(numAnotacion))
                    m_Log.debug("El ejercicio  vacio");
                    if (!"".equals(fechaDesde) && !"".equals(fechaHasta)){
                        pWhere3 = "AND RES_FEC BETWEEN " + oad.convertir("'" + fechaDesde + " 00:00:00'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS") +
                                " AND " + oad.convertir("'" + fechaHasta + " 23:59:59'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS");
                    }
            }

            /**** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ****/
            if(codUorDestino!=null && !"".equals(codUorDestino)){
                pWhere3 += " AND RES_UOD=" + codUorDestino  ;
            }

            /*Criterio de busqueda ejercicio y num anotacion*/
            m_Log.debug("ejercicio" + ejercicio);
            if(ejercicio!=null && !"".equals(ejercicio)){
                pWhere3 += " AND RES_EJE=" + ejercicio ;
            }
            m_Log.debug("numAnotacion" + numAnotacion);
            if ((ejercicio!=null && !"".equals(ejercicio)) &&(numAnotacion!=null && !"".equals(numAnotacion))){
                pWhere3 +=  " AND RES_NUM=" + numAnotacion ;
            }


            if(codAsunto!=null && !"".equals(codAsunto)){                
                //pWhere3+= " AND R_RES.ASUNTO='" + codAsunto + "' AND R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + " ";
                pWhere3+= " AND R_RES.ASUNTO IN (SELECT R_TIPOASUNTO.CODIGO FROM R_TIPOASUNTO WHERE R_TIPOASUNTO.CODIGO='" + codAsunto + "' AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto +")";
            }
            
            if((documentoBusqueda!=null && !"".equals(documentoBusqueda)) || (nombreBusqueda!=null && !"".equals(nombreBusqueda)) || (apellido1Busqueda!=null && !"".equals(apellido1Busqueda))
                    || (apellido2Busqueda!=null && !"".equals(apellido2Busqueda))){

                pWhere3 += "AND EXISTS(SELECT EXT_TER FROM R_EXT,T_HTE B WHERE EXT_NUM=RES_NUM AND EXT_EJE=RES_EJE AND " +
                           "EXT_UOR=RES_UOR AND EXT_TIP=RES_TIP AND EXT_DEP=RES_DEP AND EXT_TER=B.HTE_TER " +
                           "AND EXT_NVR=B.HTE_NVR ";

                if(documentoBusqueda!=null && !"".equals(documentoBusqueda)){
                    pWhere3 += " AND B.HTE_DOC LIKE ('%" + documentoBusqueda.toUpperCase() + "%') ";
                }
                
                if(nombreBusqueda!=null && !"".equals(nombreBusqueda)){
                    pWhere3 += " AND B.HTE_NOM LIKE ('%" + nombreBusqueda.toUpperCase() + "%') ";
                }
                
                if(apellido1Busqueda!=null && !"".equals(apellido1Busqueda)){
                    pWhere3 += " AND B.HTE_AP1 LIKE ('%" + apellido1Busqueda.toUpperCase() + "%') ";
                }
                
                if(apellido2Busqueda!=null && !"".equals(apellido2Busqueda)){
                    pWhere3 += " AND B.HTE_AP2 LIKE ('%" + apellido2Busqueda.toUpperCase() + "%') ";
                }
                
                

                pWhere3 += ") ";
            }
            if(codUorAnotacion!=null && !"".equals(codUorAnotacion)){
                pWhere3 += " AND RES_UOR=" + codUorAnotacion  ;
            }

            /*****************/
            if(UsuariosGruposDAO.getInstance().tienePermisoDirectiva(ConstantesDatos.REGISTRO_S_SOLO_UORS_USUARIO,uVO.getIdUsuario(),con)){
                pWhere3 += " AND (UOD.UOR_TIP IS NULL OR UOD.UOR_TIP=0)";
            }
            /****************/
            
            String pWhere4;
            m_Log.debug("Resultado de tVO.getRegistroTelematico(): " + tVO.getRegistroTelematico());
            
            if(tVO.getRegistroTelematico().equals("0")){
               pWhere4 = " AND REGISTRO_TELEMATICO = 1";
            }else if (tVO.getRegistroTelematico().equals("1")){
                 pWhere4 = " AND REGISTRO_TELEMATICO = 0";
            }else {
                 pWhere4 = "";
            }
            m_Log.debug("Resultado pWhere4: "+pWhere4);
          

            
            // CRITERIO FIN DIGITALIZACION 
            String pWhere5 = " AND FIN_DIGITALIZACION = 1";
            
            if (tVO.getRegPendCatalogacion() != null && !"".equals(tVO.getRegPendCatalogacion()) && "0".equals(tVO.getRegPendCatalogacion())) {
                pWhere5 = pWhere5 + "AND RES_DEP = D.RED_DEP " +
                "AND RES_UOR = D.RED_UOR " +
                "AND RES_TIP = D.RED_TIP " +
                "AND RES_EJE = D.RED_EJE " +
                "AND RES_NUM = D.RED_NUM " +
                "AND D.RED_MIGRA = 0 " +
                "AND D.RED_TIPODOC_ID IS NULL ";
            }
            
            /**** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ****/  
            
            String sql = parte_select + parteFrom1 + pWhere + p2Where + pWhere3 + pWhere4 + pWhere5;

            sql += ")";

            if (("".equals(columna))|| (columna==null)||("0".equals(columna))){
            sql += " ORDER BY RES_FEC DESC, RES_NUM DESC";
            }else{
                sql += " ORDER BY "+columna+" "+tipoOrden;
            }
            

            if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getAsientosEntradaRegistro --> " + sql);
           
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            while (rs.next()) {
                
                if(!soloContar){
                    numPaginaE = (int) Math.ceil(posE/lineas)+1;
                    if (numPaginaE != pagActual) {
                        posE++;
                        continue;
                    }
                }
                
                TramitacionValueObject tvo1 = new TramitacionValueObject();
                String numeroAsiento = rs.getString("RES_NUM");
                String ejercicioAsiento = rs.getString("RES_EJE");
                String codDepartamento  = rs.getString("RES_DEP");
                String codUnidadRegistro = rs.getString("RES_UOR");
                String tipoRegistro = rs.getString("RES_TIP");
                
                tvo1.setCodDepartamento(codDepartamento);
                tvo1.setCodUnidadRegistro(codUnidadRegistro);
                tvo1.setTipoRegistro(tipoRegistro);
                tvo1.setEjerNum(ejercicioAsiento + "/" + numeroAsiento);
                m_Log.debug(tvo1.getEjerNum());
                tvo1.setFechaAnotacion(rs.getString("FECANOT"));
                tvo1.setFechaDocumento(rs.getString("FECDOC"));
                tvo1.setAsunto(AdaptadorSQLBD.js_escape(rs.getString("RES_ASU")));
                tvo1.setObservaciones(AdaptadorSQLBD.js_escape(rs.getString("RES_OBS")));
                
                //formato del interesado
                String apellido1 = rs.getString("APELLIDO1");
                String apellido2 = rs.getString("APELLIDO2");
                String numTerceros = rs.getString("num_terceros");
                String nombre=rs.getString("HTE_NOM");
                String nombreTerc=FormateadorTercero.getDescTercero(nombre, apellido1, apellido2, false);
                String tipoTransporte=rs.getString("TRANSPORTE");
                String nombreUOR=rs.getString("UOR_NOM");
               
                tvo1.setNumTerceros(numTerceros);
                tvo1.setRemitente(nombreTerc);
                tvo1.setDocTercero(rs.getString("HTE_DOC"));
                tvo1.setEstado("0");
                tvo1.setOrigen(nombreServicio);
                if(tipoTransporte!=null)
                tvo1.setTipoTransporte(tipoTransporte);
                else  tvo1.setTipoTransporte("");
                lista.addElement(tvo1);
                tvo1.setUnidadTramitadora(rs.getString("UNIDADDESTINO"));
                tvo1.setUnidadInicio(nombreUOR);
                /**
                    tvo1.setProcedimiento(rs.getString("PROCEDIMIENTO"));
                    tvo1.setNumExpediente(rs.getString("exr_num"));
                */
                if(!soloContar){
                    // Si sólo se ejecuta la consulta para con
                    ArrayList<String> listaExpedientes = this.getListaExpedientesRelacionadosAnotacion(numeroAsiento,ejercicioAsiento,codDepartamento, codUnidadRegistro, tipoRegistro, con);
                    tvo1.setProcedimiento(extraerCodigosProcedimientos(listaExpedientes));                
                    tvo1.setNumExpediente(tratarListaExpedientes(listaExpedientes));
                }
                
                tvo1.setUsuarioAlta(rs.getString("NOM"));
                                // Asunto codificado
                
                String codAsuntoCod = rs.getString("COD_ASUNTO_CODIFICADO");
                if(codAsuntoCod!=null){
                    tvo1.setCodigoAsuntoCodificado(codAsuntoCod);
                }else {
                    tvo1.setCodigoAsuntoCodificado("");
                }
                String descripAsunto=rs.getString("DES_ASUNTO_CODIFICADO");
                if(descripAsunto!=null){
                    tvo1.setDescripcionAsuntoCodificado(descripAsunto);
                }else{
                    tvo1.setDescripcionAsuntoCodificado("");
                }
                
                //tecnico de referencia
                tvo1.setTecnicoReferencia("");   

                posE++;
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error.TramitacionDAO.", e);

        } finally {
            cerrarConexiones(stmt, rs, oad, con, "Error.TramitacionDAO.getAsientosRegistroEntrada.DevolverConexion");
            m_Log.debug("getAsientosRegistroEntrada");

        }

        return lista;
    }
    
    public String extraerCodigosProcedimientos(ArrayList<String> listaExpedientes){
        String salida = "";
        for(int i=0;listaExpedientes!=null && i<listaExpedientes.size();i++){
            String num = listaExpedientes.get(i);
            String[] datos = num.split("/");
            if(datos!=null && datos.length==3){
               salida = salida + datos[1];
               if(listaExpedientes.size()-i>1)
                salida= salida + "</BR>";
            }
        }
        return salida;
    }
    
    
    public String tratarListaExpedientes(ArrayList<String> listaExpedientes){
        String salida = "";
        for(int i=0;listaExpedientes!=null && i<listaExpedientes.size();i++){
            salida = salida + listaExpedientes.get(i);
            if(listaExpedientes.size()-i>1)
                salida= salida + "</BR>";
        }
        return salida;
    }
    
    /**
     * Recupera la lista de expedientes relacionados con una anotación de registro
     * @param numAnotacion: Número de la anotación
     * @param ejercicio: Ejercicio de la anotación
     * @param codDepartamento: Código de departamento de la anotación
     * @param codUorRegistro: Código de uor de registro de la anotación
     * @param tipoRegistro: Tipo de registro de la anotación
     * @param con: Conexión a la BBDD
     * @return String con los números de expedientes concatenados por una coma
     * @throws SQLException 
     */
    public ArrayList<String> getListaExpedientesRelacionadosAnotacion(String numAnotacion,String ejercicio,String codDepartamento,String codUorRegistro,String tipoRegistro,Connection con) throws SQLException{
        if(m_Log.isDebugEnabled()) m_Log.debug("getListaExpedientesRelacionadosAnotacion() : BEGIN");
        ArrayList<String> salida = new ArrayList<String>();
        Statement st  = null;
        ResultSet rs  = null;
        try {
            String sql = "SELECT EXR_NUM FROM E_EXR WHERE EXR_EJR=" + ejercicio + " AND EXR_NRE=" + numAnotacion + " AND EXR_DEP=" + codDepartamento + 
                          " AND EXR_UOR=" + codUorRegistro + " AND EXR_TIP='" + tipoRegistro + "'";
            st = con.createStatement();
            rs = st.executeQuery(sql);
            
            while(rs.next()){
                salida.add(rs.getString("EXR_NUM"));                                 
            }
            
        }catch(SQLException e){
            m_Log.error("Error en getListaExpedientesRelacionadosAnotacion(): " + e.getMessage());
            throw e;
        }finally{
            try{
                if(st!=null) st.close();
                if(rs!=null) rs.close();
            }catch(SQLException e){
                m_Log.error("Error al cerrar recursos asociados a la conexión de BBDD: " + e.getMessage());         
            }
        }        
        m_Log.debug("getListaExpedientesRelacionadosAnotacion. END");
        return salida;
    }//getListaExpedientesRelacionadosAnotacion
    
	public String calculoAlarmaVencimiento(ArrayList coleccionAlarmas, Connection con, AdaptadorSQL oad){
        //Se recorre el arraylist. Si encontramos una fecha de vencim inferor a hoy entonces guardamos un no
        //caso contrario guartdamos un si
        String alarmaVencida = "no";
        int i= 0;
        Calendar today = Calendar.getInstance();
        while (i<coleccionAlarmas.size() && alarmaVencida.equals("no")){
            Date fechVencimiento = (Date)coleccionAlarmas.get(i);
            SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy");
            Calendar c = Calendar.getInstance();
            c.setTime(fechVencimiento);
            
            if (c.compareTo(today)<0){
                alarmaVencida = "si";
            }
            i++;
        }
        return alarmaVencida;
    }
    public String calculoCercaFinPlazo(int plazoCercaFin, Calendar fechaLimitePlazo, String tipoPlazo, int unidadesPlazo, Connection con, AdaptadorSQL oad) throws TechnicalException {
        String fuera = "";
        //calculo el dia de inicio de plazo
        int horas;
        int diaP = 0;

        SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy HH:mm:sss");

        m_Log.debug("******* calculoCercaFinPlazo p. plazoCercaFin: " + plazoCercaFin);
        m_Log.debug("******* calculoCercaFinPlazo p. fechaLimitePlazo: " + sf.format(fechaLimitePlazo.getTime()));
        m_Log.debug("******* calculoCercaFinPlazo p. tipoPlazo: " + tipoPlazo);
        m_Log.debug("******* calculoCercaFinPlazo p. unidadesPlazo: " + unidadesPlazo);
        

        Calendar fechaInicioPlazo = Calendar.getInstance();
        if (fechaLimitePlazo == null) return "no";
        else fechaInicioPlazo = getFechaInicioPlazo(fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);

        m_Log.debug(" ******** fecha de inicio de plazo calculada: " + sf.format(fechaInicioPlazo.getTime()));
        m_Log.debug(" ******** fecha límite de plazo: " + sf.format(fechaLimitePlazo.getTime()));

        long time = fechaLimitePlazo.getTime().getTime() - fechaInicioPlazo.getTime().getTime();
        m_Log.debug(" ******** diferencia entre fechaLimitePlazo y fechaInicio: " + time);
        
        //Muestro el resultado en días
        m_Log.debug(" ********   dias de diferencia : " + time / (3600 * 24 * 1000));
        int d = (int) (time / (3600 * 24 * 1000));
        m_Log.debug("- dia ENTRE INICIO Y FIN : " + d);
        //CALCULO DE CUANTAS HORAS DEBEN PASAR PARA QUE LA APLICACION EMPIECE A AVISAR:
        //la formula seria: (24 horas * dia de inicio de plazo )/ 100 *Porcentaje de aviso(plazoCercaFin)= 
        //numero de horas que tienen que pasar para avisar
        horas = ((24 * d * plazoCercaFin) / 100);
        m_Log.debug(" ********   horas : " + horas);
        //calculo diap=cuantos dias antes tiene que empezar avisar
        //diaP = horas / 24;
        diaP =(int)Math.ceil(((double)horas/(double)24));
        m_Log.debug(" ********   cuantos dias antes tiene que empezar avisar : " + diaP);
        //si diap es = tengo que avisar el mismo dia que finaliza
        //calculo la fecha para ello covierto a calendar el string
        //Obtengo la fecha actual.
        Calendar calendario = Calendar.getInstance();        
        
        // Obtengo la fecha para comenzar a avisar.
        Calendar cal = new GregorianCalendar();
        cal.setTimeInMillis(fechaLimitePlazo.getTime().getTime());
        cal.add(Calendar.DATE, -diaP);

        m_Log.debug("************ fecha actual: " + sf.format(calendario.getTime()));
        m_Log.debug("************ fecha a partir de la cual se avisa de cerca de fin de plazo: " + sf.format(cal.getTime()));
        
        // Obtengo la fecha de fin de plazo
        if (calendario.after(cal) && calendario.before(fechaLimitePlazo)) fuera = "no";
        else if(calendario.after(fechaLimitePlazo)) fuera = "si";

        //Retorno: null, no esta cerca del plazo
        // si: esta fuera del plazo
        // no: no se pasa del plazo, pero está cerca
        
//////        // VALORES DE RETORNO POSIBLES.
//////        // fuera = "si" --> hay que avisar que el trámite está cercano a la finalización del plazo.
//////        // fuera = "no" --> no hay que avisar que el trámite está cercano a la finalización del plazo.
        m_Log.debug(" ********   fuera : " + fuera);
        return fuera;
    }
    
    private Calendar getFechaInicioPlazo(Calendar fechaLimitePlazo, String tipoPlazo, int unidadesPlazo, Connection con, AdaptadorSQL oad) throws TechnicalException {
        
        try {
            Calendar fechaInicioPlazo = Calendar.getInstance();
            fechaInicioPlazo.setTimeInMillis(fechaLimitePlazo.getTimeInMillis());
            if (tipoPlazo.equals(TIPO_PLAZO_DIAS_NATURALES)) {
                fechaInicioPlazo.add(Calendar.DATE, -unidadesPlazo);
            } else if (tipoPlazo.equals(TIPO_PLAZO_MESES)) {
                fechaInicioPlazo.add(Calendar.MONTH, -unidadesPlazo);
            } else if (tipoPlazo.equals(TIPO_PLAZO_DIAS_HABILES)) {
                Vector diasFestivos = CalendarioGeneralDAO.getInstance().obtenerFestivosPorAno(
                        Integer.toString(fechaInicioPlazo.get(Calendar.YEAR)), con, oad);
                int contadorDias = unidadesPlazo;
                while (contadorDias >= 0) {
                    fechaInicioPlazo.add(Calendar.DATE, -1);
                    boolean incremento = true;
                    if (fechaInicioPlazo.get(Calendar.DAY_OF_WEEK) == Calendar.SUNDAY) {
                        incremento = false;
                    } else {
                        for (Object objDiaFestivo: diasFestivos) {
                            String diaFestivo = (String)objDiaFestivo;
                            java.util.Date dateFestivo = Fecha.obtenerDate(diaFestivo);
                            if (dateFestivo.equals(fechaInicioPlazo.getTime())) {
                                incremento = false;
                            }    
                        }                                            
                    }
                    if (incremento) contadorDias--;
                }
            }
            return fechaInicioPlazo;        
        } catch (GestionException ge) {
            throw new TechnicalException(ge.getMessage(), ge);
        }
    }
    
    
    private void cerrarConexiones(Statement stmt, ResultSet rs, AdaptadorSQLBD abd, Connection con, String errorKey) throws TechnicalException {
        try {
            if (stmt != null) stmt.close();
            if (rs != null) rs.close();
            abd.devolverConexion(con);
        } catch (Exception bde) {
            bde.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
            throw new TechnicalException(errorKey, bde);
        }
    }

    public Vector getAsientosExpedientesHistorico(UsuarioValueObject uVO, TramitacionValueObject tVO,
            String nombreServicio, String[] params, String fechaDesde, String fechaHasta, String documentoBusqueda,
            String nombreBusqueda,String apellido1Busqueda,String apellido2Busqueda,String codAsunto,String unidadRegistroAsunto,
            String tipoRegistroAsunto,String codUorDestino,String ejercicio,String numAnotacion,String codUorAnotacion)
    throws TramitacionException, TechnicalException {
        if(m_Log.isDebugEnabled()) m_Log.debug("getAsientosExpedientesHistorico() : BEGIN");
        String filtro ="";
        Vector<TramitacionValueObject> lista = new Vector<TramitacionValueObject>();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String pWhere3 = "";
        
        if(m_Log.isDebugEnabled()) m_Log.debug("Uor de la anotacion" + codUorAnotacion);
        boolean soloContar = tVO.isSoloContarExpedientesBuzonEntrada();
        int posE = 0;
        int numPaginaE = 0;
        int pagActual = -1;
        
        if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado()!=null) {
            pagActual = Integer.parseInt(tVO.getPaginaListado());
        }//if
        
        int lineas = -1;
        if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado()!=null) {
            lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());    
        }//if
       
        try{
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();
            String from = sql_res_codDpto+ ","+sql_res_codUnid+ "," +sql_res_tipoReg+ ","+sql_res_ejer+ ","+sql_res_num+ "," + sql_res_obs;
            from += ","+oad.convertir(sql_res_fecAnot,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY")+" AS fAnotacion ";
            from += ","+sql_res_asunt + ",R_RES.PROCEDIMIENTO, " + sql_res_estado ;
            from += ","+ sql_hte_nan +","+ oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT,
                    new String[]{sql_hte_p1a, "' '", sql_hte_a1a}) + " AS APELLIDO1 ,"
                    + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{sql_hte_p2a, "' '", sql_hte_a2a}) +
                    " AS APELLIDO2 ";
            from += ", (SELECT COUNT (*) FROM  R_EXT WHERE res_uor=ext_uor AND res_dep=ext_dep AND res_tip=ext_tip AND res_eje=ext_eje AND res_num=ext_num )AS num_terceros ";
            
            if(m_Log.isDebugEnabled()) m_Log.debug("from: " + from);
            
            ArrayList<String> join1 = new ArrayList<String>();
            //join1.add("R_TIPOASUNTO");
            /** ORIGINAL
            join1.add("E_EXR");
            **/
            //join1.add("LEFT");
            //join1.add("R_TIPOASUNTO");
            /** ORIGINAL
            join1.add("RIGHT");
            **/
            join1.add("R_RES");
            /** ORIGINAL
            join1.add(sql_exr_dep + "=" + sql_res_codDpto +
                    " AND " + sql_exr_uor + "=" + sql_res_codUnid +
                    " AND " + sql_exr_tip + "=" + sql_res_tipoReg +
                    " AND " + sql_exr_ejr + "=" + sql_res_ejer +
                    " AND " + sql_exr_nre + "=" + sql_res_num); **/
            join1.add("INNER");
            join1.add("T_HTE");
            join1.add(sql_res_codTerc+ "=" + sql_hte_ter + " AND " + sql_res_modTerc+ "=" + sql_hte_nvr);
            join1.add("INNER");
            join1.add("T_DNN");
            join1.add(sql_res_domTerc+ "=" + sql_dnn_dom);
            join1.add("INNER");
            join1.add(GlobalNames.ESQUEMA_GENERICO + "T_MUN T_MUN");
            join1.add(sql_dnn_pai +"="+ sql_mun_pai + " AND " + sql_dnn_prv +"="+ sql_mun_prv + " AND " + sql_dnn_mun +"="+ sql_mun_cod);
            //join1.add("R_TIPOASUNTO");
            join1.add("false");

            if((ejercicio == null || "".equals(ejercicio))){
                // && (numAnotacion == null || "".equals(numAnotacion))
                if(m_Log.isDebugEnabled()) m_Log.debug("El ejercicio  vacio");
                if (!"".equals(fechaDesde) && !"".equals(fechaHasta)){
                    pWhere3 = " AND RES_FEC BETWEEN " + oad.convertir("'" + fechaDesde + " 00:00:00'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS") +
                        " AND " + oad.convertir("'" + fechaHasta + " 23:59:59'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS");
                }//if
            }//if
            
            /*Criterio de busqueda registro telem?tico*/	

            m_Log.debug("Resultado de tVO.getRegistroTelematico(): " + tVO.getRegistroTelematico());
            
            if(tVO.getRegistroTelematico().equals("0")){
               pWhere3 += " AND REGISTRO_TELEMATICO = 1";
            }else if (tVO.getRegistroTelematico().equals("1")){
                 pWhere3 += " AND REGISTRO_TELEMATICO = 0";
            }
            
            /*Criterio de busqueda ejercicio y num anotacion*/
            if(m_Log.isDebugEnabled()) m_Log.debug("ejercicio" + ejercicio);
            if(ejercicio!=null && !"".equals(ejercicio)){
                pWhere3 += " AND RES_EJE=" + ejercicio ;
            }//if
            
            if(m_Log.isDebugEnabled()) m_Log.debug("numAnotacion" + numAnotacion);
            if ((ejercicio!=null && !"".equals(ejercicio)) &&(numAnotacion!=null && !"".equals(numAnotacion))){
                pWhere3 +=  " AND RES_NUM=" + numAnotacion ;
            }//if
            
            /**** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ****/
            if(m_Log.isDebugEnabled()) m_Log.debug("unidad destiono" + codUorDestino);
            if(codUorDestino!=null && !"".equals(codUorDestino)){
                pWhere3 += " AND RES_UOD=" + codUorDestino  ;
            }//if
            
            if(m_Log.isDebugEnabled()) m_Log.debug("codAsunto" + codAsunto);
            if(codAsunto!=null && !"".equals(codAsunto)){
                //pWhere3+= " AND ASUNTO='" + codAsunto + "' ";
               pWhere3+= " AND EXISTS (SELECT R_RES.ASUNTO FROM R_RES B, R_TIPOASUNTO WHERE (R_RES.ASUNTO=R_TIPOASUNTO.CODIGO"
                       + " AND (R_TIPOASUNTO.UNIDADREGISTRO=-1 OR R_RES.RES_UOR=R_TIPOASUNTO.UNIDADREGISTRO) "
                       + " AND (R_TIPOASUNTO.TIPOREGISTRO='E' OR R_TIPOASUNTO.TIPOREGISTRO='A')  ";
                pWhere3+= " AND R_RES.ASUNTO='" + codAsunto + "' AND R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + ") AND R_RES.RES_NUM=B.RES_NUM AND R_RES.RES_EJE=B.RES_EJE AND R_RES.RES_UOR=B.RES_UOR AND R_RES.RES_TIP=B.RES_TIP AND R_RES.RES_DEP=B.RES_DEP)";
            }//if
            
            if((documentoBusqueda!=null && !"".equals(documentoBusqueda)) || (nombreBusqueda!=null && !"".equals(nombreBusqueda)) || (apellido1Busqueda!=null && !"".equals(apellido1Busqueda))
                    || (apellido2Busqueda!=null && !"".equals(apellido2Busqueda))){

                pWhere3 += "AND EXISTS(SELECT EXT_TER FROM R_EXT,T_HTE B WHERE EXT_NUM=RES_NUM AND EXT_EJE=RES_EJE AND " +
                           "EXT_UOR=RES_UOR AND EXT_TIP=RES_TIP AND EXT_DEP=RES_DEP AND EXT_TER=B.HTE_TER " +
                           "AND EXT_NVR=B.HTE_NVR ";

                if(documentoBusqueda!=null && !"".equals(documentoBusqueda)){
                    pWhere3 += " AND B.HTE_DOC LIKE ('%" + documentoBusqueda.toUpperCase() + "%') ";
                }//if

                if(nombreBusqueda!=null && !"".equals(nombreBusqueda)){
                    pWhere3 += " AND B.HTE_NOM LIKE ('%" + nombreBusqueda.toUpperCase() + "%') ";
                }//if

                if(apellido1Busqueda!=null && !"".equals(apellido1Busqueda)){
                    pWhere3 += " AND B.HTE_AP1 LIKE ('%" + apellido1Busqueda.toUpperCase() + "%') ";
                }//if

                if(apellido2Busqueda!=null && !"".equals(apellido2Busqueda)){
                    pWhere3 += " AND B.HTE_AP2 LIKE ('%" + apellido2Busqueda.toUpperCase() + "%') ";
                }//if
                
                pWhere3 += ") ";
            }//if
            
            if(codUorAnotacion!=null && !"".equals(codUorAnotacion)){
                pWhere3 += " AND RES_UOR=" + codUorAnotacion  ;
            }//if

            ArrayList<String> join2 = new ArrayList<String>();
            //join2.add("R_TIPOASUNTO");
            /*** ORIGINAL
            join2.add("E_EXR");
            ***/
            //join2.add("LEFT");
            //join2.add("R_TIPOASUNTO");
            /** ORIGINAL
            join2.add("RIGHT"); **/
            join2.add("R_RES");
            /** ORIGINAL
            join2.add(sql_exr_dep + "=" + sql_res_codDpto +
                    " AND " + sql_exr_uor + "=" + sql_res_codUnid +
                    " AND " + sql_exr_tip + "=" + sql_res_tipoReg +
                    " AND " + sql_exr_ejr + "=" + sql_res_ejer +
                    " AND " + sql_exr_nre + "=" + sql_res_num); **/
            join2.add("INNER");
            join2.add("T_HTE");
            join2.add(sql_res_codTerc+ "=" + sql_hte_ter + " AND " + sql_res_modTerc+ "=" + sql_hte_nvr);
            join2.add("INNER");
            join2.add("T_DPO");
            join2.add(sql_res_domTerc+ "=" + sql_dpo_dom);
            join2.add("INNER");
            join2.add("T_DSU");
            join2.add(sql_dpo_dirSuelo+ "=" + sql_dsu_codDirSuelo);
            join2.add("INNER");
            join2.add(GlobalNames.ESQUEMA_GENERICO + "T_MUN T_MUN");
            join2.add(sql_dsu_pais +"="+ sql_mun_pai + " AND " + sql_dsu_prov +"="+ sql_mun_prv + " AND " + sql_dsu_mun +"="+ sql_mun_cod);
            //join2.add("R_TIPOASUNTO");
            join2.add("false");

            String pWhere = sql_res_tipoDestino + " != 1 AND " + sql_res_estado + "!=0 AND " +
                    //sql_res_estado + "!=9 AND " + sql_res_tipoReg + "='E'"
                    sql_res_estado + "!=9 AND " + sql_res_estado + "!=3 AND " + sql_res_tipoReg + "='E'"
                     + " AND EXISTS (SELECT DISTINCT " +  sql_uou_uor + " FROM "+
                    GlobalNames.ESQUEMA_GENERICO+"A_UOU WHERE " +
                    sql_uou_usu + "="+ uVO.getIdUsuario() + " AND " + sql_uou_org + "=" +
                    uVO.getOrgCod() + " AND " + sql_uou_ent+ "=" + uVO.getEntCod() + " AND " +
                    sql_uou_uor + "=" + sql_res_ord_unid + ")"; // Datos listado.

            String sql ="";
            if (pWhere3!=null && !"".equals(pWhere3)){
                if(m_Log.isDebugEnabled()) m_Log.debug("Filtro:" + pWhere3);
                sql = oad.join(from, pWhere, join1.toArray(new String[]{})) + pWhere3 +
                    " UNION " + oad.join(from, pWhere, join2.toArray(new String[]{})) + pWhere3 + " ORDER BY fAnotacion DESC";
            }else{
               sql = oad.join(from, pWhere, join1.toArray(new String[]{})) +
                    " UNION " + oad.join(from, pWhere, join2.toArray(new String[]{})) + " ORDER BY fAnotacion DESC";
            }//if

            SimpleDateFormat s = new SimpleDateFormat("dd/MM/yyyy");

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getAsientosExpedientesHistorico --> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            while(rs.next()){
                 if(!soloContar){
                    numPaginaE = (int) Math.ceil(posE/lineas)+1;
                    if (numPaginaE != pagActual) {
                        posE++;
                        continue;
                    }//if
                }//if
                 
                TramitacionValueObject tvo1 = new TramitacionValueObject();
                String codDepartamento=rs.getString(sql_res_codDpto);
                tvo1.setCodDepartamento(codDepartamento);
                String codUnidadRegistro=rs.getString(sql_res_codUnid);
                tvo1.setCodUnidadRegistro(codUnidadRegistro);
                String tipoRegistro=rs.getString(sql_res_tipoReg);
                tvo1.setTipoRegistro(tipoRegistro);
                String ejercicioRegistro=rs.getString(sql_res_ejer);
                String numeroRegistro=rs.getString(sql_res_num);
                tvo1.setEjerNum(ejercicioRegistro+"/"+numeroRegistro);
                tvo1.setFechaAnotacion(rs.getString("fAnotacion"));
                tvo1.setAsunto(AdaptadorSQLBD.js_escape(rs.getString(sql_res_asunt)));
                tvo1.setObservaciones(rs.getString(sql_res_obs));
                tvo1.setNumTerceros(rs.getString("num_terceros"));
                String apellido1 = rs.getString("APELLIDO1");
                String apellido2 = rs.getString("APELLIDO2");
                String nombre=rs.getString("HTE_NOM");
                String nombreTerc=FormateadorTercero.getDescTercero(nombre, apellido1, apellido2, false);
                tvo1.setRemitente(nombreTerc);
                //SI EL ESTADO ES ACEPTADO Y TIENE EXPEDIENTE ASOCIADO CAMBIO EL ESTADO A eXPEDIENTE ASOCIADO
                //String num_expediente = rs.getString("EXR_NUM");
                String estado = rs.getString(sql_res_estado);
                /** original
                if (num_expediente != null && !"".equals(num_expediente) && "1".equals(estado)) {
                **/
                //Para obtener el numero de expedientes relacionados de cada anotación, vamos a realizar una consulta aparte solo para
                //las anotaciones que se van a mostrar. Para el resto vamos a ponerle el valor 0, ya que no hay ordenación en esta tabla
                int menorLineaPagina=0;
                int mayorLineaPagina=lineas-1;
                int numeroExpedientesRelacionados=0;
                
                menorLineaPagina=(pagActual-1)*lineas;
                mayorLineaPagina=(pagActual*lineas)-1;
                
                if((posE<=mayorLineaPagina)&&(posE>=menorLineaPagina)){
                    //Consulta de numero de expedientes
                    numeroExpedientesRelacionados= getNumeroExpedientesAsociadosARegistroHistorico(con,Integer.parseInt(codDepartamento),Integer.parseInt(codUnidadRegistro),tipoRegistro,Integer.parseInt(ejercicioRegistro),Integer.parseInt(numeroRegistro));   
                }else numeroExpedientesRelacionados=0;  //Valor por defecto para las anotaciones que no se muestran
                
                if(numeroExpedientesRelacionados>=1 && "1".equals(estado)){
                      tvo1.setEstado("3");                      
                }else{
                    tvo1.setEstado(estado);
                }//if
                tvo1.setOrigen(nombreServicio);
                lista.addElement(tvo1);
                posE++;
            }//while
        } catch (Exception e) {
            lista = new Vector<TramitacionValueObject>();
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getAsientosExpedientesHistorico", e);
        } finally {
            cerrarResultSet(rs);
            cerrarStatement(stmt);
            devolverConexion(oad, con);
            if(m_Log.isDebugEnabled()) m_Log.debug("getAsientosExpedientesHistorico");
        }//try-catch-finally
        if(m_Log.isDebugEnabled()) m_Log.debug("getAsientosExpedientesHistorico() : END");
        return lista;
    }//getAsientosExpedientesHistorico
    
    public int getNumeroExpedientesAsociadosARegistroHistorico (Connection con,int departamento,int codUor,String tipo,int ejercicio,int numero)
    {
       
        Statement st = null;
        ResultSet rs = null;
        PreparedStatement ps = null;
        int resultado=0;

        try{
            String sql = "SELECT COUNT (EXR_NUM) FROM E_EXR " +
                         "WHERE EXR_DEP=? AND EXR_UOR=? AND EXR_TIP=? AND EXR_EJR=? AND EXR_NRE=?";
            m_Log.debug("obtener numero de expedientes asociados: "+ sql);
            
            ps = con.prepareStatement(sql);
            
            ps.setInt(1,departamento);
            ps.setInt(2,codUor);
            ps.setString(3,tipo);
            ps.setInt(4,ejercicio);
            ps.setInt(5,numero);
            
             m_Log.debug("parámetros: "+departamento+","+codUor+","+tipo+","+ejercicio+","+numero);
            
            
            rs = ps.executeQuery();
            
       
            
            while(rs.next()){
               resultado=rs.getInt(1);
            }// while
            
          

        }catch(SQLException e){
            e.printStackTrace();
        }finally{
            try{
                if(st!=null) st.close();
                if(rs!=null) rs.close();
            }catch(SQLException e){
               m_Log.error("Error en la claúsula finally al cerrar los recursos asociados a la conexión de BD: " + e.getMessage());
            }
        }
        return resultado;
    }
    
    public Vector getListaUnidadesTramitadorasUsuario(UsuarioValueObject uVO, String[] params)
            throws TramitacionException, TechnicalException {
        return getListaUnidadesTramitadorasUsuario(uVO, params, null);
    }


    public Vector getListaUnidadesTramitadorasUsuario(UsuarioValueObject uVO, String[] params, Connection auxCon)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaUnidadesTramitadoras");

        Vector lista = new Vector();
        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            if(auxCon == null){
                oad = new AdaptadorSQLBD(uVO.getParamsCon());
                con = oad.getConnection();
            } else {
                con = auxCon;
            }

            String parte_select = "SELECT "+ sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                              +" WHERE " + sql_uou_usu + "="+ uVO.getIdUsuario()
                                + " AND " + sql_uou_org + "=" + uVO.getOrgCod()
                                + " AND " + sql_uou_ent+ "=" + uVO.getEntCod();

            stmt = con.prepareStatement(parte_select);
            rs = stmt.executeQuery();
            while(rs.next()){
                String codUOT = (String) rs.getString(sql_uou_uor);
                lista.addElement(codUOT);
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaUnidadesTramitadoras", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                if(auxCon == null) {
                    oad.devolverConexion(con);
                }
            }catch(Exception bde) { 
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaUnidadesTramitadoras.Devolver conexion", bde);
            }
            m_Log.debug("getListaUnidadesTramitadoras");
            return lista;
        }
    }
  

 

    public Vector getExpedientesPendientes(UsuarioValueObject uVO, TramitacionValueObject tVO,String[] params,String columna, String nombreColumna,String tipoOrden)
            throws TramitacionException, TechnicalException {
      
        Vector lista = new Vector();
        Vector listaFinal = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt;
        ResultSet rs = null;
        String sql;

        String codigoColOrdInteresado=COLUMNA_ORDEN_INTERESADO; //Columna de ordenación por tercero
        Vector<CampoSuplementarioVO> camposSuplementarios = null;
        
        String parteSelectCampoSuplementario         = null;
        String parteFromColumnaCampoSuplementario    = null;
        String parteGroupByColumnaCampoSuplementario = null;
        String parteOrderByColumnaCampoSuplementario = null;
        String parteOrderByColumnaCampoSuplementario2 = null;
        boolean ordenCampoSuplementario = false;
        /*************************************************/
        ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();
        boolean eTXTEnFrom = false; // indica si se la tabla E_TXT ya se encuentra en la claúsula FROM
        boolean eTFEEnFrom = false; // indica si se la tabla E_TFE ya se encuentra en la claúsula FROM
        boolean eTFECEnFrom = false; // indica si se la tabla E_TFEC ya se encuentra en la claúsula FROM
        boolean eTNUEnFrom = false; // indica si se la tabla E_TNU ya se encuentra en la claúsula FROM
        boolean eTNUCEnFrom = false; // indica si se la tabla E_TNUC ya se encuentra en la claúsula FROM
        boolean eTDEEnFrom = false; // indica si se la tabla E_TDE ya se encuentra en la claúsula FROM
        String parteWhereByColumnaCampoSuplementario = null;
        TransformacionAtributoSelect transformador = null;
        
        String nsl_comp_anterior="";
        String nsl_sort_anterior="";
        String valor_nsl_comp_anterior="";
        String valor_nsl_sort_anterior="";
        /*************************************************/

        try{
            m_Log.debug("********** TramitacionDAO.getExpedientesPendientes");

            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            transformador = new TransformacionAtributoSelect(oad);
            con = oad.getConnection();

             /**  EN EL CASO DE REALIZAR UN FILTRADO POR PROCEDIMIENTO, SE COMPRUEBA SI  EL PROCEDIMIENTO TIENE DEFINIDO SU PROPIA
                    VISTA DE EXPEDIENTES PENDIENTES **/
            if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento())){
                if(CamposListadoPendientesProcedimientoDAO.getInstance().tieneProcedimientoVistaExpedientesPendientes(tVO.getCodProcedimiento(),uVO.getOrgCod(),con)){
                    m_Log.debug("Filtro procedimiento " + tVO.getCodProcedimiento() + " tiene vista de pendientes propia" );
                    camposSuplementarios = CamposListadoPendientesProcedimientoDAO.getInstance().getCamposSuplementariosListado(tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                }

                /*************************************************/

                /** SE COMPRUEBA SI LA COLUMNA POR LA QUE SE ORDENA NO ES NUMÉRICA, EN ESTE CASO ES QUE SE PRETENDE ORDENAR POR UN CAMPO SUPLEMENTARIO DE LA VISTA DE EXPEDIENTES
                       PENDIENTES DEL PROCEDIMIENTO **/
                if(columna!=null && !"".equals(columna) && !NumericOperations.isInteger(columna)){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    int tipoDato = CamposListadoPendientesProcedimientoDAO.getInstance().getTipoCampoSuplementario(columna,tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                    m_Log.debug("La tabla en la que se aloja el valor del campo suplementario es " + tipoDato);
                    switch (tipoDato){
                        case 1: //  Campo de tipo numérico
                            parteSelectCampoSuplementario         = "E_TNU.TNU_VALOR" ;
                            //parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + columna + "') ";

                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND TNU_COD='" + columna + "') ";
                                        
                            parteGroupByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TNU_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TNU_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TNU.TNU_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTNUEnFrom                            = true;
                            break;
                        case 2: //  Campo de tipo texto corto
                            parteSelectCampoSuplementario         = "E_TXT.TXT_VALOR ";
                            //parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + columna + "') ";
                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + columna + "') ";
                            parteGroupByColumnaCampoSuplementario = "E_TXT.TXT_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TXT_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TXT_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TXT.TXT_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTXTEnFrom                            = true;
                            break;
                        case 3: //  Campo de tipo fecha
                            parteSelectCampoSuplementario         = "E_TFE.TFE_VALOR ";
                            //parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + columna + "') ";
                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND TFE_COD='" + columna + "') ";

                            parteGroupByColumnaCampoSuplementario = "E_TFE.TFE_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TFE_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TFE_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TFE.TFE_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTFEEnFrom                            = true;
                            break;
                        case 6: //  Campo de tipo desplegable
                            parteSelectCampoSuplementario         = "E_TDE.TDE_VALOR ";
                            //parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + columna + "') ";
                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + columna + "') ";
                            parteGroupByColumnaCampoSuplementario = "E_TDE.TDE_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TDE_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TDE_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TDE.TDE_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTDEEnFrom                            = true;
                            break;
                        case 8: //  Campo de tipo numérico calculado
                            parteSelectCampoSuplementario         = "E_TNUC.TNUC_VALOR" ;                            

                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND TNUC_COD='" + columna + "') ";
                                        
                            parteGroupByColumnaCampoSuplementario = "E_TNUC.TNUC_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TNUC_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TNUC_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TNUC.TNUC_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTNUCEnFrom                            = true;
                            break;                        
                        case 9: //  Campo de tipo fecha calculada
                            parteSelectCampoSuplementario         = "E_TFEC.TFEC_VALOR ";                            
                            if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                            else
                                parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND TFEC_COD='" + columna + "') ";

                            parteGroupByColumnaCampoSuplementario = "E_TFEC.TFEC_VALOR ";
                            parteOrderByColumnaCampoSuplementario = "CONSULTA.TFEC_VALOR ";
                            parteOrderByColumnaCampoSuplementario2 = "TFEC_VALOR ";
                            parteWhereByColumnaCampoSuplementario = " AND E_TFEC.TFEC_COD='" + columna + "' ";
                            ordenCampoSuplementario               = true;
                            eTFECEnFrom                            = true;
                            break;
                            
                    }// switch
                }// if

                /*************************************************/
            }// if


            //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
            String parteWhereBusquedaCampoSuplementario = "";
            String parteFromBusquedaCampoSuplementarioNumerico    = "";
            String parteFromBusquedaCampoSuplementarioNumericoCalculado    = "";
            String parteFromBusquedaCampoSuplementarioFecha       = "";
            String parteFromBusquedaCampoSuplementarioFechaCalculada       = "";
            String parteFromBusquedaCampoSuplementarioDesplegable = "";
            String parteFromBusquedaCampoSuplementarioTexto       = "";
            boolean busquedaCampoSuplementario = false;
            
               /** SE COMPRUEBA SI SE HA ESTABLECIDO UN CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO, YA QUE EN ESTE CASO HABRÁ QUE
                     AÑADIR LA PARTE FROM Y LA PARTE WHERE  **/
                if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda()){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                    if(criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda()))
                    {
                        int tipoDato = Integer.parseInt(criterio.getTipoCampoSuplementarioCriterioBusqueda());
                        m_Log.debug("El tipo del dato del campo suplementario por el que se hace la búsqueda es " + tipoDato);
                        switch (tipoDato){
                            case 1: //  Campo de tipo numérico
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioNumerico = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND TNU_VALOR<=" + valores.get(1) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR!=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                            case 2: //  Campo de tipo texto corto
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioTexto = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                               
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR!='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==7){ // Operador LIKE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR LIKE('%" +  valores.get(0) + "%') AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                               
                                busquedaCampoSuplementario = true;
                                break;
                            case 3: //  Campo de tipo fecha
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioFecha    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                              
                               if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    /*
                                    parteWhereBusquedaCampoSuplementario = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0));
                                    */
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            //+" AND E_TFE.TFE_VALOR>?) ";
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                
                                busquedaCampoSuplementario             = true;
                                break;
                            case 6: //  Campo de tipo desplegable
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioDesplegable  = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR='" + valores.get(0) + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador !=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR!='" + valores.get(0) + "') ";
                                }
                               
                                busquedaCampoSuplementario = true;
                                break;
                            case 8: //  Campo de tipo numérico calculado
                                parteFromBusquedaCampoSuplementarioNumericoCalculado = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND TNUC_VALOR<=" + valores.get(1) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR!=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;                            
                            case 9: //  Campo de tipo fecha                                
                                parteFromBusquedaCampoSuplementarioFechaCalculada    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";                                

                               if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                
                                busquedaCampoSuplementario = true;
                                break;
                        }// switch
                    }// if
                }// if
            
            //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>



            String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                "E_EXP."+ sql_exp_codMun+ ", " +
                sql_pml_valorCampo + ", " +
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +
                oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fIni, " +
                "E_EXP."+sql_exp_codProc+ ", " +
                "E_EXP."+sql_exp_fechIni + ", " +
                "E_EXP."+sql_exp_asunto + ", " +
                "G_REL."+sql_rel_num + ", " +                
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {oad.convertir(sql_cro_fli,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {sql_uou_uor}) + " AS ExisUOR, " +                
                oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM,"+
                 "  E_EXP.EXP_FEI AS fIniOrden, " +
                //oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"YYYY/MM/DD") + " AS fFinOrden" + ",E_EXR."+sql_exr_top ;
                "   E_EXP.EXP_FEF AS fFinOrden";
             if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
                {
                parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";
                }
            
            // obtenemos campo que nos muestra si un expediente esta destacado
            parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
            }
            /*************************************************/
            
            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) " +  // NUEVO
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +
                    "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                    "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                    /**
                    "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                    "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";            
                    **/
             /*****************************************************************/
             if(codigoColOrdInteresado.equals(columna) || (criterio!=null && ("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda()))))//Ordenacion por interesado
             { //Ordenacion por interesado o criterio de búsqueda por interesado o por tipo de documento
                parteFrom2=parteFrom2+" "+
                        "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+" ) "+
                        "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";
             }
            /*****************************************************************/

            if(ordenCampoSuplementario){
                // SE AÑADE A LA PARTE "FROM" DE LA CONSULTA LA PARTE CORRESPONDIENTE AL JOIN CON LA TABLA QUE CONTIENE EL VALOR DEL CAMPO SUPLEMENTARIO
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }

            if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCalculado;
                }else               
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCalculada;
                }
            }

            String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' "
                    + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' "
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) "
                        + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD="
                        + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + " AND ENT_COD=" +uVO.getEntCod() + ")))";
            
            if ("1".equals(tVO.getCodRangoTemporal()) || "2".equals(tVO.getCodRangoTemporal())){
                pWhere2 = pWhere2 + " AND E_EXP.EXP_FEI >= ? ";
            }

            // Si se filtra por el código de procedimiento
            if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento())){
                m_Log.debug("Filtrando expedientes pendientes por código de procedimiento");
                pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + tVO.getCodProcedimiento() + "' OR G_EXP.EXP_PRO='" + tVO.getCodProcedimiento() + "') ";
            }

            if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
            {
                       pWhere2=pWhere2 + " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";
            }


            /********* nuevo para busqueda ********/
            //if(ordenCampoSuplementario)
            if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;

            /********** nuevo para busqueda *******/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1));
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){                  
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";
               }//if
               pWhere2 = pWhere2 + auxiliar;
            }//if
            
            if (tVO.getUsuarioTramitador()!=null && tVO.getUsuarioTramitador()!="" && es.altia.agora.business.geninformes.utils.Utilidades.isInteger(tVO.getUsuarioTramitador())) {
               pWhere2 += " AND (E_EXP.EXP_USU =  " + tVO.getUsuarioTramitador() +" OR E_CRO.CRO_USU =  " + tVO.getUsuarioTramitador() +
                        " OR E_CRO.CRO_USF =  " + tVO.getUsuarioTramitador() +") ";
               }//if


            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            /******************************************* BÚSQUEDA **********************************************/


            String groupSelect = "GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + ", " +
                    sql_pml_valorCampo + ", " +
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP."+sql_exp_asunto + ", " +
                    "G_REL."+sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    "E_EXP."+sql_exp_loc ;
                    //"E_EXP."+sql_exp_loc + ", " + "E_EXR."+sql_exr_top+ " " ;
            if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
             {
                 groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});
             }

             groupSelect=groupSelect+",EXP_IMP, E_EXP.EXP_FPA ";

            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/



            String sql2 = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            String pOrder = "";
            String pOrder2 = "";
            // Se supone que en este caso que el expediente no esta cerrado
            if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
            {
                 pOrder= "ORDER BY NOMBRE"+ " "+tipoOrden;
                 pOrder2=pOrder;
            }
             else{
                 if(("".equals(columna)) || (columna==null)|| ("0".equals(columna))){
                      pOrder = " ORDER BY "+ sql_exp_fechIni + " DESC ";
                      pOrder2=pOrder;
                }
                else{
                    // original
                    //pOrder = " ORDER BY "+ columna + " "+tipoOrden;

                    /*************************************************/
                    if(ordenCampoSuplementario){
                        // Se añade a la parte ORDER BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                        pOrder = " ORDER BY " + parteOrderByColumnaCampoSuplementario + " " + tipoOrden;
                        pOrder2 = " ORDER BY " + parteOrderByColumnaCampoSuplementario2 + " " + tipoOrden;
                    }else{
                       pOrder = " ORDER BY "+ columna + " "+tipoOrden;
                       pOrder2 = " ORDER BY "+ columna + " "+tipoOrden;
                    }
                    /*************************************************/

                }
             }

             if (params[0] != null && (params[0].equals("oracle") || params[0].equals("ORACLE"))) {
               sql =  sql2 + pOrder;  
             }else
                 sql =  sql2 + pOrder2;
            
            
            String consultaFinal="";
            boolean paginar=false;
            
            
            int posE = 0;
            int numPaginaE = 0;
            int pagActual = -1;
            if (!"".equals(tVO.getPaginaListado())&&tVO.getPaginaListado()!=null) {
                pagActual = Integer.parseInt(tVO.getPaginaListado());
            }
            int lineas = -1;
            if (!"".equals(tVO.getNumLineasPaginaListado())&&tVO.getNumLineasPaginaListado()!=null) {
                lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());    
            }
            
            
            //La funcion row_number solo podemos usarla con el over cuando conocemos el nombre de la oclumna a ordenar. Con el numero falla. Se ordena solo cuando conocemos el nombre
            //Cuando ordenamos por interesado o cuando no ordenamos por nada (por defecto exp_fei desc)
            if (params[0] != null && (params[0].equals("oracle") || params[0].equals("ORACLE"))) {
                if (codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
                {
                    pOrder = "ORDER BY NOMBRE" + " " + tipoOrden;
                    paginar = true;
                    consultaFinal = "select /*+first_rows(" + lineas + ")*/  * from (SELECT consulta.*, ROW_NUMBER() over ( " + pOrder + ") RN  FROM(" + sql2 + ") CONSULTA )  resultado where rn between ? AND ? order by rn";
                } else {
                    if (("".equals(columna)) || (columna == null) || ("0".equals(columna))) { //Si no hay ordenacion de ningun tipo
                        pOrder = " ORDER BY " + sql_exp_fechIni + " DESC ";
                        paginar = true;
                        consultaFinal = "select /*+first_rows(" + lineas + ")*/  * from (SELECT consulta.*, ROW_NUMBER() over ( " + pOrder + ") RN  FROM(" + sql2 + ") CONSULTA )  resultado where rn between ? AND ? order by rn";
                    } else {

                        if (ordenCampoSuplementario) { //si es por campo suplementario se especifica el nombre de la columna. Podemos usar paginacion
                            // Se añade a la parte ORDER BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                            pOrder = " ORDER BY " + parteOrderByColumnaCampoSuplementario + " " + tipoOrden;
                            paginar = true;
                            consultaFinal = "select /*+first_rows(" + lineas + ")*/  * from (SELECT consulta.*, ROW_NUMBER() over ( " + pOrder + ") RN  FROM(" + sql2 + ") CONSULTA )  resultado where rn between ? AND ? order by rn";
                            
                        } else if (("".equals(nombreColumna)) || (nombreColumna == null)) { //Si no es por campo suplementario y el nombre esta a null, no usamos paginacion en BBDD
                            consultaFinal = sql;
                        } else { //Si viene el nombre de la columna a oprdenar, paginamos en BBDD
                            pOrder = " ORDER BY " + nombreColumna + " " + tipoOrden;
                            paginar = true;
                            consultaFinal = "select /*+first_rows(" + lineas + ")*/  * from (SELECT consulta.*, ROW_NUMBER() over ( " + pOrder + ") RN  FROM(" + sql2 + ") CONSULTA )  resultado where rn between ? AND ? order by rn";
                        }

                    }

                }
            } else {
                consultaFinal = sql;
            }


            /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
            //Nota Febrero 2017: Para la consulta de expedientes pendientes vamos a desactivar estos alter. Ya que se ejecutan siempre y dan problemas de stuck-thread
            // Tendría que hacerse el alter sólo con filtros y ordenación de interesados, asunto, observaciones y campos suplementarios
//           if(params[0]!=null && (params[0].equalsIgnoreCase("oracle"))){
//                String alter1 = "ALTER SESSION SET NLS_COMP=LINGUISTIC";
//                String alter2 = "ALTER SESSION SET NLS_SORT=GENERIC_BASELETTER";
//                Statement st =con.createStatement();
//                st.executeQuery(alter1);
//                st=con.prepareStatement(alter2);
//                st.executeQuery(alter2);
//                st.close();
//            }
            /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/

 
            if(m_Log.isDebugEnabled()) m_Log.debug(consultaFinal);
            stmt = con.prepareStatement(consultaFinal);
            
             int contador = 1; 
            /*****************************************************************************************/
            ArrayList<String> valores = null;
            if(criterio!=null) valores = criterio.getValoresCriterioBusqueda();
            //if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())){ // Criterio de búsqueda es la fecha de inicio
            if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())
                    || (criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda())
                    && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())))
            { // Criterio de búsqueda es la fecha de inicio o por campo suplementario de tipo fecha

               
                
            }//if 
            
            if ("1".equals(tVO.getCodRangoTemporal())){
                Calendar calendario = Calendar.getInstance();
	        calendario.add(Calendar.MONTH, -6);
	        Timestamp time = new Timestamp(calendario.getTimeInMillis());
	        stmt.setTimestamp(contador++,time);
	
            } else if ("2".equals(tVO.getCodRangoTemporal())) {
	        Calendar calendario = Calendar.getInstance();
	        calendario.add(Calendar.MONTH, -12);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
	        stmt.setTimestamp(contador++,time);

            }
          
            if (paginar)
            {
                stmt.setInt(contador++, (lineas * (pagActual - 1)) + 1);      
                stmt.setInt(contador++, pagActual * lineas);
            }

               // ================== Búsqueda por un campo suplementario ==========================>
            /*****************************************************************************************/
            rs = stmt.executeQuery();
            

            Hashtable<Integer,ArrayList<Calendar>> listaFestivos = new Hashtable<Integer,ArrayList<Calendar>>();
            DefinicionProcedimientosManager manager = DefinicionProcedimientosManager.getInstance();
            Hashtable<String,DefinicionProcedimientosValueObject> listaPlazos = new Hashtable<String,DefinicionProcedimientosValueObject>();
            Calendar today = Calendar.getInstance();
            ConsultaExpedientesDAO cDAO=ConsultaExpedientesDAO.getInstance();
            
            String listaExpedientes="";
            
            while(rs.next()) {
                if (!paginar) {
                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                    if (numPaginaE > pagActual) {
                        break;
                    } else if (numPaginaE != pagActual) {
                        posE++;
                        continue;
                    }
                }
     
                String fueraDePlazo = "no";
                String pendiente = "no";
                TramitacionValueObject tvo1 = new TramitacionValueObject();
                tvo1.setLocalizacion(rs.getString(1));
                tvo1.setCodMunicipio(rs.getString(2));
                tvo1.setCodProcedimiento(rs.getString(7));
                tvo1.setDescProcedimiento(rs.getString(3));
                tvo1.setEjercicio(rs.getString(4));
                tvo1.setNumero(rs.getString(5));
                tvo1.setFechaInicioExpediente(rs.getString(6));
                String asuntoExp = rs.getString(9);
                if (asuntoExp != null) tvo1.setAsuntoExp(AdaptadorSQLBD.js_escape(asuntoExp));
                else tvo1.setAsuntoExp("");
                String numeroRelacion = rs.getString(10);
                if (numeroRelacion == null) tvo1.setNumeroRelacion("");
                else tvo1.setNumeroRelacion(numeroRelacion);
                /**
                if ("0".equals(rs.getString("EXR_TOP")))
                    tvo1.setTipoInicio("Instancia");
                else tvo1.setTipoInicio("Oficio");
                ***/
                
                if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(),con)){
        		tvo1.setTipoInicio("Instancia");
        	}else
                	tvo1.setTipoInicio("Oficio");
                
                lista.addElement(tvo1);
                // Ver si esta fuera de plazo.
                String fechaLimite = rs.getString(11);
                tvo1.setFechaLimiteP(fechaLimite);
                if (fechaLimite != null && !"".equals(fechaLimite)) {

                    Calendar calendario = Calendar.getInstance();
                    java.util.Date date = calendario.getTime();
                 
                    Calendar fechaLimitePlazo = Calendar.getInstance();
                    fechaLimitePlazo.clear();
                    java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                    fechaLimitePlazo.setTime(dateLimite);
                    fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                    fechaLimitePlazo.set(Calendar.MINUTE, 59);
                    fechaLimitePlazo.set(Calendar.SECOND, 59);
                    //Usamos un java.sql.Date porque se trunca de la varaible date las HH:MM:SS
                    java.sql.Date d1 = new Date(calendario.getTimeInMillis());
                    java.sql.Date d2 = new Date(fechaLimitePlazo.getTimeInMillis());

                    if(d1.getTime() > d2.getTime()) fueraDePlazo = "si";
                }
                tvo1.setFueraDePlazo(fueraDePlazo);
                // Comprobar si esta pendiente
                String exisUOR = rs.getString(12);
                if (exisUOR != null) pendiente = "si";
                tvo1.setPendiente(pendiente);
                tvo1.setFechaFinExpediente(rs.getString("fFin"));
                tvo1.setEstado(rs.getString("ESTADO"));
                tvo1.setUsuarioIni(rs.getString("USU_NOM"));
                tvo1.setUnidadInicio(rs.getString("UOR_NOM"));
                tvo1.setExpImportante(rs.getString("EXP_IMP"));
                
                Calendar fecAlarma = DateOperations.timestampToCalendar(rs.getTimestamp("EXP_FPA"));
                if (fecAlarma == null)
                    tvo1.setAlarmaVencida("nadaQueMostrar"); 
                else if (fecAlarma.before(today))
                    tvo1.setAlarmaVencida("si"); 
                else
                    tvo1.setAlarmaVencida("no"); 
                        
                Calendar fechaInicio = DateOperations.toCalendar(rs.getTimestamp("EXP_FEI"));
                fechaInicio.set(Calendar.HOUR_OF_DAY,0);
                fechaInicio.set(Calendar.MINUTE,0);
                fechaInicio.set(Calendar.SECOND,0);
                                

                if(!listaPlazos.containsKey(tvo1.getCodProcedimiento())){
                    DefinicionProcedimientosValueObject dfvo = new DefinicionProcedimientosValueObject();
                    dfvo.setTxtCodigo(tvo1.getCodProcedimiento());
                    listaPlazos.put(tvo1.getCodProcedimiento(),manager.getPlazosFinalizacion(dfvo, con));
                }

                DefinicionProcedimientosValueObject definicion = listaPlazos.get(tvo1.getCodProcedimiento());                
                if(definicion!=null && definicion.getPlazo()!=null && definicion.getTipoPlazo()!=null){
                    Calendar fechaFin = null;
                    
                    if(!listaFestivos.containsKey(tvo1.getEjercicio())){
                        listaFestivos.put(Integer.parseInt(tvo1.getEjercicio()),this.getFestivos(Integer.parseInt(tvo1.getEjercicio()),con));
                    }
                    int porcentaje = 0;
                    if(definicion.getPorcentaje()!=null && definicion.getPorcentaje().length()>0)
                        porcentaje = Integer.parseInt(definicion.getPorcentaje());

                    // Se obtiene la fecha de fin del expediente
                    fechaFin = this.calcularFechaFinExpediente(fechaInicio,Integer.parseInt(definicion.getPlazo()),Integer.parseInt(definicion.getTipoPlazo()),listaFestivos.get(tvo1.getEjercicio()));
                   
                   // Se comprueba si el expediente está cercano a la fecha de fin o fuera de plazo
                    String resultado = this.calculoExpedienteCercaFinPlazo(porcentaje, fechaInicio, fechaFin);
                    // Si la salida es un si es que el expediente está cerca de fin de plazo
                      // Si el resultado es nulo es que no se está ni cerca ni fuera de plazo
                    if(resultado==null){
                        tvo1.setCercaPlazoExpediente(false);
                        tvo1.setFueraPlazoExpediente(false);
                    }else{
                        if(resultado.equals("si")){
                            tvo1.setCercaPlazoExpediente(true);
                            tvo1.setFueraPlazoExpediente(false);
                        }
                        // Si el resultado es no es que no lo está
                        if(resultado.equals("no")){
                            tvo1.setCercaPlazoExpediente(false);
                            tvo1.setFueraPlazoExpediente(true);
                        }
                    }

                  
                } else{
                    tvo1.setCercaPlazoExpediente(false);
                    tvo1.setFueraPlazoExpediente(false);
                } 
                posE++;
            }
            rs.close();
            stmt.close();
            
            Hashtable<String,String> coleccionFueraPlazo = new Hashtable<String,String>();
            Hashtable<String,String> coleccionUnidades = new Hashtable<String,String>();
            
            if(lista.size()>0){
                String interrogante="";
                for(int i=0;i<lista.size();i++)
                {
                    if (i==0) interrogante="?";
                    else interrogante=interrogante+",?";
                }

                  sql ="SELECT CRO_NUM, TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,UOR_NOM " +
                          "FROM E_TRA, E_CRO " +  
                          " inner join A_UOR  on (CRO_UTR = UOR_COD) "+
                          "WHERE TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA " +
                          "AND  CRO_NUM in ("+interrogante+") " +
                          "AND CRO_FEF IS NULL order by CRO_NUM";
                          m_Log.debug("sql: " + sql);
                     stmt = con.prepareStatement(sql);
                   int j=1;
                  for(int i=0;i<lista.size();i++) {
                    TramitacionValueObject tvo1;
                    tvo1 = (TramitacionValueObject) lista.elementAt(i);

                    stmt.setString(j++, tvo1.getNumero());
                  }


                  rs = stmt.executeQuery();

                

                     SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
                     //String tramites = ""; 
                     String unidadesTramitadoras = "";

                     while(rs.next())
                     {
                           int plazoCercaFin = 0;
                           String tipoPlazo = null;
                           int unidadesPlazo =0;
                           String fechaLimite = null;
                           Timestamp tFechaLimite = null;
                           String numeroExpediente= null;
                           String unidades=null;
                           // Obtener la fecha inicio tramite y el % cerca de aviso.

                           numeroExpediente = rs.getString("CRO_NUM");
                           plazoCercaFin = rs.getInt("TRA_FIN");
                           tipoPlazo     = rs.getString("TRA_UND");
                           unidadesPlazo = rs.getInt("TRA_PLZ");
                           tFechaLimite   = rs.getTimestamp("FechaLimite");
                           unidades= rs.getString("UOR_NOM");
                           // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                           // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                           Calendar fechaLimitePlazo = null;
                           if(tFechaLimite!=null)
                           {
                               fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());

                                fechaLimitePlazo = Calendar.getInstance();
                                fechaLimitePlazo.clear();                            
                                java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                                fechaLimitePlazo.setTime(dateLimite);
                                fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                                fechaLimitePlazo.set(Calendar.MINUTE, 59);
                                fechaLimitePlazo.set(Calendar.SECOND, 59);
                                if(fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin >= 0){
                                    String fuera=calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);
                                    if(coleccionFueraPlazo.containsKey(numeroExpediente))
                                    {
                                        String pl = coleccionFueraPlazo.get(numeroExpediente);
                                        if (("si".equals(fuera)) && ("no".equals(pl))) coleccionFueraPlazo.put(numeroExpediente,fuera);
                                        else if(("si".equals(fuera)) && ("".equals(pl))) coleccionFueraPlazo.put(numeroExpediente,fuera);
                                        else if(("no".equals(fuera)) && ("".equals(pl))) coleccionFueraPlazo.put(numeroExpediente,fuera);
                                    } else coleccionFueraPlazo.put(numeroExpediente,fuera);

                                }
                           }

                          if(coleccionUnidades.containsKey(numeroExpediente)){
                              String unid=coleccionUnidades.get(numeroExpediente);
                              unid=unid+"; "+unidades;
                              coleccionUnidades.put(numeroExpediente,unid);

                          }else{
                              coleccionUnidades.put(numeroExpediente,unidades);
                          }

                     }// while
                     rs.close(); 
                     stmt.close(); 
                 
            }
                 
             

            for(int i=0;i<lista.size();i++) {
                TramitacionValueObject tvo1;
                tvo1 = (TramitacionValueObject) lista.elementAt(i);
                
                
                if(coleccionFueraPlazo!=null)
                {
                    //Obtener los valores de fuera para cada expediente. 
                    //Si tiene algún si--> Fuera de plazo. Si no tiene si, pero tiene algún no--> Cerca de fin. Si no tiene valores--> nada
                    String fuera=coleccionFueraPlazo.get(tvo1.getNumero());
                    
                    if ("si".equals(fuera)){
                        tvo1.setPlazoCercaFin("no");                     
                        tvo1.setFueraDePlazo("si");
                        
                    }else if ("no".equals(fuera)){
                        tvo1.setPlazoCercaFin("si");                     
                        tvo1.setFueraDePlazo("no");
                        
                    }else{
                    //Si no tiene valores
                        tvo1.setPlazoCercaFin("no");                     
                        tvo1.setFueraDePlazo("no");
                    }
                   
                } 
                
                 tvo1.setListaUnidadesTramitadorasPendientes(coleccionUnidades.get(tvo1.getNumero()));
                
  
                // OBTENER LOS DATOS DE LOS INTERESADOS
                /* ORIGINAL
                sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, ROL_DES, MOSTRAR FROM E_ROL,E_EXT "
                        +" LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR)  " +
                        "WHERE EXT_MUN = " + tvo1.getCodMunicipio() + " AND EXT_EJE = " + tvo1.getEjercicio() + " " +
                        "AND EXT_NUM = '" + tvo1.getNumero() + "' AND ROL_MUN = " + tvo1.getCodMunicipio() + " " +
                        "AND ROL_PRO = '" + tvo1.getCodProcedimiento() + "' AND ROL_COD = EXT_ROL" ;
                */  
                sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, MOSTRAR FROM E_EXT "
                        +" LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR)  " +
                        "WHERE EXT_MUN = ? AND EXT_EJE = ? " +
                        "AND EXT_NUM = ? AND EXT_PRO = ? ";

                if(m_Log.isDebugEnabled()) m_Log.debug(sql);
                stmt = con.prepareStatement(sql);
                
                stmt.setInt(1, Integer.parseInt(tvo1.getCodMunicipio()));
                stmt.setInt(2, Integer.parseInt(tvo1.getEjercicio()));
                stmt.setString(3, tvo1.getNumero());
                stmt.setString(4, tvo1.getCodProcedimiento());
                
                rs = stmt.executeQuery();
                
                String interesados = "";
                boolean primero = true;
                while (rs.next()) {
                    // Obtener una descripcion del tercero.
                    String tercero_p1a = rs.getString(sql_hte_p1a);
                    String tercero_a1a = rs.getString(sql_hte_a1a);
                    String tercero_p2a = rs.getString(sql_hte_p2a);
                    String tercero_a2a = rs.getString(sql_hte_a2a);
                    String tercero_nom = rs.getString(sql_hte_nan);
                    String titular = "";
                    if (tercero_p1a != null) titular += tercero_p1a + " ";
                    if (tercero_a1a != null) titular += tercero_a1a + " ";
                    if (tercero_p2a != null) titular += tercero_p2a + " ";
                    if (tercero_a2a != null) titular += tercero_a2a + " ";
                    if (titular.trim().equals("")) titular = tercero_nom;
                    else titular = titular.substring(0, titular.length()-1) + ", " + tercero_nom;
                    
                    // Interesado principal
                    if (rs.getInt("MOSTRAR") == 1) {
                        tvo1.setTitular(titular);
                    }
                    
                    // Listado de interesados con roles
                    if (primero) primero = false;
                    else interesados += ";";
                    
                    titular = tercero_nom + " ";
                    if (tercero_p1a != null) titular += tercero_p1a + " ";
                    if (tercero_a1a != null) titular += tercero_a1a + " ";
                    if (tercero_p2a != null) titular += tercero_p2a + " ";
                    if (tercero_a2a != null) titular += tercero_a2a + " ";
                    titular = titular.trim();
                    
                    //interesados += titular + " (" + rs.getString("ROL_DES") + ")";
                    interesados += titular;
                }
                m_Log.debug("Interesados del expediente: " + interesados);
                //tvo1.setListaInteresados(interesados);
                rs.close();
                stmt.close();
                
                // SI NO TIENE TERCERO TITULAR Y TIENE TERCEROS -> INCLUIR COMO TITULAR UNO DE LOS TERCEROS
                if((tvo1.getTitular()==null || tvo1.getTitular().equals("")) && interesados.length()>0){
                    String interesadoMostrar, textoMostrar = "";
                    if(interesados.indexOf(";")!=-1){
                        String[] listaInteresados = interesados.split(";");
                        interesadoMostrar = listaInteresados[0].trim();
                    } else interesadoMostrar = interesados.trim();
                    String[] interesadoPartes = interesadoMostrar.split("\\s+");
                    //m_Log.info("**************PARTES DEL INTERESADO:*****************");
                    for(int cont=1;cont<interesadoPartes.length-1;cont++){
                        //m_Log.info("parte "+cont+": --"+interesadoPartes[cont]+"--");
                        textoMostrar += interesadoPartes[cont];
                        if(cont<interesadoPartes.length-2) textoMostrar += " ";
                    }
                    textoMostrar += ", "+interesadoPartes[0];
                    m_Log.debug("*******INTERESADO MOSTRAR: "+textoMostrar+"**********");
                    tvo1.setTitular(textoMostrar);
                }

                /**** HABRÁ QUE COMPROBAR CUAL DE LOS TRÁMITES DEL EXPEDIENTE TIENE UNA FECHA CERCANA A PLAZO, PARA
                 ASÍ PODER MARCAR EL EXPEDIENTE COMO CERCANO A FIN DE PLAZO */

                // SE RECUPERAN TODOS LOS TRÁMITES ABIERTOS PARA EL EXPEDIENTE
                // #218055: la parte de trámites abiertos se recupera por ajax cuando se selecciona el expediente, se mantiene la parte referente a plazos y uors
                //sql ="SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,TML_VALOR,UOR_NOM " +
  /*              sql ="SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,UOR_NOM " +
                      "FROM E_TRA, E_CRO " +
                      //" inner join E_TML on (CRO_PRO = TML_PRO and CRO_MUN = TML_MUN and CRO_TRA = TML_TRA) "+
                      " inner join A_UOR  on (CRO_UTR = UOR_COD) "+
                      "WHERE TRA_MUN = ? AND TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA " +
                      "AND CRO_MUN = ? AND CRO_EJE=? AND CRO_NUM = ? " +
                      "AND CRO_FEF IS NULL";
                      m_Log.debug("sql: " + sql);
                 stmt = con.prepareStatement(sql);
                 
                 stmt.setInt(1, Integer.parseInt(tvo1.getCodMunicipio()));
                 stmt.setInt(2, Integer.parseInt(tvo1.getCodMunicipio()));
                 stmt.setInt(3, Integer.parseInt(tvo1.getEjercicio()));
                 stmt.setString(4, tvo1.getNumero());
              
                 
                 rs = stmt.executeQuery();

                 ArrayList<String> coleccionFueraPlazo = new ArrayList<String>();
                 SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
                 //String tramites = ""; 
                 String unidadesTramitadoras = "";
                 primero = true;
                 while(rs.next())
                 {
                       int plazoCercaFin = 0;
                       String tipoPlazo = null;
                       int unidadesPlazo =0;
                       String fechaLimite = null;
                       Timestamp tFechaLimite = null;
                       // Obtener la fecha inicio tramite y el % cerca de aviso.
                       plazoCercaFin = rs.getInt("TRA_FIN");
                       tipoPlazo     = rs.getString("TRA_UND");
                       unidadesPlazo = rs.getInt("TRA_PLZ");
                       tFechaLimite   = rs.getTimestamp("FechaLimite");
                       
                        if (primero) primero = false;
                        else {
                            //tramites += ";";
                            unidadesTramitadoras += ";";
                        } 

                        //tramites += rs.getString("TML_VALOR");
                        unidadesTramitadoras += rs.getString("UOR_NOM");

                       // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                       // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                       Calendar fechaLimitePlazo = null;
                       if(tFechaLimite!=null)
                       {
                           fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());
                            
                            fechaLimitePlazo = Calendar.getInstance();
                            fechaLimitePlazo.clear();                            
                            java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                            fechaLimitePlazo.setTime(dateLimite);
                            fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                            fechaLimitePlazo.set(Calendar.MINUTE, 59);
                            fechaLimitePlazo.set(Calendar.SECOND, 59);
                            if(fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin!=0){
                                String fuera=calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);
                                
                                if("si".equals(fuera))
                                    coleccionFueraPlazo.add(fuera);
                            }
                       }
                 }// while
                 rs.close();
                 stmt.close();
                 tvo1.setPlazoCercaFin("no");
                 if(coleccionFueraPlazo!=null && coleccionFueraPlazo.contains("si")){
                     // Si hay algún trámite del expediente en cerca de fin de plazo. El expediente
                     // se pintará como cerca de fin de plazo
                     tvo1.setPlazoCercaFin("si");                     
                     tvo1.setFueraDePlazo("no");
                 }
                //m_Log.debug("Tramites pendientes: " + tramites);
                //tvo1.setListaTramitesPendientes(tramites);

                m_Log.debug("Unidades tramitadoras pendientes: " + unidadesTramitadoras);
                tvo1.setListaUnidadesTramitadorasPendientes(unidadesTramitadoras);
*/
                /*** Se recuperan los valores de los campos suplementarios que forman parte de la vista de expedientes pendientes ***/
                 Hashtable<String,String> campos = new Hashtable<String,String>();
                       
                        if(camposSuplementarios!=null && camposSuplementarios.size()>0){
                            
                                campos = CamposListadoPendientesProcedimientoManager.getInstance().getValorCampoSuplementario2(tvo1.getNumero(),tvo1.getEjercicio(),tvo1.getCodMunicipio(),camposSuplementarios,params);                                                                                   

                                //System.out.println("\n\n CAMPOS EXPEDIENTES--->"+ campos);
                            tvo1.setValoresCamposVistaPendientes(campos);
                        
                        }//if

                /*** Se recuperan los valores de los campos suplementarios que forman parte de la vista de expedientes pendientes ***/
                listaFinal.addElement(tvo1);
            }

        } catch (Exception e) {
            listaFinal = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientes", e);

        } finally {
            try{
                
                if(params[0]!=null && (params[0].equals("oracle") || params[0].equals("ORACLE")) ){
                        Statement st_alter;
                        String alter1 = "ALTER SESSION SET NLS_COMP=BINARY";
                        String alter2 = "ALTER SESSION SET NLS_SORT=SPANISH";
                        st_alter = con.createStatement();
                        st_alter.executeQuery(alter1);
                        st_alter.executeQuery(alter2);

                        st_alter.close();
                 }
               
                oad.devolverConexion(con);
            }catch(BDException bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientes.Devolver conexion", bde);
            }catch (SQLException sqle){
                sqle.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(sqle.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientes.Devolver conexion", sqle);
            }
        }

        m_Log.debug("getListaExpedientesPendientes en TramitacionDAO");
        return listaFinal;
    }

    
    
    public Vector getExpedientesPendientes(UsuarioValueObject uVO, TramitacionValueObject tVO,String[] params)
            throws TramitacionException, TechnicalException {
        Vector lista = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt;
        ResultSet rs = null;
        String sql;
        String nsl_comp_anterior="";
        String nsl_sort_anterior="";
        String valor_nsl_comp_anterior="";
        String valor_nsl_sort_anterior="";
        /************************/
        ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();
        
        TransformacionAtributoSelect transformador = null;
        /************************/
        try{
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();
            transformador = new TransformacionAtributoSelect(oad);
            
            m_Log.debug("********** TramitacionDAO.getExpedientesPendientes SOLO EXP");
            String parteSelect2 = "SELECT E_EXP."+ sql_exp_codMun+ ", " +
                "E_EXP."+sql_exp_codProc+ ", " +
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +   
                "E_EXR."+sql_exr_top+ "," +    
                "E_EXP."+sql_exp_fechIni + ", E_EXP.EXP_FPA";
            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +                    
                    "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                    "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") " + 
                    "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                    "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
            

            /******************************************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************************************/

            
            String parteFromBusquedaCampoSuplementario    = "";            
            String parteWhereBusquedaCampoSuplementario   = "";
            boolean busquedaCampoSuplementario            = false;

            /********************** PRUEBA **********************/
               /** SE COMPRUEBA SI SE HA ESTABLECIDO UN CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO, YA QUE EN ESTE CASO HABRÁ QUE
                     AÑADIR LA PARTE FROM Y LA PARTE WHERE  **/
                if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda()){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                    if(criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda()))
                    {
                        int tipoDato = Integer.parseInt(criterio.getTipoCampoSuplementarioCriterioBusqueda());
                        m_Log.debug("El tipo del dato del campo suplementario por el que se hace la búsqueda es " + tipoDato);
                        switch (tipoDato){
                            case 1: //  Campo de tipo numérico                                
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";                                

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <                                   
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=
                               
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND TNU_VALOR<=" + valores.get(1) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR!=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }


                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                //parteOrderByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                                busquedaCampoSuplementario             = true;
                                break;
                            case 2: //  Campo de tipo texto corto
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador <>                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR!='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                  
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==7){ // Operador LIKE                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR LIKE('%" +  valores.get(0) + "%') AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";                                  
                                }

                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                busquedaCampoSuplementario              = true;
                                break;
                            case 3: //  Campo de tipo fecha
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";                                
                               
                               if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    /*
                                    parteWhereBusquedaCampoSuplementario = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0));
                                    */
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            //+" AND E_TFE.TFE_VALOR>?) ";
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                busquedaCampoSuplementario             = true;
                                break;
                            case 6: //  Campo de tipo desplegable                                
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";                                
                                
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario + 
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR='" + valores.get(0) + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador !=
                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR!='" + valores.get(0) + "') ";
                                }

                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                busquedaCampoSuplementario            = true;
                                break;
                           case 8: //  Campo de tipo numérico calculado
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";                               

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <                                   
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=
                               
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND TNUC_VALOR<=" + valores.get(1) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR!=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }


                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                busquedaCampoSuplementario             = true;
                                break;                            
                            case 9: //  Campo de tipo fecha calculada
                                parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";                                                                

                               if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                                busquedaCampoSuplementario             = true;
                                break;
                        }// switch
                    }// if
                }// if
            /********************* PRUEBA ***********************/

            String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' "
                    + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' "
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) ";

                        /** Inicio filtro por procedimiento **/
                        if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento()) && !"TODOS".equalsIgnoreCase(tVO.getCodProcedimiento())){
                            pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + tVO.getCodProcedimiento() + "'";
                        }
                        /** Fin filtro por procedimiento **/
                        
                        if ("1".equals(tVO.getCodRangoTemporal()) || "2".equals(tVO.getCodRangoTemporal())) {
                           pWhere2 = pWhere2 + " AND E_EXP.EXP_FEI >= ? ";
                       }

            /*****************************************************************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda               
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0){
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0));
                        m_Log.debug("Auxiliar:  " + auxiliar);
                    }
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        //auxiliar = " AND E_EXP.EXP_FEI>? ";
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                    // Identificación
                   if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                       auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                 + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                   }else{
                       auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                   }
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";
               }//if
               pWhere2 = pWhere2 + auxiliar;
            }//if

            if (tVO.getUsuarioTramitador()!=null && tVO.getUsuarioTramitador()!="") {
               pWhere2 += " AND (E_EXP.EXP_USU = " + tVO.getUsuarioTramitador() +" OR E_CRO.CRO_USU = " + tVO.getUsuarioTramitador() +
                        " OR E_CRO.CRO_USF = " + tVO.getUsuarioTramitador() +") ";
            }//if

            /*********************** prueba *********************/
            if(busquedaCampoSuplementario){
                // Si se realiza una búsqueda por campo suplementario se añade la parte correspondiente en el WHERE de la consulta SQL
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }
            /*********************** prueba *********************/
            
            /*****************************************************************************************/

            
            String groupSelect = " GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    sql_pml_valorCampo + ", " +
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM,E_EXR.EXR_TOP,e_exp.exp_fpa" +  " ";


           /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
            //Nota Febrero 2017: Para la consulta de expedientes pendientes vamos a desactivar estos alter. Ya que se ejecutan siempre y dan problemas de stuck-thread
//           if(params[0]!=null && (params[0].equalsIgnoreCase("oracle"))){
//                String alter1 = "ALTER SESSION SET NLS_COMP=LINGUISTIC";
//                String alter2 = "ALTER SESSION SET NLS_SORT=GENERIC_BASELETTER";
//                Statement st =con.createStatement();
//                st.executeQuery(alter1);
//                st=con.prepareStatement(alter2);
//                st.executeQuery(alter2);
//                st.close();
//            }
            /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
            

            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect +" ORDER BY "+ sql_exp_fechIni + " DESC ";

            if(m_Log.isDebugEnabled()) m_Log.debug(sql);
            stmt = con.prepareStatement(sql);

            /*****************************************************************************************/
            ArrayList<String> valores = null;
            if(criterio!=null) valores = criterio.getValoresCriterioBusqueda();
            
            if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())){ // Criterio de búsqueda es la fecha de inicio
                //int contador = 1;
                m_Log.debug("Operador criterio: " + criterio.getOperadorCriterioBusqueda());
                
                
            }//if
            else
            if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda())
                    && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                
            }// if
            
            int contador=1;
            if ("1".equals(tVO.getCodRangoTemporal())){
                Calendar calendario = Calendar.getInstance();
	        calendario.add(Calendar.MONTH, -6);
	        Timestamp time = new Timestamp(calendario.getTimeInMillis());
	        stmt.setTimestamp(contador++,time);
	
            } else if ("2".equals(tVO.getCodRangoTemporal())) {
	        Calendar calendario = Calendar.getInstance();
	        calendario.add(Calendar.MONTH, -12);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
	        stmt.setTimestamp(contador++,time);

            }
          
            /*****************************************************************************************/

            rs = stmt.executeQuery();
            ConsultaExpedientesDAO cDAO = ConsultaExpedientesDAO.getInstance();            
            while(rs.next()) {
                TramitacionValueObject tvo1 = new TramitacionValueObject();
                
                String codMunicipio     = rs.getString(1);
                String codProcedimiento = rs.getString(2);
                String ejercicio        = rs.getString(3);
                String numeroExpediente = rs.getString(4);                
                tvo1.setCodMunicipio(codMunicipio);
                tvo1.setCodProcedimiento(codProcedimiento);
                tvo1.setEjercicio(ejercicio);
                tvo1.setNumero(numeroExpediente);
                if ("0".equals(rs.getString("EXR_TOP")))
                    tvo1.setTipoInicio("Instancia");
                else tvo1.setTipoInicio("Oficio");

                /** SE COMPRUEBA SI EL PROCEDIMIENTO AL QUE PERTENECE EL EXPEDIENTE ESTÁ RESTRINGIDO Y SI LO ESTÁ Y EL USUARIO NO TIENE PERMISO NO SE AÑADE
                 *  EN LA COLECCIÓN DEL EXPEDIENTES PENDIENTES */
                boolean estaRestringido = this.estaRestringidoProcedimiento(tvo1.getCodProcedimiento(), con);
                if(estaRestringido){
                    // El procedimiento al que pertenece el expediente está marcado como restringido => Se comprueba si el usuario tiene permiso sobre el procedimiento
                    boolean tienePermiso = PermisoProcRestringidoDAO.getInstance().tieneUsuarioPermisoSobreProcedimientoRestringido(Integer.toString(uVO.getIdUsuario()), tvo1.getCodMunicipio(), tvo1.getCodProcedimiento(), con);
                    if(tienePermiso)
                        lista.addElement(tvo1);
                }else
                    lista.addElement(tvo1);

                //lista.addElement(tvo1);
            }
            rs.close();
            stmt.close();
        return lista;
        } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientes", e);

        } finally {
            try{
                
                if(params[0]!=null && (params[0].equals("oracle") || params[0].equals("ORACLE")) ){
                        Statement st_alter;
                        String alter1 = "ALTER SESSION SET NLS_COMP=BINARY";
                        String alter2 = "ALTER SESSION SET NLS_SORT=SPANISH";
                        st_alter = con.createStatement();
                        st_alter.executeQuery(alter1);
                        st_alter.executeQuery(alter2);

                        st_alter.close();
                    }
                oad.devolverConexion(con);
            }catch(BDException bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientes.Devolver conexion", bde);
            }catch (SQLException sqle){
                sqle.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(sqle.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientes.Devolver conexion", sqle);
            }
        }

    }

    /**
     * Comprueba si un procedimiento está marcado como restringido
     * @param codProcedimiento: Código del procedimiento
     * @param con: Conexión a la BBDD
     * @return Un boolean
     */
   private boolean estaRestringidoProcedimiento(String codProcedimiento,Connection con){
       PreparedStatement ps =null;
       ResultSet rs = null;
       boolean exito = false;
       try{
           String sql = "SELECT COUNT(*) AS NUM FROM E_PRO WHERE PRO_COD=? AND PRO_RESTRINGIDO=1";
           
           ps = con.prepareStatement(sql);
           ps.setString(1,codProcedimiento);
           rs = ps.executeQuery();
           while(rs.next()){
               int num = rs.getInt("NUM");
               if(num>=1) exito = true;
           }
           
       }catch(SQLException e){
           e.printStackTrace();
       }finally{
           try{
               
               if(ps!=null) ps.close();
               if(rs!=null) rs.close();
               
           }catch(SQLException e){
               e.printStackTrace();
           }
       }
       return exito;
   }

    
    public Vector getListaProcedimientosUsuario(UsuarioValueObject uVO, int sinTipoProcs, String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaProcedimientosUsuario en TramitacionDAO");

        Vector lista = new Vector();
        
        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        
        try{
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

           
           sql = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo + ", PRO_RESTRINGIDO "
                    + " FROM E_PUI, E_PRO, E_PML "
                    + " WHERE " + sql_pui_codMun + "=" + sql_pro_codMun
                    + " AND " + sql_pui_codProc + "=" + sql_pro_cod
                    + " AND " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                   // MAI: indicamos que los procedimientos que solo se pueden iniciar por webService no salgan
                    + " AND PRO_SOLOWS<>1 " 
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                    + " AND "+ sql_uou_uor +"="+  sql_pui_uor + ")) "
                    + " AND " + sql_pro_fechDesd + "<=  " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1"
                    + " AND " + sql_pro_tipInic +"<>" + sinTipoProcs;

        sql += " UNION ";
        // Cuando es un procedimiento que tiene asociado cq UORs de entrada entonces el procedimiento se añade siempre
        // y cuando el usuario tenga alguna UOR asociada
        sql += "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo + ", PRO_RESTRINGIDO "
                    + " FROM E_PRO, E_PML "
                    + " WHERE " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                 // MAI: indicamos que los procedimientos que solo se pueden iniciar por webService no salgan
                    + " AND PRO_SOLOWS<>1 "              
                    + " AND ( NOT EXISTS ( "
                      + " SELECT DISTINCT " +sql_pui_uor + " FROM E_PUI "
                      + " WHERE "+ sql_pui_codProc + "=" + sql_pro_cod + ") "
                    + " AND EXISTS ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod() + ")) "
                    + " AND " + sql_pro_fechDesd + "<=  " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + "<" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1"
          + " AND " + sql_pro_tipInic +"<>" + sinTipoProcs;
        sql += " ORDER BY "+ sql_pml_codProc+ " ASC ";



            
        if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientosUsuario--> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                DefinicionProcedimientosValueObject dpVO = new DefinicionProcedimientosValueObject();
                dpVO.setCodMunicipio((String) rs.getString(sql_pml_codMun));
                dpVO.setTxtCodigo((String) rs.getString(sql_pml_codProc));
                dpVO.setTxtDescripcion((String) rs.getString(sql_pml_valorCampo));
                // Lista de uors del usuario.
                Vector l = getListaUORs_usuario(oad,con,dpVO,uVO);
                dpVO.setTablaUnidadInicio(l);
                
                // Obtener la lista de unidades orgánicas del trámite de inicio.
                Vector<UORDTO> uorsTramiteInicio = getUnidadesTramitadorasTramiteInicio(dpVO.getTxtCodigo(), con, oad);
                dpVO.setUorsTramiteInicio(uorsTramiteInicio);

                /** NUEVO **/
                String proRestringido = rs.getString("PRO_RESTRINGIDO");
                m_Log.debug(" ************************ >>> proRestringido: " + proRestringido + " , codProcedimiento: " + dpVO.getTxtCodigo());
                if(proRestringido!=null && !"".equals(proRestringido) && "1".equals(proRestringido)){
                    // Si el procedimiento está restringido => Se comprueba si el usuario tiene  permiso para trabajar con el y por tanto, iniciar expediente
                    
                    boolean tienePermiso = PermisoProcRestringidoDAO.getInstance().tieneUsuarioPermisoSobreProcedimientoRestringido(Integer.toString(uVO.getIdUsuario()), Integer.toString(uVO.getOrgCod()), dpVO.getTxtCodigo(), con);
                    m_Log.debug("******************* El usuario " + uVO.getIdUsuario() + " para el procedimiento " + dpVO.getTxtCodigo() + " permiso: " + tienePermiso);
                    if(tienePermiso) lista.addElement(dpVO);

                }else // Si el procedimiento no está restringido el usuario puede iniciar expediente
                    lista.addElement(dpVO);
                    
                /** NUEVO */                
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientosUsuario", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientosUsuario.Devolver conexion", bde);
            }
        }
        m_Log.debug("getListaExpedientesPendientes");
        return lista;
    }
    
    
    
    public Vector getListaProcedimientosUsuario2(UsuarioValueObject uVO, int sinTipoProcs, String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaProcedimientosUsuario2 en TramitacionDAO");

        Vector lista = new Vector();
        
        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        
        try{
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

           sql = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo + ", PRO_RESTRINGIDO "
                    + " FROM E_PUI, E_PRO, E_PML "
                    + " WHERE " + sql_pui_codMun + "=" + sql_pro_codMun
                    + " AND " + sql_pui_codProc + "=" + sql_pro_cod
                    + " AND " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                   // MAI: indicamos que los procedimientos que solo se pueden iniciar por webService no salgan
                    + " AND PRO_SOLOWS<>1 " 
                    + " AND PRO_LIBRERIA<>1 " 
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                    + " AND "+ sql_uou_uor +"="+  sql_pui_uor + ")) "
                    + " AND " + sql_pro_fechDesd + "<=  " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1"
                    + " AND " + sql_pro_tipInic +"<>" + sinTipoProcs;

        sql += " UNION ";
        // Cuando es un procedimiento que tiene asociado cq UORs de entrada entonces el procedimiento se añade siempre
        // y cuando el usuario tenga alguna UOR asociada
        sql += "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo + ", PRO_RESTRINGIDO "
                    + " FROM E_PRO, E_PML "
                    + " WHERE " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                 // MAI: indicamos que los procedimientos que solo se pueden iniciar por webService no salgan
                    + " AND PRO_SOLOWS<>1 "
                    + " AND PRO_LIBRERIA<>1 " 
                    + " AND ( NOT EXISTS ( "
                      + " SELECT DISTINCT " +sql_pui_uor + " FROM E_PUI "
                      + " WHERE "+ sql_pui_codProc + "=" + sql_pro_cod + ") "
                    + " AND EXISTS ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod() + ")) "
                    + " AND " + sql_pro_fechDesd + "<=  " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + "<" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1"
          + " AND " + sql_pro_tipInic +"<>" + sinTipoProcs;
        sql += " ORDER BY "+ sql_pml_codProc+ " ASC ";



            
        if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientosUsuario--> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                DefinicionProcedimientosValueObject dpVO = new DefinicionProcedimientosValueObject();
                dpVO.setCodMunicipio((String) rs.getString(sql_pml_codMun));
                dpVO.setTxtCodigo((String) rs.getString(sql_pml_codProc));
                dpVO.setTxtDescripcion((String) rs.getString(sql_pml_valorCampo));
                
                String proRestringido = rs.getString("PRO_RESTRINGIDO");
                if(proRestringido!=null && !"".equals(proRestringido) && "1".equals(proRestringido)){
                    // Si el procedimiento está restringido => Se comprueba si el usuario tiene  permiso para trabajar con el y por tanto, iniciar expediente
                    
                    boolean tienePermiso = PermisoProcRestringidoDAO.getInstance().tieneUsuarioPermisoSobreProcedimientoRestringido(Integer.toString(uVO.getIdUsuario()), Integer.toString(uVO.getOrgCod()), dpVO.getTxtCodigo(), con);
                    m_Log.debug("******************* El usuario " + uVO.getIdUsuario() + " para el procedimiento " + dpVO.getTxtCodigo() + " permiso: " + tienePermiso);
                    if(tienePermiso) lista.addElement(dpVO);

                }else // Si el procedimiento no está restringido el usuario puede iniciar expediente
                    lista.addElement(dpVO);
                    
                /** NUEVO */                
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientosUsuario", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientosUsuario.Devolver conexion", bde);
            }
        }
        m_Log.debug("getListaExpedientesPendientes");
        return lista;
    }

    public Vector getListaProcedimientosUOR(String uor, String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("Inicio getListaProcedimientosUOR");

        Vector lista = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            oad = new AdaptadorSQLBD(params); 
            con = oad.getConnection();

            sql = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo +", DIGIT_DOC_REGISTRO"
                    + " FROM E_PUI, E_PRO, E_PML, PLUGIN_DOC_PROCEDIMIENTO "
                    + " WHERE (" + sql_pui_codMun + "=" + sql_pro_codMun
                    + " AND " + sql_pui_codProc + "=" + sql_pro_cod
                    + " AND COD_PROCEDIMIENTO = PRO_COD "
                    + " AND " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +sql_uor_codigo
                    + " FROM A_UOR "
                    + " WHERE "+ uor +"="+  sql_pui_uor + ")) "
                    + " AND " + sql_pro_fechDesd + "<= " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<=" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1" +
                    ")";


            sql+=" UNION SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo+", DIGIT_DOC_REGISTRO"
                    + " FROM E_PRO, E_PML, PLUGIN_DOC_PROCEDIMIENTO  WHERE" +
                    " (" + sql_pro_cod + " NOT IN (SELECT "+ sql_pui_codProc + " FROM e_pui)  "
                    + " AND " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND COD_PROCEDIMIENTO = PRO_COD"
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                    + " AND " + sql_pro_fechDesd + "<= " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<=" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1)"   ;
            sql+= " UNION SELECT DISTINCT e_tra.tra_mun,  e_tra.tra_pro,  pml_valor, DIGIT_DOC_REGISTRO "
                    + "FROM e_tra LEFT JOIN e_pml ON (pml_cod = e_tra.tra_pro AND pml_mun = e_tra.tra_mun) "
                    + "INNER JOIN E_PRO ON (pml_cod = pro_cod and pml_mun = pro_mun "
                    + " AND " + sql_pro_fechDesd + "<= " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<=" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1) "
                    +  "RIGHT JOIN e_tra_utr on (e_tra.tra_cod = e_tra_utr.tra_cod and "
                      + "e_tra.tra_mun = e_tra_utr.tra_mun and e_tra.tra_pro = e_tra_utr.tra_pro and tra_utr_cod = " + uor+ ") "
                    + " INNER JOIN PLUGIN_DOC_PROCEDIMIENTO"
                    + " ON (E_TRA.TRA_PRO = PLUGIN_DOC_PROCEDIMIENTO.COD_PROCEDIMIENTO)"
                        + "where e_tra.tra_utr =0 ";
            sql+= " UNION SELECT DISTINCT tra_mun,  tra_pro,  pml_valor, DIGIT_DOC_REGISTRO "
                    + "FROM e_tra LEFT JOIN e_pml ON (pml_cod = tra_pro AND pml_mun = tra_mun) "
                    + "INNER JOIN E_PRO ON (pml_cod = pro_cod and pml_mun = pro_mun "
                    + " AND " + sql_pro_fechDesd + "<= " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND ( " + sql_pro_fechHast + " IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<=" + sql_pro_fechHast + " ) "
                    + " AND " + sql_pro_estado + "=1) "
                    + " INNER JOIN PLUGIN_DOC_PROCEDIMIENTO"
                    + " ON (E_TRA.TRA_PRO = PLUGIN_DOC_PROCEDIMIENTO.COD_PROCEDIMIENTO)"
                    + "where tra_utr =1 or tra_uin = -99998 or tra_uin = " + uor;

                        
            sql+= " ORDER BY "+ sql_pml_valorCampo+ " ASC ";

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientosUOR--> "+ sql);            
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                DefinicionProcedimientosValueObject dpVO = new DefinicionProcedimientosValueObject();
                dpVO.setCodMunicipio((String) rs.getString(sql_pml_codMun));
                dpVO.setTxtCodigo((String) rs.getString(sql_pml_codProc));
                dpVO.setTxtDescripcion((String) rs.getString(sql_pml_valorCampo));
                dpVO.setProcedimientoDigit(rs.getString("DIGIT_DOC_REGISTRO"));
                
                lista.addElement(dpVO);
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientosUOR", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientosUOR.Devolver conexion", bde);
            }
        }
        m_Log.debug("Fin getListaProcedimientosUOR");
        return lista;
    }

    public Vector getListaProcedimientosVigentes(String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("Inicio getListaProcedimientosVigentes");

        Vector lista = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            oad = new AdaptadorSQLBD(params); 
            con = oad.getConnection();

            sql+="SELECT DISTINCT PML_MUN, PML_COD, PML_VALOR, DIGIT_DOC_REGISTRO" 
                    + " FROM E_PRO, E_PML, PLUGIN_DOC_PROCEDIMIENTO  " 
                    + "WHERE PRO_MUN= PML_MUN" 
                    + " AND PRO_COD = PML_COD" 
                    + " AND PML_CMP = 'NOM' "
                    + " AND PML_LENG ="+ idiomaDefecto
                    + " AND PRO_FLD <= " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY")
                    + " AND (PRO_FLH IS NULL "
                    + " OR " + oad.convertir(oad.convertir(
                    oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY"),
                    AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY") + "<= PRO_FLH) "
                    + " AND PRO_EST = 1 "
                    + " AND PRO_COD = COD_PROCEDIMIENTO"   ;
            sql+= " ORDER BY pml_valor ASC ";

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientosVigentes--> "+ sql);            
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                DefinicionProcedimientosValueObject dpVO = new DefinicionProcedimientosValueObject();
                dpVO.setCodMunicipio((String) rs.getString("PML_MUN"));
                dpVO.setTxtCodigo((String) rs.getString("PML_COD"));
                dpVO.setTxtDescripcion((String) rs.getString("PML_VALOR"));
                dpVO.setProcedimientoDigit(rs.getString("DIGIT_DOC_REGISTRO"));
                
                lista.addElement(dpVO);
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientosVigentes", e);
        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientosVigentes.Devolver conexion", bde);
            }
        }
        m_Log.debug("Fin getListaProcedimientosVigentes");
        return lista;
}

 public Vector getCamposListado(int codListado, String[] params)
            throws TramitacionException, TechnicalException {

    Vector resultado = new Vector();
    AdaptadorSQLBD abd = null;
    Connection conexion = null;
    Statement stmt = null;
    ResultSet rs = null;
    String sql = "";
    try{
      //m_Log.debug("A por el OAD");
      abd = new AdaptadorSQLBD(params);
      //m_Log.debug("A por la conexion");
      conexion = abd.getConnection();
      // Creamos la select con los parametros adecuados.
      sql = "SELECT * FROM A_CAMPLIST WHERE CAMPLIST_CODLIST="+codListado+"ORDER BY CAMPLIST_COD";
      if(m_Log.isDebugEnabled()) m_Log.debug(sql);
      stmt = conexion.createStatement();
      rs = stmt.executeQuery(sql);
      while(rs.next()){
        CamposListadosParametrizablesVO gVOCampos = new CamposListadosParametrizablesVO();
        gVOCampos.setCodCampo(Integer.parseInt(rs.getString("CAMPLIST_COD")));
        gVOCampos.setNomCampo(rs.getString("CAMPLIST_NOM"));
        int act=Integer.parseInt(rs.getString("CAMPLIST_ACTIVO"));
        String activo="";
        if (1==act){
            activo="SI";
        }else{
            activo="NO";
        }
        gVOCampos.setActCampo(activo);
        gVOCampos.setTamanoCampo(Integer.parseInt(rs.getString("CAMPLIST_TAMANO")));
        gVOCampos.setOrdenCampo(Integer.parseInt(rs.getString("CAMPLIST_ORDEN")));
        gVOCampos.setCampoSuplementario(false);
        gVOCampos.setColumnaCampo(rs.getString("CAMPLIST_COLUMNA"));
        resultado.add(gVOCampos);
      }
      rs.close();
      stmt.close();
    }catch (Exception e){
        e.printStackTrace();
        if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
    }finally{
        try{
            abd.devolverConexion(conexion);
        }catch (Exception e){
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
        }
    }
    return resultado;

    }
    public Vector getListaProcedimientosSoloUsuario(UsuarioValueObject uVO,String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaProcedimientosSoloUsuario");

        Vector lista = new Vector();
        Vector datosProcedimiento=null;

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

            String parteSelect = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo;
            String parteFrom = " FROM E_PUI, E_PRO, E_PML ";
            String pWhere = " WHERE " + sql_pro_estado + "=1"
                    + " AND " + sql_pui_codMun + "=" + sql_pro_codMun
                    + " AND " + sql_pui_codProc + "=" + sql_pro_cod
                    + " AND " + sql_pro_codMun + "=" + sql_pml_codMun
                    + " AND " + sql_pro_cod + "=" + sql_pml_codProc
                    + " AND " + sql_pml_campo + "="+ "'NOM' "
                    + " AND " + sql_pml_lengua+ "="+ idiomaDefecto
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                    + " AND "+ sql_uou_uor +"="+  sql_pui_uor + ")) OR(" +
                    "PRO_COD NOT IN (SELECT "+sql_pui_codProc+" FROM E_PUI))";
            String pOrder = " ORDER BY "+ sql_pml_valorCampo+ " ASC ";

            sql = parteSelect + parteFrom + pWhere + pOrder;

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientosSoloUsuario--> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                ElementoListaValueObject elvo = new ElementoListaValueObject();
                elvo.setIdentificador((String) rs.getString(sql_pml_codMun));
                elvo.setCodigo((String) rs.getString(sql_pml_codProc));
                elvo.setDescripcion((String) rs.getString(sql_pml_valorCampo));
                elvo.setOrden(i++);
                lista.addElement(elvo);
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientosSoloUsuario", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientosSoloUsuario.Devolver conexion", bde);
            }
        }

        m_Log.debug("getListaProcedimientosSoloUsuario");
        return lista;
    }

    public Vector getListaProcedimientos(UsuarioValueObject uVO,String[] params)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaProcedimientos");

        Vector lista = new Vector();
        Vector datosProcedimiento=null;

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";


        try{
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            
            String parteSelect = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo;
            
           

            String parteFrom = " FROM E_PRO, E_PML, E_PUI ";
            String pWhere = " WHERE " + sql_pro_cod + "=" + sql_pui_codProc;
            pWhere += " AND " + sql_pro_codMun + "=" + sql_pui_codMun;
            pWhere += " AND " + sql_pro_estado + "=1";
            pWhere += " AND " + sql_pro_codMun + "=" + sql_pml_codMun;
            pWhere += " AND " + sql_pro_cod + "=" + sql_pml_codProc;
            pWhere += " AND " + sql_pml_campo + "="+ "'NOM' ";
            pWhere += " AND " + sql_pml_lengua+ "="+ idiomaDefecto;
            pWhere += " AND (( "+sql_pui_uor+" IN( ";
            pWhere += " SELECT " + sql_uor_codigo;
            pWhere += " FROM A_UOR ";
            pWhere += " WHERE "+sql_uor_codigo + " IN ( SELECT "+ sql_uou_uor;
            pWhere += " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU ";
            pWhere += " WHERE " + sql_uou_usu + "="+ uVO.getIdUsuario();
            pWhere += " AND " + sql_uou_org + "=" + uVO.getOrgCod();
            pWhere += " AND " + sql_uou_ent+ "=" + uVO.getEntCod();
            pWhere += " ) ";
            pWhere += " ) ";
            pWhere += " AND " + sql_pro_tramInternet + " = 1) OR " + sql_pro_tramInternet + "=0) ";
            pWhere += " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";


            String parteSelect2 = "SELECT DISTINCT "+ sql_pml_codMun+ ","+sql_pml_codProc+ "," +sql_pml_valorCampo;

            String parteFrom2 = " FROM E_PRO, E_PML ";
            String pWhere2 = " WHERE " + sql_pro_estado + "=1";
            pWhere2 += " AND " + sql_pro_codMun + "=" + sql_pml_codMun;
            pWhere2 += " AND " + sql_pro_cod + "=" + sql_pml_codProc;
            pWhere2 += " AND " + sql_pml_campo + "="+ "'NOM' ";
            pWhere2 += " AND " + sql_pml_lengua+ "="+ idiomaDefecto;
            pWhere2 += " AND ( "+sql_pro_cod+" NOT IN( ";
            pWhere2 += " SELECT " + sql_pui_codProc;
            pWhere2 += " FROM E_PUI ";
            pWhere2 += " ) ";
            pWhere2 += " ) ";
            pWhere2 += " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

            String pOrder = " ORDER BY "+ sql_pml_valorCampo+ " ASC ";

            sql = parteSelect + parteFrom + pWhere;
            sql = sql + " UNION ";
            sql = sql + parteSelect2 + parteFrom2 + pWhere2;
            sql = sql + pOrder;


            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaProcedimientos--> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            int i=0;
            while(rs.next()){
                ElementoListaValueObject elvo = new ElementoListaValueObject();
                elvo.setIdentificador((String) rs.getString(sql_pml_codMun));
                elvo.setCodigo((String) rs.getString(sql_pml_codProc));
                elvo.setDescripcion((String) rs.getString(sql_pml_valorCampo));
                elvo.setOrden(i++);
                lista.addElement(elvo);
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaProcedimientos", e);

        } finally {
            try{
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            }catch(Exception bde) {
                bde.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(bde.getMessage());
                throw new TramitacionException("Error.TramitacionDAO.getListaProcedimientos.Devolver conexion", bde);
            }
        }

        m_Log.debug("getListaProcedimientos");
        return lista;
    }

        public void getNuevoExpediente(UsuarioValueObject uVO, TramitacionValueObject tvo, String[] params)
                throws TramitacionException, TechnicalException {
            
            AdaptadorSQLBD oad = new AdaptadorSQLBD(uVO.getParamsCon());
            Connection con = null;

            try {
                con = oad.getConnection();
                oad.inicioTransaccion(con);
                getNuevoExpediente(uVO, tvo, con);
                commitTransaction(oad, con);
            } catch (Exception e) {
                rollBackTransaction(oad, con);
                throw new TramitacionException("Error. TramitacionDAO.getNuevoExpediente", e);
            } finally {
                devolverConexion(oad, con);
            }
        }

    public void getNuevoExpediente(UsuarioValueObject uVO, TramitacionValueObject tvo,Connection con)
            throws TramitacionException, TechnicalException {

        TramitacionDAO.m_Log.info((Object)"getNuevoExpediente::BEGIN");
        final String organizacion = Integer.toString(uVO.getOrgCod());
        final Calendar cal = Calendar.getInstance();
        String ejercicio = String.valueOf(cal.get(1));
        String numero = "";
        String proc = "";
        String uor = "";
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql = "";
        boolean res = false;
        int updated = 0;
        Boolean insertarNuevo;
        final AdaptadorSQLBD oad = new AdaptadorSQLBD(uVO.getParamsCon());
        
        
        try {            
            if("DEM50".equals(tvo.getCodProcedimiento()) && "2023".equals(String.valueOf(cal.get(1)))){ //caso específico del procedimiento DEM50: en el año 2023 iniciar de 2024
                ejercicio = "2024";
            } else if (tvo.getEjercicioRegistro() != null) { //caso en que el procedimiento esté marcado para que sus expedientes se inicien según el año de la anotación
                ejercicio = tvo.getEjercicioRegistro();
            }
            res = false;
            proc = tvo.getCodProcedimiento();
            uor = "0";
            sql = "SELECT " + oad.funcionMatematica(16, new String[] { TramitacionDAO.sql_nex_num }) + " AS NEX_NUM" 
                + " FROM E_NEX " 
                + " WHERE " + TramitacionDAO.sql_nex_codMun + "=" + organizacion 
                + " AND " + TramitacionDAO.sql_nex_ejer + "=" + ejercicio 
                + " AND " + TramitacionDAO.sql_nex_codProc + "='" + proc + "' " 
                + " AND " + TramitacionDAO.sql_nex_uor + "=" + uor;
            
            TramitacionDAO.m_Log.info((Object)("Query para consultar el n\u00famero de expediente siguiente = " + sql));
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery(); 
            rs.next();
            m_Log.info("valor del nex num es " + rs.getString("NEX_NUM"));
            insertarNuevo = StringUtils.isNotNullOrEmptyOrNullString(rs.getString("NEX_NUM")) ? Boolean.FALSE : Boolean.TRUE;
            rs.close();
            stmt.close();
          
            if (!insertarNuevo) {
                
                sql = "UPDATE E_NEX SET " + TramitacionDAO.sql_nex_num + 
                    " = NEX_NUM + 1 " + " WHERE " 
                    + TramitacionDAO.sql_nex_codMun + "=" + organizacion 
                    + " AND " + TramitacionDAO.sql_nex_ejer + "=" + ejercicio 
                    + " AND " + TramitacionDAO.sql_nex_codProc + "='" + proc + "' " 
                    + " AND " + TramitacionDAO.sql_nex_uor + "=" + uor;
                m_Log.info("Actualizamos el valor del procedemiento :" + sql);
                stmt = con.prepareStatement(sql);
                updated = stmt.executeUpdate();
                stmt.close();
                sql = "SELECT NEX_NUM FROM E_NEX WHERE NEX_PRO= ? AND NEX_EJE=? AND NEX_MUN=? AND NEX_UOR=?";
                stmt = con.prepareStatement(sql);
                int contbd = 1;
                stmt.setString(contbd++, proc);
                stmt.setString(contbd++, ejercicio);
                stmt.setString(contbd++, organizacion);
                stmt.setString(contbd++, uor);
                rs = stmt.executeQuery();
                int numExpAux = 0;
                while (rs.next()) {
                    numExpAux = rs.getInt("NEX_NUM");
                }
                numero = String.valueOf(numExpAux);
            }
            else {
                
                numero = "1";
                sql = "INSERT INTO E_NEX (" + TramitacionDAO.sql_nex_codMun + ","
                    + TramitacionDAO.sql_nex_ejer + ","
                    + TramitacionDAO.sql_nex_codProc + ","
                    + TramitacionDAO.sql_nex_uor + "," 
                    + TramitacionDAO.sql_nex_num + " ) " 
                    + " VALUES (" + organizacion + "," + ejercicio + ",'" + proc + "'," + uor + "," + numero + ")";
                m_Log.info("Query para crear el primer expediente de un procedimiento siguiente = " + sql);
                stmt = con.prepareStatement(sql);
                updated = stmt.executeUpdate();
                
            }

            TramitacionDAO.m_Log.info((Object)("se actualiza/inserta en E_NEX el \u00faltimo n\u00famero de expediente: " + numero));
//            if (updated <= 0) {
//                throw new TramitacionException("Error. TramitacionDAO.getNuevoExpediente");
//            }
            res = true;
            rs.close();
            stmt.close();
        }
        catch (Exception e) {
            m_Log.error("Error recuperando o insertando el último número de un expediente : "+ e.getMessage());
            if (TramitacionDAO.m_Log.isErrorEnabled()) {
                TramitacionDAO.m_Log.error((Object)e.getMessage());
            }
            ejercicio = "";
            numero = "";
            proc = "";
            uor = "";
            throw new TramitacionException("Error. TramitacionDAO.getNuevoExpediente", (Throwable)e);
        }
        finally {
            tvo.setEjercicio(ejercicio);
            if (numero.length() > 0 && numero.length() < 6) {
                numero = "000000".substring(0, 6 - numero.length()) + numero;
            }
            tvo.setNumeroSimple(numero);
            tvo.setNumero(ejercicio + "/" + proc + "/" + numero);
            try {
                if (stmt != null) {
                    stmt.close();
                }
                if (rs != null) {
                    rs.close();
                }
            }
            catch (SQLException e2) {
               m_Log.error("Error cerrando conexión : "+ e2.getMessage());
            }
        }
        TramitacionDAO.m_Log.debug((Object)"TramitacionDAO.getNuevoExpediente finalizado");
    }
    
    public void getNumeroExpediente(TramitacionValueObject tvo, Connection con)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getNumeroExpediente");

        PreparedStatement stmt = null;
        ResultSet rs = null;
        ExpedienteRelacionadoVO expedienteRelacionado = new ExpedienteRelacionadoVO();
        ArrayList<String> listaCodigosExpedientesRelacionados = new ArrayList<String>();
        ArrayList<String> listaCodProcedimientosExpedientesRelacionados = new ArrayList<String>();
        Boolean multiplesAnotaciones = false;
        try {
             
            //david.vidal #113619 se incluye la tabla e_exp para integrar la ordenacion por 
            
            String sql = "SELECT EXR_NUM, EXR_PRO, PML_VALOR, EXP_FEI FROM E_EXR, E_PML,E_EXP WHERE EXP_PRO = EXR_PRO  AND EXP_NUM = EXR_NUM " + 
                    " AND EXR_DEP = ? AND EXR_UOR = ? " +
                    " AND EXR_TIP = ? AND EXR_EJR = ? AND EXR_NRE = ? AND EXR_PRO = PML_COD " +
                    " AND PML_CMP = 'NOM' AND PML_LENG = '"+idiomaDefecto+"'" ;
            
            String sql2 = "SELECT EXR_NUM, EXR_PRO, PML_VALOR , EXP_FEI FROM HIST_E_EXR, E_PML,HIST_E_EXP WHERE EXP_PRO = EXR_PRO  AND EXP_NUM = EXR_NUM " + 
                    " AND EXR_DEP = ? AND EXR_UOR = ? " +
                    " AND EXR_TIP = ? AND EXR_EJR = ? AND EXR_NRE = ? AND EXR_PRO = PML_COD " +
                    " AND PML_CMP = 'NOM' AND PML_LENG = '"+idiomaDefecto+"'" + 
                    " ORDER BY EXP_FEI DESC"; 
            
            String sqlfinal=sql+" union all "+sql2;

            if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getNumeroExpediente--> " + sqlfinal);

            stmt = con.prepareStatement(sqlfinal);
            int i = 1;
            stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
            stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
            stmt.setString(i++, tvo.getTipoRegistro());
            stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
            stmt.setInt(i++, Integer.parseInt(tvo.getNumero()));
            stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
            stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
            stmt.setString(i++, tvo.getTipoRegistro());
            stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
            stmt.setInt(i, Integer.parseInt(tvo.getNumero()));

            rs = stmt.executeQuery();
            while (rs.next()) {
                /* Original
                tvo.setNumeroExpediente(rs.getString("EXR_NUM"));
                tvo.setCodProcedimiento(rs.getString("EXR_PRO"));
                tvo.setDescProcedimiento(rs.getString("PML_VALOR"));
                */
                listaCodigosExpedientesRelacionados.add(rs.getString("EXR_NUM"));
                listaCodProcedimientosExpedientesRelacionados.add(rs.getString("EXR_PRO"));
                if(listaCodigosExpedientesRelacionados.size() > 1 && multiplesAnotaciones == false){
                    multiplesAnotaciones = true;
                }//if(listaCodigosExpedientesRelacionados.size() > 1 && multiplesAnotaciones == false)
            }//while (rs.next() 

            if(listaCodigosExpedientesRelacionados != null && listaCodigosExpedientesRelacionados.size() > 0 ){
                expedienteRelacionado.setNumExpedientesRelacionados(listaCodigosExpedientesRelacionados);
            }//if(listaCodigosExpedientesRelacionados.size() > 0 )
            if(listaCodProcedimientosExpedientesRelacionados != null && listaCodProcedimientosExpedientesRelacionados.size() > 0){
                expedienteRelacionado.setCodProcedimientoExpedientesRelacionados(listaCodProcedimientosExpedientesRelacionados);
            }//if(listaCodProcedimientosExpedientesRelacionados.size() > 0)
            tvo.setExpedientesRelacionados(expedienteRelacionado);
        } catch (Exception e) {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getNumeroExpediente", e);
        } finally {
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(stmt);
            m_Log.debug("getNumeroExpediente");
        }
    }

    public int localizaExpediente(TramitacionValueObject tvo,String[] params)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("adjuntaExpediente");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        Vector listaExpedientes = new Vector();
        String existe = "no";
        int res = 0;

        try
        {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();

            res = localizaExpediente(con,tvo);

        } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", e);
        } finally {
            try{
                oad.devolverConexion(con);
            }catch(Exception ex){
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error("Excepcion capturada en: " + getClass().getName());
            }
        }
        m_Log.debug("adjuntaExpediente");
        return res;
    }

    public int localizaExpediente(Connection con,TramitacionValueObject tvo)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("localizaExpediente");

        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        Vector listaExpedientes = new Vector();
        int res = -1;

        try
        {
             sql = "SELECT EXP_EJE, EXP_PRO, EXP_MUN FROM E_EXP "                   
                    + " WHERE EXP_NUM LIKE ? ";	
             sql += " UNION SELECT EXP_EJE, EXP_PRO, EXP_MUN FROM HIST_E_EXP "
                    + " WHERE EXP_NUM LIKE ? ";
            stmt = con.prepareStatement(sql);
            
            int i = 1;

            stmt.setString(i++, tvo.getNumeroExpediente());
            stmt.setString(i++, tvo.getNumeroExpediente());
            
            rs = stmt.executeQuery();
            while(rs.next()){
                tvo.setCodProcedimiento(rs.getString("EXP_PRO"));
                tvo.setEjercicio(rs.getString(sql_exp_ejer));
                tvo.setCodMunicipio(rs.getString(sql_exp_codMun));
                res =1;
            }

        } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", e);
        } finally{
            try {
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
        m_Log.debug("localizaExpediente");
        return res;
    }

    public int localizaExpedienteDesdeRegistro(Connection con,TramitacionValueObject tvo)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("localizaExpedienteDesdeRegistro");

        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        Vector listaExpedientes = new Vector();
        int res = -1;
        String codProcedimiento = tvo.getCodProcedimiento();

        try 
        {
            sql = "SELECT "+  sql_exp_num + "," + sql_exp_ejer +","+ sql_exp_codProc + "," + sql_exp_codMun+ " FROM E_EXP "
                    + " WHERE "+ sql_exp_num + " LIKE '" + tvo.getNumeroExpediente() +"'";
            
            
            String sql2 = "SELECT "+  sql_exp_num + "," + sql_exp_ejer +","+ sql_exp_codProc + "," + sql_exp_codMun+ " FROM HIST_E_EXP "
                    + " WHERE "+ sql_exp_num + " LIKE '" + tvo.getNumeroExpediente() +"'";
            
            String sqlfinal= sql+ " union all "+ sql2;
            stmt = con.prepareStatement(sqlfinal); 
            rs = stmt.executeQuery();
            while(rs.next()){
                String cP = rs.getString(sql_exp_codProc);
                tvo.setCodProcedimiento(cP);
                tvo.setEjercicio(rs.getString(sql_exp_ejer));
                tvo.setCodMunicipio(rs.getString(sql_exp_codMun));
                if(codProcedimiento != null && !codProcedimiento.equals("")) {
                    if(codProcedimiento.equals(cP)) {
                        res = 1;
                    }	else res=2;
                } else {
                    res =1;
                }
            }
        m_Log.debug("localizaExpedienteDesdeRegistro");
        return res;
        } catch (SQLException ex) {
            ex.printStackTrace();
            m_Log.error(ex.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.localizaExpedienteDesdeRegistro", ex);
        }finally{
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(stmt);
            }

    }

    public Vector localizaExpedienteByNum(TramitacionValueObject tvo,String codUsuario,String codOrganizacion, String[] params)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("localizaExpediente");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        Vector listaExpedientes = new Vector();
        Vector res = new Vector();

        try
        {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();

            /** ORIGINAL
            sql = "SELECT "+  sql_exp_num + "," + sql_exp_ejer +","+ sql_exp_codProc + "," + sql_exp_codMun+ " FROM E_EXP "
                    + " WHERE "+ sql_exp_num + " LIKE '" + tvo.getNumeroExpediente() +"'";
            */
            
            sql = "SELECT  EXP_NUM, EXP_EJE, EXP_PRO, EXP_MUN FROM E_EXP,E_PRO "
                 + " WHERE EXP_NUM LIKE '" + tvo.getNumeroExpediente() +"' AND EXP_PRO=PRO_COD AND EXP_MUN=PRO_MUN " +
                    " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + codUsuario + " AND ORG_COD=" + codOrganizacion + ")))";


            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: adjuntaExpediente--> "+ sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            while(rs.next()){
                tvo.setCodProcedimiento(rs.getString(sql_exp_codProc));
                tvo.setEjercicio(rs.getString(sql_exp_ejer));
                tvo.setCodMunicipio(rs.getString(sql_exp_codMun));
                tvo.setNumeroExpediente(rs.getString(sql_exp_num));
                res.addElement(tvo);
            }

        } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", e);
        } finally{
            try {
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
        m_Log.debug("localizaExpediente");
        return res;
    }

    /* Metodo para añadir los interesados de un registro a un expediente en la opcion adjuntar expediente
     * Se añaden aquellos terceros que no pertenecen al expediente
     * Si los terceros son el mismo pero distintas versiones o con otro domicilio se deja el que está
     */

    public int setInteresadosReg2Exp(TramitacionValueObject tramVO,RegistroValueObject elRegistroESVO,GeneralValueObject gVO, Vector tercerosSoloEnRegistro, String[] params)
            throws TramitacionException, TechnicalException,BDException
    {


        if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO->setInteresadosReg2Exp");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement st = null;
        ResultSet rs = null;
        String sql="";
        int resultado;
        int resultado1;
        int resultadoFinal = 0;

        try
        {
        
        String procExpediente=tramVO.getCodProcedimiento();
        String codMunicipio=tramVO.getCodMunicipio();
        String ejercicio=tramVO.getEjercicio();
        String numero=tramVO.getNumeroExpediente();
        String codigoRolDefecto=tramVO.getCodigoRolDefectoInteresados();

        String hayListaTercerosReg=(String)gVO.getAtributo("hayListaTerc");
        
        String procAsiento = elRegistroESVO.getCodProcedimiento();


        // Hay lista de interesados (no viene de un servicio WEB)
        if (hayListaTercerosReg.equals("si")) {
            if (m_Log.isDebugEnabled()) m_Log.debug("Se añaden los interesados del registro al expediente.");

            // Comprobamos si el procedimiento del asiento y el del nuevo expediente coinciden
            boolean mismoProcedimiento = procExpediente.equals(procAsiento);
            if (mismoProcedimiento) {
                if (m_Log.isDebugEnabled()) m_Log.debug("El procedimiento es el mismo que el del asiento");
            } else {
                if (m_Log.isDebugEnabled()) m_Log.debug("El procedimiento es distinto que el del asiento");
            }

            Vector codigoInteresadosReg=new Vector();
            for(int i=0;i<tercerosSoloEnRegistro.size();i++)
               {
                   GeneralValueObject interesadogVO = new GeneralValueObject();
                   interesadogVO=(GeneralValueObject)tercerosSoloEnRegistro.get(i);
                   codigoInteresadosReg.add((String)interesadogVO.getAtributo("codigoTercero"));

              }

            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();



            // Obtenemos la lista de terceros asociados al asiento
            sql = "SELECT EXT_TER, EXT_NVR, EXT_DOT, EXT_ROL, COUNT(RES_TER) MOSTRAR "+
                 "FROM R_EXT LEFT JOIN R_RES " +
                 "ON(EXT_UOR = RES_UOR AND EXT_DEP = RES_DEP AND EXT_TIP = RES_TIP AND EXT_EJE = RES_EJE AND EXT_NUM = RES_NUM AND EXT_TER = RES_TER)" +
                 " WHERE " + r_ext_coduor + "=" + Integer.toString(elRegistroESVO.getUnidadOrgan()) +
                 " AND " + r_ext_dep + "=" + Integer.toString(elRegistroESVO.getIdentDepart()) +
                 " AND " + r_ext_tipo + "='" + elRegistroESVO.getTipoReg() + "'" +
                 " AND " + r_ext_ano + "=" + Integer.toString(elRegistroESVO.getAnoReg()) +
                 " AND " + r_ext_numero + "=" + Long.toString(elRegistroESVO.getNumReg()) + " " +
                 "GROUP BY EXT_TER, EXT_NVR, EXT_DOT, EXT_ROL";

            if (m_Log.isDebugEnabled()) m_Log.debug(sql);
            st = con.prepareStatement(sql);
            rs = st.executeQuery();

            // Se prepara un statement para insertar los terceros en el expediente
            sql = "INSERT INTO E_EXT ( " + ext_mun + "," + ext_eje + "," + ext_num + "," + ext_ter + "," +
                                           ext_nvr + "," + ext_dot + "," + ext_rol + "," + ext_pro + ", MOSTRAR) " +
                  "VALUES ( " + codMunicipio + "," + ejercicio + ",'" + numero + "',?,?,?,?,'" + procExpediente + "', ?)";

            if (m_Log.isDebugEnabled()) m_Log.debug(sql);
            PreparedStatement ps = con.prepareStatement(sql);

            int j;
            
            
            while (rs.next()) {
                if(codigoInteresadosReg.contains(rs.getString(r_ext_ter)))
                {
                    j = 1;
                    ps.setInt(j++, rs.getInt(r_ext_ter));
                    ps.setInt(j++, rs.getInt(r_ext_nvr));
                    ps.setInt(j++, rs.getInt(r_ext_dot));
                    if (mismoProcedimiento) {
                        // Se conservan los roles

                        ps.setInt(j++, rs.getInt(r_ext_rol));
                        if ((rs.getInt(r_ext_rol)) == (Integer.parseInt(codigoRolDefecto))) {
                            ps.setBoolean(j++, rs.getBoolean("MOSTRAR"));
                        } else {
                            ps.setBoolean(j++, false);
                        }
                    } else {
                        // Se usa el rol por defecto del procedimiento

                        ps.setInt(j++, Integer.parseInt(codigoRolDefecto)); // Se usa el mapeo
                        ps.setBoolean(j++, rs.getBoolean("MOSTRAR"));
                    }
                   

                    ps.executeUpdate();
                }
            }

            ps.close();
            rs.close();
            st.close();
            resultado1=1;

        
        } 
         } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", e);
        } finally{
            try {
                if (st!=null) st.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }

        
        return 1;

    }

     /* Metodo para añadir los interesados de un registro EXTERNO a un expediente en la opcion adjuntar expediente
     * Se añaden aquellos terceros que no pertenecen al expediente, si existe alguno que no existe en el SGE se da de alta
     * Si los terceros son el mismo pero distintas versiones o con otro domicilio se deja el que está
     */

    public int setInteresadoExternoReg2Exp(TramitacionValueObject tramVO,MantAnotacionRegistroForm registroForm,GeneralValueObject gVO,  UsuarioValueObject usuarioVO,String[] params)
            throws TramitacionException, TechnicalException,BDException
    {


        if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO->setInteresadoExternoReg2Exp");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement st = null;
        ResultSet rs = null;
        String sql="";
        

        try
        {

        String procExpediente=tramVO.getCodProcedimiento();
        String codMunicipio=tramVO.getCodMunicipio();
        String ejercicio=tramVO.getEjercicio();
        String numero=tramVO.getNumeroExpediente();
        String codigoRolDefecto=tramVO.getCodigoRolDefectoInteresados();
       
        int codigoPaisPorDefecto=0;
        int codDom=0;
        int codTer=0;
        int version=1;
        int mostrar=0;

        RegistroValueObject rgVO=(RegistroValueObject)registroForm.getRegistro();
        String descProvInteresado=rgVO.getProvInteresado();
        String descMunInteresado=rgVO.getMunInteresado();
        String domicilioCompleto=rgVO.getDomCompletoInteresado();

        //En el formulario no tengo estos datos
        String nombreInteresadoExterno=rgVO.getNombreInteresadoExterno();
        String apellido1InteresadoExterno=rgVO.getApellido1InteresadoExterno();
        String apellido2InteresadoExterno=rgVO.getApellido2InteresadoExterno();
        String nombreCompletoInteresadoExterno=registroForm.getTxtInteresado();
        String codExternoTercero=rgVO.getCodTerceroExterno();


        //Comprobamos si existe el tercero externo en el SGE en función de su Documento
        CondicionesBusquedaTerceroVO conds= new CondicionesBusquedaTerceroVO();
        if(("".equals(registroForm.getTxtDNI()))||(" ".equals(registroForm.getTxtDNI()))||(registroForm.getTxtDNI()==null))
        {
            conds.setApellido1(apellido1InteresadoExterno);
            conds.setApellido2(apellido2InteresadoExterno);
            conds.setNombre(nombreInteresadoExterno);
        }
        else
        {
            conds.setDocumento(registroForm.getTxtDNI());
        }
       
        conds.setTipoDocumento(-1);

        oad = new AdaptadorSQLBD(params);
        con = oad.getConnection();

        sql = "SELECT PRM_PAI FROM T_PRM";

        if (m_Log.isDebugEnabled()) m_Log.debug(sql);
        st = con.prepareStatement(sql);
        rs = st.executeQuery();

          if (rs.next()) {

              codigoPaisPorDefecto=rs.getInt(1);
          }
        rs.close();
        st.close();

        //obtener la provincia
        ProvinciasDAO provinciasDAO = ProvinciasDAO.getInstance();
        GeneralValueObject gVO1=provinciasDAO.getProvinciaByPaisAndDesc(codigoPaisPorDefecto, descProvInteresado, params);
        String codigoProvincia =(String)gVO1.getAtributo("codigoProvincia");
        int codProv=Integer.parseInt(codigoProvincia);

        //obtener el municipio
        MunicipiosDAO municipiosDAO = MunicipiosDAO.getInstance();
        MunicipioVO munVO=municipiosDAO.getMunicipioByPaisAndProvAndDesc(codigoPaisPorDefecto, codProv,descMunInteresado, params);
        int codigoMunicipio =munVO.getCodigoMunicipio();
        
        TercerosValueObject terVO=new TercerosValueObject();

        Vector terceroInterno=TercerosManager.getInstance().getTerceroInterno(conds, params);

        if(terceroInterno.size()>0) //Existe un tercero interno que coincide con el Externo
        {

            terVO=(TercerosValueObject)terceroInterno.get(0);


            //Insertar el domicilio
            DomicilioSimpleValueObject domicilioVO=new DomicilioSimpleValueObject();
            domicilioVO.setIdPais(Integer.toString(codigoPaisPorDefecto));
            domicilioVO.setIdProvincia(codigoProvincia);
            domicilioVO.setIdMunicipio(Integer.toString(codigoMunicipio));
            domicilioVO.setNormalizado("2");
            domicilioVO.setDomicilio(domicilioCompleto);
            
            if((terVO.getDomPrincipal()==null) ||(terVO.getDomPrincipal().equals("")))
            domicilioVO.setEsDomPrincipal("true");
            else domicilioVO.setEsDomPrincipal("false");
            domicilioVO.setEnPadron("0");

           
            Vector domicilio=new Vector();
            domicilio.add(domicilioVO);
            terVO.setDomicilios(domicilio);

            codDom=TercerosManager.getInstance().setDomicilioTercero(terVO, params);

           
           codTer=Integer.parseInt(terVO.getIdentificador());
           version =Integer.parseInt(terVO.getVersion());


        }
        else //No existe el tercero interno
        {
            //insertar el tercero

             terVO.setTipoDocumento(registroForm.getCbTipoDoc());
             terVO.setDocumento(registroForm.getTxtDNI());             
             terVO.setTelefono(registroForm.getTxtTelefono());
             terVO.setEmail(registroForm.getTxtCorreo());
             terVO.setApellido1(apellido1InteresadoExterno);
             terVO.setApellido2(apellido2InteresadoExterno);
             terVO.setNombre(nombreInteresadoExterno);
             terVO.setNombreCompleto(nombreCompletoInteresadoExterno);
             terVO.setNormalizado("0");
             terVO.setSituacion('A');
             terVO.setUsuarioAlta(Integer.toString(usuarioVO.getIdUsuario()));
             terVO.setModuloAlta(Integer.toString(usuarioVO.getAppCod()));
             terVO.setCodTerceroOrigen(codExternoTercero);

             codTer=TercerosManager.getInstance().setTercero(terVO, params);
             version=1; //Es la primera version del tercero

             //insertar el domicilio
            DomicilioSimpleValueObject domicilioVO=new DomicilioSimpleValueObject();
            domicilioVO.setIdPais(Integer.toString(codigoPaisPorDefecto));
            domicilioVO.setIdProvincia(codigoProvincia);
            domicilioVO.setIdMunicipio(Integer.toString(codigoMunicipio));
            domicilioVO.setNormalizado("2");
            domicilioVO.setDomicilio(domicilioCompleto);
            domicilioVO.setEnPadron("0");
            domicilioVO.setEsDomPrincipal("true");
            Vector domicilio=new Vector();
            domicilio.add(domicilioVO);
            terVO.setDomicilios(domicilio);
            terVO.setIdentificador(Integer.toString(codTer));


            codDom=TercerosManager.getInstance().setDomicilioTercero(terVO, params);
        }
        
         //Asociar al expediente

            //Comprobar si para el expediente existe algun tercero que se muestre
            sql = "SELECT * FROM E_EXT WHERE " + ext_num + "='" +numero +"' AND MOSTRAR=1" ;

            //if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: comprobarExpediente--> "+ sql);
            st = con.prepareStatement(sql);
            rs = st.executeQuery();
            if(rs.next()){
                mostrar=0;
            }
            else mostrar=1;
            st.close();
            rs.close();


             sql = "INSERT INTO E_EXT ( " + ext_mun + "," + ext_eje + "," + ext_num + "," + ext_ter + "," +
                                           ext_nvr + "," + ext_dot + "," + ext_rol + "," + ext_pro + ", MOSTRAR) " +
                  "VALUES ( " + codMunicipio + "," + ejercicio + ",'" + numero + "',"+codTer+","+version+","+codDom+","+codigoRolDefecto+",'" + procExpediente + "', "+mostrar+")";

            if (m_Log.isDebugEnabled()) m_Log.debug(sql);
            st = con.prepareStatement(sql);
            st.executeUpdate();

            st.close();



         } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", e);
        } finally{
            try {
                if (st!=null) st.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }


        return 1;

    }

    public String comprobarExpediente(TramitacionValueObject tvo,String[] params)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("comprobarExpediente");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        String numeroExpediente = "";

        try
        {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            if ("SGE".equals(tvo.getOrigen())) {
                sql = "SELECT " + sql_exr_num + " FROM E_EXR WHERE " + sql_exr_dep + "=" + tvo.getCodDepartamento()
                        + " AND " + sql_exr_uor + "=" + tvo.getCodUnidadRegistro() + " AND "
                        + sql_exr_ejr + "=" + tvo.getEjercicioRegistro() + " AND " + sql_exr_nre
                        + " = " + tvo.getNumero() + " AND " + sql_exr_tip + "='"
                        + tvo.getTipoRegistro() + "'";

                //if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: comprobarExpediente--> "+ sql);
                stmt = con.prepareStatement(sql);
                rs = stmt.executeQuery();
                while (rs.next()) {
                    numeroExpediente = rs.getString(sql_exr_num);
                }
            } else {
                sql = "SELECT EXREXT_NUM FROM E_EXREXT WHERE EXREXT_UOR=" + tvo.getCodUnidadRegistro() + " AND "
                        + "EXREXT_EJE=" + tvo.getEjercicioRegistro() + " AND EXREXT_NRE=" + tvo.getNumero()
                        + " AND EXREXT_TIP='"+ tvo.getTipoRegistro() + "'";
                stmt = con.prepareStatement(sql);
                rs = stmt.executeQuery();
                while (rs.next()) {
                    numeroExpediente = rs.getString("EXREXT_NUM");
                }
            }

        } catch (SQLException ex) {
            ex.printStackTrace();
        } catch (Exception e) {
            e.printStackTrace();
            m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.comprobarExpediente", e);
        } finally {
            try {
                if (stmt!=null) stmt.close();
                if (rs!=null) rs.close();
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
        m_Log.debug("comprobarExpediente");
        return numeroExpediente;
    }

    public int recuperarAsiento(TramitacionValueObject tvo,String[] params)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("recuperarAsiento");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        int res = 0;
        String expedientesEliminar = tvo.getexpedientesEliminar();
               
        try {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            oad.inicioTransaccion(con);
            String sql = "";
            if (!"".equals(expedientesEliminar) && !"null".equals(expedientesEliminar) && expedientesEliminar.length()>=1){
                sql = "DELETE FROM E_EXR WHERE " + sql_exr_dep + "=" + tvo.getCodDepartamento() + 
                    " AND " + sql_exr_uor + "=" + tvo.getCodUnidadRegistro() + " AND " +
                    sql_exr_ejr + "=" + tvo.getEjercicioRegistro() + " AND " + sql_exr_nre +
                    " = " + tvo.getNumero() + " AND " + sql_exr_tip + "='" +
                        tvo.getTipoRegistro() + "' AND EXR_NUM IN (" + expedientesEliminar + ")";
                
                
                if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: recuperarAsiento--> "+ sql);
                stmt = con.prepareStatement(sql);
                res = stmt.executeUpdate();
                stmt.close();
                
                if(res == 0){
                    sql = "DELETE FROM HIST_E_EXR WHERE " + sql_exr_dep + "=" + tvo.getCodDepartamento() + 
                        " AND " + sql_exr_uor + "=" + tvo.getCodUnidadRegistro() + " AND " +
                        sql_exr_ejr + "=" + tvo.getEjercicioRegistro() + " AND " + sql_exr_nre +
                        " = " + tvo.getNumero() + " AND " + sql_exr_tip + "='" +
                            tvo.getTipoRegistro() + "' AND EXR_NUM IN (" + expedientesEliminar + ")";


                    if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: recuperarAsiento--> "+ sql);
                    stmt = con.prepareStatement(sql);
                    res = stmt.executeUpdate();
                    stmt.close();
                }
            }
                       
            sql = "UPDATE R_RES SET " +  sql_res_estado + "=0 WHERE " +
                    sql_res_codDpto + "=" + tvo.getCodDepartamento() + " AND " + sql_res_codUnid + "=" +
                    tvo.getCodUnidadRegistro() + " AND " + sql_res_tipoReg + "='" + tvo.getTipoRegistro() +
                    "' AND " + sql_res_ejer + "=" + tvo.getEjercicioRegistro() + " AND " +
                    sql_res_num + "=" + tvo.getNumero();
            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: recuperarAsiento--> "+ sql);
            stmt = con.prepareStatement(sql); 
            res = stmt.executeUpdate();
            stmt.close();
            // Insercion en el histórico de movimientos
            HistoricoMovimientoValueObject hvo = new HistoricoMovimientoValueObject();
            hvo.setCodigoUsuario(tvo.getIdUsuario());
            hvo.setTipoEntidad(ConstantesDatos.HIST_ENTIDAD_ANOTACION);
            hvo.setCodigoEntidad(HistoricoAnotacionHelper.crearClaveHistorico(tvo));
            hvo.setTipoMovimiento(ConstantesDatos.HIST_ANOT_RECUPERAR);
            hvo.setDetallesMovimiento(HistoricoAnotacionHelper.crearXMLRecuperarHistorico());
            HistoricoMovimientoManager.getInstance().insertarMovimientoHistorico(hvo, con, params);
            
            oad.finTransaccion(con);

        } catch (Exception e) {
            oad.rollBack(con);
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.recuperarAsiento", e);
        } finally {
            try {
                if (stmt!=null) stmt.close();
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
        m_Log.debug("recuperarAsiento");
        return res;
    }


    public int insertarExpediente(Connection con, TramitacionValueObject tvo, int ori, String tipoOp)
            throws TramitacionException, TechnicalException, BDException {

        m_Log.debug("insertarExpediente");

        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql;
        int ejercicio = 0;
        String procedimiento = "";
        int municipio = 0;
        String numeroExpediente="";
        int res = 0;
        boolean existeRelacion = false;

        try {

            sql = "SELECT EXR_NUM, EXR_MUN, EXR_EJE, EXR_PRO FROM E_EXR WHERE EXR_DEP = ? AND EXR_UOR = ? " +
                    "AND EXR_TIP = ? AND EXR_EJR = ? AND EXR_NRE = ?";
            if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: insertarExpediente--> " + sql);

            stmt = con.prepareStatement(sql);
            int i = 1;
            stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
            stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
            stmt.setString(i++, tvo.getTipoRegistro());
            stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
            stmt.setInt(i, Integer.parseInt(tvo.getNumero()));
            rs = stmt.executeQuery();

            if (rs.next()) {
                existeRelacion = true;
                numeroExpediente = rs.getString("EXR_NUM");
                municipio = rs.getInt("EXR_MUN");
                ejercicio = rs.getInt("EXR_EJE");
                procedimiento = rs.getString("EXR_PRO");
            }
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(stmt);

            /** Una anotación de registro solo puede estar asociada a un expediente.
             * Si existe una relación en BBDD habrá que comprobar si es o no la adecuada.
             */

            String existe = "no";
            if (numeroExpediente.equals(tvo.getNumeroExpediente())) {
                existe = "yaRelacionado";
            } else if (existeRelacion){
                    existe = "si";
            }
            
            // #253742: Añadir valor de fecha actual al insertar
            java.util.Date fechoraActual = new java.util.Date();
            java.sql.Timestamp sqlTimestamp = new java.sql.Timestamp(fechoraActual.getTime());
            m_Log.debug(" ---------- tvo.getNumeroExpediente() : " +  tvo.getNumeroExpediente());
            if (("si".equals(existe))&&(tvo.getNumeroExpediente()!=null) && (!tvo.getDejarAnotacionBuzonEntrada())) {
                sql = "UPDATE E_EXR SET EXR_FECHAINSMOD = ?,EXR_NUM = ?,EXR_ORIGEN=?";
                if (tvo.getCodProcedimiento() != null && !tvo.getCodProcedimiento().equals("")) sql += ", EXR_PRO = ?";                
                sql += " WHERE EXR_DEP = ? AND EXR_UOR = ? AND EXR_TIP = ? AND EXR_EJR = ? AND EXR_NRE = ?";
                if (m_Log.isDebugEnabled()) m_Log.debug("el update de E_EXR es : " + sql);

                stmt = con.prepareStatement(sql);
                i = 1;
                stmt.setTimestamp(i++, sqlTimestamp);
                stmt.setString(i++, tvo.getNumeroExpediente());
                stmt.setString(i++,tvo.getOrigenExpedienteRelacionado());
                if (tvo.getCodProcedimiento() != null && !tvo.getCodProcedimiento().equals(""))
                    stmt.setString(i++, tvo.getCodProcedimiento());
                stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
                stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
                stmt.setString(i++, tvo.getTipoRegistro());
                stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
                stmt.setInt(i, Integer.parseInt(tvo.getNumero()));

                res = stmt.executeUpdate();
                if (m_Log.isDebugEnabled()) m_Log.debug("las filas afectadas en el update de E_EXR es : " + res);
                SigpGeneralOperations.closeStatement(stmt);
            }else if (("si".equals(existe))&&(tvo.getNumeroExpediente()==null)) {
                m_Log.debug(" ---------  TENGO QUE HACER EL DELETE ---");
                sql = "DELETE FROM E_EXR WHERE " + sql_exr_dep + "=" + tvo.getCodDepartamento() +
                    " AND " + sql_exr_uor + "=" + tvo.getCodUnidadRegistro() + " AND " +
                    sql_exr_ejr + "=" + tvo.getEjercicioRegistro() + " AND " + sql_exr_nre +
                    " = " + tvo.getNumero() + " AND " + sql_exr_tip + "='" +
                    tvo.getTipoRegistro() + "'";
                if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: recuperarAsiento--> "+ sql);
                stmt = con.prepareStatement(sql);
                res = stmt.executeUpdate();
                SigpGeneralOperations.closeStatement(stmt);
            }else if ("yaRelacionado".equals(existe)) {

                sql = "UPDATE E_EXR SET EXR_FECHAINSMOD = ?,EXR_ORI = ?,EXR_ORIGEN=? WHERE EXR_DEP = ? AND EXR_UOR = ? AND EXR_TIP = ? " +
                        "AND EXR_EJR = ? AND EXR_NRE = ? AND EXR_NUM = ?";

                stmt = con.prepareStatement(sql);
                i = 1;
                stmt.setTimestamp(i++, sqlTimestamp);
                stmt.setInt(i++, ori);
                stmt.setString(i++,tvo.getOrigenExpedienteRelacionado());
                stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
                stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
                stmt.setString(i++, tvo.getTipoRegistro());
                stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
                stmt.setInt(i++, Integer.parseInt(tvo.getNumero()));
                stmt.setString(i, tvo.getNumeroExpediente());

                res = stmt.executeUpdate();
                SigpGeneralOperations.closeStatement(stmt);
            } else {
                // Esa anotación no esta asociada a ningún otro expediente.
                // Recupero la información necesaria del expediente.
                sql = "SELECT EXP_EJE, EXP_MUN, EXP_PRO FROM E_EXP WHERE EXP_NUM = '" + tvo.getNumeroExpediente() + "'";
                if (m_Log.isDebugEnabled()) m_Log.debug("el select de E_EXP es : " + sql);

                stmt = con.prepareStatement(sql);
                rs = stmt.executeQuery();
                while (rs.next()) {
                    ejercicio = rs.getInt("EXP_EJE");
                    procedimiento = rs.getString("EXP_PRO");
                    municipio = rs.getInt("EXP_MUN");
                }

                SigpGeneralOperations.closeResultSet(rs);
                SigpGeneralOperations.closeStatement(stmt);
                
                sql = " INSERT INTO E_EXR (EXR_EJE, EXR_NUM, EXR_DEP, EXR_UOR, EXR_TIP, EXR_EJR, EXR_NRE, " +
                        "EXR_ORI, EXR_TOP, EXR_MUN, EXR_PRO,EXR_ORIGEN,EXR_FECHAINSMOD) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?)";
                if (m_Log.isDebugEnabled()) m_Log.debug("el insert de E_EXR es : " + sql);

                /** SI EL PLUGIN DE EXPEDIENTES RELACIONADOS CONFIGURADO NO ES EL DE FLEXIA, ENTONCES SE ESTÁ RELACIONADO LA ANOTACIÓN DE REGISTRO
                      CON UN EXPEDIENTE PROCEDENTE DE UN GESTOR EXTERNO Y , POR TANTO, QUE NO EXISTE EN FLEXIA. EN ESTE CASO, SE RECUPERA EL
                       CÓDIGO DE MUNICIPIO DEL PROCEDIMIENTO Y EL CÓDIGO DEL MISMO DE REGISTRO.PROPERTIES **/
                if(tvo.isUtilizarDatosExpedienteRelacionadoExterno()){
                    ejercicio          = Integer.parseInt(tvo.getEjercicioRegistro());
                    municipio        = Integer.parseInt(tvo.getMunicipioExpedienteRelacionadoExterno());
                    procedimiento = tvo.getCodProcedimientoExpedienteRelacionadoExterno();
                }
                                
                stmt = con.prepareStatement(sql);
                i = 1;
                stmt.setInt(i++, ejercicio);
                stmt.setString(i++, tvo.getNumeroExpediente());
                stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
                stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
                stmt.setString(i++, tvo.getTipoRegistro());
                stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
                stmt.setInt(i++, Integer.parseInt(tvo.getNumero()));
                stmt.setInt(i++, ori);
                stmt.setString(i++, tipoOp);
                stmt.setInt(i++, municipio);                
                stmt.setString(i++, procedimiento);
                stmt.setString(i++,tvo.getOrigenExpedienteRelacionado());
                stmt.setTimestamp(i,sqlTimestamp);
                res = stmt.executeUpdate();
                if (m_Log.isDebugEnabled()) m_Log.debug("las filas afectadas en el insert de E_EXR es : " + res);
                SigpGeneralOperations.closeStatement(stmt);
            }

        } catch (Exception e) {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.insertarExpediente", e);
        } finally {
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(stmt);
        }
        m_Log.debug("insertarExpediente");
        return res;

    }

    public int insertarExpediente(TramitacionValueObject tvo,String[] params,int ori,String top)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("insertarExpediente");

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        int res = 0;


        try
        {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            oad.inicioTransaccion(con);

            res = insertarExpediente(con,tvo,ori,top);

            oad.finTransaccion(con);

        } catch (Exception e) {
            oad.rollBack(con);
            e.printStackTrace();
            m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.insertarExpediente", e);
        } finally {
            try{
                oad.devolverConexion(con);
            }catch(Exception e){
                e.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            }
        }
        m_Log.debug("insertarExpediente");
        return res;

    }


    public int cambiaEstadoAsiento(Connection con,TramitacionValueObject tvo,int estado)
            throws TramitacionException, TechnicalException,BDException {

        m_Log.debug("cambiaEstadoAsiento connection: " + con);
        m_Log.debug("cambiaEstadoAsiento TramitacionValueObject: " + tvo);
        m_Log.debug("cambiaEstadoAsiento estado: " + estado);
        
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        int res = 0;

        try
        {
            m_Log.debug("TramitacionDAO. cambiaEstadoAsiento: ");                                  
       
            sql = "UPDATE R_RES SET " + sql_res_obs + "=?," +  sql_res_estado + "=" + estado + " WHERE " +
                    sql_res_codDpto + "=" + tvo.getCodDepartamento() + " AND " + sql_res_codUnid + "=" +
                    tvo.getCodUnidadRegistro() + " AND " + sql_res_tipoReg + "='" + tvo.getTipoRegistro() +
                    "' AND " + sql_res_ejer + "=" + tvo.getEjercicioRegistro() + " AND " +
                    sql_res_num + "=" + tvo.getNumero();
            // fin de cambio de estado            
            // Cambiamos los tags <br> por saltos de línea en las observaciones.
            String obs = tvo.getObservaciones();
            if (obs != null) {
                obs = obs.replaceAll("<br>","\n");
            }
            if(m_Log.isDebugEnabled()) m_Log.debug("el update de R_RES es : " 
                 + sql + "\nLas observaciones son: " + obs);

            stmt = con.prepareStatement(sql);
            stmt.setString(1,obs);
            res = stmt.executeUpdate();            

             /* Si el asiento se rechaza (estado = 2) hay que eliminar el expediente
             * asociado, en caso de que existiese.
             */
            if (estado == ConstantesDatos.REG_ANOTACION_ESTADO_RECHAZADA) {
                sql = "DELETE FROM E_EXR WHERE EXR_DEP=? AND EXR_UOR=? AND EXR_TIP=? AND EXR_EJR=? "
                        + "AND EXR_NRE=?";
                stmt = con.prepareStatement(sql);
                stmt.setInt(1, Integer.parseInt(tvo.getCodDepartamento()));
                stmt.setInt(2, Integer.parseInt(tvo.getCodUnidadRegistro()));
                stmt.setString(3, tvo.getTipoRegistro());
                stmt.setInt(4, Integer.parseInt(tvo.getEjercicioRegistro()));
                stmt.setInt(5, Integer.parseInt(tvo.getNumero()));
                res = stmt.executeUpdate();
                if (m_Log.isDebugEnabled()) {
                    m_Log.debug("Eliminar relacion expediente " + sql);
                }
            }

        } catch (SQLException ex) {
            ex.printStackTrace();
        } catch (Exception e) {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.cambiaEstadoAsiento", e);
        } finally{
            try{
                if (stmt!=null) stmt.close();
            }catch(Exception e){
                e.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            }
        }        
        
        m_Log.debug("cambiaEstadoAsiento");        
        return res;
    }

    public int cambiaEstadoAsiento(TramitacionValueObject tvo,int estado,String[] params)
            throws TramitacionException, TechnicalException,BDException {
       
        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";
        int res = 0;

        try
        {
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            oad.inicioTransaccion(con);
            
            cambiaEstadoAsiento(con,tvo,estado);

            // Inserción en el histórico
            HistoricoMovimientoValueObject hvo = new HistoricoMovimientoValueObject();
            hvo.setCodigoUsuario(tvo.getIdUsuario());
            hvo.setTipoEntidad(ConstantesDatos.HIST_ENTIDAD_ANOTACION);
            hvo.setCodigoEntidad(HistoricoAnotacionHelper.crearClaveHistorico(tvo));
            // Cambiamos los tags <br> por saltos de línea en las observaciones.
            String obs = tvo.getObservaciones().replaceAll("<br>","\n");
            if (estado == ConstantesDatos.REG_ANOTACION_ESTADO_ACEPTADA) {
                hvo.setTipoMovimiento(ConstantesDatos.HIST_ANOT_ACEPTAR);
                hvo.setDetallesMovimiento(HistoricoAnotacionHelper.crearXMLAceptar(obs));
            } else if(estado == ConstantesDatos.REG_ANOTACION_ESTADO_ACEPTADA_EN_DESTINO){
                hvo.setTipoMovimiento(ConstantesDatos.HIST_ANOT_ACEPTAR_EN_DESTINO);
                hvo.setDetallesMovimiento(HistoricoAnotacionHelper.crearXmlAceptarEnDestino(obs));
            } else if (estado == ConstantesDatos.REG_ANOTACION_ESTADO_RECHAZADA) {
                hvo.setTipoMovimiento(ConstantesDatos.HIST_ANOT_RECHAZAR);
                hvo.setDetallesMovimiento(HistoricoAnotacionHelper.crearXMLRechazar(obs));
            } else {
                throw new TramitacionException("Error. TramitacionDAO.cambiaEstadoAsiento" +
                        "ESTADO INESPERADO : " + estado);
            }
            HistoricoMovimientoManager.getInstance().insertarMovimientoHistorico(hvo, con, params);

            oad.finTransaccion(con);
            
        } catch (Exception e) {
            oad.rollBack(con);
            e.printStackTrace();
            m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.cambiaEstadoAsiento", e);
        } finally {
            try{
                oad.devolverConexion(con);
            }catch(Exception ex){
                ex.printStackTrace();
                if(m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
        m_Log.debug("cambiaEstadoAsiento");
        return res;

    }

    /**
     * @param tvo TramitacionValueObject con la información para adjuntar el asiento al expediente.
     * @param params String[] con los parametros de conexion a BBDD.
     * @throws TramitacionException Si se produce algún error de tramitacion
     * @throws TechnicalException Si hay algún problema técnico
     * @throws BDException Si hay algún problema de conxion a BBDD.
     */
    public void adjuntarExpedientesDesdeUnidadTramitadora(TramitacionValueObject tvo, String[] params)
            throws TramitacionException, TechnicalException, BDException {

        AdaptadorSQLBD oad = null;
        Connection con = null;

        if (tvo.getNumeroExpediente() == null || tvo.getNumeroExpediente().equals("")) {
            if (m_Log.isDebugEnabled()) m_Log.debug("ERROR: EL NUMERO DE EXPEDIENTE ES NULO.");
            throw new TramitacionException("ERROR: EL NUMERO DE EXPEDIENTE ES NULO.");
        }

        try {
            // Recupera los parametros de la conexion.
            oad = new AdaptadorSQLBD(params);
            con = oad.getConnection();
            oad.inicioTransaccion(con);

            // Busca el expediente.
            if (localizaExpediente(con, tvo) <= 0) {
                if (m_Log.isDebugEnabled()) m_Log.debug("ERROR: EL EXPEDIENTE A RELACIONAR NO EXISTE.");
                throw new TramitacionException("ERROR: EL EXPEDIENTE A RELACIONAR NO EXISTE.");
            }

            // Si lo encuentra, intenta insertarlo..
            if (insertarExpediente(con, tvo, 1, "1") <= 0) {
                if (m_Log.isDebugEnabled()) m_Log.debug("ERROR: NO SE HA PODIDO ASOCIAR EL EXPEDIENTE AL ASIENTO");
                throw new TramitacionException("ERROR: NO SE HA PODIDO ASOCIAR EL EXPEDIENTE AL ASIENTO");
            }

            //Habrá que comprobar si es necesario cambiar el estado del asiento
            if(!tvo.getDejarAnotacionBuzonEntrada()){
                // Si ha logrado insertarlo, cambia el estado al asiento.
                if (cambiaEstadoAsiento(con, tvo, 1) <= 0) {
                    if (m_Log.isDebugEnabled()) m_Log.debug("ERROR: NO HA SIDO POSIBLE CAMBIAR EL ESTADO AL ASIENTO");
                    throw new TramitacionException("ERROR: NO HA SIDO POSIBLE CAMBIAR EL ESTADO AL ASIENTO");
                }//if (cambiaEstadoAsiento(con, tvo, 1) <= 0)
            }//if(!tvo.getDejarAnotacionBuzonEntrada())

            // Inserción en el histórico
            HistoricoMovimientoValueObject hvo = new HistoricoMovimientoValueObject();
            hvo.setCodigoUsuario(tvo.getIdUsuario());
            hvo.setTipoEntidad(ConstantesDatos.HIST_ENTIDAD_ANOTACION);
            hvo.setCodigoEntidad(HistoricoAnotacionHelper.crearClaveHistorico(tvo));
            hvo.setTipoMovimiento(ConstantesDatos.HIST_ANOT_ADJUNTAR);
            hvo.setDetallesMovimiento(HistoricoAnotacionHelper.crearXMLAdjuntar(tvo.getNumeroExpediente()));
            HistoricoMovimientoManager.getInstance().insertarMovimientoHistorico(hvo, con, params);

            oad.finTransaccion(con);

        } catch (Exception ex) {
            oad.rollBack(con);
            ex.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.adjuntaExpediente", ex);
        } finally {
            try {
                oad.devolverConexion(con);
            } catch (Exception ex) {
                ex.printStackTrace();
                if (m_Log.isErrorEnabled()) m_Log.error(ex.getMessage());
            }
        }
    }

    public Vector getListaUORs_usuario(AdaptadorSQLBD oad, Connection con, DefinicionProcedimientosValueObject dpVO, UsuarioValueObject uVO)
            throws TramitacionException, TechnicalException {

        //m_Log.debug("getListaUORs_usuario");

        Vector lista = new Vector();
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            String parte_select = "SELECT DISTINCT " + sql_uor_codigo
                            + "," + sql_uor_nombre + "," + sql_uor_codigo_visible
                            + " FROM E_PUI, A_UOR UORs "
                    + " WHERE " +  sql_pui_codMun + "=" + dpVO.getCodMunicipio()
                    + " AND " + sql_pui_codProc + "='" + dpVO.getTxtCodigo()+"'"
                    + " AND " + sql_pui_uor + "=" + sql_uor_codigo
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +  sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                    + " AND "+ sql_uou_uor +"="+ sql_uor_codigo + ")) ";

            parte_select += " UNION ";

            // En esta segnuda parte de la UNION lo que se hace es que si el procedimiento tiene asociado como UORs de entrada
            //CUALQUIERA entonces los UOOs que se toman son los del usuario
            parte_select += "SELECT DISTINCT " + sql_uor_codigo
                                  + "," + sql_uor_nombre + "," + sql_uor_codigo_visible
                                  + " FROM A_UOR UORs "
                                  + " WHERE "
                                  + "(NOT EXISTS ( "
                                      + " SELECT DISTINCT " +  sql_pui_uor
                                      + " FROM E_PUI "
                                      + " WHERE "+ sql_pui_codMun + "=" + dpVO.getCodMunicipio()
                                      + " AND "+ sql_pui_codProc +"='" + dpVO.getTxtCodigo()+"')) "
                                  + " AND (EXISTS ( "
                                      + " SELECT DISTINCT " +  sql_uou_uor
                                      + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                                      + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                                      + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                                      + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                                      + " AND "+ sql_uou_uor +"="+ sql_uor_codigo + ")) ";
            parte_select += " ORDER BY "+sql_uor_nombre;

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaUORs_usuario --> "+ parte_select);
            stmt = con.prepareStatement(parte_select);
            rs = stmt.executeQuery();
            while(rs.next()){
                ElementoListaValueObject elVO = new ElementoListaValueObject();
                elVO.setCodigo( (String) rs.getString(sql_uor_codigo));
                elVO.setDescripcion((String) rs.getString(sql_uor_nombre));
                elVO.setIdentificador( (String) rs.getString(sql_uor_codigo_visible));
                lista.addElement(elVO);
            }

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaUORs_usuario --> numero unidades organicas del usuario: " + lista.size());
            rs.close();
            stmt.close();

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaUORs_usuario", e);
        } finally {
            m_Log.debug("getListaUORs_usuario");
            return lista;
        }
    }
    
    
    public Vector getListaUORs_usuarioPorProc(AdaptadorSQLBD oad, Connection con, String codigoOrganizacion ,String codigoProcedimiento, UsuarioValueObject uVO)
            throws TramitacionException, TechnicalException {

        m_Log.debug("getListaUORs_usuarioPorProc");

        Vector lista = new Vector();
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String sql="";

        try{
            String parte_select = "SELECT DISTINCT " + sql_uor_codigo
                            + "," + sql_uor_nombre + "," + sql_uor_codigo_visible
                            + " FROM E_PUI, A_UOR UORs "
                    + " WHERE " +  sql_pui_codMun + "=" + codigoOrganizacion
                    + " AND " + sql_pui_codProc + "='" + codigoProcedimiento+"'"
                    + " AND " + sql_pui_uor + "=" + sql_uor_codigo
                    + " AND (EXISTS ( "
                    + " SELECT DISTINCT " +  sql_uou_uor
                    + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                    + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                    + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                    + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                    + " AND "+ sql_uou_uor +"="+ sql_uor_codigo + ")) ";

            parte_select += " UNION ";

            // En esta segnuda parte de la UNION lo que se hace es que si el procedimiento tiene asociado como UORs de entrada
            //CUALQUIERA entonces los UOOs que se toman son los del usuario
            parte_select += "SELECT DISTINCT " + sql_uor_codigo
                                  + "," + sql_uor_nombre + "," + sql_uor_codigo_visible
                                  + " FROM A_UOR UORs "
                                  + " WHERE "
                                  + "(NOT EXISTS ( "
                                      + " SELECT DISTINCT " +  sql_pui_uor
                                      + " FROM E_PUI "
                                      + " WHERE "+ sql_pui_codMun + "=" + codigoOrganizacion
                                      + " AND "+ sql_pui_codProc +"='" + codigoProcedimiento+"')) "
                                  + " AND (EXISTS ( "
                                      + " SELECT DISTINCT " +  sql_uou_uor
                                      + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                                      + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                                      + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                                      + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                                      + " AND "+ sql_uou_uor +"="+ sql_uor_codigo + ")) ";
            parte_select += " ORDER BY "+sql_uor_nombre;

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaUORs_usuario --> "+ parte_select);
            stmt = con.prepareStatement(parte_select);
            rs = stmt.executeQuery();
            while(rs.next()){
                ElementoListaValueObject elVO = new ElementoListaValueObject();
                elVO.setCodigo( (String) rs.getString(sql_uor_codigo));
                elVO.setDescripcion((String) rs.getString(sql_uor_nombre));
                elVO.setIdentificador( (String) rs.getString(sql_uor_codigo_visible));
                lista.addElement(elVO);
            }

            if(m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getListaUORs_usuario --> numero unidades organicas del usuario: " + lista.size());
            rs.close();
            stmt.close();

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getListaUORs_usuario", e);
        } finally {
            m_Log.debug("getListaUORs_usuario");
            return lista;
        }
    }
    
    
    private void commitTransaction(AdaptadorSQLBD abd, Connection con) throws TechnicalException {
        try {
            if (con != null) abd.finTransaccion(con);
        } catch (BDException bde) {
            m_Log.error("ERROR AL HACER COMMIT DE LA TRANSACCION EN LA CONEXION A LA BASE DE DATOS", bde);
            throw new TechnicalException(bde.getMensaje());
        }
    }

    private void rollBackTransaction(AdaptadorSQLBD abd, Connection con) throws TechnicalException {
        try {
            if (con != null) abd.rollBack(con);
        } catch (BDException bde) {
            m_Log.error("ERROR AL HACER ROLLBACK DE LA TRANSACCION EN LA CONEXION A LA BASE DE DATOS", bde);
            throw new TechnicalException(bde.getMensaje());
        }
    }

    private void devolverConexion(AdaptadorSQLBD abd, Connection con) throws TechnicalException {
        try {
            if (con != null) abd.devolverConexion(con);
        } catch (BDException bde) {
            m_Log.error("ERROR AL DEVOLVER LA CONEXION A LA BASE DE DATOS", bde);
            throw new TechnicalException(bde.getMensaje(), bde);
        }
    }

    private void cerrarStatement(Statement statement) throws TechnicalException {
        try {
            if (statement != null) statement.close();
        } catch(SQLException sqle){
            m_Log.error("ERROR AL CERRAR EL STATEMENT DE LA BASE DE DATOS", sqle);
            throw new TechnicalException(sqle.getMessage(), sqle);
        }
    }

    private void cerrarResultSet(ResultSet resultSet) throws TechnicalException {
        try {
            if (resultSet != null) resultSet.close();
        } catch(SQLException sqle){
            m_Log.error("ERROR AL CERRAR EL RESULTSET DE LA BASE DE DATOS", sqle);
            throw new TechnicalException(sqle.getMessage(), sqle);
        }
    }      
    
    /**
     * Comprueba si un usuario tiene permiso sobre un determinado 
     * @param idOrganizacion: Id de la organización
     * @param idUsuario: Id del usuario
     * @param idOrganica: Id de la unidad orgánica
     * @param connection: Conexión a la BBDD
     */
    public boolean tienePermisoSobreUnidadInicio(int idOrganizacion,int idUsuario,String numeroExpediente,Connection connection) throws TramitacionException, TechnicalException {
        boolean tiene = false;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String SQL = "SELECT EXP_UOR FROM E_EXP WHERE EXP_NUM=?";
        SQL += " UNION SELECT EXP_UOR FROM HIST_E_EXP WHERE EXP_NUM=?";
        int uorInicio = -1;

        try {
            ps = connection.prepareStatement(SQL);
            ps.setString(1, numeroExpediente);
            ps.setString(2, numeroExpediente);
            rs = ps.executeQuery();
            while (rs.next()) {
                uorInicio = rs.getInt(1);                
            }
            if  (uorInicio==-1) throw new TechnicalException("Problema en la consulta para ver la uor de inicio de expediente");
            
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(ps);

            SQL = "SELECT UOU_UOR FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU" + " WHERE UOU_ORG = ? AND UOU_UOR = ? AND UOU_USU = ?";
                        ps = connection.prepareStatement(SQL);
            ps.setInt(1, idOrganizacion);
            ps.setInt(2, uorInicio);
            ps.setInt(3, idUsuario);
            rs = ps.executeQuery();
            tiene = rs.next();
        }catch(SQLException e)  {
            e.printStackTrace();
            if(m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.tienePermisoSobreUnidadInicio", e);
        }finally{            
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(ps);
        }
        return tiene;
    }

    /**
     * Comprueba si un usuario tiene permiso sobre algunas de las unidades tramitadoras de un expediente
     * @param codExpediente: Código del expediente
     * @param idUsuario: Id del usuario
     * @param idOrganizacion: Id de la organización
     * @param con: Conexión a la BBDD
     * @return Un boolean
     */

    public boolean tienePermisoUnidadesTramitadoras(String numeroExpediente,int idUsuario,int idOrganizacion,Connection con) throws TramitacionException, TechnicalException {
        boolean tiene = false;
        PreparedStatement ps = null;
        ResultSet rs = null;
        String SQL = "SELECT DISTINCT CRO_UTR FROM E_CRO LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU "
                + "ON (UOU_UOR = CRO_UTR AND UOU_ORG = CRO_MUN) WHERE CRO_NUM=? AND UOU_USU = ?";
        SQL += " UNION ALL SELECT DISTINCT CRO_UTR FROM HIST_E_CRO LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU "
                + "ON (UOU_UOR = CRO_UTR AND UOU_ORG = CRO_MUN) WHERE CRO_NUM=? AND UOU_USU = ?";
        
        try{            
            ps = con.prepareStatement(SQL);
            ps.setString(1, numeroExpediente);
            ps.setInt(2,idUsuario);
            ps.setString(3, numeroExpediente);
            ps.setInt(4,idUsuario);
            rs = ps.executeQuery();
            tiene = rs.next();
        }catch(SQLException e)  {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) {
                m_Log.error(e.getMessage());
            }
            throw new TramitacionException("Error. TramitacionDAO.tienePermisoSobreUnidadInicio", e);
        }finally{
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(ps);
            return tiene;
               }                
            }
            
    /**
     * Recupera la entidad de una uor
     * @param idUsuario: Id del usuario
     * @param idOrganizacion: Id de la organización
     * @param idUor: Id de la uor
     * @return Un int
     * @throws es.altia.agora.business.sge.exception.TramitacionException
     * @throws es.altia.common.exception.TechnicalException
     */
    public String getCodMunicipio(String codExpediente,Connection connection) throws TramitacionException, TechnicalException
    {
        String SQL      = null;
        PreparedStatement ps    = null;
        ResultSet rs    = null;
        String idMun    = null;
        try
        {
          // Se recupera la entidad correspondiente al usuario, organización y uor
             SQL = "SELECT EXP_MUN " + 
                  " FROM E_EXP" +            
                   " WHERE EXP_NUM=? ";
             SQL += " UNION ALL SELECT EXP_MUN " + 
                  " FROM HIST_E_EXP" +            
                   " WHERE EXP_NUM=? ";
                
                m_Log.debug("TramitacionDAO.getCodMunicipio - SQL: " + SQL);
                
                  ps = connection.prepareStatement(SQL);

                int i = 1;

                ps.setString(i++, codExpediente);	
                ps.setString(i++, codExpediente);	
                rs = ps.executeQuery();
              
                while(rs.next()){
                    idMun = rs.getString("EXP_MUN");
                }
                
                m_Log.debug("Id municipio: " + idMun);
        }
        catch(SQLException e){
            e.printStackTrace();
            m_Log.error("TramitacionDAO.getCodMunicipio SQLException: " + e.getMessage());
        }
        finally{
            
            try{
                GeneralOperations.closeStatement(ps);
                GeneralOperations.closeResultSet(rs);
            }
            catch(InternalErrorException e){
                e.printStackTrace();
                m_Log.error("TramitacionDAO.getCodMunicipio InternalErrorException: " + e.getMessage());
            }
        }
        
        return idMun;
    }


    /**
     * Recupera una colección con las unidades tramitadoras asociadas al trámite de inicio de un procedimiento.
     * Si no tiene unidades tramitadoras asignadas, entonces devuelve una colección vacía
     * @param   codPro  Codigo del procedimiento
     * @param   connection
     * @return         
     * @throws SQLException Si hay algún error al realizar las consultas SQL.
     */
    public Vector<UORDTO> getUnidadesTramitadorasTramiteInicio(String codPro, Connection con, AdaptadorSQLBD oad)
    throws SQLException, TechnicalException {

        m_Log.debug("DefinicionProcedimientosDAO --> getUnidadesTramitadorasTramiteInicio");
        // Obtenemos la conexion.
        PreparedStatement ps = null;
        ResultSet rs = null;
        int tramiteInicio = -1;
        int codMunicipio = -1;
        String modoUnidadInicio = "";
        Vector<UORDTO> unidadesTramitadoras = new Vector<UORDTO>();

        try {

            String sql = "SELECT PRO_TRI,TRA_MUN,TRA_COD, TRA_UTR FROM E_PRO, E_TRA WHERE PRO_COD=? AND E_PRO.PRO_TRI=E_TRA.TRA_COD AND TRA_PRO=PRO_COD";
            m_Log.debug("getUnidadesTramitadorasTramiteInicio sql: " + sql);
            m_Log.debug("getUnidadesTramitadorasTramiteInicio codPro: " + codPro);
            int i=1;
            ps = con.prepareStatement(sql);
            ps.setString(i++,codPro);
            rs = ps.executeQuery();
            
            if (rs.next()){
                tramiteInicio = rs.getInt("PRO_TRI");
                codMunicipio  = rs.getInt("TRA_MUN");
                modoUnidadInicio = rs.getString("TRA_UTR");
            }
            
            if (modoUnidadInicio.equals(ConstantesDatos.TRA_UTR_EXPEDIENTE)) return unidadesTramitadoras;
            if (modoUnidadInicio.equals(ConstantesDatos.TRA_UTR_OTRAS)) {
                if (tramiteInicio >= 0 && codMunicipio >= 0) {
                    unidadesTramitadoras = UnidadesTramitacionDAO.getInstance().getUTRByTramite(codMunicipio, codPro, tramiteInicio, con);                    
                }
                return unidadesTramitadoras;
            } else {
                return UORsDAO.getInstance().getListaUORs(false, con, oad);
            }
                        
            
        }catch(TechnicalException e){
             e.printStackTrace();            
            throw new SQLException(e.getMessage());
        }
        finally{
            SigpGeneralOperations.closeResultSet(rs);
            SigpGeneralOperations.closeStatement(ps);
        }       
    }


    /**
     * Recupera el tipo de unidad tramitadora para el trámite de inicio
     * @param   codPro  Codigo del procedimiento
     * @param   connection: Conexión a la base de datos
     * @return  4 ? El trámite lo ejecuta la unidad del expediente.
                3 ? El trámite lo ejecuta la unidad que lo inicia.
                2 ? El trámite lo ejecuta la unidad del trámite anterior.
                1 ? El trámite lo ejecuta cualquier unidad orgánica (se elegirá una en el momento de instanciar el trámite).
                0 ? El trámite lo ejecuta cualquiera de las unidades incluidas en el atributo ?unidadesTramitadoras?.
     * @throws SQLException Si hay algún error al realizar las consultas SQL.
     */
    public int getTipoUnidadTramitadoraTramiteInicio(String codPro,Connection con)
    throws SQLException {

        m_Log.debug("TramitacionDAO.getTipoUnidadTramitadoraTramiteInicio init");
        // Obtenemos la conexion.
        PreparedStatement ps = null;
        ResultSet rs = null;        
        int tipoUtr = -1;
        try {

            String sql = "SELECT PRO_TRI,TRA_UTR,TRA_COD FROM E_PRO, E_TRA WHERE PRO_COD=? AND E_PRO.PRO_TRI=E_TRA.TRA_COD AND TRA_PRO=PRO_COD";
            m_Log.debug("getTipoUnidadTramitadoraTramiteInicio sql: " + sql);
            m_Log.debug("getUnidadesTramigetTipoUnidadTramitadoraTramiteIniciotadorasTramiteInicio codPro: " + codPro);
            int i=1;
            ps = con.prepareStatement(sql);
            ps.setString(i++,codPro);
            rs = ps.executeQuery();
            while(rs.next()){        
                tipoUtr = rs.getInt("TRA_UTR");
            }
          
        }catch(Exception e){
             e.printStackTrace();
            throw new SQLException(e.getMessage());
        }
        finally{
            try{
                if (rs != null) rs.close();
                if (ps != null) ps.close();
            }
            catch(SQLException e){
                e.printStackTrace();
                throw new SQLException(e.getMessage());
            }
        }
        return tipoUtr;
    }


     /**
     * Se recuperan todas las unidades organizativas de la base de datos para que el usuario puede elegir la que desea
     * para asignar al trámite     
     * @param   connection: Conexión a la base de datos
     * @return  4 ? El trámite lo ejecuta la unidad del expediente.
                3 ? El trámite lo ejecuta la unidad que lo inicia.
                2 ? El trámite lo ejecuta la unidad del trámite anterior.
                1 ? El trámite lo ejecuta cualquier unidad orgánica (se elegirá una en el momento de instanciar el trámite).
                0 ? El trámite lo ejecuta cualquiera de las unidades incluidas en el atributo ?unidadesTramitadoras?.
     * @throws SQLException Si hay algún error al realizar las consultas SQL.
     */
    public Vector<UORDTO> getTodasUnidadesOrganizativas(Connection con,String jndi)
    throws SQLException {

        m_Log.debug("TramitacionDAO.getTodasUnidadesOrganizativas init");
        Vector<UORDTO> unidades = new Vector<UORDTO>();
        SortedMap <ArrayList<String>,UORDTO> unidadesOrg = (SortedMap <ArrayList<String>,UORDTO>) CacheDatosFactoria.getImplUnidadesOrganicas().getDatosBD(jndi);
        if (unidadesOrg!=null && !unidadesOrg.isEmpty()) {
            for(Map.Entry<ArrayList<String>,UORDTO> entry : unidadesOrg.entrySet()) {
                UORDTO unidad = entry.getValue();
                if (unidad.getUor_fecha_baja()==null && "A".equals(unidad.getUor_estado()))
                    unidades.add(unidad);
            }
        } 

        return unidades;
    }


       /**
     * Recupera el tipo de unidad tramitadora para un
     * trámite de un procedimiento
     * @param   codPro  Codigo del procedimiento
     * @param   codTramite  Código del trámite
     * @param   connection: Conexión a la base de datos
     * @return  4 ? El trámite lo ejecuta la unidad del expediente.
                3 ? El trámite lo ejecuta la unidad que lo inicia.
                2 ? El trámite lo ejecuta la unidad del trámite anterior.
                1 ? El trámite lo ejecuta cualquier unidad orgánica (se elegirá una en el momento de instanciar el trámite).
                0 ? El trámite lo ejecuta cualquiera de las unidades incluidas en el atributo ?unidadesTramitadoras?.
     * @throws SQLException Si hay algún error al realizar las consultas SQL.
     */
    public int getTipoUnidadTramitadoraTramite(String codPro,String codTramite,int codOrganizacion,Connection con)
    throws SQLException {

        m_Log.debug("TramitacionDAO.getTipoUnidadTramitadoraTramite init");
        // Obtenemos la conexion.
        PreparedStatement ps = null;
        ResultSet rs = null;
        int tipoUtr = -1;
        try {

            //String sql = "SELECT TRA_UTR FROM E_TRA WHERE TRA_PRO=? AND TRA_COD=?";
            String sql = "SELECT TRA_UTR FROM E_TRA WHERE TRA_PRO=? AND TRA_COD=? AND TRA_MUN=?";
            m_Log.debug("getTipoUnidadTramitadoraTramite sql: " + sql);
            m_Log.debug("getTipoUnidadTramitadoraTramite codPro: " + codPro);
            m_Log.debug("getTipoUnidadTramitadoraTramite codTramite: " + codTramite);
            int i=1;
            ps = con.prepareStatement(sql);
            ps.setString(i++,codPro);
            ps.setString(i++,codTramite);
            ps.setInt(i++,codOrganizacion);
            rs = ps.executeQuery();
            while(rs.next()){
                tipoUtr = rs.getInt("TRA_UTR");
            }

        }catch(Exception e){
             e.printStackTrace();
            throw new SQLException(e.getMessage());
        }
        finally{
            try{
                if (rs != null) rs.close();
                if (ps != null) ps.close();
            }
            catch(SQLException e){
                e.printStackTrace();
                throw new SQLException(e.getMessage());
            }
        }
        return tipoUtr;
    }

    public Vector getExpedientesPendientesFiltrados(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params, String columna, String tipoOrden, int filtro)
            throws TramitacionException, TechnicalException {

        Vector lista = new Vector();
        Vector listaFinal = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt;
        ResultSet rs = null;
        String sql;
        String codigoColOrdInteresado=COLUMNA_ORDEN_INTERESADO; //Columna de ordenación por terceroç
        String nsl_comp_anterior="";
        String nsl_sort_anterior="";
        String valor_nsl_comp_anterior="";
        String valor_nsl_sort_anterior="";

        
        Vector<CampoSuplementarioVO> camposSuplementarios = null;
        Hashtable<Integer,ArrayList<Calendar>> listaFestivos = new Hashtable<Integer,ArrayList<Calendar>>();
        Hashtable<String,DefinicionProcedimientosValueObject> listaPlazos = new Hashtable<String,DefinicionProcedimientosValueObject>();
        
        
        String parteOrderByColumnaCampoSuplementario = null;
        boolean ordenCampoSuplementario = false;

        /************ criterio búsqueda *********************/
        ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();

        /************ criterio búsqueda *********************/
        List<String> idCargos=null;
        if (filtro==7){
              idCargos= TramitesExpedienteDAO.getInstance().getCargosUsuario(uVO,params);
        }
        
        
        if(filtro==4 || filtro==5 || filtro==6){
            try{

                m_Log.debug(" TramitacionDAO.getExpedientesPendientesFiltrados =================>>");
                oad = new AdaptadorSQLBD(params);
                con = oad.getConnection();
                listaFinal = this.getExpedientesPendientesPlazoFiltrados(uVO, tVO, params, columna, tipoOrden, filtro, con,oad);

            }catch(Exception e){
                e.printStackTrace();
                m_Log.error(e.getMessage());
            }finally{
                try{
                    oad.devolverConexion(con);
                }catch(BDException e){
                    m_Log.error("Error al cerrar la conexión a la base de datos");
                    e.printStackTrace();
                }
            }
        }
        else
        {
            if (filtro != 0) {
                try {
                    oad = new AdaptadorSQLBD(uVO.getParamsCon());
                    con = oad.getConnection();

                    /** prueba **/
                     if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento())){
                       if(CamposListadoPendientesProcedimientoDAO.getInstance().tieneProcedimientoVistaExpedientesPendientes(tVO.getCodProcedimiento(),uVO.getOrgCod(),con)){
                        m_Log.debug("Filtro procedimiento " + tVO.getCodProcedimiento() + " tiene vista de pendientes propia");
                        camposSuplementarios = CamposListadoPendientesProcedimientoDAO.getInstance().getCamposSuplementariosListado(tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                        }
                    }
                    /** prueba **/
                    
                    int tipoDatoColumna =-1;
                    // ORIGINAL
                    //if(codigoColOrdInteresado.equals(columna)) sql= queryExpedientesFiltradosOrdenInteresados(oad, filtro, uVO, true);
                    if(codigoColOrdInteresado.equals(columna)) {
                        sql= queryExpedientesFiltradosOrdenInteresados(oad, filtro, uVO, true,tVO.getCodProcedimiento(),tVO.getCodRangoTemporal(),criterio);
                    }
                    else{
                        String codProcedimiento = null;
                        if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento()) && !"null".equalsIgnoreCase(tVO.getCodProcedimiento())){
                            codProcedimiento = tVO.getCodProcedimiento();

                            /*******************************/
                            if(columna!=null && !"".equals(columna) && !NumericOperations.isInteger(columna)){                               
                                /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                                tipoDatoColumna = CamposListadoPendientesProcedimientoDAO.getInstance().getTipoCampoSuplementario(columna,tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                                m_Log.debug("La tabla en la que se aloja el valor del campo suplementario es " + tipoDatoColumna);
                                switch (tipoDatoColumna){
                                    case 1: //  Campo de tipo numérico
                                        parteOrderByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;
                                    case 2: //  Campo de tipo texto corto
                                        parteOrderByColumnaCampoSuplementario = "E_TXT.TXT_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;
                                    case 3: //  Campo de tipo fecha
                                        parteOrderByColumnaCampoSuplementario = "E_TFE.TFE_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;
                                    case 6: //  Campo de tipo desplegable
                                        parteOrderByColumnaCampoSuplementario = "E_TDE.TDE_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;
                                    case 8: //  Campo de tipo numérico calculado
                                        parteOrderByColumnaCampoSuplementario = "E_TNUC.TNUC_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;                                   
                                    case 9: //  Campo de tipo fecha calculada
                                        parteOrderByColumnaCampoSuplementario = "E_TFEC.TFEC_VALOR ";
                                        ordenCampoSuplementario               = true;
                                        break;
                                 }// switch
                            }//if
                            /*******************************/
                        }

                        // original
                        //sql = queryExpedientesFiltrados(oad, filtro, uVO, true,codProcedimiento);
                        sql = queryExpedientesFiltrados(oad, filtro, uVO, true,codProcedimiento,tVO.getCodRangoTemporal(),columna,tipoDatoColumna,criterio,idCargos);
                    }

                    String pOrder = "";
                    // Se supone que en este caso que el expediente no esta cerrado
                    if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
                    {
                        pOrder= " ORDER BY NOMBRE"+ " "+tipoOrden;
                    }
                    else{
                        if (("".equals(columna)) || (columna == null) || ("0".equals(columna))) {
                            pOrder = " ORDER BY " + sql_exp_fechIni + " DESC ";
                        } else {

                            /*************************************************/
                            if(ordenCampoSuplementario){
                                // Se añade a la parte ORDER BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                                pOrder = " ORDER BY " + parteOrderByColumnaCampoSuplementario + " " + tipoOrden;
                            }else
                               pOrder = " ORDER BY "+ columna + " "+tipoOrden;
                            /*************************************************/
                            
                            //pOrder = " ORDER BY " + parteOrderByColumnaCampoSuplementario + " " + tipoOrden;
                        }
                   }

                    sql = sql + pOrder;

                    if (m_Log.isDebugEnabled()) {
                        m_Log.debug(sql);
                    }


                    /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
//                   if(params[0]!=null && (params[0].equalsIgnoreCase("oracle"))){
//                        String alter1 = "ALTER SESSION SET NLS_COMP=LINGUISTIC";
//                        String alter2 = "ALTER SESSION SET NLS_SORT=GENERIC_BASELETTER";
//                        Statement st =con.createStatement();
//                        st.executeQuery(alter1);
//                        st=con.prepareStatement(alter2);
//                        st.executeQuery(alter2);
//                        st.close();
//                    }
                    /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/

                    stmt = con.prepareStatement(sql);

                    /************************************** criterio búsqueda ***************************************************/
                    ArrayList<String> valores = null;
                    if(criterio!=null) valores = criterio.getValoresCriterioBusqueda();

                    if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())){ // Criterio de búsqueda es la fecha de inicio
                        //int contador = 1;
                        m_Log.debug("Operador criterio: " + criterio.getOperadorCriterioBusqueda());
                    
                    }//if
                    else
                    if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda())
                            && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        
                    }// if
                    
                    
                    int contador=1;
                    if ("1".equals(tVO.getCodRangoTemporal())){
                       Calendar calendario = Calendar.getInstance();
                       calendario.add(Calendar.MONTH, -6);
                       Timestamp time = new Timestamp(calendario.getTimeInMillis());
                       stmt.setTimestamp(contador++,time);

                   } else if ("2".equals(tVO.getCodRangoTemporal())) {
                       Calendar calendario = Calendar.getInstance();
                       calendario.add(Calendar.MONTH, -12);
                       Timestamp time = new Timestamp(calendario.getTimeInMillis());
                       stmt.setTimestamp(contador++,time);

                   }
                    /************************************** criterio búsqueda ***************************************************/


                    rs = stmt.executeQuery();
                    int posE = 0;
                    int numPaginaE = 0;
                    int pagActual = -1;
                    if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado() != null) {
                        pagActual = Integer.parseInt(tVO.getPaginaListado());
                    }
                    int lineas = -1;
                    if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado() != null) {
                        lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());
                    }
                    
                    Calendar today = Calendar.getInstance();
                    ConsultaExpedientesDAO cDAO = ConsultaExpedientesDAO.getInstance();
                    
                    while (rs.next()) {
                        numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                        if(numPaginaE>pagActual){
                            break;
                        }else
                        if (numPaginaE != pagActual) { 
                            posE++;
                            continue;
                        }

                        String pendiente = "no";
                        TramitacionValueObject tvo1 = new TramitacionValueObject();
                        tvo1.setLocalizacion(rs.getString(1));
                        tvo1.setCodMunicipio(rs.getString(2));
                        tvo1.setCodProcedimiento(rs.getString("EXP_PRO"));
                        tvo1.setDescProcedimiento(rs.getString("PML_VALOR"));
                        tvo1.setEjercicio(rs.getString(4));
                        tvo1.setNumero(rs.getString(5));
                        
                        if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(), con)){
                            tvo1.setTipoInicio("Instancia");
                        }else
                            tvo1.setTipoInicio("Oficio");
                                               
                         tvo1.setFechaInicioExpediente(rs.getString(6));
                        
                        String asuntoExp = rs.getString(9);
                        if (asuntoExp != null) {
                            tvo1.setAsuntoExp(AdaptadorSQLBD.js_escape(asuntoExp));
                        } else {
                            tvo1.setAsuntoExp("");
                        }
                        String numeroRelacion = rs.getString(10);
                        if (numeroRelacion == null) {
                            tvo1.setNumeroRelacion("");
                        } else {
                            tvo1.setNumeroRelacion(numeroRelacion);
                        }

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        tvo1.setExpImportante(rs.getString("EXP_IMP"));
                        
                        Calendar fecAlarma = DateOperations.timestampToCalendar(rs.getTimestamp("EXP_FPA"));
                        if (fecAlarma == null)
                            tvo1.setAlarmaVencida("nadaQueMostrar"); 
                        else if (fecAlarma.before(today))
                            tvo1.setAlarmaVencida("si"); 
                        else
                            tvo1.setAlarmaVencida("no"); 
                        
                        boolean aux = isCercaFinPlazo(tvo1, con, oad);
                        if (!aux) {
                            tvo1.setPlazoCercaFin("si");
                            tvo1.setFueraDePlazo("no");
                        } else {
                            tvo1.setPlazoCercaFin("no");
                            String fechaLimite = rs.getString(11);
                            tvo1.setFechaLimiteP(fechaLimite);

                            if (fechaLimite != null && !"".equals(fechaLimite)) {
                                Calendar calendario = Calendar.getInstance();
                                java.util.Date date = calendario.getTime();
                                java.util.Date dateLimite = Fecha.obtenerDate(fechaLimite);
                                if (date.compareTo(dateLimite) >= 0) {
                                    tvo1.setFueraDePlazo("si");
                                } else {
                                    tvo1.setFueraDePlazo("no");
                                }
                            }
                        }
                        lista.addElement(tvo1);

                        // Comprobar si esta pendiente
                        String exisUOR = rs.getString(12);
                        if (exisUOR != null) {
                            pendiente = "si";
                        }
                        tvo1.setPendiente(pendiente);
                        tvo1.setFechaFinExpediente(rs.getString("fFin"));
                        tvo1.setEstado(rs.getString("ESTADO"));
                        tvo1.setUsuarioIni(rs.getString("USU_NOM"));
                        tvo1.setUnidadInicio(rs.getString("UOR_NOM"));                       
                        posE++;
                    }
                    rs.close();
                    stmt.close();
                    for (int i = 0; i < lista.size(); i++) {
                        TramitacionValueObject tvo1;
                        tvo1 = (TramitacionValueObject) lista.elementAt(i);

                        // OBTENER LOS DATOS DE LOS INTERESADOS
                        sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, ROL_DES, MOSTRAR FROM E_ROL,E_EXT "
                                +" LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR)  " +
                                " WHERE EXT_MUN = " + tvo1.getCodMunicipio() + " AND EXT_EJE = " + tvo1.getEjercicio() + " " +
                                "AND EXT_NUM = '" + tvo1.getNumero() + "' AND ROL_MUN = " + tvo1.getCodMunicipio() + " " +
                                "AND ROL_PRO = '" + tvo1.getCodProcedimiento() + "' AND ROL_COD = EXT_ROL " ;
                               

                        if (m_Log.isDebugEnabled()) {
                            m_Log.debug(sql);
                        }
                        stmt = con.prepareStatement(sql);
                        rs = stmt.executeQuery();

                        String interesados = "";
                        boolean primero = true;
                        while (rs.next()) {
                            // Obtener una descripcion del tercero.
                            String tercero_p1a = rs.getString(sql_hte_p1a);
                            String tercero_a1a = rs.getString(sql_hte_a1a);
                            String tercero_p2a = rs.getString(sql_hte_p2a);
                            String tercero_a2a = rs.getString(sql_hte_a2a);
                            String tercero_nom = rs.getString(sql_hte_nan);
                            String titular = "";
                            if (tercero_p1a != null) {
                                titular += tercero_p1a + " ";
                            }
                            if (tercero_a1a != null) {
                                titular += tercero_a1a + " ";
                            }
                            if (tercero_p2a != null) {
                                titular += tercero_p2a + " ";
                            }
                            if (tercero_a2a != null) {
                                titular += tercero_a2a + " ";
                            }
                            if (titular.trim().equals("")) {
                                titular = tercero_nom;
                            } else {
                                titular = titular.substring(0, titular.length() - 1) + ", " + tercero_nom;
                            }

                            // Interesado principal
                            if (rs.getInt("MOSTRAR") == 1) {
                                tvo1.setTitular(titular);
                            }

                            // Listado de interesados con roles
                            if (primero) {
                                primero = false;
                            } else {
                                interesados += ";";
                            }

                            titular = tercero_nom + " ";
                            if (tercero_p1a != null) {
                                titular += tercero_p1a + " ";
                            }
                            if (tercero_a1a != null) {
                                titular += tercero_a1a + " ";
                            }
                            if (tercero_p2a != null) {
                                titular += tercero_p2a + " ";
                            }
                            if (tercero_a2a != null) {
                                titular += tercero_a2a + " ";
                            }
                            titular = titular.trim();

                            interesados += titular + " (" + rs.getString("ROL_DES") + ")";
                        }
                        m_Log.debug("Interesados del expediente: " + interesados);
                        tvo1.setListaInteresados(interesados);
                        rs.close();
                        stmt.close();

                        // SE RECUPERAN TODOS LOS TRÁMITES ABIERTOS PARA EL EXPEDIENTE
                        sql = "SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,TML_VALOR,UOR_NOM " +
                                "FROM E_TRA, E_CRO " +
                                " inner join E_TML on (CRO_PRO = TML_PRO and CRO_MUN = TML_MUN and CRO_TRA = TML_TRA) "+
                                " inner join A_UOR  on (CRO_UTR = UOR_COD) "+                      
                                "WHERE TRA_MUN = " + tvo1.getCodMunicipio() + " AND TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA " +
                                " AND CRO_MUN = " + tvo1.getCodMunicipio() + " AND CRO_EJE="+tvo1.getEjercicio()+" AND CRO_NUM = '" + tvo1.getNumero() + "' " +
                                " AND CRO_FEF IS NULL";
                        m_Log.debug("sql: " + sql);
                        stmt = con.prepareStatement(sql);
                        rs = stmt.executeQuery();

                        ArrayList<String> coleccionFueraPlazo = new ArrayList<String>();
                        SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
                        String tramites = ""; 
                        String unidadesTramitadoras = "";
                        primero = true;
                        while (rs.next()) {
                            int plazoCercaFin = 0;
                            String tipoPlazo = null;
                            int unidadesPlazo = 0;
                            String fechaLimite = null;
                            Timestamp tFechaLimite = null;
                            // Obtener la fecha inicio tramite y el % cerca de aviso.
                            plazoCercaFin = rs.getInt("TRA_FIN");
                            tipoPlazo = rs.getString("TRA_UND");
                            unidadesPlazo = rs.getInt("TRA_PLZ");
                            tFechaLimite = rs.getTimestamp("FechaLimite");
                            if (primero) {
                                primero = false;
                            } else {
                                tramites += ";";
                                unidadesTramitadoras += ";";
                            }

                            tramites += rs.getString("TML_VALOR");
                            unidadesTramitadoras += rs.getString("UOR_NOM");

                            // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                            // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                            Calendar fechaLimitePlazo = null;
                            if (tFechaLimite != null) {
                                fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());

                                fechaLimitePlazo = Calendar.getInstance();
                                fechaLimitePlazo.clear();
                                java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                                fechaLimitePlazo.setTime(dateLimite);
                                fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                                fechaLimitePlazo.set(Calendar.MINUTE, 59);
                                fechaLimitePlazo.set(Calendar.SECOND, 59);
                                if (fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin >= 0) {
                                    String fuera = calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);

                                    if ("si".equals(fuera)) {
                                        coleccionFueraPlazo.add(fuera);
                                    }
                                }
                            }
                        }// while
                        rs.close();
                        stmt.close();
                        tvo1.setPlazoCercaFin("no");
                        if (coleccionFueraPlazo != null && coleccionFueraPlazo.contains("si")) {
                            // Si hay algún trámite del expediente en cerca de fin de plazo. El expediente
                            // se pintará como cerca de fin de plazo
                            tvo1.setPlazoCercaFin("si");
                        }


                        // OBTENEMOS LOS NOMBRES DE LOS TRAMITES PENDIENTES
                        // Los tramites pendientes son aquellos sin fecha de fin
                        m_Log.debug("Tramites pendientes: " + tramites);
                        tvo1.setListaTramitesPendientes(tramites);
                        m_Log.debug("Unidades tramitadoras pendientes: " + unidadesTramitadoras);
                        tvo1.setListaUnidadesTramitadorasPendientes(unidadesTramitadoras);



                        /** Se recuperan los valores de los campos suplementarios que forman parte de la vista de pendientes */
                         Hashtable<String,String> campos = new Hashtable<String,String>();
                       
                        if(camposSuplementarios!=null && camposSuplementarios.size()>0){
                            
                                campos = CamposListadoPendientesProcedimientoManager.getInstance().getValorCampoSuplementario2(tvo1.getNumero(),tvo1.getEjercicio(),tvo1.getCodMunicipio(),camposSuplementarios,params);                                                                                   

                            tvo1.setValoresCamposVistaPendientes(campos);
                        
                        }//if

                        /**************** Se comprueba si el expediente está cerca o fuera de plazo ********************/
                                                

                        if(!listaPlazos.containsKey(tvo1.getCodProcedimiento())){
                            DefinicionProcedimientosValueObject dfvo = new DefinicionProcedimientosValueObject();
                            dfvo.setTxtCodigo(tvo1.getCodProcedimiento());
                            listaPlazos.put(tvo1.getCodProcedimiento(),DefinicionProcedimientosManager.getInstance().getPlazosFinalizacion(dfvo, con));
                            // El manager es DefinicionProcedimientosManager
                        }

                        /**********/
                        DefinicionProcedimientosValueObject definicion = listaPlazos.get(tvo1.getCodProcedimiento());
                        m_Log.debug("=================> Plazos de la definición del procedimiento");
                        Calendar fechaInicioExpediente = DateOperations.toCalendar(tvo1.getFechaInicioExpediente(),"dd/MM/yyyy");
                        if(definicion!=null && definicion.getPlazo()!=null && definicion.getTipoPlazo()!=null){
                            Calendar fechaFin = null;

                            if(!listaFestivos.containsKey(tvo1.getEjercicio())){
                                    listaFestivos.put(Integer.parseInt(tvo1.getEjercicio()),this.getFestivos(Integer.parseInt(tvo1.getEjercicio()),con));
                            }
                            int porcentaje = 0;
                            if(definicion.getPorcentaje()!=null && definicion.getPorcentaje().length()>0)
                                    porcentaje = Integer.parseInt(definicion.getPorcentaje());

                            // Se obtiene la fecha de fin del expediente                            
                            fechaFin = this.calcularFechaFinExpediente(fechaInicioExpediente,Integer.parseInt(definicion.getPlazo()),Integer.parseInt(definicion.getTipoPlazo()),listaFestivos.get(tvo1.getEjercicio()));
                            m_Log.debug(">>>>>>> getExpedientesPendiente fechaInicio " + this.mostrarFecha(fechaInicioExpediente));
                            m_Log.debug(">>>>>>> getExpedientesPendiente fechaFin " + this.mostrarFecha(fechaFin));

                            // Se comprueba si el expediente está cercano a la fecha de fin o fuera de plazo
                            String resultado = this.calculoExpedienteCercaFinPlazo(porcentaje,fechaInicioExpediente,fechaFin);
                            // Si la salida es un si es que el expediente está cerca de fin de plazo
                            // Si el resultado es nulo es que no se está ni cerca ni fuera de plazo
                            if(resultado==null){
                                    tvo1.setCercaPlazoExpediente(false);
                                    tvo1.setFueraPlazoExpediente(false);
                            }else{

                                    if(resultado.equals("si")){
                                            tvo1.setCercaPlazoExpediente(true);
                                            tvo1.setFueraPlazoExpediente(false);
                                    }

                                    // Si el resultado es no es que no lo está
                                    if(resultado.equals("no")){
                                            tvo1.setCercaPlazoExpediente(false);
                                            tvo1.setFueraPlazoExpediente(true);
                                    }
                            }//else
                        }//if

                        /**************** Se comprueba si el expediente está cerca o fuera de plazo ********************/

                        if (filtro != 0) {
                            listaFinal.addElement(tvo1);
                        } else {
                            if ((tvo1.getPlazoCercaFin()).equals("si")) {
                                listaFinal.addElement(tvo1);
                            }
                        }
                    }

                } catch (Exception e) {
                    listaFinal = null;
                    e.printStackTrace();
                    if (m_Log.isErrorEnabled()) {
                        m_Log.error(e.getMessage());
                    }
                    throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientesFiltrados", e);

                } finally {
                    try {
                        
                        if(params[0]!=null && (params[0].equals("oracle") || params[0].equals("ORACLE")) ){
                            Statement st_alter;
                            String alter1 = "ALTER SESSION SET NLS_COMP=BINARY";
                            String alter2 = "ALTER SESSION SET NLS_SORT=SPANISH";
                            st_alter = con.createStatement();
                            st_alter.executeQuery(alter1);
                            st_alter.executeQuery(alter2);

                            st_alter.close();
                        }
                        
                        m_Log.debug(" ************************************** TramitacionDAO.getExpedientesPendientesFiltrados. ANTES DE CERRAR LA CONEXIÓN CON LA BASE DE DATOS *******************");
                        oad.devolverConexion(con);
                        m_Log.debug(" ************************************** TramitacionDAO.getExpedientesPendientesFiltrados. DESPUÉS DE CERRAR LA CONEXIÓN CON LA BASE DE DATOS *******************");
                    } catch (BDException bde) {
                        bde.printStackTrace();
                        if (m_Log.isErrorEnabled()) {
                            m_Log.error(bde.getMessage());
                        }
                        throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientesFiltrados.Devolver conexion", bde);
                        } catch (SQLException sqle) {
                            sqle.printStackTrace();
                            if (m_Log.isErrorEnabled()) m_Log.error("SQLException del finally: " + sqle.getMessage());
                        }
                        }
            } else {
                listaFinal = cargarPaginaExpedientesCercaFinPlazo(uVO, tVO, params, columna, tipoOrden, 0);
            }
        }// else
        m_Log.debug("getExpedientesPendientesFiltrados en TramitacionDAO" + listaFinal.size());

        return listaFinal;
    }

    /*
     * Si cargaPagina=true es que es la consulta de carga de la página (la que debe traer todos los datos).
     */
    // original
    //private String queryExpedientesFiltrados(AdaptadorSQLBD oad, int filtro, UsuarioValueObject uVO, boolean cargaPagina,String codProcedimiento) {
    private String queryExpedientesFiltrados(AdaptadorSQLBD oad, int filtro, UsuarioValueObject uVO, boolean cargaPagina,String codProcedimiento,String codRangoTemporal,
            String columna,int tipoDato,ValoresCriterioBusquedaExpPendientesVO criterio, List<String> idCargos) {
        String sql = "";
        
        String parteSelectCampoSuplementario         = null;
        String parteFromColumnaCampoSuplementario    = null;
        String parteGroupByColumnaCampoSuplementario = null;        
        boolean ordenCampoSuplementario = false;

        /************ criterio búsqueda ***************/
        String parteFromBusquedaCampoSuplementario ="";        
                
        boolean eTXTEnFrom = false; // indica si se la tabla E_TXT ya se encuentra en la claúsula FROM
        boolean eTFEEnFrom = false; // indica si se la tabla E_TFE ya se encuentra en la claúsula FROM
        boolean eTNUEnFrom = false; // indica si se la tabla E_TNU ya se encuentra en la claúsula FROM
        boolean eTFECEnFrom = false; // indica si se la tabla E_TFEC ya se encuentra en la claúsula FROM
        boolean eTNUCEnFrom = false; // indica si se la tabla E_TNUC ya se encuentra en la claúsula FROM
        boolean eTDEEnFrom = false; // indica si se la tabla E_TDE ya se encuentra en la claúsula FROM
        String parteWhereByColumnaCampoSuplementario = null;
        TransformacionAtributoSelect transformador = new TransformacionAtributoSelect(oad);
        /************ criterio búsqueda ***************/

        
        /** SE COMPRUEBA SI LA COLUMNA POR LA QUE SE ORDENA NO ES NUMÉRICA, EN ESTE CASO ES QUE SE PRETENDE ORDENAR POR UN CAMPO SUPLEMENTARIO DE LA VISTA DE EXPEDIENTES
             PENDIENTES DEL PROCEDIMIENTO **/
            if(columna!=null && !"".equals(columna) && !NumericOperations.isInteger(columna)){
                /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/                
                m_Log.debug("La tabla en la que se aloja el valor del campo suplementario es " + tipoDato);
                switch (tipoDato){
                    case 1: //  Campo de tipo numérico
                        parteSelectCampoSuplementario         = "E_TNU.TNU_VALOR" ;
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TNU.TNU_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTNUEnFrom                            = true;
                        break;
                    case 2: //  Campo de tipo texto corto
                        parteSelectCampoSuplementario         = "E_TXT.TXT_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TXT.TXT_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TXT.TXT_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTXTEnFrom                            = true;
                        break;
                    case 3: //  Campo de tipo fecha
                        parteSelectCampoSuplementario         = "E_TFE.TFE_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TFE.TFE_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TFE.TFE_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTFEEnFrom                            = true;
                        break;
                    case 6: //  Campo de tipo desplegable
                        parteSelectCampoSuplementario         = "E_TDE.TDE_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TDE.TDE_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TDE.TDE_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTDEEnFrom                            = true;
                        break;
                    case 8: //  Campo de tipo numérico calculado
                        parteSelectCampoSuplementario         = "E_TNUc.TNUC_VALOR" ;
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TNUC.TNUC_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TNUC.TNUC_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTNUCEnFrom                            = true;
                        break;                    
                    case 9: //  Campo de tipo fecha calculado
                        parteSelectCampoSuplementario         = "E_TFEC.TFEC_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TFEC.TFEC_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TFEC.TFEC_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTFECEnFrom                            = true;
                        break;

                }// switch
            }// if
        /*************************************************/


         //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
            String parteWhereBusquedaCampoSuplementario = "";
            String parteFromBusquedaCampoSuplementarioNumerico    = "";
            String parteFromBusquedaCampoSuplementarioFecha       = "";
            String parteFromBusquedaCampoSuplementarioNumericoCal = "";
            String parteFromBusquedaCampoSuplementarioFechaCal    = "";
            String parteFromBusquedaCampoSuplementarioDesplegable = "";
            String parteFromBusquedaCampoSuplementarioTexto       = "";
            boolean busquedaCampoSuplementario = false;

               /** SE COMPRUEBA SI SE HA ESTABLECIDO UN CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO, YA QUE EN ESTE CASO HABRÁ QUE
                     AÑADIR LA PARTE FROM Y LA PARTE WHERE  **/
                if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda()){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                    if(criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda()))
                    {
                        int tipoDatoCampo = Integer.parseInt(criterio.getTipoCampoSuplementarioCriterioBusqueda());
                        m_Log.debug("El tipo del dato del campo suplementario por el que se hace la búsqueda es " + tipoDato);
                        switch (tipoDatoCampo){
                            case 1: //  Campo de tipo numérico
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioNumerico = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND TNU_VALOR<=" + valores.get(1) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR!=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                            case 2: //  Campo de tipo texto corto
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioTexto = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                               
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR!='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==7){ // Operador LIKE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR LIKE('%" +  valores.get(0) + "%') AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }


                                busquedaCampoSuplementario = true;
                                break;
                            case 3: //  Campo de tipo fecha
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioFecha    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                              try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    /*
                                    parteWhereBusquedaCampoSuplementario = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0));
                                    */
                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0))  + " ) ";
                                   
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT DISTINCT(TFE_VALOR) FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                                 }catch(Exception e){
                                        e.printStackTrace();
                                    }
                            case 6: //  Campo de tipo desplegable
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioDesplegable  = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";

                                 if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR='" + valores.get(0) + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador !=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR!='" + valores.get(0) + "') ";
                                }

                                busquedaCampoSuplementario            = true;
                                break;
                            case 8: //  Campo de tipo numérico Calculado                                
                                parteFromBusquedaCampoSuplementarioNumericoCal = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND TNUC_VALOR<=" + valores.get(1) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR!=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;                            
                            case 9: //  Campo de tipo fecha calculado                                
                                parteFromBusquedaCampoSuplementarioFechaCal    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                                 try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =                                    
                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0))  + " ) ";
                                    
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT DISTINCT(TFEC_VALOR) FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                                }catch(Exception e){
                                    e.printStackTrace();
                                }
                        }// switch
                    }// if
                }// if

        //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
        

        if (filtro == 0) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                
                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                 String parteFrom2 = " " +
                        " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";   
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " +  
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                        **/    

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*************************************************/

                if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUc NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEc NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
                }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " + sql_pml_lengua + 
                        "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))";

                 if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() +")))";

            /********* nuevo para busqueda ********/
            if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                       
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                    }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                  

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

           String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ,E_EXR." + sql_exr_top ;
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA" ;

               /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/


                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXR." + sql_exr_top;
                        //"E_EXP." + sql_exp_fechIni + "," + 
                        //"E_EXR." + sql_exr_top + " ";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";                      

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        
                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                 if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else                        
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
                }

                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " + 
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))";


                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() +")))";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

             /******************************************  CRITERIO BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                     }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' "; */

                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

             /******* CRITERIO BÚSQUEDA ******/


                String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXR."+sql_exr_top + " ";
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }

        } else if (filtro == 1) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +                                                
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                         "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                         ***/


                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                /********************* SE AÑADE LA PARTE CORRESPONDIENTE EN EL FROM DE LA CONSULTA PARA PODER ORDENAR POR EL CAMPO SUPLEMENTARIO ***********************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*******************************************************************/


              /***************** SE COMPRUEBA SI HAY QUE AÑADIR LA PARTE CORRESPONDIENTE EN LA PARTE FROM DE LA CONSULTA SQL CORRESPONDIENTE A LA BÚSQUEDA POR CAMPO SUPLEMENTARIO  ****************/
               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


              String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + ") ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                    }catch(Exception e){
                            e.printStackTrace();
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                   // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                    "E_EXP." + sql_exp_codProc + ", " +
                    "E_EXP." + sql_exp_ejer + ", " +
                    "E_EXP." + sql_exp_num + ", " +
                    oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + ", " +
                    sql_pml_valorCampo + ", " +
                    "E_EXP." + sql_exp_fechIni + ", " +
                    "E_EXP." + sql_exp_asunto + ", " +
                    "G_REL." + sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ,E_EXR."+sql_exr_top +" ";
                    "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/
                
                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;
                        //"E_EXR." + sql_exr_top + " " ;
                
                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";
                
                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        "INNER JOIN  E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                        ***/

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                 /***************** SE COMPRUEBA SI HAY QUE AÑADIR LA PARTE CORRESPONDIENTE EN LA PARTE FROM DE LA CONSULTA SQL CORRESPONDIENTE A LA BÚSQUEDA POR CAMPO SUPLEMENTARIO  ****************/
               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO +  "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                      
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                    }catch(Exception e){
                            e.printStackTrace();
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

             
                String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        //"E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + ", E_EXP.EXP_IMP, " + "E_EXR."+sql_exr_top ;
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }

        } else if ((filtro == 2)||(filtro == 7)) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni, " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) ";
                /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")"; **/
                parteFrom2=parteFrom2+"LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() ;
                        if (filtro == 7){
                            parteFrom2=parteFrom2+  " AND CRO_UTR=UOU_UOR) ";
                            //para este caso extraemos los cargos                                   
                            parteFrom2=parteFrom2+"  JOIN E_TRA on( (CRO_TRA=TRA_COD) AND TRA_CAR = UOU_CAR "
                                    + " OR  UOU_CAR =0 )";
                        }
                        else{
                            parteFrom2=parteFrom2+") ";
                        }
                parteFrom2=parteFrom2+" INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") ";
                        

                /******************* INICIO: CRITERIO DE BÚSQUEDA ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* FIN: CRITERIO DE BÚSQUEDA ***********************/


               /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
              /*************************************************/


              if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
              }//if


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                 /******************************************  BÚSQUEDA ***********************************************/

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/


            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                   }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            /********************** criterio búsqueda *^******************************/
                

              String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;

            } else {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;
                        //"E_EXR."+sql_exr_top;

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";                      

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "INNER JOIN E_PRO ON (EXP_MUN = PRO_MUN AND EXP_PRO = PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod();                        
                         if (filtro == 7){
                            parteFrom2=parteFrom2+  " AND  CRO_UTR=UOU_UOR) ";
                            //para este caso extraemos los cargos                                   
                            parteFrom2=parteFrom2+"  JOIN E_TRA   on ( (CRO_TRA=TRA_COD) AND TRA_CAR = UOU_CAR "
                                    + " or  UOU_CAR =0 )";
                        }
                        else{
                            parteFrom2=parteFrom2+") ";
                        }
                         /**
                        parteFrom2=parteFrom2 + "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")"; **/
                        
                /******************* INICIO: CRITERIO DE BÚSQUEDA ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* FIN: CRITERIO DE BÚSQUEDA ***********************/

                if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
              }//if


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " +
                        sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/



            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                     }catch(Exception e){
                            e.printStackTrace();
                     }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                   // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                   // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            /********************** criterio búsqueda *^******************************/

           String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        //"E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM"  + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM,E_EXP.EXP_IMP, E_EXP.EXP_FPA ";


                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
                return sql;
            }

        } else if (filtro == 3) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni, " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";
                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) " + 
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                       "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                        ***/

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*************************************************/

                 if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
            }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " +
                        sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND (NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) " + 
                       " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************** INICIO: CRITERIO DE BÚSQUEDA **************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                   }catch(Exception e){
                            e.printStackTrace();
                   }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }
            /******************** FIN: CRITERIO DE BÚSQUEDA **************/

                String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ," + "E_EXR."+sql_exr_top;
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;
                        //"E_EXR."+sql_exr_top;
                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "INNER JOIN E_PRO ON (EXP_MUN = PRO_MUN AND EXP_PRO = PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        
                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND(NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/


                /******************** INICIO: CRITERIO DE BÚSQUEDA **************/
                // Se comprueba si el criterio no es nulo
                if(criterio!=null){
                    // Si se ha introducido algún criterio de búsqueda
                   ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                   String auxiliar = "";
                   if("1".equals(criterio.getCodigoCriterioBusqueda())){
                        // Número de expediente
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }
                   else
                   if("4".equals(criterio.getCodigoCriterioBusqueda())){
                        // Búsqueda por fecha de inicio de expediente
                       try{ 
                       if(criterio.getOperadorCriterioBusqueda()==0)
                            //auxiliar = " AND E_EXP.EXP_FEI=? ";
                            
                                auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                            
                        else
                        if(criterio.getOperadorCriterioBusqueda()==1)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==2)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==3)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==4)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                           auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                       }catch(Exception e){
                                e.printStackTrace();
                            }
                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("5".equals(criterio.getCodigoCriterioBusqueda())){
                        // Asunto
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                    }else
                    if("6".equals(criterio.getCodigoCriterioBusqueda())){
                        // Observaciones
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("2".equals(criterio.getCodigoCriterioBusqueda())){                                       
                        // Identificación
                        if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                      + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                        }else{
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                        }
                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("3".equals(criterio.getCodigoCriterioBusqueda())){
                       // Interesado
                       String nombre    = null;
                       String apellido1 = null;
                       String apellido2 = null;

                       if(valores!=null && valores.size()==1){
                           nombre = valores.get(0);
                       }else
                       if(valores!=null && valores.size()==2){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                       }else
                       if(valores!=null && valores.size()==3){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                           apellido2 =  valores.get(2);
                       }

                       if(nombre!=null)
                           auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                       if(apellido1!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                       if(apellido2!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }//if

                }//if

                if(busquedaCampoSuplementario){
                    // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                    pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
                }
              /******************** FIN: CRITERIO DE BÚSQUEDA **************/
                

                String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        //"E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }
            /***** oscar ****/
        //}else if(filtro==4 || filtro==5 || filtro==6){
        }else if(filtro==4 || filtro==5 || filtro==6 || filtro==8){
            /** SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO */
             String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                "E_EXP."+ sql_exp_codMun+ ", " +
                sql_pml_valorCampo + ", " +
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +
                oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fIni, " +
                "E_EXP."+sql_exp_codProc+ ", " +
                "E_EXP."+sql_exp_fechIni + ", " +
                "E_EXP."+sql_exp_asunto + ", " +
                "G_REL."+sql_rel_num + ", " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {oad.convertir(sql_cro_fli,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {sql_uou_uor}) + " AS ExisUOR, " +
                oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM,"+
                 "  E_EXP.EXP_FEI AS fIniOrden, " +
                //oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"YYYY/MM/DD") + " AS fFinOrden" + ",E_EXR."+sql_exr_top;
                "   E_EXP.EXP_FEF AS fFinOrden";

                // obtenemos campo que nos muestra si un expediente esta destacado
                parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) "  +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +
                    "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                    "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                    /***
                    "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                    "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                    ***/

            /******************* criterio búsqueda ***********************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************* criterio búsqueda ***********************/


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }

             if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
                        
            }


            String pWhere2 = "";
            if (filtro==4 || filtro ==5){
                
                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' "
                    + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' "
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) " 
                        + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" +  uVO.getOrgCod() + "))) ";


                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
            }else  if (filtro == 6){

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND EXP_IMP='S' " +
                           " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " +
                           " OR (exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + ")) " +
                           " AND " + sql_cro_fef + " IS NULL) " +
                           " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento))
                      pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";                  
                
            }else if (filtro == 8){
                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + 
                           " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " +
                           " OR (exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + ")) " +
                           " AND " + sql_cro_fef + " IS NULL) " +
                           " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))" +
                           " AND E_EXP.EXP_FPA  IS NOT NULL AND E_EXP.EXP_FPA < "+oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null);

                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento))
                      pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";                  
                
                
            }
            
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

            /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                    }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + ", " +
                    sql_pml_valorCampo + ", " +
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP."+sql_exp_asunto + ", " +
                    "G_REL."+sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    //"E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;
                    "E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/

            m_Log.debug("queryExpedientesFiltrados filtro=4. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);

         }
        return sql;
    }



      private String queryExpedientesFiltradosOrdenInteresados(AdaptadorSQLBD oad, int filtro, UsuarioValueObject uVO, boolean cargaPagina,String codProcedimiento,String codRangoTemporal,ValoresCriterioBusquedaExpPendientesVO criterio) {

        String sql = "";
        String parteSelect2 = "";
        String parteFrom2 = "";
        String pWhere2 = "";
        String groupSelect = "";

        
          //============================ GENERACIÓN DE LA PARTE FROM EN EL CASO DE QUE EL CRITERIO DE BUSQUEDA SEA POR CAMPO SUPLEMENTARIO ======================================>
            String parteWhereBusquedaCampoSuplementario = "";
            String parteFromBusquedaCampoSuplementario  = "";
            String parteFromBusquedaCampoSuplementarioNumerico    = "";
            String parteFromBusquedaCampoSuplementarioFecha       = "";
            String parteFromBusquedaCampoSuplementarioDesplegable = "";
            String parteFromBusquedaCampoSuplementarioTexto       = "";
            boolean busquedaCampoSuplementario = false;

            TransformacionAtributoSelect transformador = new TransformacionAtributoSelect(oad);

               /** SE COMPRUEBA SI SE HA ESTABLECIDO UN CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO, YA QUE EN ESTE CASO HABRÁ QUE
                     AÑADIR LA PARTE FROM Y LA PARTE WHERE  **/
                if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda()){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                    if(criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda()))
                    {
                        int tipoDato = Integer.parseInt(criterio.getTipoCampoSuplementarioCriterioBusqueda());
                        m_Log.debug("El tipo del dato del campo suplementario por el que se hace la búsqueda es " + tipoDato);
                        switch (tipoDato){
                            case 1: //  Campo de tipo numérico
                                
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";
                                //parteFromBusquedaCampoSuplementarioNumerico = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";
                                
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND TNU_VALOR<=" + valores.get(1) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR!=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                            case 2: //  Campo de tipo texto corto
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                //parteFromBusquedaCampoSuplementarioTexto = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                                
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR!='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==7){ // Operador LIKE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR LIKE('%" +  valores.get(0) + "%') AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario = true;
                                break;
                            case 3: //  Campo de tipo fecha
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                //parteFromBusquedaCampoSuplementarioFecha    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                                try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    /*
                                    parteWhereBusquedaCampoSuplementario = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0));
                                    */
                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0))  + " ) ";
                                    
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                                }catch(Exception e){
                                        e.printStackTrace();
                                }
                            case 6: //  Campo de tipo desplegable
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                //parteFromBusquedaCampoSuplementarioDesplegable  = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";
                                
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR='" + valores.get(0) + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador !=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR!='" + valores.get(0) + "') ";
                                }

                                busquedaCampoSuplementario            = true;
                                break;
                            case 8: //  Campo de tipo numérico calculado
                                
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";                                
                                
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNCU_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND TNUC_VALOR<=" + valores.get(1) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR!=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario = true;
                                break;                            
                            case 9: //  Campo de tipo fecha calculada                                
                                parteFromBusquedaCampoSuplementario = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                                try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                   
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0))  + " ) ";
                                    
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                             + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario = true;
                                break;
                                }catch(Exception e){
                                        e.printStackTrace();
                                    }
                        }// switch
                    }// if
                }// if

            //============================ FIN: PARTE FROM Y WHERE DEL CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
        

        if (filtro == 0) {
            if (cargaPagina == true) {
                parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                /*********** CRITERIO DE BÚSQUEDA *********************/
                if(busquedaCampoSuplementario){
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                }
                /*********** CRITERIO DE BÚSQUEDA *********************/


                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " +
                        sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))"+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";
                
                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";
	
            /******************************************  PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){ 
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0){
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    }
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0)+":"+valores.get(1));
                    }catch(Exception e){
                            e.printStackTrace();
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                 
                   
                   // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            // SI EL CRITERIO DE BÚSQUEDA ES UN CAMPO SUPLEMENTARIO  SE AÑADE LA PARTE WHERE EN LA CONSULTA SQL
            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }
           /******************************************  PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/

                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;
                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+ " AS NOMBRE";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                         parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))"+
                       " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + " ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }

        } else if (filtro == 1) {
            if (cargaPagina == true) {
                parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                         sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+ " AS NOMBRE";

                        // devolvemos tambien el campo que nos indica si un expediente  es importante o no
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+" ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                /************ CRITERIO DE BÚSQUEDA *******************/
                if(busquedaCampoSuplementario){            
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                }
                /************ CRITERIO DE BÚSQUEDA *******************/

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + ") "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";
	
            /****************************************** INICIO:PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0){
                       
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    }
                   
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1));

                    }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                  
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if
            }//if
           /****************************************** FIN:PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/

            // SI EL CRITERIO DE BÚSQUEDA ES UN CAMPO SUPLEMENTARIO  SE AÑADE LA PARTE WHERE EN LA CONSULTA SQL
            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


               groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";

                        // devolvemos tambien el campo que nos indica si un expediente  es importante o no
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                         parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";
	
                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + " ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }

        } else if ((filtro == 2)||(filtro == 7)) {    
            if (cargaPagina == true) {
                parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc +  ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";
                if (filtro == 7){
                    parteFrom2=parteFrom2+  " AND  CRO_UTR=UOU_UOR ";
                            //para este caso extraemos los cargos                                   
                    parteFrom2=parteFrom2+"  JOIN E_TRA   on ( (CRO_TRA=TRA_COD) AND TRA_CAR = UOU_CAR "
                                    + " or  UOU_CAR =0)";
                }

                /******************* CRITERIO DE BÚSQUEDA ***********************/
                if(busquedaCampoSuplementario){
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                }
                /******************* CRITERIO DE BÚSQUEDA ***********************/

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                 if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))	
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";	
                
            /******************************************  INICIO: PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                   if(criterio.getOperadorCriterioBusqueda()==0){
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    }
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0)) ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                   }catch(Exception e){
                            e.printStackTrace();
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){                  
                   // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            /******************************************  FIN: PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/

            // SI EL CRITERIO DE BÚSQUEDA ES UN CAMPO SUPLEMENTARIO  SE AÑADE LA PARTE WHERE EN LA CONSULTA SQL
            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


                /** PRUEBAS ORDEN INTERESADO FILTRADO POR PROCEDIMIENTO */
                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                /** PRUEBAS ORDEN INTERESADO FILTRADO POR PROCEDIMIENTO */

                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;

            } else {
                parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+ " AS NOMBRE";

                        // devolvemos tambien el campo que nos indica si un expediente  es importante o no
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                             parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+" ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " + 
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";
	
                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + " ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});



                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
                return sql;
            }

        } else if (filtro == 3) {
            if (cargaPagina == true) {
                parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +
                        "E_PML." + sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+") "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                /*********** CRITERIO DE BÚSQUEDA ******************/
                if(busquedaCampoSuplementario){
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
                }


                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND (NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";
                
                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                 if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))	
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";	
	
                 /******************************************  PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/
                // Se comprueba si el criterio no es nulo
                if(criterio!=null){
                    // Si se ha introducido algún criterio de búsqueda
                   ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                   String auxiliar = "";
                   if("1".equals(criterio.getCodigoCriterioBusqueda())){
                        // Número de expediente
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }
                   else
                   if("4".equals(criterio.getCodigoCriterioBusqueda())){
                        // Búsqueda por fecha de inicio de expediente
                       try{ 
                       if(criterio.getOperadorCriterioBusqueda()==0){
                            
                                auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                            
                        }
                        else
                        if(criterio.getOperadorCriterioBusqueda()==1)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==2)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==3)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0)) ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==4)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                           auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1)) ;

                       }catch(Exception e){
                                e.printStackTrace();
                            }
                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("5".equals(criterio.getCodigoCriterioBusqueda())){
                        // Asunto
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                    }else
                    if("6".equals(criterio.getCodigoCriterioBusqueda())){
                        // Observaciones
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("2".equals(criterio.getCodigoCriterioBusqueda())){
                        // Identificación
                        if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                      + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                        }else{
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                        }

                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("3".equals(criterio.getCodigoCriterioBusqueda())){
                       // Interesado
                       String nombre    = null;
                       String apellido1 = null;
                       String apellido2 = null;

                       if(valores!=null && valores.size()==1){
                           nombre = valores.get(0);
                       }else
                       if(valores!=null && valores.size()==2){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                       }else
                       if(valores!=null && valores.size()==3){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                           apellido2 =  valores.get(2);
                       }

                       if(nombre!=null)
                           auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                       if(apellido1!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                       if(apellido2!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }//if

                }//if

                // SI EL CRITERIO DE BÚSQUEDA ES UN CAMPO SUPLEMENTARIO  SE AÑADE LA PARTE WHERE EN LA CONSULTA SQL
                if(busquedaCampoSuplementario){
                    // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                    pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
                }

                groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;

                        parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                        oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+ " AS NOMBRE";

                        // devolvemos tambien el campo que nos indica si un expediente  es importante o no
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

                parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +
                        "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                        "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";

                 parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' " + " AND " +
                        sql_pml_lengua + "='"+idiomaDefecto+"' " + " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND(NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }
                
                 if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))	
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";	
                
                groupSelect = " GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        sql_pml_valorCampo + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + " ";
                groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }
        }else                   
         //if(filtro==4 || filtro==5){
         if(filtro==4 || filtro==5 || filtro==6 || filtro==8){
            // SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO
            parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                "E_EXP."+ sql_exp_codMun+ ", " +
                "E_PML."+sql_pml_valorCampo + ", " +
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +
                oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fIni,E_EXP." +
                sql_exp_codProc + ", " +
                "E_EXP."+sql_exp_fechIni + ", " +
                "E_EXP."+sql_exp_asunto + ", " +
                "G_REL."+sql_rel_num + ", " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {oad.convertir(sql_cro_fli,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {sql_uou_uor}) + " AS ExisUOR, " +
                oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM,"+
                 "  E_EXP.EXP_FEI AS fIniOrden, " +
                "   E_EXP.EXP_FEF AS fFinOrden";

                parteSelect2=parteSelect2+", "+"T_HTE."+ sql_hte_ter+ ", " +
                oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a,  "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a,  "T_HTE."+ sql_hte_nan})+" AS NOMBRE";

                // obtenemos campo que nos muestra si un expediente esta destacado
                parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";

            parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +
                    "INNER JOIN E_PML ON (E_EXP." + sql_exp_codMun + " = " + sql_pml_codMun + " AND " +
                    "E_EXP." + sql_exp_codProc + " = " + sql_pml_codProc + ") " +
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";

            parteFrom2=parteFrom2+" "+
                                "LEFT JOIN E_EXT ON (E_EXP."+sql_exp_ejer+"=E_EXT."+ext_eje+" AND E_EXP."+sql_exp_codMun+"=E_EXT."+ext_mun+" AND E_EXP."+sql_exp_num+"=E_EXT."+ext_num+"  ) "+
                                "LEFT JOIN T_HTE ON (E_EXT."+ext_ter+"=T_HTE."+sql_hte_ter+" AND E_EXT."+ext_nvr+"=T_HTE."+sql_hte_nvr+") ";

         

            // SI EL CRITERIO DE BÚSQUEDA ES POR UN CAMPO SUPLEMENTARIO, SE AÑADE LOS JOIN CORRESPONDIENTE EN LA PARTE FROM DE LA CONSULTA SQL
            if(busquedaCampoSuplementario){            
                parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementario;
            }

            pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_pml_campo + "='NOM' "
                    + " AND " + sql_pml_lengua + "='"+idiomaDefecto+"' "
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) "+
                        " AND (E_EXT.EXT_TER IS NULL  OR  E_EXT.EXT_TER=(SELECT MAX(EXT_TER) FROM E_EXT  WHERE EXT_NUM=E_EXP.EXP_NUM AND MOSTRAR=1))";
            
                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                   pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";	
                }
            
                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

             if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))	
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";	
	
            if(filtro==6){
                pWhere2 = pWhere2 + " AND EXP_IMP='S' ";
            }
            if(filtro==8){
               pWhere2 = pWhere2 + " AND E_EXP.EXP_FPA  IS NOT NULL AND E_EXP.EXP_FPA < "+oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null);
            }

            if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" +  codProcedimiento + "') ";
            }

            /******************************************  PARTE WHERE PARA LOS CRITERIOS DE BÚSQUEDA POR UN CAMPO FIJO ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0){
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    }
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                    }catch(Exception e){
                            e.printStackTrace();
                     }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){                  
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            // SI EL CRITERIO DE BÚSQUEDA ES UN CAMPO SUPLEMENTARIO  SE AÑADE LA PARTE WHERE EN LA CONSULTA SQL
            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            groupSelect = "GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + ", " +
                    sql_pml_valorCampo + ", " +
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP."+sql_exp_asunto + ", " +
                    "G_REL."+sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    "E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP, E_EXP.EXP_FPA ";
            groupSelect=groupSelect+",HTE_TER,"+oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"T_HTE."+ sql_hte_p1a, "T_HTE."+ sql_hte_a1a, "T_HTE."+ sql_hte_p2a,  "T_HTE."+ sql_hte_a2a, "T_HTE."+ sql_hte_nan});

            m_Log.debug("queryExpedientesFiltrados filtro=4. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);

        }
        return sql;
    }

    private boolean isCercaFinPlazo(TramitacionValueObject tvo1, Connection con, AdaptadorSQLBD oad) {
        PreparedStatement stmt = null;
        ResultSet rs = null;
        boolean devolver = false;

        try {
            String sql = "SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite " +
                    "FROM E_TRA, E_CRO " +
                    "WHERE TRA_MUN = " + tvo1.getCodMunicipio() + " AND TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA " +
                    "AND CRO_MUN = " + tvo1.getCodMunicipio() + " AND CRO_NUM = '" + tvo1.getNumero() + "' " +
                    "AND CRO_FEF IS NULL";
            m_Log.debug("sql: " + sql);
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();

            ArrayList<String> coleccionFueraPlazo = new ArrayList<String>();
            SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
            while (rs.next()) {
                int plazoCercaFin = 0;
                String tipoPlazo = null;
                int unidadesPlazo = 0;
                String fechaLimite = null;
                Timestamp tFechaLimite = null;
                // Obtener la fecha inicio tramite y el % cerca de aviso.
                plazoCercaFin = rs.getInt("TRA_FIN");
                tipoPlazo = rs.getString("TRA_UND");
                unidadesPlazo = rs.getInt("TRA_PLZ");
                tFechaLimite = rs.getTimestamp("FechaLimite");

                // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                Calendar fechaLimitePlazo = null;
                if (tFechaLimite != null) {
                    fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());

                    fechaLimitePlazo = Calendar.getInstance();
                    fechaLimitePlazo.clear();
                    java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                    fechaLimitePlazo.setTime(dateLimite);
                    fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                    fechaLimitePlazo.set(Calendar.MINUTE, 59);
                    fechaLimitePlazo.set(Calendar.SECOND, 59);
                    if (fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin >= 0) {
                        String fuera = calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);

                        if ("si".equals(fuera)) {
                            coleccionFueraPlazo.add(fuera);
                        }
                    }
                }
            }// while
            rs.close();
            stmt.close();
            if (coleccionFueraPlazo != null && coleccionFueraPlazo.contains("si")) {
                devolver = true;
            } else {
                devolver = false;
            }

            return devolver;

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            return devolver;
        }
    }

    public Vector cargarPaginaExpedientesCercaFinPlazo(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params, String columna, String tipoOrden, int filtro)
            throws TramitacionException, TechnicalException {

        Vector lista = new Vector();
        Vector listaFinal = new Vector();
        Vector listaProvisional = new Vector();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt;
        ResultSet rs = null;
        String sql;
        /************** criterio búsqueda ***********************/
        ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();
        /************** criterio búsqueda ***********************/
        
        try {
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

            String codProcedimiento = null;
            if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento()) && !"TODOS".equalsIgnoreCase(tVO.getCodProcedimiento()))
                codProcedimiento = tVO.getCodProcedimiento();

            sql = queryExpedientesFiltrados(oad, filtro, uVO, true,codProcedimiento,tVO.getCodRangoTemporal(),columna,-1,criterio,null);
            String pOrder = "";
            if (("".equals(columna)) || (columna == null) || ("0".equals(columna))) {
                pOrder = " ORDER BY " + sql_exp_fechIni + " DESC ";
            } else {
                pOrder = " ORDER BY " + columna + " " + tipoOrden;
            }

            sql = sql + pOrder;

            if (m_Log.isDebugEnabled()) {
                m_Log.debug(sql);
            }
            
            
            stmt = con.prepareStatement(sql);
            
            
            if ("1".equals(tVO.getCodRangoTemporal())) {
                Calendar calendario = Calendar.getInstance();
                calendario.add(Calendar.MONTH, -6);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
                stmt.setTimestamp(1, time);

            } else if ("2".equals(tVO.getCodRangoTemporal())) {
                Calendar calendario = Calendar.getInstance();
                calendario.add(Calendar.MONTH, -12);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
                stmt.setTimestamp(1, time);

            }
            
            rs = stmt.executeQuery();
            int posE = 0;
            int numPaginaE = 0;
            int pagActual = -1;
            if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado() != null) {
                pagActual = Integer.parseInt(tVO.getPaginaListado());
            }
            int lineas = -1;
            if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado() != null) {
                lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());
            }
            
            Calendar today = Calendar.getInstance();
            ConsultaExpedientesDAO cDAO = ConsultaExpedientesDAO.getInstance();
            
            while (rs.next()) {
                String fueraDePlazo = "no";
                String pendiente = "no";
                TramitacionValueObject tvo1 = new TramitacionValueObject();
                tvo1.setLocalizacion(rs.getString(1));
                tvo1.setCodMunicipio(rs.getString(2));
                tvo1.setCodProcedimiento(rs.getString(7));
                tvo1.setDescProcedimiento(rs.getString(3));
                tvo1.setEjercicio(rs.getString(4));
                tvo1.setNumero(rs.getString(5));
                tvo1.setFechaInicioExpediente(rs.getString(6));
                String asuntoExp = rs.getString(9);
                if (asuntoExp != null) {
                    tvo1.setAsuntoExp(AdaptadorSQLBD.js_escape(asuntoExp));
                } else {
                    tvo1.setAsuntoExp("");
                }
                String numeroRelacion = rs.getString(10);
                if (numeroRelacion == null) {
                    tvo1.setNumeroRelacion("");
                } else {
                    tvo1.setNumeroRelacion(numeroRelacion);
                }

                boolean aux = isCercaFinPlazo(tvo1, con, oad);
                if (!aux) {
                    tvo1.setPlazoCercaFin("si");
                    listaProvisional.addElement(tvo1);
                } else {
                    continue;
                }
                tvo1.setExpImportante(rs.getString("EXP_IMP"));

                Calendar fecAlarma = DateOperations.timestampToCalendar(rs.getTimestamp("EXP_FPA"));
                if (fecAlarma == null)
                    tvo1.setAlarmaVencida("nadaQueMostrar"); 
                else if (fecAlarma.before(today))
                    tvo1.setAlarmaVencida("si"); 
                else
                    tvo1.setAlarmaVencida("no"); 
                
                // Ver si esta fuera de plazo.
                String fechaLimite = rs.getString(11);
                tvo1.setFechaLimiteP(fechaLimite);

                tvo1.setFueraDePlazo(fueraDePlazo);
                // Comprobar si esta pendiente
                String exisUOR = rs.getString(12);
                if (exisUOR != null) {
                    pendiente = "si";
                }
                tvo1.setPendiente(pendiente);
                tvo1.setFechaFinExpediente(rs.getString("fFin"));
                tvo1.setEstado(rs.getString("ESTADO"));
                tvo1.setUsuarioIni(rs.getString("USU_NOM"));
                tvo1.setUnidadInicio(rs.getString("UOR_NOM"));
                
                if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(), con)){
                    tvo1.setTipoInicio("Instancia");
                }else
                    tvo1.setTipoInicio("Oficio");
                
            }
            rs.close();
            stmt.close();

            for (int k = 0; k < listaProvisional.size(); k++) {
                numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                if (numPaginaE != pagActual) {
                    posE++;
                    continue;
                }
                lista.add(listaProvisional.get(k));
                posE++;

            }

            for (int i = 0; i < lista.size(); i++) {
                TramitacionValueObject tvo1;
                tvo1 = (TramitacionValueObject) lista.elementAt(i);

                // OBTENER LOS DATOS DE LOS INTERESADOS
                sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, ROL_DES, MOSTRAR FROM E_ROL,E_EXT "
                        + " LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR)  " +
                        "WHERE EXT_MUN = " + tvo1.getCodMunicipio() + " AND EXT_EJE = " + tvo1.getEjercicio() + " " +
                        "AND EXT_NUM = '" + tvo1.getNumero() + "' AND ROL_MUN = " + tvo1.getCodMunicipio() + " " +
                        "AND ROL_PRO = '" + tvo1.getCodProcedimiento() + "' AND ROL_COD = EXT_ROL " ;
                       

                if (m_Log.isDebugEnabled()) {
                    m_Log.debug(sql);
                }
                stmt = con.prepareStatement(sql);
                rs = stmt.executeQuery();

                String interesados = "";
                boolean primero = true;
                while (rs.next()) {
                    // Obtener una descripcion del tercero.
                    String tercero_p1a = rs.getString(sql_hte_p1a);
                    String tercero_a1a = rs.getString(sql_hte_a1a);
                    String tercero_p2a = rs.getString(sql_hte_p2a);
                    String tercero_a2a = rs.getString(sql_hte_a2a);
                    String tercero_nom = rs.getString(sql_hte_nan);
                    String titular = "";
                    if (tercero_p1a != null) {
                        titular += tercero_p1a + " ";
                    }
                    if (tercero_a1a != null) {
                        titular += tercero_a1a + " ";
                    }
                    if (tercero_p2a != null) {
                        titular += tercero_p2a + " ";
                    }
                    if (tercero_a2a != null) {
                        titular += tercero_a2a + " ";
                    }
                    if (titular.trim().equals("")) {
                        titular = tercero_nom;
                    } else {
                        titular = titular.substring(0, titular.length() - 1) + ", " + tercero_nom;
                    }

                    // Interesado principal
                    if (rs.getInt("MOSTRAR") == 1) {
                        tvo1.setTitular(titular);
                    }

                    // Listado de interesados con roles
                    if (primero) {
                        primero = false;
                    } else {
                        interesados += ";";
                    }

                    titular = tercero_nom + " ";
                    if (tercero_p1a != null) {
                        titular += tercero_p1a + " ";
                    }
                    if (tercero_a1a != null) {
                        titular += tercero_a1a + " ";
                    }
                    if (tercero_p2a != null) {
                        titular += tercero_p2a + " ";
                    }
                    if (tercero_a2a != null) {
                        titular += tercero_a2a + " ";
                    }
                    titular = titular.trim();

                    interesados += titular + " (" + rs.getString("ROL_DES") + ")";
                }
                m_Log.debug("Interesados del expediente: " + interesados);
                tvo1.setListaInteresados(interesados);
                rs.close();
                stmt.close();

                // SE RECUPERAN TODOS LOS TRÁMITES ABIERTOS PARA EL EXPEDIENTE
                sql = "SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,TML_VALOR,UOR_NOM "
                                + "FROM E_TRA, E_CRO "
                                + " inner join E_TML on (CRO_PRO = TML_PRO and CRO_MUN = TML_MUN and CRO_TRA = TML_TRA) "
                                + " inner join A_UOR  on (CRO_UTR = UOR_COD) "
                                + "WHERE TRA_MUN = " + tvo1.getCodMunicipio() + " AND TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA "
                                + "AND CRO_MUN = " + tvo1.getCodMunicipio() + " AND CRO_EJE=" + tvo1.getEjercicio() + " AND CRO_NUM = '" + tvo1.getNumero() + "' "
                                + "AND CRO_FEF IS NULL";
                m_Log.debug("sql: " + sql);
                stmt = con.prepareStatement(sql);
                rs = stmt.executeQuery();

                ArrayList<String> coleccionFueraPlazo = new ArrayList<String>();
                SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
                String tramites = "";
                String unidadesTramitadoras = "";
                primero = true;
                while (rs.next()) {
                    int plazoCercaFin = 0;
                    String tipoPlazo = null;
                    int unidadesPlazo = 0;
                    String fechaLimite = null;
                    Timestamp tFechaLimite = null;
                    // Obtener la fecha inicio tramite y el % cerca de aviso.
                    plazoCercaFin = rs.getInt("TRA_FIN");
                    tipoPlazo = rs.getString("TRA_UND");
                    unidadesPlazo = rs.getInt("TRA_PLZ");
                    tFechaLimite = rs.getTimestamp("FechaLimite");
                    
                    if (primero) {
                        primero = false;
                    } else {
                        tramites += ";";
                        unidadesTramitadoras += ";";
                    }

                    tramites += rs.getString("TML_VALOR");
                    unidadesTramitadoras += rs.getString("UOR_NOM");

                    // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                    // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                    Calendar fechaLimitePlazo = null;
                    if (tFechaLimite != null) {
                        fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());

                        fechaLimitePlazo = Calendar.getInstance();
                        fechaLimitePlazo.clear();
                        java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                        fechaLimitePlazo.setTime(dateLimite);
                        fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                        fechaLimitePlazo.set(Calendar.MINUTE, 59);
                        fechaLimitePlazo.set(Calendar.SECOND, 59);
                        if (fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin >= 0) {
                            String fuera = calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);

                            if ("no".equals(fuera)) {
                                coleccionFueraPlazo.add(fuera);
                            }
                        }
                    }
                }// while
                rs.close();
                stmt.close();
                tvo1.setPlazoCercaFin("no");
                if (coleccionFueraPlazo != null && coleccionFueraPlazo.contains("no")) {
                    // Si hay algún trámite del expediente en cerca de fin de plazo. El expediente
                    // se pintará como cerca de fin de plazo
                    tvo1.setPlazoCercaFin("si");
                }


                m_Log.debug("Tramites pendientes: " + tramites);
                tvo1.setListaTramitesPendientes(tramites);
                m_Log.debug("Unidades tramitadoras pendientes: " + unidadesTramitadoras);
                tvo1.setListaUnidadesTramitadorasPendientes(unidadesTramitadoras);
                // OBTENEMOS LOS NOMBRES DE LOS TRAMITES PENDIENTES
                // Los tramites pendientes son aquellos sin fecha de fin
               


                //listaFinal.addElement(tvo1);
                if (filtro != 0) {
                    listaFinal.addElement(tvo1);
                } else {
                    if ((tvo1.getPlazoCercaFin()).equals("si")) {
                        listaFinal.addElement(tvo1);
                    }
                }
            }

        } catch (Exception e) {
            listaFinal = null;
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) {
                m_Log.error(e.getMessage());
            }
            throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientes", e);

        } finally {
            try {
                oad.devolverConexion(con);
            } catch (BDException bde) {
                bde.printStackTrace();
                if (m_Log.isErrorEnabled()) {
                    m_Log.error(bde.getMessage());
                }
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientes.Devolver conexion", bde);
            }
        }

        m_Log.debug("getListaExpedientesPendientes en TramitacionDAO" + listaFinal.size());
        return listaFinal;
    }


    /**
     * Recupera los días festivos de un determinado ejercicio
     * @param ejercicio: Año
     * @param con: Conexión a la BD
     * @return Colección de objetos calendar
     */
    public ArrayList<Calendar> getFestivos(int ejercicio,Connection con) throws SQLException{

        ArrayList<Calendar> festivos = new ArrayList<Calendar>();
        PreparedStatement ps = null;
        ResultSet  rs = null;
        try{

            String sql = "SELECT GEN_CAL_DIA FROM  GEN_CALENDARIO WHERE GEN_CAL_ANO=?";
            m_Log.debug("sql: " + sql);
            m_Log.debug("ejercicio: " + ejercicio);
            int i=1;
            ps = con.prepareStatement(sql);
            ps.setInt(i,ejercicio);

            rs = ps.executeQuery();
            while(rs.next()){
                festivos.add(DateOperations.toCalendar(rs.getTimestamp("GEN_CAL_DIA")));
            }

        }catch(SQLException e){
            e.printStackTrace();
            m_Log.error(e.getMessage());
        }finally{
            try{
                if(rs!=null) rs.close();
                if(ps!=null) ps.close();
            }catch(SQLException e){                
            }
        }

        return festivos;
    }
    
    /**
     * Comprueba si un determinado Calendar está en una colección de objetos Calendar
     * @param fecha: Calendar
     * @param festivos: Colección de días festivos
     * @return Boolean
     */
    public static boolean constainsDay(Calendar fecha,ArrayList<Calendar> festivos){
        boolean exito = false;

        if(festivos!=null){
            for(int i=0;i<festivos.size();i++){
                Calendar festivo = festivos.get(i);
                int diaFestivo   = festivo.get(Calendar.DAY_OF_MONTH);
                int mesFestivo =  festivo.get(Calendar.MONTH);
                int yearFestivo = festivo.get(Calendar.YEAR);


                int dia   = fecha.get(Calendar.DAY_OF_MONTH);
                int mes =  fecha.get(Calendar.MONTH);
                int year = fecha.get(Calendar.YEAR);

                if(dia==diaFestivo && mes==mesFestivo && year==yearFestivo){
                    exito = true;break;
                }
            }// for
        }

        return exito;
    }


    private String mostrarFecha(Calendar c){
        SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy HH:mm:ss");
        return sf.format(c.getTime());
    }

    /**
     *
     * Obtiene la fecha de fin de un expediente calculando a partir de la fecha de inicio del mismo, nº de unidades y tipo de plazo
     * @param fechaInicioExpediente: Fecha inicio
     * @param unidades: Número
     * @param tipoPlazo:En función del valor que tome se obtiene la fecha de fin del expediente. Los valores a tomar son:
     *                              1: Días naturales, 2: Días hábiles, 3: Meses
     * @param festivos: Colección de Calendar que representan a los días festivos correspondientes al mismo ejercicio al que pertenece el expediente
     *
     * @return Calendar
     */
    public Calendar calcularFechaFinExpediente(Calendar fechaInicioExpediente,int unidades,int tipoPlazo,ArrayList<Calendar> festivos){
        
        Calendar fechaFin = (Calendar)fechaInicioExpediente.clone();
            
        fechaFin.set(Calendar.HOUR_OF_DAY,0);
        fechaFin.set(Calendar.MINUTE,0);
        fechaFin.set(Calendar.SECOND,0);

        m_Log.debug("Fecha inicio: " + mostrarFecha(fechaInicioExpediente));

        // Se calcula la fecha de fin de plazo
        if(tipoPlazo==TramitacionDAO.TIPO_PLAZO_EXPEDIENTES_DIAS_NATURALES){
             m_Log.debug("Calcular fecha de fin teniendo en cuenta que son días naturales");
             fechaFin.add(Calendar.DATE, unidades);
             m_Log.debug("Fecha fin: " + mostrarFecha(fechaFin) + " después de " + unidades + " días naturales");
        }

        if(tipoPlazo==TramitacionDAO.TIPO_PLAZO_EXPEDIENTES_MESES){
            m_Log.debug("Calcular fecha de fin teniendo en cuenta que son meses");
            fechaFin.add(Calendar.MONTH, unidades);
            m_Log.debug("Fecha fin: " + mostrarFecha(fechaFin) + " después de " + unidades + " meses");
        }

        if(tipoPlazo==TramitacionDAO.TIPO_PLAZO_EXPEDIENTES_DIAS_HABILES){        
            int contador = unidades;
            while(contador>0){
                fechaFin.add(Calendar.DATE, 1);
                boolean festivo = constainsDay(fechaFin,festivos);
                if(fechaFin.get(Calendar.DAY_OF_WEEK)!=Calendar.SUNDAY && fechaFin.get(Calendar.DAY_OF_WEEK)!=Calendar.SATURDAY && !festivo){
                    // Si el día de la semana no ni sábado ni domingo ni festivo
                    contador--;
                }
            } // while
        }

        m_Log.debug("La fecha de inicio a partir de la que se hace el cálculo es: " + mostrarFecha(fechaInicioExpediente));
        m_Log.debug("La fecha de fin a devolver es " + mostrarFecha(fechaFin));
        return fechaFin;
    }

/**
 * Comprueba si un expediente se encuentra actualmente cerca de su fin de plazo o bien fuera de plazo
 * @param porcentaje: Porcentaje de la fecha de fin a partir del cual se comienza a avisar
 * @param fechaInicio: Fecha de inicio del expediente
 * @param fechaFin: Fecha de fin de expediente
 * @return String que toma los siguientes valores:
 *                  "si": Expediente cercano a fin de plazo
 *                  "no": Fuera de plazo
 *                  null: No verifica ninguna de las condiciones anteriores
 */
     public String calculoExpedienteCercaFinPlazo(int porcentaje, Calendar fechaInicio, Calendar fechaFin) {
        String fuera =  null;
        //calculo el dia de inicio de plazo        
        int horas;
        int diaP = 0;
        

        m_Log.debug(" ********  calculoExpedienteCercaFinPlazo.fechaInicio : "+ mostrarFecha(fechaInicio));
        m_Log.debug(" ********  calculoExpedienteCercaFinPlazo.fechaFin : "+ mostrarFecha(fechaFin));

        if (fechaInicio == null) return fuera;      
         
        //Realizo la operación
        long time = fechaFin.getTimeInMillis() - fechaInicio.getTimeInMillis();
        //Muestro el resultado en días       
        int d = (int) (time / (3600 * 24 * 1000));
       
        horas = ((24 * d * porcentaje) / 100);
        
        diaP =(int)Math.ceil(((double)horas/(double)24));
        
        m_Log.debug(" ********   horas antes que debe avisar : " + diaP);
        //si diap es = tengo que avisar el mismo dia que finaliza
        //calculo la fecha para ello covierto a calendar el string
        
        Calendar calendario = Calendar.getInstance();

        // Se obtiene la fecha para comenzar a avisar.
        Calendar comenzarAviso= Calendar.getInstance();
        comenzarAviso.setTimeInMillis(fechaFin.getTimeInMillis());
        comenzarAviso.add(Calendar.HOUR, -horas);
         m_Log.debug(" ********  comenzarAviso : "+ comenzarAviso.getTime().toString());
        
        if (calendario.after(comenzarAviso) && calendario.before(fechaFin)) fuera = "si";
        else if(calendario.after(fechaFin)) fuera = "no";

        // VALORES DE RETORNO POSIBLES.
        // fuera = "si" --> hay que avisar que el trámite está cercano a la finalización del plazo.
        // fuera = "no" -->  hay que avisar que el trámite está fuera de fin del plazo.
        m_Log.debug(" ********   fuera : " + fuera);
        return fuera;
    }




     /**
      * Recupera los expedientes pendientes. Se recuperan bien los que estén cerca de fin de plazo o bien los que estén fuera de plazo, dependiendo del valor
      * indicado en el parámetro filtro
      * @param uVO
      * @param tVO
      * @param params
      * @param columna
      * @param tipoOrden
      * @param filtro
      * @param con
      * @return
      * @throws es.altia.agora.business.sge.exception.TramitacionException
      * @throws es.altia.common.exception.TechnicalException
      */
      public Vector getExpedientesPendientesPlazoFiltrados(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params, String columna, String tipoOrden, int filtro,Connection con,AdaptadorSQLBD oad)
            throws TramitacionException, TechnicalException {

             String sql;
             ResultSet rs = null;
             PreparedStatement stmt = null;
             Vector lista = new Vector();
             Vector listaFinal = new Vector();
             String codigoColOrdInteresado=COLUMNA_ORDEN_INTERESADO; //Columna de ordenación por tercero             
             Vector<CampoSuplementarioVO> camposSuplementarios = null;       
             String nsl_comp_anterior="";
             String nsl_sort_anterior="";
             String valor_nsl_comp_anterior="";
             String valor_nsl_sort_anterior="";
                 
             
             boolean ordenCampoSuplementario =false;
             String parteOrderByColumnaCampoSuplementario = null;                          


             /********** criterio búsqueda ***************/
             ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();
             /********** criterio búsqueda ***************/
             
             try {
                 
                    if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento())){
                        if(CamposListadoPendientesProcedimientoDAO.getInstance().tieneProcedimientoVistaExpedientesPendientes(tVO.getCodProcedimiento(),uVO.getOrgCod(),con)){
                            m_Log.debug("Filtro procedimiento " + tVO.getCodProcedimiento() + " tiene vista de pendientes propia");
                            camposSuplementarios = CamposListadoPendientesProcedimientoDAO.getInstance().getCamposSuplementariosListado(tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                        }//if
                    }// if
                 
                    
                    if(codigoColOrdInteresado.equals(columna))
                        sql= queryExpedientesFiltradosOrdenInteresados(oad, filtro, uVO, true,tVO.getCodProcedimiento(),tVO.getCodRangoTemporal(),criterio);
                    else{
                        String codProcedimiento = null;
                        if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento()) && !"null".equalsIgnoreCase(tVO.getCodProcedimiento()) && !"TODOS".equalsIgnoreCase(tVO.getCodProcedimiento()))
                            codProcedimiento = tVO.getCodProcedimiento();


                        /*************************************/
                        int tipoDato = -1;
                        if(codProcedimiento!=null && !"".equals(codProcedimiento) && columna!=null && !"".equals(columna)){
                            // Si se filtra por procedimiento y la columna no es numérica => Entonces se ordena por un campo suplementario
                            // perteneciente a la vista del procedimiento.
                            tipoDato = CamposListadoPendientesProcedimientoDAO.getInstance().getTipoCampoSuplementario(columna,tVO.getCodProcedimiento(),uVO.getOrgCod(),con);
                            m_Log.debug("La tabla en la que se aloja el valor del campo suplementario es " + tipoDato);

                            switch(tipoDato){
                                 case 1: //  Campo de tipo numérico                                    
                                    parteOrderByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;
                                case 2: //  Campo de tipo texto corto                                    
                                    parteOrderByColumnaCampoSuplementario = "E_TXT.TXT_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;
                                case 3: //  Campo de tipo fecha
                                    parteOrderByColumnaCampoSuplementario = "E_TFE.TFE_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;
                                case 6: //  Campo de tipo desplegable                                    
                                    parteOrderByColumnaCampoSuplementario = "E_TDE.TDE_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;
                                case 8: //  Campo de tipo numérico calculado                                 
                                    parteOrderByColumnaCampoSuplementario = "E_TNUC.TNUC_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;                                
                                case 9: //  Campo de tipo fecha calculado
                                    parteOrderByColumnaCampoSuplementario = "E_TFEC.TFEC_VALOR ";
                                    ordenCampoSuplementario               = true;
                                    break;
                            }// switch
                        }// if
                        /***************************************/
                        
                        /** original
                            sql = queryExpedientesFiltrados(oad, filtro, uVO, true,codProcedimiento); */
                        sql = queryExpedientesFiltrados(oad, filtro, uVO, true,codProcedimiento,tVO.getCodRangoTemporal(),columna,tipoDato,criterio,null);
                    }
                    String pOrder = "";
                    // Se supone que en este caso que el expediente no esta cerrado
                    if(codigoColOrdInteresado.equals(columna))//Ordenacion por interesado
                    {
                        pOrder= "ORDER BY NOMBRE"+ " "+tipoOrden;
                    }
                    else
                    {
                        if (("".equals(columna)) || (columna == null) || ("0".equals(columna))) {
                            pOrder = " ORDER BY " + sql_exp_fechIni + " DESC ";
                        } else {
                            //pOrder = " ORDER BY " + columna + " " + tipoOrden;                            
                            /*************************************************/
                            if(ordenCampoSuplementario){
                                // Se añade a la parte ORDER BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                                pOrder = " ORDER BY " + parteOrderByColumnaCampoSuplementario + " " + tipoOrden;
                            }else
                               pOrder = " ORDER BY "+ columna + " "+tipoOrden;

                            /*************************************************/
                            
                        }// else
                    }// else

                    sql = sql + pOrder;

                    if (m_Log.isDebugEnabled()) {
                        m_Log.debug(sql);
                    }

                    /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
//                    if(params[0]!=null && (params[0].equalsIgnoreCase("oracle"))){
//                        String alter1 = "ALTER SESSION SET NLS_COMP=LINGUISTIC";
//                        String alter2 = "ALTER SESSION SET NLS_SORT=GENERIC_BASELETTER";
//                        Statement st =con.createStatement();
//                        st.executeQuery(alter1);
//                        st=con.prepareStatement(alter2);
//                        st.executeQuery(alter2);
//                        st.close();
//                    }
                    /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/



                    stmt = con.prepareStatement(sql);
                    /*****************************************  criterio busqueda ************************************************/
                    ArrayList<String> valores = null;
                    if(criterio!=null) valores = criterio.getValoresCriterioBusqueda();

                    int contador = 1;
                 if ("1".equals(tVO.getCodRangoTemporal())) {
                     Calendar calendario = Calendar.getInstance();
                     calendario.add(Calendar.MONTH, -6);
                     Timestamp time = new Timestamp(calendario.getTimeInMillis());
                     stmt.setTimestamp(contador++, time);

                 } else if ("2".equals(tVO.getCodRangoTemporal())) {
                     Calendar calendario = Calendar.getInstance();
                     calendario.add(Calendar.MONTH, -12);
                     Timestamp time = new Timestamp(calendario.getTimeInMillis());
                     stmt.setTimestamp(contador++, time);

                 }

                    if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())){ // Criterio de búsqueda es la fecha de inicio
                        //int contador = 1;
                        m_Log.debug("Operador criterio: " + criterio.getOperadorCriterioBusqueda());

                    }//if
                    else
                    if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda())
                            && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                       
                    }// if
                    /*****************************************  criterio busqueda ************************************************/



                    rs = stmt.executeQuery();
                    int posE = 0;
                    int numPaginaE = 0;
                    int pagActual = -1;
                    if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado() != null) {
                        pagActual = Integer.parseInt(tVO.getPaginaListado());
                    }
                    int lineas = -1;
                    if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado() != null) {
                        lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());
                    }
                    boolean expInsertado = false;
                    Calendar today = Calendar.getInstance();
                    ConsultaExpedientesDAO cDAO = ConsultaExpedientesDAO.getInstance();
                    while (rs.next()) {
                        expInsertado = false;
                        String pendiente = "no";
                        TramitacionValueObject tvo1 = new TramitacionValueObject();
                        tvo1.setLocalizacion(rs.getString(1));
                        tvo1.setCodMunicipio(rs.getString(2));
                        tvo1.setCodProcedimiento(rs.getString(7));
                        tvo1.setDescProcedimiento(rs.getString(3));
                        tvo1.setEjercicio(rs.getString(4));
                        tvo1.setNumero(rs.getString(5));
                        tvo1.setFechaInicioExpediente(rs.getString(6));
                        String asuntoExp = rs.getString(9);
                        Calendar fechaInicio = DateOperations.toCalendar(rs.getTimestamp("EXP_FEI"));
                        fechaInicio.set(Calendar.HOUR_OF_DAY,0);
                        fechaInicio.set(Calendar.MINUTE,0);
                        fechaInicio.set(Calendar.SECOND,0);
                        if (asuntoExp != null) {
                            tvo1.setAsuntoExp(AdaptadorSQLBD.js_escape(asuntoExp));
                        } else {
                            tvo1.setAsuntoExp("");
                        }
                        String numeroRelacion = rs.getString(10);
                        if (numeroRelacion == null) {
                            tvo1.setNumeroRelacion("");
                        } else {
                            tvo1.setNumeroRelacion(numeroRelacion);
                        }

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        tvo1.setExpImportante(rs.getString("EXP_IMP"));
                        
                        Calendar fecAlarma = DateOperations.timestampToCalendar(rs.getTimestamp("EXP_FPA"));
                        if (fecAlarma == null)
                            tvo1.setAlarmaVencida("nadaQueMostrar"); 
                        else if (fecAlarma.before(today))
                            tvo1.setAlarmaVencida("si"); 
                        else
                            tvo1.setAlarmaVencida("no"); 

                        DefinicionProcedimientosValueObject definicion = new DefinicionProcedimientosValueObject();
                        definicion.setTxtCodigo(tvo1.getCodProcedimiento());
                        definicion = DefinicionProcedimientosManager.getInstance().getPlazosFinalizacion(definicion, con);
                        ArrayList<Calendar> festivos = TramitacionManager.getInstance().getFestivos(Integer.parseInt(tvo1.getEjercicio()), con);
                        
                        //FECHA VENCIMIENTO
                        if ((filtro==8) && "si".equals(tvo1.getAlarmaVencida())){
                            
                            // Expediente con alarma
                            tvo1.setFechaVencidaExpediente(true);

                            numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                            if(numPaginaE>pagActual){
                                // Si ya nos hemos pasado de la página actual salimos del bucle para no seguir recorriendo el resultset
                                break;
                            }else
                            if (numPaginaE != pagActual) {
                                posE++;                                        
                                continue;
                            }else{
                                lista.addElement(tvo1);
                                expInsertado = true;   // la variable posE solo se debe incrementar cuando se ha agregado un expediente
                            }
                        }
                        
                        if(definicion!=null && definicion.getPlazo()!=null && definicion.getTipoPlazo()!=null)
                        {
                            int porcentaje = 0;
                            if(definicion.getPorcentaje()!=null)
                                porcentaje = Integer.parseInt(definicion.getPorcentaje());

                            Calendar fechaFin = TramitacionManager.getInstance().calcularFechaFinExpediente(fechaInicio,Integer.parseInt(definicion.getPlazo()), Integer.parseInt(definicion.getTipoPlazo()), festivos);
                            String resultado = TramitacionManager.getInstance().calculoExpedienteCercaFinPlazo(porcentaje, fechaInicio, fechaFin);
                            if(resultado!=null){
                                // cuando estamos mostrando los expedientes destacados(filtro==6), tambien debemos mostrar la informacion
                                // de los expedientes cercanos o fuera de plazo
                                if ((filtro==4 && resultado.equals("si")) ||(filtro==6 && resultado.equals("si")) ){
                                    // Expediente cerca a fin de plazo
                                    tvo1.setCercaPlazoExpediente(true);
                                    tvo1.setFueraPlazoExpediente(false);

                                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                                    if(numPaginaE>pagActual){
                                        // Si ya nos hemos pasado de la página actual salimos del bucle para no seguir recorriendo el resultset
                                        break;
                                    }else
                                    if (numPaginaE != pagActual) {
                                        posE++;                                        
                                        continue;
                                    }else{
                                        lista.addElement(tvo1);
                                        expInsertado = true;   // la variable posE solo se debe incrementar cuando se ha agregado un expediente
                                    }
                                    

                                }else if ((filtro==5 && resultado.equals("no")) || (filtro==6 && resultado.equals("no"))){
                                    // Expediente fuera de plazo
                                    tvo1.setCercaPlazoExpediente(false);
                                    tvo1.setFueraPlazoExpediente(true);

                                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                                    if(numPaginaE>pagActual){
                                        // Si ya nos hemos pasado de la página actual salimos del bucle para no seguir recorriendo el resultset
                                        break;
                                    }else
                                    if (numPaginaE != pagActual) {
                                        posE++;                                        
                                        continue;
                                    }else{
                                        lista.addElement(tvo1);
                                        expInsertado = true;   // la variable posE solo se debe incrementar cuando se ha agregado un expediente
                                    }
                                }

                            }else { // si el resultado es nulo y el filtro es el de expdientes destacados, insertamos igualmente
                                if (filtro == 6) {
                                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                                    if(numPaginaE>pagActual){
                                        // Si ya nos hemos pasado de la página actual salimos del bucle para no seguir recorriendo el resultset
                                        break;
                                    }else
                                    if (numPaginaE != pagActual) {
                                        posE++;
                                        continue;
                                    } else {
                                        lista.addElement(tvo1);
                                        expInsertado = true;    
                                    }
                                }
                            }

                        }else{  // si el filtro==6 (expedientes  destacados) entonces debemos insertar el expediente igualmente
                            if (filtro == 6){
                                numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                                
                                if(numPaginaE>pagActual){
                                    // Si ya nos hemos pasado de la página actual salimos del bucle para no seguir recorriendo el resultset
                                    break;
                                }else
                                if (numPaginaE != pagActual) {
                                    posE++;                                    
                                    continue;
                                }else{
                                    lista.addElement(tvo1);
                                    expInsertado = true;   
                                }
                            }
                        }
                        
                      
                        // Comprobar si esta pendiente
                        String exisUOR = rs.getString(12);
                        if (exisUOR != null) {
                            pendiente = "si";
                        }
                        tvo1.setPendiente(pendiente);
                        tvo1.setFechaFinExpediente(rs.getString("fFin"));
                        tvo1.setEstado(rs.getString("ESTADO"));
                        tvo1.setUsuarioIni(rs.getString("USU_NOM"));
                        tvo1.setUnidadInicio(rs.getString("UOR_NOM"));      
                        
                        if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(), con)){
                            tvo1.setTipoInicio("Instancia");
                        }else
                            tvo1.setTipoInicio("Oficio");                        
                        /**
                        if ("0".equals(rs.getString("EXR_TOP")))
                            tvo1.setTipoInicio("Instancia");
                        else tvo1.setTipoInicio("Oficio");
                        **/
                        if (expInsertado) posE++;
                    }
                    rs.close();
                    stmt.close();
                    
                    
                    
                    
                    
                    for (int i = 0; i < lista.size(); i++) {
                        TramitacionValueObject tvo1;
                        tvo1 = (TramitacionValueObject) lista.elementAt(i);
                        
                        // OBTENER LOS DATOS DE LOS INTERESADOS
                        sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, ROL_DES, MOSTRAR FROM E_ROL,E_EXT"
                        + " LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR)  " +
                                "WHERE EXT_MUN = " + tvo1.getCodMunicipio() + " AND EXT_EJE = " + tvo1.getEjercicio() + " " +
                                "AND EXT_NUM = '" + tvo1.getNumero() + "' AND ROL_MUN = " + tvo1.getCodMunicipio() + " " +
                                "AND ROL_PRO = '" + tvo1.getCodProcedimiento() + "' AND ROL_COD = EXT_ROL ";
                               

                        if (m_Log.isDebugEnabled()) {
                            m_Log.debug(sql);
                        }
                        stmt = con.prepareStatement(sql);
                        rs = stmt.executeQuery();

                        String interesados = "";
                        boolean primero = true;
                        while (rs.next()) {
                            // Obtener una descripcion del tercero.
                            String tercero_p1a = rs.getString(sql_hte_p1a);
                            String tercero_a1a = rs.getString(sql_hte_a1a);
                            String tercero_p2a = rs.getString(sql_hte_p2a);
                            String tercero_a2a = rs.getString(sql_hte_a2a);
                            String tercero_nom = rs.getString(sql_hte_nan);
                            String titular = "";
                            if (tercero_p1a != null) {
                                titular += tercero_p1a + " ";
                            }
                            if (tercero_a1a != null) {
                                titular += tercero_a1a + " ";
                            }
                            if (tercero_p2a != null) {
                                titular += tercero_p2a + " ";
                            }
                            if (tercero_a2a != null) {
                                titular += tercero_a2a + " ";
                            }
                            if (titular.trim().equals("")) {
                                titular = tercero_nom;
                            } else {
                                titular = titular.substring(0, titular.length() - 1) + ", " + tercero_nom;
                            }

                            // Interesado principal
                            if (rs.getInt("MOSTRAR") == 1) {
                                tvo1.setTitular(titular);
                            }

                            // Listado de interesados con roles
                            if (primero) {
                                primero = false;
                            } else {
                                interesados += ";";
                            }

                            titular = tercero_nom + " ";
                            if (tercero_p1a != null) {
                                titular += tercero_p1a + " ";
                            }
                            if (tercero_a1a != null) {
                                titular += tercero_a1a + " ";
                            }
                            if (tercero_p2a != null) {
                                titular += tercero_p2a + " ";
                            }
                            if (tercero_a2a != null) {
                                titular += tercero_a2a + " ";
                            }
                            titular = titular.trim();

                            interesados += titular + " (" + rs.getString("ROL_DES") + ")";
                        }
                        m_Log.debug("Interesados del expediente: " + interesados);
                        tvo1.setListaInteresados(interesados);
                        rs.close();
                        stmt.close();

                        // SE RECUPERAN TODOS LOS TRÁMITES ABIERTOS PARA EL EXPEDIENTE
                        sql = "SELECT TRA_FIN, TRA_UND, TRA_PLZ, CRO_FLI as FechaLimite,TML_VALOR,UOR_NOM "
                                + "FROM E_TRA, E_CRO "
                                + " inner join E_TML on (CRO_PRO = TML_PRO and CRO_MUN = TML_MUN and CRO_TRA = TML_TRA) "
                                + " inner join A_UOR  on (CRO_UTR = UOR_COD) "
                                + "WHERE TRA_MUN = " + tvo1.getCodMunicipio() + " AND TRA_PRO = CRO_PRO AND TRA_COD = CRO_TRA "
                                + "AND CRO_MUN = " + tvo1.getCodMunicipio() + " AND CRO_EJE=" + tvo1.getEjercicio() + " AND CRO_NUM = '" + tvo1.getNumero() + "' "
                                + "AND CRO_FEF IS NULL";
                        
                        
                        m_Log.debug("sql: " + sql);
                        stmt = con.prepareStatement(sql);
                        rs = stmt.executeQuery();

                        ArrayList<String> coleccionFueraPlazo = new ArrayList<String>();
                        SimpleDateFormat sf = new SimpleDateFormat("dd/MM/yyyy");
                        String tramites = "";
                        String unidadesTramitadoras = "";
                        primero = true;
                        while (rs.next()) {
                            int plazoCercaFin = 0;
                            String tipoPlazo = null;
                            int unidadesPlazo = 0;
                            String fechaLimite = null;
                            Timestamp tFechaLimite = null;
                            // Obtener la fecha inicio tramite y el % cerca de aviso.
                            plazoCercaFin = rs.getInt("TRA_FIN");
                            tipoPlazo = rs.getString("TRA_UND");
                            unidadesPlazo = rs.getInt("TRA_PLZ");
                            tFechaLimite = rs.getTimestamp("FechaLimite");

                            if (primero) {
                                primero = false;
                            } else {
                                tramites += ";";
                                unidadesTramitadoras += ";";
                            }

                            tramites += rs.getString("TML_VALOR");
                            unidadesTramitadoras += rs.getString("UOR_NOM");

                            // Se comprueba si el trámite está cerca de la fecha de fin de plazo. Si lo está
                            // se guarda en el ArrayList coleccionFueraPlazo un String con un "si"
                            Calendar fechaLimitePlazo = null;
                            if (tFechaLimite != null) {
                                fechaLimite = sf.format(Fecha.toCalendar(tFechaLimite).getTime());

                                fechaLimitePlazo = Calendar.getInstance();
                                fechaLimitePlazo.clear();
                                java.util.Date dateLimite = (Date) Fecha.obtenerDate(fechaLimite);
                                fechaLimitePlazo.setTime(dateLimite);
                                fechaLimitePlazo.set(Calendar.HOUR_OF_DAY, 23);
                                fechaLimitePlazo.set(Calendar.MINUTE, 59);
                                fechaLimitePlazo.set(Calendar.SECOND, 59);
                                if (fechaLimite != null && !"".equals(fechaLimite) && plazoCercaFin >= 0) {
                                    String fuera = calculoCercaFinPlazo(plazoCercaFin, fechaLimitePlazo, tipoPlazo, unidadesPlazo, con, oad);

                                    if ("si".equals(fuera)) {
                                        coleccionFueraPlazo.add(fuera);
                                    }
                                }
                            }
                        }// while
                        rs.close();
                        stmt.close();
                        tvo1.setPlazoCercaFin("no");
                        if (coleccionFueraPlazo != null && coleccionFueraPlazo.contains("si")) {
                            // Si hay algún trámite del expediente en cerca de fin de plazo. El expediente
                            // se pintará como cerca de fin de plazo
                            tvo1.setPlazoCercaFin("si");
                        }


                        m_Log.debug("Tramites pendientes: " + tramites);
                        tvo1.setListaTramitesPendientes(tramites);

                        m_Log.debug("Unidades tramitadoras pendientes: " + unidadesTramitadoras);
                        tvo1.setListaUnidadesTramitadorasPendientes(unidadesTramitadoras);


                        /********************** prueba *******************/                        
                        Hashtable<String,String> campos = new Hashtable<String,String>();
                        if(camposSuplementarios!=null && camposSuplementarios.size()>0){
                            

                                campos = CamposListadoPendientesProcedimientoManager.getInstance().getValorCampoSuplementario2(tvo1.getNumero(),tvo1.getEjercicio(),tvo1.getCodMunicipio(),camposSuplementarios,params);
                                                           
                          

                            tvo1.setValoresCamposVistaPendientes(campos);
                        }//if
                        /************************ prueba ******************/
                        

                        
                     

                        /** prueba **/
                        listaFinal.addElement(tvo1);                      
                    }

                } catch (Exception e) {
                    listaFinal = null;
                    e.printStackTrace();
                    if (m_Log.isErrorEnabled()) {
                        m_Log.error(e.getMessage());
                    }
                    throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientesFiltrados", e);

                } finally {
                    try {
                        
                        if(params[0]!=null && (params[0].equals("oracle") || params[0].equals("ORACLE")) ){
                        Statement st_alter;
                        String alter1 = "ALTER SESSION SET NLS_COMP=BINARY";
                        String alter2 = "ALTER SESSION SET NLS_SORT=SPANISH";
                        st_alter = con.createStatement();
                        st_alter.executeQuery(alter1);
                        st_alter.executeQuery(alter2);

                        st_alter.close();
                    }
                        
                        if(stmt!=null) stmt.close();
                        if(rs!=null) rs.close();
                    } catch (Exception bde) {
                        bde.printStackTrace();
                        if (m_Log.isErrorEnabled()) {
                            m_Log.error(bde.getMessage());
                        }
                        throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientesFiltrados.Devolver conexion", bde);
                    }
                }

                return listaFinal;
      }






    /**
      * Recupera los expedientes pertenecientes a una relación
      * indicado en el parámetro filtro
      * @param codMunicipio: Código del municipio
      * @param codProcedimiento: Código del procedimiento
      * @param numRelacion: Nº de la relación
      * @param con: Conexión a la BD
      * @return ArrayList de String con los número de expedientes pertenecientes a la relación
      * @throws es.altia.agora.business.sge.exception.TramitacionException
      * @throws es.altia.common.exception.TechnicalException
      */
      public ArrayList<String> getExpedientesRelacion(String codMunicipio,String codProcedimiento,String numRelacion,String ejercicio,Connection con)
            throws TramitacionException, TechnicalException {

             String sql;
             ResultSet rs = null;
             PreparedStatement ps = null;
             ArrayList<String> expedientes = new ArrayList<String>();

            try {
                sql = "SELECT EXP_NUM FROM G_EXP WHERE REL_MUN=? AND REL_PRO=? AND REL_EJE=? AND REL_NUM=?";
                int i=1;
                ps = con.prepareStatement(sql);
                ps.setInt(i++,Integer.parseInt(codMunicipio));
                ps.setString(i++, codProcedimiento);
                ps.setInt(i++,Integer.parseInt(ejercicio));
                ps.setString(i++, numRelacion);

                rs = ps.executeQuery();
                while(rs.next()){
                    expedientes.add(rs.getString("EXP_NUM"));
                }

            } catch (SQLException e) {
                e.printStackTrace();
                throw new TramitacionException("Error al recuperar los expedientes d ela relación",e);
            } finally {
                try {
                    if(ps!=null) ps.close();
                    if(rs!=null) rs.close();

                } catch (SQLException bde) {
                    bde.printStackTrace();
                    if (m_Log.isErrorEnabled()) {
                        m_Log.error(bde.getMessage());
                    }
                    throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientesFiltrados.Devolver conexion", bde);
                }
            }
            return expedientes;
      }



     public int establecerExpedienteDestacado(String ejercicio, String numeroExp, Connection conexion, int opcion) {
        String sql = "";
        ResultSet rs = null;
        PreparedStatement ps = null;
        int resultado = -1;

        try {
            if (opcion == 1) { // marcamos el expediente como destacado
                sql = " UPDATE E_EXP SET EXP_IMP='S' WHERE EXP_EJE=? AND EXP_NUM=? ";

            } else if (opcion == 0) {   // desmarcamos el expediente
                sql = " UPDATE E_EXP SET EXP_IMP='N' WHERE EXP_EJE=? AND EXP_NUM=? ";
            }

            int i = 1;
            ps = conexion.prepareStatement(sql);
            ps.setString(i++, ejercicio);
            ps.setString(i++, numeroExp);
            resultado = ps.executeUpdate();


        } catch (SQLException e) {
            e.printStackTrace();

        } finally {
            try {
                if (ps != null) {
                    ps.close();
                }
                if (rs != null) {
                    rs.close();
                }
            } catch (SQLException bde) {
                bde.printStackTrace();
                if (m_Log.isErrorEnabled()) {
                    m_Log.error(bde.getMessage());
                }
            }
        }
        return resultado;
    }


    /**
      * Recupera el nº de expediente relacionado externo que tiene como un determinado origen.
      * El nº de
      * @param tvo: TramitacionValueObject
      * @param origen: Origen del expediente relacionado
      * @param con: Conexión a la base de datos
      * @throws es.altia.agora.business.sge.exception.TramitacionException si ocurre algún error
      */
   public void getNumeroExpedienteRelacionadoExterno(TramitacionValueObject tvo,  String origen, Connection con)  throws TramitacionException,TechnicalException {

        m_Log.debug("getNumeroExpedienteRelacionadoExterno");
        PreparedStatement stmt = null;
        ResultSet rs = null;

        try {

            String sql = "SELECT EXR_NUM, EXR_PRO FROM E_EXR WHERE EXR_DEP = ? AND EXR_UOR = ? " +
                              "AND EXR_TIP = ? AND EXR_EJR = ? AND EXR_NRE = ? AND EXR_ORIGEN=?";

            if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: getNumeroExpedienteRelacionadoExterno--> " + sql);

            stmt = con.prepareStatement(sql);
            int i = 1;
            stmt.setInt(i++, Integer.parseInt(tvo.getCodDepartamento()));
            stmt.setInt(i++, Integer.parseInt(tvo.getCodUnidadRegistro()));
            stmt.setString(i++, tvo.getTipoRegistro());
            stmt.setInt(i++, Integer.parseInt(tvo.getEjercicioRegistro()));
            stmt.setInt(i++, Integer.parseInt(tvo.getNumero()));
            stmt.setString(i++,origen);

            rs = stmt.executeQuery();
            if (rs.next()) {
                tvo.setNumeroExpediente(rs.getString("EXR_NUM"));
                tvo.setCodProcedimiento(rs.getString("EXR_PRO"));
                tvo.setDescProcedimiento(null);
            }

        } catch (Exception e) {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.getNumeroExpediente", e);
        } finally {
                SigpGeneralOperations.closeResultSet(rs);
                SigpGeneralOperations.closeStatement(stmt);
        }
   }
   
  
   /****************************** CONSULTA PARA CONTAR EXPEDIENTES PENDIENTES EN UN PRIMER TRAMO *****************************/
   
   
   
     /************************************* PRUEBA **************************************************/
     public int contarExpedientesPendientesFiltrados(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params, int filtro)
            throws TramitacionException, TechnicalException {
        int numero = 0;
        Vector lista = new Vector();
        Vector listaCercaPlazoFin = new Vector();
        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt=null;
        ResultSet rs = null;
        String sql;
        TramitacionValueObject tvo1 = null;
        /*************** criterio busqueda *********************/
        ValoresCriterioBusquedaExpPendientesVO criterio = tVO.getCriterioBusquedaExpPendientes();
        /*************** criterio busqueda *********************/

        try {
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

            m_Log.debug("********** TramitacionDAO.getExpedientesPendientesFiltrados FILTRO=" + filtro);
            m_Log.debug("********** TramitacionDAO.getExpedientesPendientesFiltrados COD PROCEDIMIENTO=" + tVO.getCodProcedimiento());
            String codProcedimiento = null;
            if(tVO.getCodProcedimiento()!=null && !"".equalsIgnoreCase(tVO.getCodProcedimiento()))
                codProcedimiento = tVO.getCodProcedimiento();

            sql = queryContarExpedientesFiltrados(oad, filtro, uVO, false,codProcedimiento,tVO.getCodRangoTemporal(),null,-1,criterio,null);
            if (m_Log.isDebugEnabled()) {
                m_Log.debug(sql);
            }


            /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
//           if(params[0]!=null && (params[0].equalsIgnoreCase("oracle"))){
//                String alter1 = "ALTER SESSION SET NLS_COMP=LINGUISTIC";
//                String alter2 = "ALTER SESSION SET NLS_SORT=GENERIC_BASELETTER";
//                Statement st =con.createStatement();
//                st.executeQuery(alter1);
//                st=con.prepareStatement(alter2);
//                st.executeQuery(alter2);
//                st.close();
//            }
            /****** PARA ACTIVAR LA BÚSQUEDA INSENTITIVA MAYUSCULAS/MINÚSCULAS EN ORACLE ******/
            
            stmt = con.prepareStatement(sql);

            /************************************** criterio búsqueda ***************************************************/
            ArrayList<String> valores = null;
            if(criterio!=null) valores = criterio.getValoresCriterioBusqueda();
            
            
            int contador = 1;
            if ("1".equals(tVO.getCodRangoTemporal())) {
                Calendar calendario = Calendar.getInstance();
                calendario.add(Calendar.MONTH, -6);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
                stmt.setTimestamp(contador++, time);

            } else if ("2".equals(tVO.getCodRangoTemporal())) {
                Calendar calendario = Calendar.getInstance();
                calendario.add(Calendar.MONTH, -12);
                Timestamp time = new Timestamp(calendario.getTimeInMillis());
                stmt.setTimestamp(contador++, time);

            }

            if(criterio!=null && "4".equals(criterio.getCodigoCriterioBusqueda())){ // Criterio de búsqueda es la fecha de inicio
                //int contador = 1;
                m_Log.debug("Operador criterio: " + criterio.getOperadorCriterioBusqueda());

            }//if
            else
            if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda())
                    && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                

            }// if
            /************************************** criterio búsqueda ***************************************************/            
            ConsultaExpedientesDAO cDAO=ConsultaExpedientesDAO.getInstance();
            if(filtro ==0){                  
                rs = stmt.executeQuery();                
                while(rs.next()){
                    
                    tvo1 = new TramitacionValueObject();
                    tvo1.setCodMunicipio(rs.getString("EXP_MUN"));
                    tvo1.setCodProcedimiento(rs.getString("EXP_PRO"));
                    tvo1.setEjercicio(rs.getString("EXP_EJE"));
                    tvo1.setNumero(rs.getString("EXP_NUM"));
                    tvo1.setExpImportante(rs.getString("EXP_IMP"));
                   
                     if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(),con)){
                        tvo1.setTipoInicio("Instancia");
                    }else
                        tvo1.setTipoInicio("Oficio");
			

                    Calendar fechaInicio = DateOperations.toCalendar(rs.getTimestamp("EXP_FEI"));
                    fechaInicio.set(Calendar.HOUR_OF_DAY,0);
                    fechaInicio.set(Calendar.MINUTE,0);
                    fechaInicio.set(Calendar.SECOND,0);
                    tvo1.setFechaInicioAsCalendar(fechaInicio);                                     
                    lista.add(tvo1);                    
                }
                
                boolean aux = false;
                for (int j = 0; j < lista.size(); j++) {
                    tvo1 = (TramitacionValueObject) lista.get(j);
                    aux = isCercaFinPlazo(tvo1, con, oad);
                    if (aux) {
                        tvo1.setPlazoCercaFin("si");
                        listaCercaPlazoFin.add(tvo1);
                    }
                }
                
                numero = listaCercaPlazoFin.size();
                
            }else
            if (filtro == 5) {                 
                /****/
                Vector listaExpFueraPlazo = new Vector();
                Hashtable<String,DefinicionProcedimientosValueObject> plazosFinalizacionProcedimientos = new Hashtable<String,DefinicionProcedimientosValueObject>();
                Hashtable<Integer,ArrayList<Calendar>> festivosEjercicio = new Hashtable<Integer, ArrayList<Calendar>>();
                rs = stmt.executeQuery();
                while (rs.next()) {                                    
                    tvo1 = new TramitacionValueObject();
                    tvo1.setCodMunicipio(rs.getString("EXP_MUN"));
                    tvo1.setCodProcedimiento(rs.getString("EXP_PRO"));
                    tvo1.setEjercicio(rs.getString("EXP_EJE"));
                    tvo1.setNumero(rs.getString("EXP_NUM"));
                    tvo1.setExpImportante(rs.getString("EXP_IMP"));
                    /**
                    if ("0".equals(rs.getString("EXR_TOP")))
                        tvo1.setTipoInicio("Instancia");
                    else tvo1.setTipoInicio("Oficio"); **/
                    if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(),con)){
                            tvo1.setTipoInicio("Instancia");
                    }else
                            tvo1.setTipoInicio("Oficio");
			
                    

                    Calendar fechaInicio = DateOperations.toCalendar(rs.getTimestamp("EXP_FEI"));
                    fechaInicio.set(Calendar.HOUR_OF_DAY,0);
                    fechaInicio.set(Calendar.MINUTE,0);
                    fechaInicio.set(Calendar.SECOND,0);
                    tvo1.setFechaInicioAsCalendar(fechaInicio);                                
                    
                    DefinicionProcedimientosValueObject dfvo = new DefinicionProcedimientosValueObject();
                    if(plazosFinalizacionProcedimientos.contains(tvo1.getCodProcedimiento())){
                        dfvo = plazosFinalizacionProcedimientos.get(tvo1.getCodProcedimiento());
                    }else{
                        dfvo.setTxtCodigo(tvo1.getCodProcedimiento());
                        dfvo = DefinicionProcedimientosManager.getInstance().getPlazosFinalizacion(dfvo, con);
                        plazosFinalizacionProcedimientos.put(tvo1.getCodProcedimiento(), dfvo);
                    }
                    
                    ArrayList<Calendar> festivos = new ArrayList<Calendar>();
                    if(festivosEjercicio.contains(new Integer(tvo1.getEjercicio()))){
                        festivos = festivosEjercicio.get(new Integer(tvo1.getEjercicio()));
                    }else{
                        festivos = TramitacionManager.getInstance().getFestivos(Integer.parseInt(tvo1.getEjercicio()), con);
                        festivosEjercicio.put(new Integer(tvo1.getEjercicio()),festivos);
                    }
                    
                    
                    /******/
                    if(dfvo!=null && dfvo.getPlazo()!=null && dfvo.getTipoPlazo()!=null){
                        
                        Calendar cFechaFin = TramitacionManager.getInstance().calcularFechaFinExpediente(tvo1.getFechaInicioAsCalendar(), Integer.parseInt(dfvo.getPlazo()),Integer.parseInt(dfvo.getTipoPlazo()), festivos);

                        int porcentaje = 0;
                        if(dfvo.getPorcentaje()!=null)
                            porcentaje = Integer.parseInt(dfvo.getPorcentaje());
                        
                        String resultado = TramitacionManager.getInstance().calculoExpedienteCercaFinPlazo(porcentaje,tvo1.getFechaInicioAsCalendar(), cFechaFin);
                        if(resultado!=null){
                            if(resultado.equals("no")){
                                tvo1.setCercaPlazoExpediente(false);
                                tvo1.setFueraPlazoExpediente(true);
                                listaExpFueraPlazo.add(tvo1);
                            }
                        }
                    }
                    /*******/
                }// while                 
                /****/
               
                numero = listaExpFueraPlazo.size();
                m_Log.debug("Número de expedientes pendientes recuperados: " + numero);                            
            }else
            if(filtro==1 || filtro==2 || filtro==3 || filtro==6 || filtro==7 || filtro==8){
                
                // filtro==6 => Exp. destacados/importantes ; filtro==8 => Exp. con alarmas
                rs = stmt.executeQuery();
                while (rs.next()) {                
                    numero = rs.getInt("NUM");               
                }
                
                m_Log.debug("Número de expedientes pendientes recuperados: " + numero);                            
            }else
            if(filtro==4){

                Hashtable<Integer,ArrayList<Calendar>> cacheFestivos = new Hashtable<Integer, ArrayList<Calendar>>();
                Hashtable<String,DefinicionProcedimientosValueObject> cachePlazoFinalizacion = new Hashtable<String, DefinicionProcedimientosValueObject>();
                
                Vector listaExpCercaPlazoFin = new Vector();   
                rs = stmt.executeQuery();
                while (rs.next()) {                                    
                  tvo1 = new TramitacionValueObject();
                  tvo1.setCodMunicipio(rs.getString("EXP_MUN"));
                  tvo1.setCodProcedimiento(rs.getString("EXP_PRO"));
                  tvo1.setEjercicio(rs.getString("EXP_EJE"));
                  tvo1.setNumero(rs.getString("EXP_NUM"));
                  tvo1.setExpImportante(rs.getString("EXP_IMP"));
                  
                   if(cDAO.isExpedienteIniciadoInstanciaParte(tvo1.getNumero(),tvo1.getCodProcedimiento(),tvo1.getCodMunicipio(),tvo1.getEjercicio(),con)){
                        tvo1.setTipoInicio("Instancia");
                  }else
		       tvo1.setTipoInicio("Oficio");
			

                  Calendar fechaInicio = DateOperations.toCalendar(rs.getTimestamp("EXP_FEI"));
                  fechaInicio.set(Calendar.HOUR_OF_DAY,0);
                  fechaInicio.set(Calendar.MINUTE,0);
                  fechaInicio.set(Calendar.SECOND,0);
                  tvo1.setFechaInicioAsCalendar(fechaInicio);                                                    

               
              }// while                                
              numero = listaExpCercaPlazoFin.size();
            }
            return numero;

        } catch (Exception e) {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) {
                m_Log.error(e.getMessage());
            }
            throw new TramitacionException("Error. TramitacionDAO.getExpedientesPendientesFiltrados", e);

        } finally {
            try {
                if(params[0]!=null && (params[0].equals("oracle") || params[0].equals("ORACLE")) ){
                        Statement st_alter;
                        String alter1 = "ALTER SESSION SET NLS_COMP=BINARY";
                        String alter2 = "ALTER SESSION SET NLS_SORT=SPANISH";
                        st_alter = con.createStatement();
                        st_alter.executeQuery(alter1);
                        st_alter.executeQuery(alter2);

                        st_alter.close();
                    }
                
                if(stmt!=null) stmt.close();
                if(rs!=null) rs.close();
                //if(con!=null) con.close();
                oad.devolverConexion(con);
            } catch (SQLException e) {
                e.printStackTrace();
                if (m_Log.isErrorEnabled()) {
                    m_Log.error(e.getMessage());
                }
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientesFiltrados.Devolver conexion",e);
            }catch (BDException e) {
                e.printStackTrace();
                if (m_Log.isErrorEnabled()) {
                    m_Log.error(e.getMessage());
                }
                throw new TramitacionException("Error.TramitacionDAO.getExpedientesPendientesFiltrados.Devolver conexion",e);
            }
        }

    }
 
     
     
     
    /**
     * Genera una query SQL que sólo se utiliza para contar expedientes que se recuperan al hacer click en algunos de los filtros 
     * de la bandeja de expedientes pendientes.
     * 
     * Si cargaPagina=true es que es la consulta de carga de la página (la que debe traer todos los datos).
     */
    // original
    //private String queryExpedientesFiltrados(AdaptadorSQLBD oad, int filtro, UsuarioValueObject uVO, boolean cargaPagina,String codProcedimiento) {
    private String queryContarExpedientesFiltrados(AdaptadorSQLBD oad, int filtro, UsuarioValueObject uVO, boolean cargaPagina,String codProcedimiento,String codRangoTemporal,
            String columna,int tipoDato,ValoresCriterioBusquedaExpPendientesVO criterio, List<String> idCargos) {
        String sql = "";
        
        String parteSelectCampoSuplementario         = null;
        String parteFromColumnaCampoSuplementario    = null;
        String parteGroupByColumnaCampoSuplementario = null;        
        boolean ordenCampoSuplementario = false;

        /************ criterio búsqueda ***************/
        String parteFromBusquedaCampoSuplementario ="";        
                
        boolean eTXTEnFrom = false; // indica si se la tabla E_TXT ya se encuentra en la claúsula FROM
        boolean eTFEEnFrom = false; // indica si se la tabla E_TFE ya se encuentra en la claúsula FROM
        boolean eTNUEnFrom = false; // indica si se la tabla E_TNU ya se encuentra en la claúsula FROM
        boolean eTFECEnFrom = false; // indica si se la tabla E_TFEC ya se encuentra en la claúsula FROM
        boolean eTNUCEnFrom = false; // indica si se la tabla E_TNUC ya se encuentra en la claúsula FROM
        boolean eTDEEnFrom = false; // indica si se la tabla E_TDE ya se encuentra en la claúsula FROM
        String parteWhereByColumnaCampoSuplementario = null;
        TransformacionAtributoSelect transformador = new TransformacionAtributoSelect(oad);
        /************ criterio búsqueda ***************/

        
        /** SE COMPRUEBA SI LA COLUMNA POR LA QUE SE ORDENA NO ES NUMÉRICA, EN ESTE CASO ES QUE SE PRETENDE ORDENAR POR UN CAMPO SUPLEMENTARIO DE LA VISTA DE EXPEDIENTES
             PENDIENTES DEL PROCEDIMIENTO **/
            if(columna!=null && !"".equals(columna) && !NumericOperations.isInteger(columna)){
                /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/                
                m_Log.debug("La tabla en la que se aloja el valor del campo suplementario es " + tipoDato);
                switch (tipoDato){
                    case 1: //  Campo de tipo numérico
                        parteSelectCampoSuplementario         = "E_TNU.TNU_VALOR" ;
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TNU.TNU_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TNU.TNU_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTNUEnFrom                            = true;
                        break;
                    case 2: //  Campo de tipo texto corto
                        parteSelectCampoSuplementario         = "E_TXT.TXT_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TXT.TXT_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TXT.TXT_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTXTEnFrom                            = true;
                        break;
                    case 3: //  Campo de tipo fecha
                        parteSelectCampoSuplementario         = "E_TFE.TFE_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TFE.TFE_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TFE.TFE_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTFEEnFrom                            = true;
                        break;
                    case 6: //  Campo de tipo desplegable
                        parteSelectCampoSuplementario         = "E_TDE.TDE_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TDE.TDE_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TDE.TDE_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTDEEnFrom                            = true;
                        break;
                    case 8: //  Campo de tipo numérico calculado
                        parteSelectCampoSuplementario         = "E_TNUc.TNUC_VALOR" ;
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TNUC.TNUC_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TNUC.TNUC_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTNUCEnFrom                            = true;
                        break;                    
                    case 9: //  Campo de tipo fecha calculado
                        parteSelectCampoSuplementario         = "E_TFEC.TFEC_VALOR ";
                        if(criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                        else
                            parteFromColumnaCampoSuplementario    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" + columna + "') ";

                        parteGroupByColumnaCampoSuplementario = "E_TFEC.TFEC_VALOR ";
                        parteWhereByColumnaCampoSuplementario = " AND E_TFEC.TFEC_COD='" + columna + "' ";
                        ordenCampoSuplementario               = true;
                        eTFECEnFrom                            = true;
                        break;

                }// switch
            }// if
        /*************************************************/


         //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
            String parteWhereBusquedaCampoSuplementario = "";
            String parteFromBusquedaCampoSuplementarioNumerico    = "";
            String parteFromBusquedaCampoSuplementarioFecha       = "";
            String parteFromBusquedaCampoSuplementarioNumericoCal = "";
            String parteFromBusquedaCampoSuplementarioFechaCal    = "";
            String parteFromBusquedaCampoSuplementarioDesplegable = "";
            String parteFromBusquedaCampoSuplementarioTexto       = "";
            boolean busquedaCampoSuplementario = false;

               /** SE COMPRUEBA SI SE HA ESTABLECIDO UN CRITERIO DE BÚSQUEDA POR CAMPO SUPLEMENTARIO, YA QUE EN ESTE CASO HABRÁ QUE
                     AÑADIR LA PARTE FROM Y LA PARTE WHERE  **/
                if(criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda()){
                    /** SE DETERMINA LA COLUMNA POR LA QUE SE ORDENA A QUE TIPO DE CAMPO SUPLEMENTARIO PERTENECE RECUPERANDO EL NOMBRE DE LA TABLA EN LA QUE SE ALOJA EL VALOR **/
                    ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                    if(criterio.getTipoCampoSuplementarioCriterioBusqueda()!=null && NumericOperations.isInteger(criterio.getTipoCampoSuplementarioCriterioBusqueda()))
                    {
                        int tipoDatoCampo = Integer.parseInt(criterio.getTipoCampoSuplementarioCriterioBusqueda());
                        m_Log.debug("El tipo del dato del campo suplementario por el que se hace la búsqueda es " + tipoDato);
                        switch (tipoDatoCampo){
                            case 1: //  Campo de tipo numérico
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioNumerico = "LEFT JOIN E_TNU ON (E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR<=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR>=" +  valores.get(0) + " AND TNU_VALOR<=" + valores.get(1) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNU_VALOR FROM E_TNU WHERE TNU_VALOR!=" +  valores.get(0) + " AND E_TNU.TNU_MUN=E_EXP.EXP_MUN AND E_TNU.TNU_EJE = E_EXP.EXP_EJE AND E_TNU.TNU_NUM=E_EXP.EXP_NUM AND E_TNU.TNU_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                            case 2: //  Campo de tipo texto corto
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioTexto = "LEFT JOIN E_TXT ON (E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM) ";
                               
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR!='" +  valores.get(0) + "' AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==7){ // Operador LIKE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TXT_VALOR FROM E_TXT WHERE TXT_VALOR LIKE('%" +  valores.get(0) + "%') AND E_TXT.TXT_MUN=E_EXP.EXP_MUN AND E_TXT.TXT_EJE = E_EXP.EXP_EJE AND E_TXT.TXT_NUM=E_EXP.EXP_NUM AND E_TXT.TXT_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }


                                busquedaCampoSuplementario = true;
                                break;
                            case 3: //  Campo de tipo fecha
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioFecha    = "LEFT JOIN E_TFE ON (E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM) ";
                              try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    /*
                                    parteWhereBusquedaCampoSuplementario = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0));
                                    */
                                    
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0))  + " ) ";
                                    
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT DISTINCT(TFE_VALOR) FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFE_VALOR FROM E_TFE WHERE E_TFE.TFE_MUN=E_EXP.EXP_MUN AND E_TFE.TFE_EJE = E_EXP.EXP_EJE AND E_TFE.TFE_NUM=E_EXP.EXP_NUM AND E_TFE.TFE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFE.TFE_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                                }catch(Exception e){
                                        e.printStackTrace();
                                }
                            case 6: //  Campo de tipo desplegable
                                //parteFromBusquedaCampoSuplementario    = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" + criterio.getCodigoCriterioBusqueda() + "') ";
                                parteFromBusquedaCampoSuplementarioDesplegable  = "LEFT JOIN E_TDE ON (E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM) ";

                                 if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR='" + valores.get(0) + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==6){ // Operador !=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                    " AND EXISTS(SELECT TDE_VALOR FROM E_TDE WHERE E_TDE.TDE_MUN=E_EXP.EXP_MUN AND E_TDE.TDE_EJE = E_EXP.EXP_EJE AND E_TDE.TDE_NUM=E_EXP.EXP_NUM AND E_TDE.TDE_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            +" AND E_TDE.TDE_VALOR!='" + valores.get(0) + "') ";
                                }

                                busquedaCampoSuplementario            = true;
                                break;
                            case 8: //  Campo de tipo numérico Calculado                                
                                parteFromBusquedaCampoSuplementarioNumericoCal = "LEFT JOIN E_TNUC ON (E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM) ";

                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <
                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR<=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR>=" +  valores.get(0) + " AND TNUC_VALOR<=" + valores.get(1) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador <>
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario +
                                            " AND EXISTS(SELECT TNUC_VALOR FROM E_TNUC WHERE TNUC_VALOR!=" +  valores.get(0) + " AND E_TNUC.TNUC_MUN=E_EXP.EXP_MUN AND E_TNUC.TNUC_EJE = E_EXP.EXP_EJE AND E_TNUC.TNUC_NUM=E_EXP.EXP_NUM AND E_TNUC.TNUC_COD='" +  criterio.getCodigoCriterioBusqueda() + "') ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;                            
                            case 9: //  Campo de tipo fecha calculado                                
                                parteFromBusquedaCampoSuplementarioFechaCal    = "LEFT JOIN E_TFEC ON (E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM) ";
                              
                                 try{
                                if(criterio.getOperadorCriterioBusqueda()==0){ // Operador =                                    
                                   
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario
                                            + " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0))  + " ) ";
                                   
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==1){ // Operador >
                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==2){ // Operador >=

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                           + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", ">="+valores.get(0))  + " ) ";

                                }else
                                if(criterio.getOperadorCriterioBusqueda()==3){ // Operador <

                                    parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT DISTINCT(TFEC_VALOR) FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                          + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<"+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==4){ // Operador <=

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", "<="+valores.get(0))  + " ) ";
                                }else
                                if(criterio.getOperadorCriterioBusqueda()==5){ // Operador ENTRE                                    

                                         parteWhereBusquedaCampoSuplementario = parteWhereBusquedaCampoSuplementario  +
                                       " AND EXISTS(SELECT TFEC_VALOR FROM E_TFEC WHERE E_TFEC.TFEC_MUN=E_EXP.EXP_MUN AND E_TFEC.TFEC_EJE = E_EXP.EXP_EJE AND E_TFEC.TFEC_NUM=E_EXP.EXP_NUM AND E_TFEC.TFEC_COD='" +  criterio.getCodigoCriterioBusqueda() + "'"
                                            + " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_TFEC.TFEC_VALOR", valores.get(0)+":"+valores.get(1))  + " ) ";
                                }

                                busquedaCampoSuplementario             = true;
                                break;
                                }catch(Exception e){
                                        e.printStackTrace();
                                }
                        }// switch
                    }// if
                }// if

        //============================ BUSQUEDA POR CAMPO SUPLEMENTARIO ======================================>
        

        if (filtro == 0) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                        "E_EXP." + sql_exp_codMun + ", " +                       
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fIni,E_EXP." +
                        sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{oad.convertir(sql_cro_fli, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                        oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN, new String[]{sql_uou_uor}) + " AS ExisUOR, " +
                        oad.convertir("E_EXP.EXP_FEF", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM," +
                        "  E_EXP.EXP_FEI AS fIniOrden, " +
                        "   E_EXP.EXP_FEF AS fFinOrden";

                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP ";

                
                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                 String parteFrom2 = " " +
                        " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";                       
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " +  
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                        **/

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*************************************************/

                if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUc NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEc NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
                }



                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " +  sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))";

                 if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                 
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() +")))";


            /********* nuevo para busqueda ********/
            if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                       
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0)+":"+valores.get(1));

                    }catch(Exception e){
                            e.printStackTrace();
                    }
                    
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                  

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

           String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +                        
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ,E_EXR." + sql_exr_top ;
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP" ;

               /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/


                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        "E_EXP." + sql_exp_fechIni;  
                        
                        // obtenemos campo que nos muestra si un expediente esta destacado
                        parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP ";                      

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD)  " +
                        "right JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ")) " +
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                 if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else                        
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
                }

                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " 
                        + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND cro_fli is not null and (" +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ">=" +
                        oad.convertir(oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null), AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + " ))";


                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() +")))";


                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

             /******************************************  CRITERIO BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                       
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0)+":"+valores.get(1));

                    }catch(Exception e){
                            e.printStackTrace();
                     }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' "; */

                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

             /******* CRITERIO BÚSQUEDA ******/


                String groupSelect = "GROUP BY E_EXP." + sql_exp_codMun + ", " +
                        "E_EXP." + sql_exp_codProc + ", " +
                        "E_EXP." + sql_exp_ejer + ", " +
                        "E_EXP." + sql_exp_num + ", " +
                        oad.convertir("E_EXP." + sql_exp_fechIni, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + ", " +                       
                        "E_EXP." + sql_exp_fechIni + ", " +
                        "E_EXP." + sql_exp_asunto + ", " +
                        "G_REL." + sql_rel_num + ", " +
                        "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                        "E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP";
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP, E_EXR."+sql_exr_top + " ";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect + " ORDER BY " + sql_exp_fechIni + " DESC ";
            }

        } else if (filtro == 1) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM(SELECT E_EXP.EXP_NUM ";

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                         "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                         ***/ 


                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                /********************* SE AÑADE LA PARTE CORRESPONDIENTE EN EL FROM DE LA CONSULTA PARA PODER ORDENAR POR EL CAMPO SUPLEMENTARIO ***********************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*******************************************************************/


              /***************** SE COMPRUEBA SI HAY QUE AÑADIR LA PARTE CORRESPONDIENTE EN LA PARTE FROM DE LA CONSULTA SQL CORRESPONDIENTE A LA BÚSQUEDA POR CAMPO SUPLEMENTARIO  ****************/
               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


              String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR  " +
                        " AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " + " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") + ") ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";


                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0)+":"+valores.get(1));

                    }catch(Exception e){
                            e.printStackTrace();
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                   // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP.EXP_NUM ) consulta";
                    //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ,E_EXR."+sql_exr_top +") ";


                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/
                
                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM (SELECT E_EXP.EXP_NUM" ;
                
                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "RIGHT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " +
                        oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") " +
                        "INNER JOIN  E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +                        
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                        ***/

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/

                 /***************** SE COMPRUEBA SI HAY QUE AÑADIR LA PARTE CORRESPONDIENTE EN LA PARTE FROM DE LA CONSULTA SQL CORRESPONDIENTE A LA BÚSQUEDA POR CAMPO SUPLEMENTARIO  ****************/
               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))OR(exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL AND CRO_FLI IS NOT NULL AND " + oad.convertir("cro_fli", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        "<" +
                        oad.convertir((oad.funcionFecha(oad.FUNCIONFECHA_SYSDATE, null)),
                        AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "YYYYMMDD") +
                        ") ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO +  "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";


                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                    try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                       
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",">="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<"+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI","<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0)+":"+valores.get(1));

                     }catch(Exception e){
                            e.printStackTrace();
                     }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

             
                String groupSelect = "GROUP BY E_EXP.EXP_NUM ) consulta";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            }

        } else if ((filtro == 2)||(filtro == 7)) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM (SELECT E_EXP.EXP_NUM" ;

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON (E_EXP.EXP_MUN = E_PRO.PRO_MUN AND E_EXP.EXP_PRO = E_PRO.PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) ";
                        
                
                parteFrom2=parteFrom2+"LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() ;
                        if (filtro == 7){
                            parteFrom2=parteFrom2+  " AND  CRO_UTR=UOU_UOR) ";
                            //para este caso extraemos los cargos                                   
                            parteFrom2=parteFrom2+"  JOIN E_TRA   on ( (CRO_TRA=TRA_COD) AND TRA_CAR = UOU_CAR "
                                    + " OR  UOU_CAR =0 )";
                        }
                        else{
                            parteFrom2=parteFrom2+") ";
                        }
              
                        

                /******************* INICIO: CRITERIO DE BÚSQUEDA ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* FIN: CRITERIO DE BÚSQUEDA ***********************/


               /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
              /*************************************************/


              if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
              }//if


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " +
                        sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

              

                 /******************************************  BÚSQUEDA ***********************************************/

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/


            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                     }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            /********************** criterio búsqueda *^******************************/
                

              String groupSelect = "GROUP BY E_EXP.EXP_NUM) consulta ";
 
                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;

            } else {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM (SELECT E_EXP.EXP_NUM";                      

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "INNER JOIN E_PRO ON (EXP_MUN = PRO_MUN AND EXP_PRO = PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +                        
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod();                        
                         if (filtro == 7){
                            parteFrom2=parteFrom2+  " AND  CRO_UTR=UOU_UOR) ";
                            //para este caso extraemos los cargos                                   
                            parteFrom2=parteFrom2+"  JOIN E_TRA   on ( (CRO_TRA=TRA_COD) AND TRA_CAR = UOU_CAR "
                                    + " or  UOU_CAR =0 )";
                        }
                        else{
                            parteFrom2=parteFrom2+") ";
                        }
                        
                        
                /******************* INICIO: CRITERIO DE BÚSQUEDA ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* FIN: CRITERIO DE BÚSQUEDA ***********************/

                if(busquedaCampoSuplementario){
                    // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                    if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                    }else
                    if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                    }else
                    if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                    }else
                    if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                    }else
                    if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                    }else
                    if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                        // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                        // DE ESTE TIPO.
                        parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                    }
              }//if


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND "
                        + sql_exp_estado + " = 0 " + " AND ((exists (SELECT DISTINCT " +
                        sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (PRO_RESTRINGIDO=0 OR (PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";


                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/



            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                     }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                   // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                   // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }
                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }

            /********************** criterio búsqueda *^******************************/
           String groupSelect = "GROUP BY E_EXP.EXP_NUM) consulta";
           sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            }
        } else if (filtro == 3) {
            if (cargaPagina == true) {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM(SELECT E_EXP.EXP_NUM";

                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }                

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                        "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                        "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                        "G_REL." + sql_rel_estado + " = 0) " +
                        "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun + " AND " +
                        "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc + " AND " +
                        "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer + " AND " +
                        "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num + ") " +
                        "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) " + 
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                       "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +                      
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                      

                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                    parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
                }
                /*************************************************/

                 if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
            }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " +
                        sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND (NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) " + 
                       " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/

            /******************** INICIO: CRITERIO DE BÚSQUEDA **************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                   }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   /*
                    // Identificación
                   auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                             + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                             */
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }
            /******************** FIN: CRITERIO DE BÚSQUEDA **************/

                String groupSelect = "GROUP BY E_EXP.EXP_NUM) consulta";
                        //"E_EXP." + sql_exp_loc + ", E_EXP.EXP_IMP ," + "E_EXR."+sql_exr_top + ")";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                    groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
                }
                /*************************************************/

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
                return sql;
            } else {
                String parteSelect2 = "SELECT COUNT(*) AS NUM FROM(SELECT E_EXP.EXP_NUM";

                String parteFrom2 = " " +
                        "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,E_EXP " +
                        "INNER JOIN E_PRO ON (EXP_MUN = PRO_MUN AND EXP_PRO = PRO_COD) " +
                        "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                        "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                        sql_cro_fef + " IS NULL) " +                       
                        "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                        sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                        sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                        sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                        /**
                        "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                        "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                        "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")"; **/


                /******************* criterio búsqueda ***********************/
                if(criterio!=null){

                    String auxiliar="";
                    // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                    if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                        auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                                  + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                        parteFrom2 = parteFrom2 + auxiliar;
                    }//if
                }// if
                /******************* criterio búsqueda ***********************/


               if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
              }


                String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + 
                        sql_exp_estado + " = 0 " + " AND ((exists ( " +
                        " SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + "))AND(NOT exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " + " AND " + sql_cro_fef + " IS NULL) ";

                if(codProcedimiento!=null && !"".equals(codProcedimiento) && !"null".equals(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND E_EXP.EXP_PRO='" + codProcedimiento + "' ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

                pWhere2 = pWhere2 + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";


                /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
                /********* nuevo para busqueda ********/


                /******************** INICIO: CRITERIO DE BÚSQUEDA **************/
                // Se comprueba si el criterio no es nulo
                if(criterio!=null){
                    // Si se ha introducido algún criterio de búsqueda
                   ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
                   String auxiliar = "";
                   if("1".equals(criterio.getCodigoCriterioBusqueda())){
                        // Número de expediente
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }
                   else
                   if("4".equals(criterio.getCodigoCriterioBusqueda())){
                        // Búsqueda por fecha de inicio de expediente
                       try{ 
                       if(criterio.getOperadorCriterioBusqueda()==0)
                            //auxiliar = " AND E_EXP.EXP_FEI=? ";
                            
                                auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                            
                        else
                        if(criterio.getOperadorCriterioBusqueda()==1)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==2)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==3)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                        else
                        if(criterio.getOperadorCriterioBusqueda()==4)
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                        else
                        if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                           auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                       }catch(Exception e){
                                e.printStackTrace();
                            }
                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("5".equals(criterio.getCodigoCriterioBusqueda())){
                        // Asunto
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                    }else
                    if("6".equals(criterio.getCodigoCriterioBusqueda())){
                        // Observaciones
                        if(criterio.getOperadorCriterioBusqueda()==0)
                            auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==6)
                            auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                        else
                        if(criterio.getOperadorCriterioBusqueda()==7)
                            auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("2".equals(criterio.getCodigoCriterioBusqueda())){
                       /*
                        // Identificación
                       auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                 + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                                 */                       
                        // Identificación
                        if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                      + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                        }else{
                            auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                        }
                        pWhere2 = pWhere2 + auxiliar;
                   }else
                   if("3".equals(criterio.getCodigoCriterioBusqueda())){
                       // Interesado
                       String nombre    = null;
                       String apellido1 = null;
                       String apellido2 = null;

                       if(valores!=null && valores.size()==1){
                           nombre = valores.get(0);
                       }else
                       if(valores!=null && valores.size()==2){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                       }else
                       if(valores!=null && valores.size()==3){
                           nombre    = valores.get(0);
                           apellido1 =  valores.get(1);
                           apellido2 =  valores.get(2);
                       }

                       if(nombre!=null)
                           auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                       if(apellido1!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                       if(apellido2!=null)
                            auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                        pWhere2 = pWhere2 + auxiliar;
                   }//if

                }//if

                if(busquedaCampoSuplementario){
                    // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                    pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
                }
              /******************** FIN: CRITERIO DE BÚSQUEDA **************/             
                String groupSelect = "GROUP BY E_EXP.EXP_NUM)consulta ";
                        //"E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM" + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top + ") ";

                sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            }
        }else if(filtro==6){
            /********************** QUERY QUE CUENTA LOS EXPEDIENTES DESTACADOS *******/
            
            /** SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO */
             String parteSelect2 = "SELECT COUNT(*) AS NUM FROM (SELECT E_EXP.EXP_NUM";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) "  +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +                   
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                    /**
                    "LEFT JOIN E_EXR ON (E_EXP."+sql_exp_codMun + " = E_EXR." + sql_exr_mun + " AND " + 
                    "E_EXP." + sql_exp_ejer + " = E_EXR." + sql_exr_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = E_EXR." + sql_exr_num +")";
                    ***/ 

            /******************* criterio búsqueda ***********************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************* criterio búsqueda ***********************/


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }


             if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }                        
            }

            String pWhere2 = "";          
            pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_exp_estado + " = 0 " + " AND EXP_IMP='S' " +
                   " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " +
                   " OR (exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + ")) " +
                   " AND " + sql_cro_fef + " IS NULL) " +
                   " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

            if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento))
              pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";                  
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

            /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                    }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){                  
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP.EXP_NUM) consulta";
                    //"E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top + ")";

            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/

            m_Log.debug("queryContarExpedientesFiltrados filtro=6. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);
            
            
            /*****************************/
        }else
        if(filtro==5){
            /** SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO */
             String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                "E_EXP."+ sql_exp_codMun+ ", " +                
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +
                oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fIni, " +
                "E_EXP."+sql_exp_codProc+ ", " +
                "E_EXP."+sql_exp_fechIni + ", " +
                "E_EXP."+sql_exp_asunto + ", " +
                "G_REL."+sql_rel_num + ", " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {oad.convertir(sql_cro_fli,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {sql_uou_uor}) + " AS ExisUOR, " +
                oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM,"+
                 "  E_EXP.EXP_FEI AS fIniOrden, " +
                     "   E_EXP.EXP_FEF AS fFinOrden";
                //oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"YYYY/MM/DD") + " AS fFinOrden" + ",E_EXR."+sql_exr_top;

                // obtenemos campo que nos muestra si un expediente esta destacado
                parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) "  +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +                    
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                    


            /******************* criterio búsqueda ***********************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************* criterio búsqueda ***********************/


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }


             if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
                        
            }

                                        
            String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR " 
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) " 
                        + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" +  uVO.getOrgCod() + "))) ";

            if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento)){
                pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
            }
            
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

            /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                   }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                                     
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + ", " +                   
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP."+sql_exp_asunto + ", " +
                    "G_REL."+sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    "E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP ";
                    //"E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/

            m_Log.debug("queryExpedientesFiltrados filtro=5. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);
            
            
        }
        else if(filtro==4){
            
            /** SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO */
             String parteSelect2 = "SELECT E_EXP." + sql_exp_loc + ", " +
                "E_EXP."+ sql_exp_codMun+ ", " +               
                "E_EXP." +sql_exp_ejer+ ", " +
                "E_EXP."+sql_exp_num+ ", " +
                oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fIni, " +
                "E_EXP."+sql_exp_codProc+ ", " +
                "E_EXP."+sql_exp_fechIni + ", " +
                "E_EXP."+sql_exp_asunto + ", " +
                "G_REL."+sql_rel_num + ", " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {oad.convertir(sql_cro_fli,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY")}) + " AS FLim, " +
                oad.funcionMatematica(AdaptadorSQLBD.FUNCIONMATEMATICA_MIN,new String[] {sql_uou_uor}) + " AS ExisUOR, " +
                oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + " AS fFin,E_EXP.EXP_EST AS ESTADO,UOR_NOM,USU_NOM,"+
                 "  E_EXP.EXP_FEI AS fIniOrden, " +
                //oad.convertir("E_EXP.EXP_FEF",AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"YYYY/MM/DD") + " AS fFinOrden" + ",E_EXR."+sql_exr_top;
                "   E_EXP.EXP_FEF AS fFinOrden";

                // obtenemos campo que nos muestra si un expediente esta destacado
                parteSelect2=parteSelect2 + ", E_EXP.EXP_IMP ";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) "  +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +                    
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
            
            /******************* criterio búsqueda ***********************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************* criterio búsqueda ***********************/


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }


             if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
                        
            }
            
                
            String pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR " 
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) " 
                        + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" +  uVO.getOrgCod() + "))) ";


                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

            /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                        
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                   }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                                     
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP."+ sql_exp_codMun+ ", " +
                    "E_EXP."+sql_exp_codProc+ ", " +
                    "E_EXP." +sql_exp_ejer+ ", " +
                    "E_EXP."+sql_exp_num+ ", " +
                    oad.convertir("E_EXP."+sql_exp_fechIni,AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO,"DD/MM/YYYY") + ", " +                   
                    "E_EXP."+sql_exp_fechIni + ", " +
                    "E_EXP."+sql_exp_asunto + ", " +
                    "G_REL."+sql_rel_num + ", " +
                    "E_EXP.EXP_FEF, E_EXP.EXP_EST,UOR_NOM,USU_NOM," +
                    //"E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP " + ",E_EXR."+sql_exr_top;
                    "E_EXP."+sql_exp_loc + ", E_EXP.EXP_IMP ";

            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/

            m_Log.debug("queryExpedientesFiltrados filtro=4. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);
            
        }
        else if(filtro==8){
            /** SE BUSCAN LOS EXPEDIENTES QUE ESTÁN CERCA DE FIN DE PLAZO O FUERA DE PLAZO */
             String parteSelect2 = "SELECT COUNT(*) AS NUM FROM (SELECT E_EXP.EXP_NUM";

                /*************************************************/
                if(ordenCampoSuplementario){
                    // Se añade a la parte select la columna que contiene el valor del campo suplementario por el que se ordena
                    parteSelect2 = parteSelect2 + "," + parteSelectCampoSuplementario;
                }
                /*************************************************/

            String parteFrom2 = " " +
                    "FROM " + GlobalNames.ESQUEMA_GENERICO + "A_USU, A_UOR,G_REL " +
                    "JOIN G_EXP ON (G_EXP." + sql_rel_exp_codMun + " = G_REL." + sql_rel_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = G_REL." + sql_rel_codProc + " AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = G_REL." + sql_rel_ejer + " AND " +
                    "G_EXP." + sql_rel_exp_num + " = G_REL." + sql_rel_num + " AND " +
                    "G_REL." + sql_rel_estado + " = 0) " +
                    "RIGHT JOIN E_EXP ON (G_EXP." + sql_rel_exp_codMun + " = E_EXP." + sql_exp_codMun +" AND " +
                    "G_EXP." + sql_rel_exp_codProc + " = E_EXP." + sql_exp_codProc +" AND " +
                    "G_EXP." + sql_rel_exp_ejer + " = E_EXP." + sql_exp_ejer +" AND " +
                    "G_EXP." + sql_exp_num + " = E_EXP." + sql_exp_num +") " +
                    "INNER JOIN E_PRO ON ( E_PRO.PRO_COD= E_EXP.EXP_PRO AND E_PRO.PRO_MUN = E_EXP.EXP_MUN) "  +
                    "LEFT JOIN E_CRO ON (E_EXP." + sql_exp_codMun + " = " + sql_cro_mun + " AND " +
                    "E_EXP." + sql_exp_ejer + " = " + sql_cro_eje + " AND " +
                    "E_EXP." + sql_exp_num + " = " + sql_cro_num + " AND " +
                    sql_cro_fef + " IS NULL) " +                    
                    "LEFT JOIN " + GlobalNames.ESQUEMA_GENERICO + "A_UOU ON (" + sql_uou_uor + " = " + sql_cro_uor + " AND " +
                    sql_uou_usu + " = " + uVO.getIdUsuario() + " AND " +
                    sql_uou_org + " = " + uVO.getOrgCod() + " AND " +
                    sql_uou_ent + " = " + uVO.getEntCod() + ") ";
                    
            /******************* criterio búsqueda ***********************/
            if(criterio!=null){

                String auxiliar="";
                // Si se filtra por identificación o por interesado => Se añade el join para la parte FROM de la consulta
                if("2".equals(criterio.getCodigoCriterioBusqueda()) || "3".equals(criterio.getCodigoCriterioBusqueda())){
                    auxiliar  = " LEFT JOIN E_EXT ON (E_EXP.EXP_EJE=E_EXT.EXT_EJE AND E_EXP.EXP_MUN=E_EXT.EXT_MUN AND E_EXP.EXP_NUM=E_EXT.EXT_NUM )"
                              + " LEFT JOIN T_HTE ON (E_EXT.EXT_TER=T_HTE.HTE_TER AND E_EXT.EXT_NVR=T_HTE.HTE_NVR) ";

                    parteFrom2 = parteFrom2 + auxiliar;
                }//if
            }// if
            /******************* criterio búsqueda ***********************/


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte FROM de la consulta la parte correspondiente al join con la tabla que contiene el valor del campo suplementario
                parteFrom2 = parteFrom2 + parteFromColumnaCampoSuplementario;
            }


             if(busquedaCampoSuplementario){
                // SI HAY BÚSQUEDA POR CAMPO SUPLEMENTARIO
                if(!eTNUEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "1".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNU NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumerico;
                }else
                if(!eTFEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "3".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFecha;
                }else
                if(!eTXTEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "2".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TXT NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioTexto;
                }else
                if(!eTDEEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "6".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TDE NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioDesplegable;
                }else
                if(!eTNUCEnFrom && criterio!=null && criterio.isCampoSuplementarioCriterioBusqueda() && "8".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TNUC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioNumericoCal;
                }else
                if(!eTFECEnFrom && criterio.isCampoSuplementarioCriterioBusqueda() && "9".equals(criterio.getTipoCampoSuplementarioCriterioBusqueda())){
                    // SI EL LEFT JOIN CON LA TABLA E_TFEC NO ESTÁ YA EN EL FROM SE AÑADE PUESTO QUE ES NECESARIO PARA LA BÚSQUEDA POR UN CAMPO SUPL.
                    // DE ESTE TIPO.
                    parteFrom2 = parteFrom2 + parteFromBusquedaCampoSuplementarioFechaCal;
                }
                        
            }


            String pWhere2 = "";
            if (filtro==4 || filtro ==5){
                
                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR "
                    + " AND " + sql_exp_estado + " = 0 "
                    + " AND ((exists ( "
                    + " SELECT DISTINCT " +sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu + "=" + uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND "+ sql_uou_uor +"="+ sql_exp_uor
                    + "))OR(exists (SELECT DISTINCT "+ sql_uou_uor
                        + " FROM "+GlobalNames.ESQUEMA_GENERICO+"A_UOU "
                        + " WHERE "+ sql_uou_usu +"="+ uVO.getIdUsuario()
                        + " AND "+ sql_uou_org +"="+ uVO.getOrgCod()
                        + " AND "+ sql_uou_ent +"="+ uVO.getEntCod()
                        + " AND " + sql_uou_uor + "=" + sql_cro_uor +")) "
                        + " AND " + sql_cro_fef + " IS NULL) " 
                        + " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" +  uVO.getOrgCod() + "))) ";


                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento)){
                    pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";
                }
                
            }else  if (filtro == 6){

                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_exp_estado + " = 0 " + " AND EXP_IMP='S' " +
                           " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " +
                           " OR (exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + ")) " +
                           " AND " + sql_cro_fef + " IS NULL) " +
                           " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))";

                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento))
                      pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";                  
                
            }else if (filtro == 8){
                pWhere2 = " WHERE USU_COD=EXP_USU AND UOR_COD=EXP_UOR AND " + sql_exp_estado + " = 0 " + 
                           " AND ((exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_cro_uor + ")) " +
                           " OR (exists (SELECT DISTINCT " + sql_uou_uor + " FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU " + " WHERE " + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "=" + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND " + sql_uou_uor + "=" + sql_exp_uor + ")) " +
                           " AND " + sql_cro_fef + " IS NULL) " +
                           " AND (E_PRO.PRO_RESTRINGIDO=0 OR (E_PRO.PRO_RESTRINGIDO=1 AND E_PRO.PRO_COD IN (SELECT PRO_COD FROM " + GlobalNames.ESQUEMA_GENERICO + "USUARIO_PROC_RESTRINGIDO WHERE USU_COD=" + uVO.getIdUsuario() + " AND ORG_COD=" + uVO.getOrgCod() + ")))" +
                            " AND E_EXP.EXP_FPA  IS NOT NULL AND E_EXP.EXP_FPA < "+oad.funcionFecha(AdaptadorSQLBD.FUNCIONFECHA_SYSDATE, null);

                if(codProcedimiento!=null && !"".equalsIgnoreCase(codProcedimiento) && !"null".equalsIgnoreCase(codProcedimiento))
                      pWhere2 = pWhere2 + " AND (E_EXP.EXP_PRO='" + codProcedimiento + "' OR G_EXP.EXP_PRO='" + codProcedimiento + "') ";                  
                
            }

                if ("1".equals(codRangoTemporal) || "2".equals(codRangoTemporal))
                    pWhere2 = pWhere2 + " AND EXP_FEI >= ? ";

            /********* nuevo para busqueda ********/
                if(ordenCampoSuplementario && criterio!=null && columna.equals(criterio.getCodigoCriterioBusqueda()))
                    pWhere2 = pWhere2 + parteWhereByColumnaCampoSuplementario;
            /********* nuevo para busqueda ********/

            /******************************************  BÚSQUEDA ***********************************************/
            // Se comprueba si el criterio no es nulo
            if(criterio!=null){
                // Si se ha introducido algún criterio de búsqueda
               ArrayList<String> valores = criterio.getValoresCriterioBusqueda();
               String auxiliar = "";
               if("1".equals(criterio.getCodigoCriterioBusqueda())){
                    // Número de expediente
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_NUM='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_NUM!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_NUM LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }
               else
               if("4".equals(criterio.getCodigoCriterioBusqueda())){
                    // Búsqueda por fecha de inicio de expediente
                   try{ 
                   if(criterio.getOperadorCriterioBusqueda()==0)
                        //auxiliar = " AND E_EXP.EXP_FEI=? ";
                        
                            auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI",valores.get(0));
                       
                    else
                    if(criterio.getOperadorCriterioBusqueda()==1)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==2)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", ">="+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==3)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<"+valores.get(0))  ;
                    else
                    if(criterio.getOperadorCriterioBusqueda()==4)
                        auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", "<="+valores.get(0));
                    else
                    if(criterio.getOperadorCriterioBusqueda()==5) // ENTRE
                       auxiliar = " AND " + transformador.construirCondicionWhereConOperadoresCampoFecha("E_EXP.EXP_FEI", valores.get(0)+":"+valores.get(1))  ;

                    }catch(Exception e){
                            e.printStackTrace();
                        }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("5".equals(criterio.getCodigoCriterioBusqueda())){
                    // Asunto
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_ASU='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_ASU!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_ASU LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
                }else
                if("6".equals(criterio.getCodigoCriterioBusqueda())){
                    // Observaciones
                    if(criterio.getOperadorCriterioBusqueda()==0)
                        auxiliar = " AND E_EXP.EXP_OBS='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==6)
                        auxiliar = " AND E_EXP.EXP_OBS!='" + valores.get(0) + "' ";
                    else
                    if(criterio.getOperadorCriterioBusqueda()==7)
                        auxiliar = " AND E_EXP.EXP_OBS LIKE ('%" + valores.get(0) + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("2".equals(criterio.getCodigoCriterioBusqueda())){
                   
                   
                    // Identificación
                    if(valores!=null && valores.get(0)!=null && criterio.getOperadorCriterioBusqueda()>0){
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda()
                                  + " AND T_HTE.HTE_DOC='" + valores.get(0) + "' ";
                    }else{
                        auxiliar  = " AND T_HTE.HTE_TID=" + criterio.getOperadorCriterioBusqueda() + " ";
                    }
                    pWhere2 = pWhere2 + auxiliar;
               }else
               if("3".equals(criterio.getCodigoCriterioBusqueda())){
                   // Interesado
                   String nombre    = null;
                   String apellido1 = null;
                   String apellido2 = null;

                   if(valores!=null && valores.size()==1){
                       nombre = valores.get(0);
                   }else
                   if(valores!=null && valores.size()==2){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                   }else
                   if(valores!=null && valores.size()==3){
                       nombre    = valores.get(0);
                       apellido1 =  valores.get(1);
                       apellido2 =  valores.get(2);
                   }

                   if(nombre!=null)
                       auxiliar = auxiliar + " AND T_HTE.HTE_NOM LIKE('%" + nombre + "%') ";

                   if(apellido1!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP1 LIKE('%" + apellido1 + "%') ";

                   if(apellido2!=null)
                        auxiliar = auxiliar + " AND T_HTE.HTE_AP2 LIKE('%" + apellido2 + "%') ";

                    pWhere2 = pWhere2 + auxiliar;
               }//if

            }//if

            if(busquedaCampoSuplementario){
                // Si se busca por campo suplementario se añade la parte correspondiente en el lado WHERE de la consulta
                pWhere2 = pWhere2 + parteWhereBusquedaCampoSuplementario;
            }


            String groupSelect = "GROUP BY E_EXP.EXP_NUM) consulta";


            /*************************************************/
            if(ordenCampoSuplementario){
                // Se añade a la parte GROUP BY de la consulta la parte correspondiente al campo que contiene el valor del campo suplementario por el que se ordena
                groupSelect = groupSelect + "," + parteGroupByColumnaCampoSuplementario;
            }
            /*************************************************/

            m_Log.debug("queryExpedientesFiltrados filtro=4. Recuperando expedientes pendientes");
            sql = parteSelect2 + parteFrom2 + pWhere2 + groupSelect;
            if(m_Log.isDebugEnabled()) m_Log.debug(sql);

         }
        return sql;
    } 
 
    
     public String recuperaClasePluginExpedRelacHistorico(Connection con,String procedimiento)  throws TramitacionException,TechnicalException {

        m_Log.debug("recuperaClasePluginExpedRelacHistorico");
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String resultado = "";        
        
        try {
                                    
            String sql = " SELECT PLUGIN_RELAC_HISTORICO FROM E_PRO " +  
                         " WHERE PRO_COD = '" + procedimiento +"'";

            if (m_Log.isDebugEnabled()) m_Log.debug("TramitacionDAO: recuperaClasePluginExpedRelacHistorico--> " + sql); 

            stmt = con.prepareStatement(sql);             
            rs = stmt.executeQuery();            
            if(rs.next()){         
                resultado = rs.getString("PLUGIN_RELAC_HISTORICO");   
            }

        } catch (Exception e) {
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) m_Log.error(e.getMessage());
            throw new TramitacionException("Error. TramitacionDAO.recuperaClasePluginExpedRelacHistorico", e);
        } finally {
                SigpGeneralOperations.closeResultSet(rs);
                SigpGeneralOperations.closeStatement(stmt);
        }
        return resultado;
   }
     
     /**
      * Método para obtener una lista con los nombres de los trámites abiertos
      * @param codOrganizacion codigo de organizacion
      * @param ejercicio ejercicio
      * @param numExpediente número de expediente
      * @param con conexión a la bbdd
      * @return 
      */
     public ArrayList<String> recuperarTramitesAbiertos(int codOrganizacion, int ejercicio, String numExpediente,  Connection con) throws SQLException{
        PreparedStatement ps = null;
        ResultSet rs = null;
        String sql = null;
        ArrayList<String> tramites = new ArrayList<String>();
            
        try {
            sql ="SELECT TML_VALOR FROM E_CRO " +
                    "JOIN E_TML ON (CRO_PRO = TML_PRO and CRO_MUN = TML_MUN and CRO_TRA = TML_TRA) "+
                    "WHERE CRO_MUN = ? AND CRO_EJE = ? AND CRO_NUM = ? AND CRO_FEF IS NULL";
            m_Log.debug("sql: " + sql);
            ps= con.prepareStatement(sql);
            int contbd = 1;
            ps.setInt(contbd++, codOrganizacion);
            ps.setInt(contbd++, ejercicio);
            ps.setString(contbd, numExpediente);
            rs = ps.executeQuery();
            
            while(rs.next())
            {
                tramites.add(rs.getString("TML_VALOR"));
            }// while
        } catch (SQLException ex) {
            ex.printStackTrace();
            m_Log.error("Error al obtener la lista de trámites abiertos.");
            throw ex;
        } finally {
            try {
                if(rs!=null) rs.close();
                if(ps!=null) ps.close();
            } catch (SQLException sqle){
                sqle.printStackTrace();
                m_Log.error("Error al liberar recursos de bbdd");
            }
        }
        
        return tramites;
     }
     
     /**
      * Método para obtener una lista con los nombres, apellidos y roles de los interesados del expediente
      * @param codOrganizacion codigo de organizacion
      * @param ejercicio ejercicio
      * @param numExpediente número de expediente
      * @param codProcedimiento código de procedimiento
      * @param con conexión a la bbdd
      * @return 
      */
     public ArrayList<String> recuperarInteresados(int codOrganizacion, int ejercicio, String numExpediente, String codProcedimiento, Connection con) throws SQLException{
        PreparedStatement ps = null;
        ResultSet rs = null;
        String sql = null;
        ArrayList<String> interesados = new ArrayList<String>();
            
        try {
            sql = "SELECT HTE_PA1, HTE_AP1, HTE_PA2, HTE_AP2, HTE_NOM, ROL_DES FROM E_EXT " +
                    "LEFT JOIN T_HTE ON (EXT_TER=HTE_TER AND EXT_NVR=HTE_NVR) " +
                    "LEFT JOIN E_ROL ON (EXT_MUN=ROL_MUN AND EXT_PRO=ROL_PRO AND EXT_ROL=ROL_COD) " +
                    "WHERE EXT_MUN = ? AND EXT_EJE = ? AND EXT_NUM = ? AND ROL_PRO = ?" ;
            m_Log.debug("sql: " + sql);
            ps= con.prepareStatement(sql);
            int contbd = 1;
            ps.setInt(contbd++, codOrganizacion);
            ps.setInt(contbd++, ejercicio);
            ps.setString(contbd++, numExpediente);
            ps.setString(contbd, codProcedimiento);
            rs = ps.executeQuery();
            
            while(rs.next())
            {
                StringBuilder titular = new StringBuilder("");
                // Obtener una descripcion del tercero.
                String particula1 = rs.getString("HTE_PA1");
                String apellido1 = rs.getString("HTE_AP1");
                String particula2 = rs.getString("HTE_PA2");
                String apellido2 = rs.getString("HTE_AP2");
                String nombre = rs.getString("HTE_NOM");
                String rol = rs.getString("ROL_DES");
                
                titular.append(nombre).append(" ");
                if (particula1 != null) titular.append(particula1).append(" ");
                if (apellido1 != null) titular.append(apellido1).append(" ");
                if (particula2 != null) titular.append(particula2).append(" ");
                if (apellido2 != null) titular.append(apellido2).append(" ");
                    
                interesados.add(titular.toString().trim() + " (" + rol + ")");
            }// while
        } catch (SQLException ex) {
            ex.printStackTrace();
            m_Log.error("Error al obtener la lista de interesados.");
            throw ex;
        } finally {
            try {
                if(rs!=null) rs.close();
                if(ps!=null) ps.close();
            } catch (SQLException sqle){
                sqle.printStackTrace();
                m_Log.error("Error al liberar recursos de bbdd");
            }
        }
        
        return interesados;
     }
     
     
     public Vector getAsientosEntradaRegistroPluginTecnico(UsuarioValueObject uVO, TramitacionValueObject tVO, String[] params,
            String fechaDesde, String fechaHasta, String nombreServicio, String documentoBusqueda, String nombreBusqueda,
            String apellido1Busqueda, String apellido2Busqueda, String codAsunto, String unidadRegistroAsunto,
            String tipoRegistroAsunto, String codUorDestino, String ejercicio, String numAnotacion, String codUorAnotacion,
            String codClasificacionAsunto,String unidadRegistroClasifAsunto,String docTecnicoRegistro
    )
            throws TramitacionException, TechnicalException {

        //Esta consulta es para los registros internos de flexia. el RTE también llama a este DAO, pero no hacemos la consulta para evitar duplicados
        if (!"SGE".equals(nombreServicio)) {
            return new Vector();
        }
        //String nombre,String apellido1,String apellido2,String codAsunto,String codUorDestino
        m_Log.debug("getAsientosEntradaRegistro plugin tecnico de referencia");

        m_Log.debug("cod UOR interno anotacion: " + codUorAnotacion);

        m_Log.debug("documentoBusqueda: " + documentoBusqueda + " ,nombreBusqueda: " + nombreBusqueda + ",apellido1Busqueda: " + apellido1Busqueda + ",apellido2Busqueda: " + apellido2Busqueda + ",codAsunto: " + codAsunto + ",codUorDestino: " + codUorDestino + ",ejercicio: " + ejercicio + ",numAnotacion: " + numAnotacion
        + ", codClasificacionAsunto" + codClasificacionAsunto + ", unidadRegistroClasifAsunto" + unidadRegistroClasifAsunto + ", docTecnicoRegistro" + docTecnicoRegistro);
        Vector<TramitacionValueObject> lista = new Vector<TramitacionValueObject>();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String columna = tVO.getColumna();
        String tipoOrden = tVO.getTipoOrdenacion();

        // SE COMPRUEBA SI SÓLO SE DEBEN CONTAR EXPEDIENTES
        boolean soloContar = tVO.isSoloContarExpedientesBuzonEntrada();

        int posE = 0;
        int numPaginaE = 0;
        int pagActual = -1;
        if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado() != null) {
            pagActual = Integer.parseInt(tVO.getPaginaListado());
        }

        int lineas = -1;
        if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado() != null) {
            lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());
        }

        try {
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();

            String pWhere3 = "";
            String parte_select =   "SELECT DISTINCT * FROM (SELECT TL.NOMBRE_TECNICA,TL.APELLIDO1_TECNICA,TL.APELLIDO2_TECNICA,"
                                    + "RES_DEP, RES_UOR,RES_UOD, RES_TIP, RES_EJE, RES_NUM, RES_OBS," + GlobalNames.ESQUEMA_GENERICO + "A_USU.USU_NOM AS NOM, ";
            parte_select += oad.convertir("RES_FEC", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY HH24:MI:SS") + " AS FECANOT, ";
            parte_select += oad.convertir("RES_FED", AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS FECDOC, ";
            parte_select += "RES_ASU, HTE_NOM,UOR.UOR_NOM, UOD.UOR_NOM AS UNIDADDESTINO, ";
            parte_select += oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA1", "' '", "HTE_AP1"}) + " AS APELLIDO1, "
                    + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{"HTE_PA2", "' '", "HTE_AP2"})
                    + " AS APELLIDO2, HTE_DOC, (SELECT COUNT (*) FROM  R_EXT WHERE res_uor=ext_uor AND res_dep=ext_dep AND res_tip=ext_tip AND res_eje=ext_eje AND res_num=ext_num )AS num_terceros, "
                    + " RES_FEC, "
                    + " RES_FED ";
            parte_select += ",TTR_DES as TRANSPORTE , rta.CODIGO as COD_ASUNTO_CODIFICADO, rta.DESCRIPCION as DES_ASUNTO_CODIFICADO";
            
            // Añadimos un nuevo join con S_VW_OR_TECNICOS_REFERENCIA para recuperar el tecnico de referencia de las entradas.
            
            String parteFrom1 = " FROM ";
            
            if (tVO.getRegPendCatalogacion() != null && !"".equals(tVO.getRegPendCatalogacion()) && "0".equals(tVO.getRegPendCatalogacion())) {
                parteFrom1 = parteFrom1 + "R_RED D, ";
            }
            
            parteFrom1 = parteFrom1 + " R_RES "
                    + "LEFT JOIN T_CAMPOS_TEXTO tcampostexto ON r_res.res_ter = tcampostexto.COD_TERCERO and tcampostexto.cod_campo = 'TTECNICOREFERENCIA' "
                    + "LEFT JOIN "+GlobalNames.ESQUEMA_GENERICO +"S_VW_OR_TECNICOS_LISTA TL ON TL.NUMERO_DOCUMENTO_TECNICA = tcampostexto.VALOR "
                    + "LEFT JOIN R_TTR ON (TTR_IDE=RES_TTR) "
                    + "LEFT JOIN R_TIPOASUNTO rta ON (r_res.ASUNTO = rta.CODIGO AND (r_res.RES_TIP = rta.TIPOREGISTRO OR rta.TIPOREGISTRO = 'A') AND r_res.RES_UOR = rta.UNIDADREGISTRO), T_HTE, A_UOR UOR,A_UOR UOD, " + GlobalNames.ESQUEMA_GENERICO + "A_USU";
            
            String pWhere = " WHERE UOR.UOR_COD=RES_UOR AND UOD.UOR_COD=RES_UOD AND RES_TIP = 'E' AND RES_MOD != 1 AND RES_TER = HTE_TER AND RES_TNV = HTE_NVR AND " + GlobalNames.ESQUEMA_GENERICO + "A_USU.USU_COD=RES_USU ";
            
            // añadimos una nueva condición para buscar por el tecnico de referencia de los registros.
            if (StringUtils.isNotNullOrEmptyOrNullString(docTecnicoRegistro)){
            pWhere = pWhere.concat("AND TL.numero_documento_tecnica ='"+ docTecnicoRegistro +"'");
            }
            
            String p2Where = " AND (RES_EST = " + ConstantesDatos.REG_ANOTACION_ESTADO_PENDIENTE
                    + " OR RES_EST = " + ConstantesDatos.REG_ANOTACION_ESTADO_ACEPTADA_EN_DESTINO + ") AND RES_UOD IN  (SELECT UOU_UOR FROM " + GlobalNames.ESQUEMA_GENERICO + "A_UOU "
                    + " WHERE UOU_USU = " + uVO.getIdUsuario() + " AND UOU_ORG = " + uVO.getOrgCod() + " AND UOU_ENT = " + uVO.getEntCod() + ") ";
            if ((ejercicio == null || "".equals(ejercicio))) {
                // && (numAnotacion == null || "".equals(numAnotacion))
                m_Log.debug("El ejercicio  vacio");
                if (!"".equals(fechaDesde) && !"".equals(fechaHasta)) {
                    pWhere3 = "AND RES_FEC BETWEEN " + oad.convertir("'" + fechaDesde + " 00:00:00'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS")
                            + " AND " + oad.convertir("'" + fechaHasta + " 23:59:59'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS");
                }
            }

            /**
             * ** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ***
             */
            if (codUorDestino != null && !"".equals(codUorDestino)) {
                pWhere3 += " AND RES_UOD=" + codUorDestino;
            }

            /*Criterio de busqueda ejercicio y num anotacion*/
            m_Log.debug("ejercicio" + ejercicio);
            if (ejercicio != null && !"".equals(ejercicio)) {
                pWhere3 += " AND RES_EJE=" + ejercicio;
            }
            m_Log.debug("numAnotacion" + numAnotacion);
            if ((ejercicio != null && !"".equals(ejercicio)) && (numAnotacion != null && !"".equals(numAnotacion))) {
                pWhere3 += " AND RES_NUM=" + numAnotacion;
            }

            if (codAsunto != null && !"".equals(codAsunto)) {
                //pWhere3+= " AND R_RES.ASUNTO='" + codAsunto + "' AND R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + " ";
                pWhere3 += " AND R_RES.ASUNTO IN (SELECT R_TIPOASUNTO.CODIGO FROM R_TIPOASUNTO WHERE R_TIPOASUNTO.CODIGO='" + codAsunto + "' AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + ")";
            }
            
            // Añadimos una nueva condición para buscar por la clasificación del asunto.
            if (StringUtils.isNotNullOrEmptyOrNullString(codClasificacionAsunto)) {
                pWhere3 += " AND R_RES.ASUNTO IN (SELECT R_TIPOASUNTO.CODIGO FROM R_TIPOASUNTO WHERE R_TIPOASUNTO.CODIGO_CLASIFICACION='" + codClasificacionAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroClasifAsunto + ")";
            }

            if ((documentoBusqueda != null && !"".equals(documentoBusqueda)) || (nombreBusqueda != null && !"".equals(nombreBusqueda)) || (apellido1Busqueda != null && !"".equals(apellido1Busqueda))
                    || (apellido2Busqueda != null && !"".equals(apellido2Busqueda))) {

                pWhere3 += "AND EXISTS(SELECT EXT_TER FROM R_EXT,T_HTE B WHERE EXT_NUM=RES_NUM AND EXT_EJE=RES_EJE AND "
                        + "EXT_UOR=RES_UOR AND EXT_TIP=RES_TIP AND EXT_DEP=RES_DEP AND EXT_TER=B.HTE_TER "
                        + "AND EXT_NVR=B.HTE_NVR ";

                if (documentoBusqueda != null && !"".equals(documentoBusqueda)) {
                    pWhere3 += " AND B.HTE_DOC LIKE ('%" + documentoBusqueda.toUpperCase() + "%') ";
                }

                if (nombreBusqueda != null && !"".equals(nombreBusqueda)) {
                    pWhere3 += " AND B.HTE_NOM LIKE ('%" + nombreBusqueda.toUpperCase() + "%') ";
                }

                if (apellido1Busqueda != null && !"".equals(apellido1Busqueda)) {
                    pWhere3 += " AND B.HTE_AP1 LIKE ('%" + apellido1Busqueda.toUpperCase() + "%') ";
                }

                if (apellido2Busqueda != null && !"".equals(apellido2Busqueda)) {
                    pWhere3 += " AND B.HTE_AP2 LIKE ('%" + apellido2Busqueda.toUpperCase() + "%') ";
                }

                pWhere3 += ") ";
            }
            if (codUorAnotacion != null && !"".equals(codUorAnotacion)) {
                pWhere3 += " AND RES_UOR=" + codUorAnotacion;
            }

            /**
             * **************
             */
            if (UsuariosGruposDAO.getInstance().tienePermisoDirectiva(ConstantesDatos.REGISTRO_S_SOLO_UORS_USUARIO, uVO.getIdUsuario(), con)) {
                pWhere3 += " AND (UOD.UOR_TIP IS NULL OR UOD.UOR_TIP=0)";
            }
            /**
             * *************
             */

            String pWhere4;
            m_Log.debug("Resultado de tVO.getRegistroTelematico(): " + tVO.getRegistroTelematico());

            if (tVO.getRegistroTelematico().equals("0")) {
                pWhere4 = " AND REGISTRO_TELEMATICO = 1";
            } else if (tVO.getRegistroTelematico().equals("1")) {
                pWhere4 = " AND REGISTRO_TELEMATICO = 0";
            } else {
                pWhere4 = "";
            }
            
            if (tVO.getRegPendCatalogacion() != null && !"".equals(tVO.getRegPendCatalogacion()) && "0".equals(tVO.getRegPendCatalogacion())) {
                pWhere4 = pWhere4 + "AND RES_DEP = D.RED_DEP " +
                "AND RES_UOR = D.RED_UOR " +
                "AND RES_TIP = D.RED_TIP " +
                "AND RES_EJE = D.RED_EJE " +
                "AND RES_NUM = D.RED_NUM " +
                "AND D.RED_MIGRA = 0 " +
                "AND D.RED_TIPODOC_ID IS NULL ";
            }
            
            
            m_Log.debug("Resultado pWhere4: " + pWhere4);

            // CRITERIO FIN DIGITALIZACION 
            String pWhere5 = " AND FIN_DIGITALIZACION = 1";

            /**
             * ** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ***
             */
            String sql = parte_select + parteFrom1 + pWhere + p2Where + pWhere3 + pWhere4 + pWhere5;

            if (("".equals(columna)) || (columna == null) || ("0".equals(columna))) {
                sql += ") ORDER BY RES_FEC DESC, RES_NUM DESC";
            } else {
                sql += ") ORDER BY " + columna + " " + tipoOrden;
            }

            if (m_Log.isDebugEnabled()) {
                m_Log.debug("TramitacionDAO: getAsientosEntradaRegistro plugin tecnico de referencia --> " + sql);
            }

            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            while (rs.next()) {

                if (!soloContar) {
                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                    if (numPaginaE != pagActual) {
                        posE++;
                        continue;
                    }
                }

                TramitacionValueObject tvo1 = new TramitacionValueObject();
                String numeroAsiento = rs.getString("RES_NUM");
                String ejercicioAsiento = rs.getString("RES_EJE");
                String codDepartamento = rs.getString("RES_DEP");
                String codUnidadRegistro = rs.getString("RES_UOR");
                String tipoRegistro = rs.getString("RES_TIP");

                tvo1.setCodDepartamento(codDepartamento);
                tvo1.setCodUnidadRegistro(codUnidadRegistro);
                tvo1.setTipoRegistro(tipoRegistro);
                tvo1.setEjerNum(ejercicioAsiento + "/" + numeroAsiento);
                m_Log.debug(tvo1.getEjerNum());
                tvo1.setFechaAnotacion(rs.getString("FECANOT"));
                tvo1.setFechaDocumento(rs.getString("FECDOC"));
                tvo1.setAsunto(AdaptadorSQLBD.js_escape(rs.getString("RES_ASU")));
                tvo1.setObservaciones(AdaptadorSQLBD.js_escape(rs.getString("RES_OBS")));

                //formato del interesado
                String apellido1 = rs.getString("APELLIDO1");
                String apellido2 = rs.getString("APELLIDO2");
                String numTerceros = rs.getString("num_terceros");
                String nombre = rs.getString("HTE_NOM");
                String nombreTerc = FormateadorTercero.getDescTercero(nombre, apellido1, apellido2, false);
                String tipoTransporte = rs.getString("TRANSPORTE");
                String nombreUOR = rs.getString("UOR_NOM");

                tvo1.setNumTerceros(numTerceros);
                tvo1.setRemitente(nombreTerc);
                tvo1.setDocTercero(rs.getString("HTE_DOC"));
                tvo1.setEstado("0");
                tvo1.setOrigen(nombreServicio);
                if (tipoTransporte != null) {
                    tvo1.setTipoTransporte(tipoTransporte);
                } else {
                    tvo1.setTipoTransporte("");
                }
                lista.addElement(tvo1);
                tvo1.setUnidadTramitadora(rs.getString("UNIDADDESTINO"));
                tvo1.setUnidadInicio(nombreUOR);
                /**
                 * tvo1.setProcedimiento(rs.getString("PROCEDIMIENTO"));
                 * tvo1.setNumExpediente(rs.getString("exr_num"));
                 */
                if (!soloContar) {
                    // Si sólo se ejecuta la consulta para con
                    ArrayList<String> listaExpedientes = this.getListaExpedientesRelacionadosAnotacion(numeroAsiento, ejercicioAsiento, codDepartamento, codUnidadRegistro, tipoRegistro, con);
                    tvo1.setProcedimiento(extraerCodigosProcedimientos(listaExpedientes));
                    tvo1.setNumExpediente(tratarListaExpedientes(listaExpedientes));
                }

                tvo1.setUsuarioAlta(rs.getString("NOM"));
                // Asunto codificado

                String codAsuntoCod = rs.getString("COD_ASUNTO_CODIFICADO");
                if (codAsuntoCod != null) {
                    tvo1.setCodigoAsuntoCodificado(codAsuntoCod);
                } else {
                    tvo1.setCodigoAsuntoCodificado("");
                }
                String descripAsunto = rs.getString("DES_ASUNTO_CODIFICADO");
                if (descripAsunto != null) {
                    tvo1.setDescripcionAsuntoCodificado(descripAsunto);
                } else {
                    tvo1.setDescripcionAsuntoCodificado("");
                }

                //tecnico de referencia
                String nombreTecnico = rs.getString("NOMBRE_TECNICA");
                String apellido1Tecnico = rs.getString("APELLIDO1_TECNICA");
                String apellido2Tecnico = rs.getString("APELLIDO2_TECNICA");

                String nombreCompletoTecnico = StringUtils.isNotNullOrEmptyOrNullString(apellido1Tecnico) ? apellido1Tecnico : "";
                nombreCompletoTecnico = nombreCompletoTecnico.concat(StringUtils.isNotNullOrEmptyOrNullString(apellido2Tecnico) ? " " + apellido2Tecnico + ", " : StringUtils.isNotNullOrEmptyOrNullString(apellido1Tecnico) ? ", " : "");
                nombreCompletoTecnico = nombreCompletoTecnico.concat(StringUtils.isNotNullOrEmptyOrNullString(nombreTecnico) ? nombreTecnico : "");
                tvo1.setTecnicoReferencia(nombreCompletoTecnico);

                posE++;
            }

        } catch (Exception e) {
            lista = null;
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) {
                m_Log.error(e.getMessage());
            }
            throw new TramitacionException("Error.TramitacionDAO.getAsientosEntradaRegistroPluginTecnico", e);

        } finally {
            cerrarConexiones(stmt, rs, oad, con, "Error.TramitacionDAO.getAsientosEntradaRegistroPluginTecnico.DevolverConexion");
            m_Log.debug("getAsientosEntradaRegistroPluginTecnico");

        }

        return lista;
    }
     
     
     
     
         public Vector getAsientosExpedientesHistoricoPluginTecnico(UsuarioValueObject uVO, TramitacionValueObject tVO,
            String nombreServicio, String[] params, String fechaDesde, String fechaHasta, String documentoBusqueda,
            String nombreBusqueda, String apellido1Busqueda, String apellido2Busqueda, String codAsunto, String unidadRegistroAsunto,
            String tipoRegistroAsunto, String codUorDestino, String ejercicio, String numAnotacion, String codUorAnotacion,
            String codClasificacionAsunto,String unidadRegistroClasifAsunto,String docTecnicoRegistro)
            throws TramitacionException, TechnicalException {
        if (m_Log.isDebugEnabled()) {
            m_Log.debug("getAsientosExpedientesHistoricoPluginTecnico() : BEGIN");
        }
        
        
        Vector<TramitacionValueObject> lista = new Vector<TramitacionValueObject>();

        AdaptadorSQLBD oad = null;
        Connection con = null;
        PreparedStatement stmt = null;
        ResultSet rs = null;
        String pWhere3 = "";

        if (m_Log.isDebugEnabled()) {
            m_Log.debug("Uor de la anotacion" + codUorAnotacion);
        }
        boolean soloContar = tVO.isSoloContarExpedientesBuzonEntrada();
        int posE = 0;
        int numPaginaE = 0;
        int pagActual = -1;

        if (!"".equals(tVO.getPaginaListado()) && tVO.getPaginaListado() != null) {
            pagActual = Integer.parseInt(tVO.getPaginaListado());
        }//if

        int lineas = -1;
        if (!"".equals(tVO.getNumLineasPaginaListado()) && tVO.getNumLineasPaginaListado() != null) {
            lineas = Integer.parseInt(tVO.getNumLineasPaginaListado());
        }//if

        try {
            oad = new AdaptadorSQLBD(uVO.getParamsCon());
            con = oad.getConnection();
            String from = " TL.NOMBRE_TECNICA,TL.APELLIDO1_TECNICA,TL.APELLIDO2_TECNICA, " + sql_res_codDpto + "," + sql_res_codUnid + "," + sql_res_tipoReg + "," + sql_res_ejer + "," + sql_res_num + "," + sql_res_obs;
            from += "," + oad.convertir(sql_res_fecAnot, AdaptadorSQLBD.CONVERTIR_COLUMNA_TEXTO, "DD/MM/YYYY") + " AS fAnotacion ";
            from += "," + sql_res_asunt + ",R_RES.PROCEDIMIENTO, " + sql_res_estado;
            from += "," + sql_hte_nan + "," + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT,
                    new String[]{sql_hte_p1a, "' '", sql_hte_a1a}) + " AS APELLIDO1 ,"
                    + oad.funcionCadena(AdaptadorSQLBD.FUNCIONCADENA_CONCAT, new String[]{sql_hte_p2a, "' '", sql_hte_a2a})
                    + " AS APELLIDO2 ";
            from += ", (SELECT COUNT (*) FROM  R_EXT WHERE res_uor=ext_uor AND res_dep=ext_dep AND res_tip=ext_tip AND res_eje=ext_eje AND res_num=ext_num )AS num_terceros ";

            if (m_Log.isDebugEnabled()) {
                m_Log.debug("from: " + from);
            }

            ArrayList<String> join1 = new ArrayList<String>();
            //join1.add("R_TIPOASUNTO");
            /**
             * ORIGINAL join1.add("E_EXR");
            *
             */
            //join1.add("LEFT");
            //join1.add("R_TIPOASUNTO");
            /**
             * ORIGINAL join1.add("RIGHT");
            *
             */
            join1.add("R_RES LEFT JOIN T_CAMPOS_TEXTO tcampostexto ON r_res.res_ter = tcampostexto.COD_TERCERO and tcampostexto.cod_campo = 'TTECNICOREFERENCIA' LEFT JOIN "+ GlobalNames.ESQUEMA_GENERICO + "S_VW_OR_TECNICOS_LISTA TL ON TL.NUMERO_DOCUMENTO_TECNICA = tcampostexto.VALOR ");
            /**
             * ORIGINAL join1.add(sql_exr_dep + "=" + sql_res_codDpto + " AND "
             * + sql_exr_uor + "=" + sql_res_codUnid + " AND " + sql_exr_tip +
             * "=" + sql_res_tipoReg + " AND " + sql_exr_ejr + "=" +
             * sql_res_ejer + " AND " + sql_exr_nre + "=" + sql_res_num); *
             */
            join1.add("INNER");
            join1.add("T_HTE");
            join1.add(sql_res_codTerc + "=" + sql_hte_ter + " AND " + sql_res_modTerc + "=" + sql_hte_nvr);
            join1.add("INNER");
            join1.add("T_DNN");
            join1.add(sql_res_domTerc + "=" + sql_dnn_dom);
            join1.add("INNER");
            join1.add(GlobalNames.ESQUEMA_GENERICO + "T_MUN T_MUN");
            join1.add(sql_dnn_pai + "=" + sql_mun_pai + " AND " + sql_dnn_prv + "=" + sql_mun_prv + " AND " + sql_dnn_mun + "=" + sql_mun_cod);
            //join1.add("R_TIPOASUNTO");
            join1.add("false");

            if ((ejercicio == null || "".equals(ejercicio))) {
                // && (numAnotacion == null || "".equals(numAnotacion))
                if (m_Log.isDebugEnabled()) {
                    m_Log.debug("El ejercicio  vacio");
                }
                if (!"".equals(fechaDesde) && !"".equals(fechaHasta)) {
                    pWhere3 = " AND RES_FEC BETWEEN " + oad.convertir("'" + fechaDesde + " 00:00:00'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS")
                            + " AND " + oad.convertir("'" + fechaHasta + " 23:59:59'", AdaptadorSQLBD.CONVERTIR_COLUMNA_FECHA, "DD/MM/YYYY HH24:MI:SS");
                }//if
            }//if

            /*Criterio de busqueda registro telem?tico*/
            m_Log.debug("Resultado de tVO.getRegistroTelematico(): " + tVO.getRegistroTelematico());

            if (tVO.getRegistroTelematico().equals("0")) {
                pWhere3 += " AND REGISTRO_TELEMATICO = 1";
            } else if (tVO.getRegistroTelematico().equals("1")) {
                pWhere3 += " AND REGISTRO_TELEMATICO = 0";
            }

            /*Criterio de busqueda ejercicio y num anotacion*/
            if (m_Log.isDebugEnabled()) {
                m_Log.debug("ejercicio" + ejercicio);
            }
            if (ejercicio != null && !"".equals(ejercicio)) {
                pWhere3 += " AND RES_EJE=" + ejercicio;
            }//if

            if (m_Log.isDebugEnabled()) {
                m_Log.debug("numAnotacion" + numAnotacion);
            }
            if ((ejercicio != null && !"".equals(ejercicio)) && (numAnotacion != null && !"".equals(numAnotacion))) {
                pWhere3 += " AND RES_NUM=" + numAnotacion;
            }//if

            /**
             * ** NUEVOS CRITERIOS DE BÚSQUEDA PARA BUZÓN DE ENTRADA ***
             */
            if (m_Log.isDebugEnabled()) {
                m_Log.debug("unidad destiono" + codUorDestino);
            }
            if (codUorDestino != null && !"".equals(codUorDestino)) {
                pWhere3 += " AND RES_UOD=" + codUorDestino;
            }//if

            if (m_Log.isDebugEnabled()) {
                m_Log.debug("codAsunto" + codAsunto);
            }

            if (StringUtils.isNotNullOrEmptyOrNullString(codAsunto) && StringUtils.isNotNullOrEmptyOrNullString(codClasificacionAsunto)) {
                //pWhere3+= " AND ASUNTO='" + codAsunto + "' ";
                pWhere3 += " AND EXISTS (SELECT R_RES.ASUNTO FROM R_RES B, R_TIPOASUNTO WHERE (R_RES.ASUNTO=R_TIPOASUNTO.CODIGO"
                        + " AND (R_TIPOASUNTO.UNIDADREGISTRO=-1 OR R_RES.RES_UOR=R_TIPOASUNTO.UNIDADREGISTRO) "
                        + " AND (R_TIPOASUNTO.TIPOREGISTRO='E' OR R_TIPOASUNTO.TIPOREGISTRO='A')  ";
                pWhere3 += " AND R_RES.ASUNTO='" + codAsunto + "' AND R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + " AND R_TIPOASUNTO.CODIGO_CLASIFICACION='" + codClasificacionAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO='" + unidadRegistroClasifAsunto + "')"
                        + " AND R_RES.RES_NUM=B.RES_NUM AND R_RES.RES_EJE=B.RES_EJE AND R_RES.RES_UOR=B.RES_UOR AND R_RES.RES_TIP=B.RES_TIP AND R_RES.RES_DEP=B.RES_DEP)";

            } else if (StringUtils.isNotNullOrEmptyOrNullString(codAsunto) && !StringUtils.isNotNullOrEmptyOrNullString(codClasificacionAsunto)) {
                //pWhere3+= " AND ASUNTO='" + codAsunto + "' ";
                pWhere3 += " AND EXISTS (SELECT R_RES.ASUNTO FROM R_RES B, R_TIPOASUNTO WHERE (R_RES.ASUNTO=R_TIPOASUNTO.CODIGO"
                        + " AND (R_TIPOASUNTO.UNIDADREGISTRO=-1 OR R_RES.RES_UOR=R_TIPOASUNTO.UNIDADREGISTRO) "
                        + " AND (R_TIPOASUNTO.TIPOREGISTRO='E' OR R_TIPOASUNTO.TIPOREGISTRO='A')  ";
                pWhere3 += " AND R_RES.ASUNTO='" + codAsunto + "' AND R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND R_TIPOASUNTO.TIPOREGISTRO='" + tipoRegistroAsunto + "' AND R_TIPOASUNTO.UNIDADREGISTRO=" + unidadRegistroAsunto + ") AND R_RES.RES_NUM=B.RES_NUM AND R_RES.RES_EJE=B.RES_EJE AND R_RES.RES_UOR=B.RES_UOR AND R_RES.RES_TIP=B.RES_TIP AND R_RES.RES_DEP=B.RES_DEP)";
            } else if (!StringUtils.isNotNullOrEmptyOrNullString(codAsunto) && StringUtils.isNotNullOrEmptyOrNullString(codClasificacionAsunto)) {
                pWhere3 += " AND EXISTS (SELECT R_RES.ASUNTO FROM R_RES B, R_TIPOASUNTO WHERE (R_RES.ASUNTO=R_TIPOASUNTO.CODIGO AND (R_TIPOASUNTO.UNIDADREGISTRO='" + unidadRegistroClasifAsunto + "' AND R_TIPOASUNTO.CODIGO_CLASIFICACION='" + codClasificacionAsunto + "')))";
            }

            if ((documentoBusqueda != null && !"".equals(documentoBusqueda)) || (nombreBusqueda != null && !"".equals(nombreBusqueda)) || (apellido1Busqueda != null && !"".equals(apellido1Busqueda))
                    || (apellido2Busqueda != null && !"".equals(apellido2Busqueda))) {

                pWhere3 += "AND EXISTS(SELECT EXT_TER FROM R_EXT,T_HTE B WHERE EXT_NUM=RES_NUM AND EXT_EJE=RES_EJE AND "
                        + "EXT_UOR=RES_UOR AND EXT_TIP=RES_TIP AND EXT_DEP=RES_DEP AND EXT_TER=B.HTE_TER "
                        + "AND EXT_NVR=B.HTE_NVR ";

                if (documentoBusqueda != null && !"".equals(documentoBusqueda)) {
                    pWhere3 += " AND B.HTE_DOC LIKE ('%" + documentoBusqueda.toUpperCase() + "%') ";
                }//if

                if (nombreBusqueda != null && !"".equals(nombreBusqueda)) {
                    pWhere3 += " AND B.HTE_NOM LIKE ('%" + nombreBusqueda.toUpperCase() + "%') ";
                }//if

                if (apellido1Busqueda != null && !"".equals(apellido1Busqueda)) {
                    pWhere3 += " AND B.HTE_AP1 LIKE ('%" + apellido1Busqueda.toUpperCase() + "%') ";
                }//if

                if (apellido2Busqueda != null && !"".equals(apellido2Busqueda)) {
                    pWhere3 += " AND B.HTE_AP2 LIKE ('%" + apellido2Busqueda.toUpperCase() + "%') ";
                }//if

                pWhere3 += ") ";
            }//if
            
            // añadimos una nueva condición para buscar por el tecnico de referencia de los registros.
            if (StringUtils.isNotNullOrEmptyOrNullString(docTecnicoRegistro)){
            pWhere3 = pWhere3.concat(" AND TL.numero_documento_tecnica ='"+ docTecnicoRegistro +"' ");
            }

            if (codUorAnotacion != null && !"".equals(codUorAnotacion)) {
                pWhere3 += " AND RES_UOR=" + codUorAnotacion;
            }//if

            ArrayList<String> join2 = new ArrayList<String>();
            //join2.add("R_TIPOASUNTO");
            /**
             * * ORIGINAL join2.add("E_EXR");
            **
             */
            //join2.add("LEFT");
            //join2.add("R_TIPOASUNTO");
            /**
             * ORIGINAL join2.add("RIGHT"); *
             */
            join2.add("R_RES LEFT JOIN T_CAMPOS_TEXTO tcampostexto ON r_res.res_ter = tcampostexto.COD_TERCERO and tcampostexto.cod_campo = 'TTECNICOREFERENCIA' LEFT JOIN "+ GlobalNames.ESQUEMA_GENERICO + "S_VW_OR_TECNICOS_LISTA TL ON TL.NUMERO_DOCUMENTO_TECNICA = tcampostexto.VALOR ");
            /**
             * ORIGINAL join2.add(sql_exr_dep + "=" + sql_res_codDpto + " AND "
             * + sql_exr_uor + "=" + sql_res_codUnid + " AND " + sql_exr_tip +
             * "=" + sql_res_tipoReg + " AND " + sql_exr_ejr + "=" +
             * sql_res_ejer + " AND " + sql_exr_nre + "=" + sql_res_num); *
             */
            join2.add("INNER");
            join2.add("T_HTE");
            join2.add(sql_res_codTerc + "=" + sql_hte_ter + " AND " + sql_res_modTerc + "=" + sql_hte_nvr);
            join2.add("INNER");
            join2.add("T_DPO");
            join2.add(sql_res_domTerc + "=" + sql_dpo_dom);
            join2.add("INNER");
            join2.add("T_DSU");
            join2.add(sql_dpo_dirSuelo + "=" + sql_dsu_codDirSuelo);
            join2.add("INNER");
            join2.add(GlobalNames.ESQUEMA_GENERICO + "T_MUN T_MUN");
            join2.add(sql_dsu_pais + "=" + sql_mun_pai + " AND " + sql_dsu_prov + "=" + sql_mun_prv + " AND " + sql_dsu_mun + "=" + sql_mun_cod);
            //join2.add("R_TIPOASUNTO");
            join2.add("false");

            String pWhere = sql_res_tipoDestino + " != 1 AND " + sql_res_estado + "!=0 AND "
                    + //sql_res_estado + "!=9 AND " + sql_res_tipoReg + "='E'"
                    sql_res_estado + "!=9 AND " + sql_res_estado + "!=3 AND " + sql_res_tipoReg + "='E'"
                    + " AND EXISTS (SELECT DISTINCT " + sql_uou_uor + " FROM "
                    + GlobalNames.ESQUEMA_GENERICO + "A_UOU WHERE "
                    + sql_uou_usu + "=" + uVO.getIdUsuario() + " AND " + sql_uou_org + "="
                    + uVO.getOrgCod() + " AND " + sql_uou_ent + "=" + uVO.getEntCod() + " AND "
                    + sql_uou_uor + "=" + sql_res_ord_unid + ")"; // Datos listado.

            String sql = "";
            if (pWhere3 != null && !"".equals(pWhere3)) {
                if (m_Log.isDebugEnabled()) {
                    m_Log.debug("Filtro:" + pWhere3);
                }
                sql = oad.join(from, pWhere, join1.toArray(new String[]{})) + pWhere3
                        + " UNION " + oad.join(from, pWhere, join2.toArray(new String[]{})) + pWhere3 + " ORDER BY fAnotacion DESC";
            } else {
                sql = oad.join(from, pWhere, join1.toArray(new String[]{}))
                        + " UNION " + oad.join(from, pWhere, join2.toArray(new String[]{})) + " ORDER BY fAnotacion DESC";
            }//if

            SimpleDateFormat s = new SimpleDateFormat("dd/MM/yyyy");

            if (m_Log.isDebugEnabled()) {
                m_Log.debug("TramitacionDAO: getAsientosExpedientesHistorico --> " + sql);
            }
            stmt = con.prepareStatement(sql);
            rs = stmt.executeQuery();
            while (rs.next()) {
                if (!soloContar) {
                    numPaginaE = (int) Math.ceil(posE / lineas) + 1;
                    if (numPaginaE != pagActual) {
                        posE++;
                        continue;
                    }//if
                }//if

                TramitacionValueObject tvo1 = new TramitacionValueObject();
                String codDepartamento = rs.getString(sql_res_codDpto);
                tvo1.setCodDepartamento(codDepartamento);
                String codUnidadRegistro = rs.getString(sql_res_codUnid);
                tvo1.setCodUnidadRegistro(codUnidadRegistro);
                String tipoRegistro = rs.getString(sql_res_tipoReg);
                tvo1.setTipoRegistro(tipoRegistro);
                String ejercicioRegistro = rs.getString(sql_res_ejer);
                String numeroRegistro = rs.getString(sql_res_num);
                tvo1.setEjerNum(ejercicioRegistro + "/" + numeroRegistro);
                tvo1.setFechaAnotacion(rs.getString("fAnotacion"));
                tvo1.setAsunto(AdaptadorSQLBD.js_escape(rs.getString(sql_res_asunt)));
                tvo1.setObservaciones(rs.getString(sql_res_obs));
                tvo1.setNumTerceros(rs.getString("num_terceros"));
                String apellido1 = rs.getString("APELLIDO1");
                String apellido2 = rs.getString("APELLIDO2");
                String nombre = rs.getString("HTE_NOM");
                String nombreTerc = FormateadorTercero.getDescTercero(nombre, apellido1, apellido2, false);
                tvo1.setRemitente(nombreTerc);
                //SI EL ESTADO ES ACEPTADO Y TIENE EXPEDIENTE ASOCIADO CAMBIO EL ESTADO A eXPEDIENTE ASOCIADO
                //String num_expediente = rs.getString("EXR_NUM");
                String estado = rs.getString(sql_res_estado);
                
                             //tecnico de referencia
                String nombreTecnico = rs.getString("NOMBRE_TECNICA");
                String apellido1Tecnico = rs.getString("APELLIDO1_TECNICA");
                String apellido2Tecnico = rs.getString("APELLIDO2_TECNICA");

                String nombreCompletoTecnico = StringUtils.isNotNullOrEmptyOrNullString(apellido1Tecnico) ? apellido1Tecnico : "";
                nombreCompletoTecnico = nombreCompletoTecnico.concat(StringUtils.isNotNullOrEmptyOrNullString(apellido2Tecnico) ? " " + apellido2Tecnico + ", " : StringUtils.isNotNullOrEmptyOrNullString(apellido1Tecnico) ? ", " : "");
                nombreCompletoTecnico = nombreCompletoTecnico.concat(StringUtils.isNotNullOrEmptyOrNullString(nombreTecnico) ? nombreTecnico : "");
                tvo1.setTecnicoReferencia(nombreCompletoTecnico);
                
                /**
                 * original if (num_expediente != null &&
                 * !"".equals(num_expediente) && "1".equals(estado)) {
                *
                 */
                //Para obtener el numero de expedientes relacionados de cada anotación, vamos a realizar una consulta aparte solo para
                //las anotaciones que se van a mostrar. Para el resto vamos a ponerle el valor 0, ya que no hay ordenación en esta tabla
                int menorLineaPagina = 0;
                int mayorLineaPagina = lineas - 1;
                int numeroExpedientesRelacionados = 0;

                menorLineaPagina = (pagActual - 1) * lineas;
                mayorLineaPagina = (pagActual * lineas) - 1;

                if ((posE <= mayorLineaPagina) && (posE >= menorLineaPagina)) {
                    //Consulta de numero de expedientes
                    numeroExpedientesRelacionados = getNumeroExpedientesAsociadosARegistroHistorico(con, Integer.parseInt(codDepartamento), Integer.parseInt(codUnidadRegistro), tipoRegistro, Integer.parseInt(ejercicioRegistro), Integer.parseInt(numeroRegistro));
                } else {
                    numeroExpedientesRelacionados = 0;  //Valor por defecto para las anotaciones que no se muestran
                }
                if (numeroExpedientesRelacionados >= 1 && "1".equals(estado)) {
                    tvo1.setEstado("3");
                } else {
                    tvo1.setEstado(estado);
                }//if
                tvo1.setOrigen(nombreServicio);
                lista.addElement(tvo1);
                posE++;
            }//while
        } catch (Exception e) {
            lista = new Vector<TramitacionValueObject>();
            e.printStackTrace();
            if (m_Log.isErrorEnabled()) {
                m_Log.error(e.getMessage());
            }
            throw new TramitacionException("Error. TramitacionDAO.getAsientosExpedientesHistorico", e);
        } finally {
            cerrarResultSet(rs);
            cerrarStatement(stmt);
            devolverConexion(oad, con);
            if (m_Log.isDebugEnabled()) {
                m_Log.debug("getAsientosExpedientesHistorico");
            }
        }//try-catch-finally
        if (m_Log.isDebugEnabled()) {
            m_Log.debug("getAsientosExpedientesHistorico() : END");
        }
        return lista;
    }//getAsientosExpedientesHistorico
   
}